import*as Common from"../common/common.js";import*as UI from"../ui/ui.js";import{Events as OverviewGridEvents,OverviewGrid}from"./OverviewGrid.js";import{Calculator}from"./TimelineGrid.js";export class TimelineOverviewPane extends UI.Widget.VBox{constructor(e){super(),this.element.id=e+"-overview-pane",this._overviewCalculator=new TimelineOverviewCalculator,this._overviewGrid=new OverviewGrid(e,this._overviewCalculator),this.element.appendChild(this._overviewGrid.element),this._cursorArea=this._overviewGrid.element.createChild("div","overview-grid-cursor-area"),this._cursorElement=this._overviewGrid.element.createChild("div","overview-grid-cursor-position"),this._cursorArea.addEventListener("mousemove",this._onMouseMove.bind(this),!0),this._cursorArea.addEventListener("mouseleave",this._hideCursor.bind(this),!0),this._overviewGrid.setResizeEnabled(!1),this._overviewGrid.addEventListener(OverviewGridEvents.WindowChanged,this._onWindowChanged,this),this._overviewGrid.setClickHandler(this._onClick.bind(this)),this._overviewControls=[],this._markers=new Map,this._overviewInfo=new OverviewInfo(this._cursorElement),this._updateThrottler=new Common.Throttler.Throttler(100),this._cursorEnabled=!1,this._cursorPosition=0,this._lastWidth=0,this._windowStartTime=0,this._windowEndTime=1/0,this._muteOnWindowChanged=!1}_onMouseMove(e){this._cursorEnabled&&(this._cursorPosition=e.offsetX+e.target.offsetLeft,this._cursorElement.style.left=this._cursorPosition+"px",this._cursorElement.style.visibility="visible",this._overviewInfo.setContent(this._buildOverviewInfo()))}async _buildOverviewInfo(){const e=this.element.ownerDocument,i=this._cursorPosition,t=await Promise.all(this._overviewControls.map(e=>e.overviewInfoPromise(i))),s=e.createDocumentFragment();return s.appendChildren.apply(s,t.filter(e=>null!==e)),s}_hideCursor(){this._cursorElement.style.visibility="hidden",this._overviewInfo.hide()}wasShown(){this._update()}willHide(){this._overviewInfo.hide()}onResize(){const e=this.element.offsetWidth;e!==this._lastWidth&&(this._lastWidth=e,this.scheduleUpdate())}setOverviewControls(e){for(let e=0;e<this._overviewControls.length;++e)this._overviewControls[e].dispose();for(let i=0;i<e.length;++i)e[i].setCalculator(this._overviewCalculator),e[i].show(this._overviewGrid.element);this._overviewControls=e,this._update()}setBounds(e,i){this._overviewCalculator.setBounds(e,i),this._overviewGrid.setResizeEnabled(!0),this._cursorEnabled=!0}scheduleUpdate(){this._updateThrottler.schedule(function(){return this._update(),Promise.resolve()}.bind(this))}_update(){if(this.isShowing()){this._overviewCalculator.setDisplayWidth(this._overviewGrid.clientWidth());for(let e=0;e<this._overviewControls.length;++e)this._overviewControls[e].update();this._overviewGrid.updateDividers(this._overviewCalculator),this._updateMarkers(),this._updateWindow()}}setMarkers(e){this._markers=e}_updateMarkers(){const e=new Map;for(const i of this._markers.keys()){const t=this._markers.get(i),s=Math.round(this._overviewCalculator.computePosition(i));e.has(s)||(e.set(s,t),t.style.left=s+"px")}this._overviewGrid.removeEventDividers(),this._overviewGrid.addEventDividers([...e.values()])}reset(){this._windowStartTime=0,this._windowEndTime=1/0,this._overviewCalculator.reset(),this._overviewGrid.reset(),this._overviewGrid.setResizeEnabled(!1),this._cursorEnabled=!1,this._hideCursor(),this._markers=new Map;for(const e of this._overviewControls)e.reset();this._overviewInfo.hide(),this.scheduleUpdate()}_onClick(e){return this._overviewControls.some(i=>i.onClick(e))}_onWindowChanged(e){if(this._muteOnWindowChanged)return;if(!this._overviewControls.length)return;this._windowStartTime=e.data.rawStartValue,this._windowEndTime=e.data.rawEndValue;const i={startTime:this._windowStartTime,endTime:this._windowEndTime};this.dispatchEventToListeners(Events.WindowChanged,i)}setWindowTimes(e,i){e===this._windowStartTime&&i===this._windowEndTime||(this._windowStartTime=e,this._windowEndTime=i,this._updateWindow(),this.dispatchEventToListeners(Events.WindowChanged,{startTime:e,endTime:i}))}_updateWindow(){if(!this._overviewControls.length)return;const e=this._overviewCalculator.minimumBoundary(),i=this._overviewCalculator.maximumBoundary()-e,t=e>0,s=t&&this._windowStartTime?Math.min((this._windowStartTime-e)/i,1):0,r=t&&this._windowEndTime<1/0?(this._windowEndTime-e)/i:1;this._muteOnWindowChanged=!0,this._overviewGrid.setWindow(s,r),this._muteOnWindowChanged=!1}}export const Events={WindowChanged:Symbol("WindowChanged")};export class TimelineOverviewCalculator{constructor(){this.reset()}computePosition(e){return(e-this._minimumBoundary)/this.boundarySpan()*this._workingArea}positionToTime(e){return e/this._workingArea*this.boundarySpan()+this._minimumBoundary}setBounds(e,i){this._minimumBoundary=e,this._maximumBoundary=i}setDisplayWidth(e){this._workingArea=e}reset(){this.setBounds(0,100)}formatValue(e,i){return Number.preciseMillisToString(e-this.zeroTime(),i)}maximumBoundary(){return this._maximumBoundary}minimumBoundary(){return this._minimumBoundary}zeroTime(){return this._minimumBoundary}boundarySpan(){return this._maximumBoundary-this._minimumBoundary}}export class TimelineOverview{show(e,i){}update(){}dispose(){}reset(){}overviewInfoPromise(e){}onClick(e){}setCalculator(e){}}export class TimelineOverviewBase extends UI.Widget.VBox{constructor(){super(),this._calculator=null,this._canvas=this.element.createChild("canvas","fill"),this._context=this._canvas.getContext("2d")}width(){return this._canvas.width}height(){return this._canvas.height}context(){return this._context}calculator(){return this._calculator}update(){this.resetCanvas()}dispose(){this.detach()}reset(){}overviewInfoPromise(e){return Promise.resolve(null)}setCalculator(e){this._calculator=e}onClick(e){return!1}resetCanvas(){this.element.clientWidth&&this.setCanvasSize(this.element.clientWidth,this.element.clientHeight)}setCanvasSize(e,i){this._canvas.width=e*window.devicePixelRatio,this._canvas.height=i*window.devicePixelRatio}}export class OverviewInfo{constructor(e){this._anchorElement=e,this._glassPane=new UI.GlassPane.GlassPane,this._glassPane.setPointerEventsBehavior(UI.GlassPane.PointerEventsBehavior.PierceContents),this._glassPane.setMarginBehavior(UI.GlassPane.MarginBehavior.Arrow),this._glassPane.setSizeBehavior(UI.GlassPane.SizeBehavior.MeasureContent),this._visible=!1,this._element=UI.Utils.createShadowRootWithCoreStyles(this._glassPane.contentElement,"perf_ui/timelineOverviewInfo.css").createChild("div","overview-info")}async setContent(e){this._visible=!0;const i=await e;this._visible&&(this._element.removeChildren(),this._element.appendChild(i),this._glassPane.setContentAnchorBox(this._anchorElement.boxInWindow()),this._glassPane.isShowing()||this._glassPane.show(this._anchorElement.ownerDocument))}hide(){this._visible=!1,this._glassPane.hide()}}