import*as Common from"../common/common.js";import{Constraints,Size}from"./Geometry.js";import{appendStyle}from"./utils/append-style.js";import{createShadowRootWithCoreStyles}from"./utils/create-shadow-root-with-core-styles.js";import{XWidget}from"./XWidget.js";export class Widget extends Common.ObjectWrapper.ObjectWrapper{constructor(t,e){super(),this.contentElement=createElementWithClass("div","widget"),t?(this.element=createElementWithClass("div","vbox flex-auto"),this._shadowRoot=createShadowRootWithCoreStyles(this.element,void 0,e),this._shadowRoot.appendChild(this.contentElement)):this.element=this.contentElement,this._isWebComponent=t,this.element.__widget=this,this._visible=!1,this._isRoot=!1,this._isShowing=!1,this._children=[],this._hideOnDetach=!1,this._notificationDepth=0,this._invalidationsSuspended=0,this._defaultFocusedChild=null}static _incrementWidgetCounter(t,e){const i=(e.__widgetCounter||0)+(e.__widget?1:0);if(i)for(;t;)t.__widgetCounter=(t.__widgetCounter||0)+i,t=t.parentElementOrShadowHost()}static _decrementWidgetCounter(t,e){const i=(e.__widgetCounter||0)+(e.__widget?1:0);if(i)for(;t;)t.__widgetCounter-=i,t=t.parentElementOrShadowHost()}static __assert(t,e){if(!t)throw new Error(e)}markAsRoot(){Widget.__assert(!this.element.parentElement,"Attempt to mark as root attached node"),this._isRoot=!0}parentWidget(){return this._parentWidget}children(){return this._children}childWasDetached(t){}isShowing(){return this._isShowing}shouldHideOnDetach(){if(!this.element.parentElement)return!1;if(this._hideOnDetach)return!0;for(const t of this._children)if(t.shouldHideOnDetach())return!0;return!1}setHideOnDetach(){this._hideOnDetach=!0}_inNotification(){return!!this._notificationDepth||this._parentWidget&&this._parentWidget._inNotification()}_parentIsShowing(){return!!this._isRoot||!!this._parentWidget&&this._parentWidget.isShowing()}_callOnVisibleChildren(t){const e=this._children.slice();for(let i=0;i<e.length;++i)e[i]._parentWidget===this&&e[i]._visible&&t.call(e[i])}_processWillShow(){this._callOnVisibleChildren(this._processWillShow),this._isShowing=!0}_processWasShown(){this._inNotification()||(this.restoreScrollPositions(),this._notify(this.wasShown),this._callOnVisibleChildren(this._processWasShown))}_processWillHide(){this._inNotification()||(this.storeScrollPositions(),this._callOnVisibleChildren(this._processWillHide),this._notify(this.willHide),this._isShowing=!1)}_processWasHidden(){this._callOnVisibleChildren(this._processWasHidden)}_processOnResize(){this._inNotification()||this.isShowing()&&(this._notify(this.onResize),this._callOnVisibleChildren(this._processOnResize))}_notify(t){++this._notificationDepth;try{t.call(this)}finally{--this._notificationDepth}}wasShown(){}willHide(){}onResize(){}onLayout(){}ownerViewDisposed(){}show(t,e){if(Widget.__assert(t,"Attempt to attach widget with no parent element"),!this._isRoot){let e=t;for(;e&&!e.__widget;)e=e.parentElementOrShadowHost();Widget.__assert(e,"Attempt to attach widget to orphan node"),this._attach(e.__widget)}this._showWidget(t,e)}_attach(t){t!==this._parentWidget&&(this._parentWidget&&this.detach(),this._parentWidget=t,this._parentWidget._children.push(this),this._isRoot=!1)}showWidget(){this._visible||(Widget.__assert(this.element.parentElement,"Attempt to show widget that is not hidden using hideWidget()."),this._showWidget(this.element.parentElement,this.element.nextSibling))}_showWidget(t,e){let i=t;for(;i&&!i.__widget;)i=i.parentElementOrShadowHost();this._isRoot?Widget.__assert(!i,"Attempt to show root widget under another widget"):Widget.__assert(i&&i.__widget===this._parentWidget,"Attempt to show under node belonging to alien widget");const s=this._visible;s&&this.element.parentElement===t||(this._visible=!0,!s&&this._parentIsShowing()&&this._processWillShow(),this.element.classList.remove("hidden"),this.element.parentElement!==t&&(this._externallyManaged||Widget._incrementWidgetCounter(t,this.element),e?Widget._originalInsertBefore.call(t,this.element,e):Widget._originalAppendChild.call(t,this.element)),!s&&this._parentIsShowing()&&this._processWasShown(),this._parentWidget&&this._hasNonZeroConstraints()?this._parentWidget.invalidateConstraints():this._processOnResize())}hideWidget(){this._visible&&this._hideWidget(!1)}_hideWidget(t){this._visible=!1;const e=this.element.parentElement;this._parentIsShowing()&&this._processWillHide(),t?(Widget._decrementWidgetCounter(e,this.element),Widget._originalRemoveChild.call(e,this.element)):this.element.classList.add("hidden"),this._parentIsShowing()&&this._processWasHidden(),this._parentWidget&&this._hasNonZeroConstraints()&&this._parentWidget.invalidateConstraints()}detach(t){if(!this._parentWidget&&!this._isRoot)return;const e=t||!this.shouldHideOnDetach();if(this._visible)this._hideWidget(e);else if(e&&this.element.parentElement){const t=this.element.parentElement;Widget._decrementWidgetCounter(t,this.element),Widget._originalRemoveChild.call(t,this.element)}if(this._parentWidget){const t=this._parentWidget._children.indexOf(this);Widget.__assert(t>=0,"Attempt to remove non-child widget"),this._parentWidget._children.splice(t,1),this._parentWidget._defaultFocusedChild===this&&(this._parentWidget._defaultFocusedChild=null),this._parentWidget.childWasDetached(this),this._parentWidget=null}else Widget.__assert(this._isRoot,"Removing non-root widget from DOM")}detachChildWidgets(){const t=this._children.slice();for(let e=0;e<t.length;++e)t[e].detach()}elementsToRestoreScrollPositionsFor(){return[this.element]}storeScrollPositions(){const t=this.elementsToRestoreScrollPositionsFor();for(let e=0;e<t.length;++e){const i=t[e];i._scrollTop=i.scrollTop,i._scrollLeft=i.scrollLeft}}restoreScrollPositions(){const t=this.elementsToRestoreScrollPositionsFor();for(let e=0;e<t.length;++e){const i=t[e];i._scrollTop&&(i.scrollTop=i._scrollTop),i._scrollLeft&&(i.scrollLeft=i._scrollLeft)}}doResize(){this.isShowing()&&(this._inNotification()||this._callOnVisibleChildren(this._processOnResize))}doLayout(){this.isShowing()&&(this._notify(this.onLayout),this.doResize())}registerRequiredCSS(t){appendStyle(this._isWebComponent?this._shadowRoot:this.element,t)}printWidgetHierarchy(){const t=[];this._collectWidgetHierarchy("",t),console.log(t.join("\n"))}_collectWidgetHierarchy(t,e){e.push(t+"["+this.element.className+"]"+(this._children.length?" {":""));for(let i=0;i<this._children.length;++i)this._children[i]._collectWidgetHierarchy(t+"    ",e);this._children.length&&e.push(t+"}")}setDefaultFocusedElement(t){this._defaultFocusedElement=t}setDefaultFocusedChild(t){Widget.__assert(t._parentWidget===this,"Attempt to set non-child widget as default focused."),this._defaultFocusedChild=t}focus(){if(!this.isShowing())return;const t=this._defaultFocusedElement;if(t)t.hasFocus()||t.focus();else if(this._defaultFocusedChild&&this._defaultFocusedChild._visible)this._defaultFocusedChild.focus();else{for(const t of this._children)if(t._visible)return void t.focus();let t=this.contentElement.traverseNextNode(this.contentElement);for(;t;){if(t instanceof XWidget)return void t.focus();t=t.traverseNextNode(this.contentElement)}}}hasFocus(){return this.element.hasFocus()}calculateConstraints(){return new Constraints}constraints(){return void 0!==this._constraints?this._constraints:(void 0===this._cachedConstraints&&(this._cachedConstraints=this.calculateConstraints()),this._cachedConstraints)}setMinimumAndPreferredSizes(t,e,i,s){this._constraints=new Constraints(new Size(t,e),new Size(i,s)),this.invalidateConstraints()}setMinimumSize(t,e){this._constraints=new Constraints(new Size(t,e)),this.invalidateConstraints()}_hasNonZeroConstraints(){const t=this.constraints();return!!(t.minimum.width||t.minimum.height||t.preferred.width||t.preferred.height)}suspendInvalidations(){++this._invalidationsSuspended}resumeInvalidations(){--this._invalidationsSuspended,!this._invalidationsSuspended&&this._invalidationsRequested&&this.invalidateConstraints()}invalidateConstraints(){if(this._invalidationsSuspended)return void(this._invalidationsRequested=!0);this._invalidationsRequested=!1;const t=this._cachedConstraints;delete this._cachedConstraints;!this.constraints().isEqual(t)&&this._parentWidget?this._parentWidget.invalidateConstraints():this.doLayout()}markAsExternallyManaged(){Widget.__assert(!this._parentWidget,"Attempt to mark widget as externally managed after insertion to the DOM"),this._externallyManaged=!0}}export const _originalAppendChild=Element.prototype.appendChild;export const _originalInsertBefore=Element.prototype.insertBefore;export const _originalRemoveChild=Element.prototype.removeChild;export const _originalRemoveChildren=Element.prototype.removeChildren;export class VBox extends Widget{constructor(t,e){super(t,e),this.contentElement.classList.add("vbox")}calculateConstraints(){let t=new Constraints;return this._callOnVisibleChildren((function(){const e=this.constraints();t=t.widthToMax(e),t=t.addHeight(e)})),t}}export class HBox extends Widget{constructor(t){super(t),this.contentElement.classList.add("hbox")}calculateConstraints(){let t=new Constraints;return this._callOnVisibleChildren((function(){const e=this.constraints();t=t.addWidth(e),t=t.heightToMax(e)})),t}}export class VBoxWithResizeCallback extends VBox{constructor(t){super(),this._resizeCallback=t}onResize(){this._resizeCallback()}}export class WidgetFocusRestorer{constructor(t){this._widget=t,this._previous=t.element.ownerDocument.deepActiveElement(),t.focus()}restore(){this._widget&&(this._widget.hasFocus()&&this._previous&&this._previous.focus(),this._previous=null,this._widget=null)}}Element.prototype.appendChild=function(t){return Widget.__assert(!t.__widget||t.parentElement===this,"Attempt to add widget via regular DOM operation."),Widget._originalAppendChild.call(this,t)},Element.prototype.insertBefore=function(t,e){return Widget.__assert(!t.__widget||t.parentElement===this,"Attempt to add widget via regular DOM operation."),Widget._originalInsertBefore.call(this,t,e)},Element.prototype.removeChild=function(t){return Widget.__assert(!t.__widgetCounter&&!t.__widget,"Attempt to remove element containing widget via regular DOM operation"),Widget._originalRemoveChild.call(this,t)},Element.prototype.removeChildren=function(){Widget.__assert(!this.__widgetCounter,"Attempt to remove element containing widget via regular DOM operation"),Widget._originalRemoveChildren.call(this)},Widget._originalAppendChild=_originalAppendChild,Widget._originalInsertBefore=_originalInsertBefore,Widget._originalRemoveChild=_originalRemoveChild,Widget._originalRemoveChildren=_originalRemoveChildren;