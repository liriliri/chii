import*as Common from"../common/common.js";import*as Platform from"../platform/platform.js";import{Constraints}from"./Geometry.js";import{Events as ResizerWidgetEvents,SimpleResizerWidget}from"./ResizerWidget.js";import{ToolbarButton}from"./Toolbar.js";import{Widget}from"./Widget.js";import{Events as ZoomManagerEvents,ZoomManager}from"./ZoomManager.js";export class SplitWidget extends Widget{constructor(e,t,i,s,n,r){super(!0),this.element.classList.add("split-widget"),this.registerRequiredCSS("ui/splitWidget.css"),this.contentElement.classList.add("shadow-split-widget"),this._sidebarElement=this.contentElement.createChild("div","shadow-split-widget-contents shadow-split-widget-sidebar vbox"),this._mainElement=this.contentElement.createChild("div","shadow-split-widget-contents shadow-split-widget-main vbox"),this._mainElement.createChild("slot").name="insertion-point-main",this._sidebarElement.createChild("slot").name="insertion-point-sidebar",this._resizerElement=this.contentElement.createChild("div","shadow-split-widget-resizer"),this._resizerElementSize=null,this._resizerWidget=new SimpleResizerWidget,this._resizerWidget.setEnabled(!0),this._resizerWidget.addEventListener(ResizerWidgetEvents.ResizeStart,this._onResizeStart,this),this._resizerWidget.addEventListener(ResizerWidgetEvents.ResizeUpdate,this._onResizeUpdate,this),this._resizerWidget.addEventListener(ResizerWidgetEvents.ResizeEnd,this._onResizeEnd,this),this._defaultSidebarWidth=s||200,this._defaultSidebarHeight=n||this._defaultSidebarWidth,this._constraintsInDip=!!r,this._resizeStartSizeDIP=0,this._setting=i?Common.Settings.Settings.instance().createSetting(i,{}):null,this._totalSizeCSS=0,this._totalSizeOtherDimensionCSS=0,this._mainWidget=null,this._sidebarWidget=null,this._animationFrameHandle=0,this._animationCallback=null,this._showHideSidebarButtonTitle="",this._showHideSidebarButton=null,this._isVertical=!1,this._sidebarMinimized=!1,this._detaching=!1,this._sidebarSizeDIP=-1,this._savedSidebarSizeDIP=this._sidebarSizeDIP,this._secondIsSidebar=!1,this._shouldSaveShowMode=!1,this._savedVerticalMainSize=null,this._savedHorizontalMainSize=null,this.setSecondIsSidebar(t),this._innerSetVertical(e),this._showMode=ShowMode.Both,this._savedShowMode=this._showMode,this.installResizer(this._resizerElement)}isVertical(){return this._isVertical}setVertical(e){this._isVertical!==e&&(this._innerSetVertical(e),this.isShowing()&&this._updateLayout())}_innerSetVertical(e){this.contentElement.classList.toggle("vbox",!e),this.contentElement.classList.toggle("hbox",e),this._isVertical=e,this._resizerElementSize=null,this._sidebarSizeDIP=-1,this._restoreSidebarSizeFromSettings(),this._shouldSaveShowMode&&this._restoreAndApplyShowModeFromSettings(),this._updateShowHideSidebarButton(),this._resizerWidget.setVertical(!e),this.invalidateConstraints()}_updateLayout(e){this._totalSizeCSS=0,this._totalSizeOtherDimensionCSS=0,this._mainElement.style.removeProperty("width"),this._mainElement.style.removeProperty("height"),this._sidebarElement.style.removeProperty("width"),this._sidebarElement.style.removeProperty("height"),this._innerSetSidebarSizeDIP(this._preferredSidebarSizeDIP(),!!e)}setMainWidget(e){this._mainWidget!==e&&(this.suspendInvalidations(),this._mainWidget&&this._mainWidget.detach(),this._mainWidget=e,e&&(e.element.slot="insertion-point-main",this._showMode!==ShowMode.OnlyMain&&this._showMode!==ShowMode.Both||e.show(this.element)),this.resumeInvalidations())}setSidebarWidget(e){this._sidebarWidget!==e&&(this.suspendInvalidations(),this._sidebarWidget&&this._sidebarWidget.detach(),this._sidebarWidget=e,e&&(e.element.slot="insertion-point-sidebar",this._showMode!==ShowMode.OnlySidebar&&this._showMode!==ShowMode.Both||e.show(this.element)),this.resumeInvalidations())}mainWidget(){return this._mainWidget}sidebarWidget(){return this._sidebarWidget}childWasDetached(e){this._detaching||(this._mainWidget===e&&(this._mainWidget=null),this._sidebarWidget===e&&(this._sidebarWidget=null),this.invalidateConstraints())}isSidebarSecond(){return this._secondIsSidebar}enableShowModeSaving(){this._shouldSaveShowMode=!0,this._restoreAndApplyShowModeFromSettings()}showMode(){return this._showMode}setSecondIsSidebar(e){e!==this._secondIsSidebar&&(this._secondIsSidebar=e,this._mainWidget&&this._mainWidget.shouldHideOnDetach()?this._sidebarWidget&&this._sidebarWidget.shouldHideOnDetach()?(console.error("Could not swap split widget side. Both children widgets contain iframes."),this._secondIsSidebar=!e):e?this.contentElement.insertBefore(this._sidebarElement,this._resizerElement):this.contentElement.insertBefore(this._sidebarElement,this._mainElement):e?this.contentElement.insertBefore(this._mainElement,this._sidebarElement):this.contentElement.insertBefore(this._mainElement,this._resizerElement))}sidebarSide(){return this._showMode!==ShowMode.Both?null:this._isVertical?this._secondIsSidebar?"right":"left":this._secondIsSidebar?"bottom":"top"}resizerElement(){return this._resizerElement}hideMain(e){this._showOnly(this._sidebarWidget,this._mainWidget,this._sidebarElement,this._mainElement,e),this._updateShowMode(ShowMode.OnlySidebar)}hideSidebar(e){this._showOnly(this._mainWidget,this._sidebarWidget,this._mainElement,this._sidebarElement,e),this._updateShowMode(ShowMode.OnlyMain)}setSidebarMinimized(e){this._sidebarMinimized=e,this.invalidateConstraints()}isSidebarMinimized(){return this._sidebarMinimized}_showOnly(e,t,i,s,n){function r(){e&&(e===this._mainWidget?this._mainWidget.show(this.element,this._sidebarWidget?this._sidebarWidget.element:null):this._sidebarWidget.show(this.element)),t&&(this._detaching=!0,t.detach(),this._detaching=!1),this._resizerElement.classList.add("hidden"),i.classList.remove("hidden"),i.classList.add("maximized"),s.classList.add("hidden"),s.classList.remove("maximized"),this._removeAllLayoutProperties(),this.doResize(),this._showFinishedForTest()}this._cancelAnimation(),n?this._animate(!0,r.bind(this)):r.call(this),this._sidebarSizeDIP=-1,this.setResizable(!1)}_showFinishedForTest(){}_removeAllLayoutProperties(){this._sidebarElement.style.removeProperty("flexBasis"),this._mainElement.style.removeProperty("width"),this._mainElement.style.removeProperty("height"),this._sidebarElement.style.removeProperty("width"),this._sidebarElement.style.removeProperty("height"),this._resizerElement.style.removeProperty("left"),this._resizerElement.style.removeProperty("right"),this._resizerElement.style.removeProperty("top"),this._resizerElement.style.removeProperty("bottom"),this._resizerElement.style.removeProperty("margin-left"),this._resizerElement.style.removeProperty("margin-right"),this._resizerElement.style.removeProperty("margin-top"),this._resizerElement.style.removeProperty("margin-bottom")}showBoth(e){this._showMode===ShowMode.Both&&(e=!1),this._cancelAnimation(),this._mainElement.classList.remove("maximized","hidden"),this._sidebarElement.classList.remove("maximized","hidden"),this._resizerElement.classList.remove("hidden"),this.setResizable(!0),this.suspendInvalidations(),this._sidebarWidget&&this._sidebarWidget.show(this.element),this._mainWidget&&this._mainWidget.show(this.element,this._sidebarWidget?this._sidebarWidget.element:null),this.resumeInvalidations(),this.setSecondIsSidebar(this._secondIsSidebar),this._sidebarSizeDIP=-1,this._updateShowMode(ShowMode.Both),this._updateLayout(e)}setResizable(e){this._resizerWidget.setEnabled(e)}isResizable(){return this._resizerWidget.isEnabled()}setSidebarSize(e){const t=ZoomManager.instance().cssToDIP(e);this._savedSidebarSizeDIP=t,this._saveSetting(),this._innerSetSidebarSizeDIP(t,!1,!0)}sidebarSize(){const e=Math.max(0,this._sidebarSizeDIP);return ZoomManager.instance().dipToCSS(e)}_totalSizeDIP(){return this._totalSizeCSS||(this._totalSizeCSS=this._isVertical?this.contentElement.offsetWidth:this.contentElement.offsetHeight,this._totalSizeOtherDimensionCSS=this._isVertical?this.contentElement.offsetHeight:this.contentElement.offsetWidth),ZoomManager.instance().cssToDIP(this._totalSizeCSS)}_updateShowMode(e){this._showMode=e,this._saveShowModeToSettings(),this._updateShowHideSidebarButton(),this.dispatchEventToListeners(Events.ShowModeChanged,e),this.invalidateConstraints()}_innerSetSidebarSizeDIP(e,t,i){if(this._showMode!==ShowMode.Both||!this.isShowing())return;if(e=this._applyConstraints(e,i),this._sidebarSizeDIP===e)return;this._resizerElementSize||(this._resizerElementSize=this._isVertical?this._resizerElement.offsetWidth:this._resizerElement.offsetHeight),this._removeAllLayoutProperties();const s=Math.round(ZoomManager.instance().dipToCSS(e)),n=s+"px",r=this._totalSizeCSS-s+"px";this._sidebarElement.style.flexBasis=n,this._isVertical?(this._sidebarElement.style.width=n,this._mainElement.style.width=r,this._sidebarElement.style.height=this._totalSizeOtherDimensionCSS+"px",this._mainElement.style.height=this._totalSizeOtherDimensionCSS+"px"):(this._sidebarElement.style.height=n,this._mainElement.style.height=r,this._sidebarElement.style.width=this._totalSizeOtherDimensionCSS+"px",this._mainElement.style.width=this._totalSizeOtherDimensionCSS+"px"),this._isVertical?this._secondIsSidebar?(this._resizerElement.style.right=n,this._resizerElement.style.marginRight=-this._resizerElementSize/2+"px"):(this._resizerElement.style.left=n,this._resizerElement.style.marginLeft=-this._resizerElementSize/2+"px"):this._secondIsSidebar?(this._resizerElement.style.bottom=n,this._resizerElement.style.marginBottom=-this._resizerElementSize/2+"px"):(this._resizerElement.style.top=n,this._resizerElement.style.marginTop=-this._resizerElementSize/2+"px"),this._sidebarSizeDIP=e,t?this._animate(!1):(this.doResize(),this.dispatchEventToListeners(Events.SidebarSizeChanged,this.sidebarSize()))}_animate(e,t){let i;this._animationCallback=t||null,i=this._isVertical?this._secondIsSidebar?"margin-right":"margin-left":this._secondIsSidebar?"margin-bottom":"margin-top";const s=e?"0":"-"+ZoomManager.instance().dipToCSS(this._sidebarSizeDIP)+"px",n=e?"-"+ZoomManager.instance().dipToCSS(this._sidebarSizeDIP)+"px":"0";this.contentElement.style.setProperty(i,s),e||(suppressUnused(this._mainElement.offsetWidth),suppressUnused(this._sidebarElement.offsetWidth)),e||this._sidebarWidget.doResize(),this.contentElement.style.setProperty("transition",i+" 50ms linear");const r=function(){if(this._animationFrameHandle=0,a){if(!(window.performance.now()<a+50))return this._cancelAnimation(),this._mainWidget&&this._mainWidget.doResize(),void this.dispatchEventToListeners(Events.SidebarSizeChanged,this.sidebarSize());this._mainWidget&&this._mainWidget.doResize()}else this.contentElement.style.setProperty(i,n),a=window.performance.now();this._animationFrameHandle=this.contentElement.window().requestAnimationFrame(r)}.bind(this);let a;this._animationFrameHandle=this.contentElement.window().requestAnimationFrame(r)}_cancelAnimation(){this.contentElement.style.removeProperty("margin-top"),this.contentElement.style.removeProperty("margin-right"),this.contentElement.style.removeProperty("margin-bottom"),this.contentElement.style.removeProperty("margin-left"),this.contentElement.style.removeProperty("transition"),this._animationFrameHandle&&(this.contentElement.window().cancelAnimationFrame(this._animationFrameHandle),this._animationFrameHandle=0),this._animationCallback&&(this._animationCallback(),this._animationCallback=null)}_applyConstraints(e,t){const i=this._totalSizeDIP(),s=this._constraintsInDip?1:ZoomManager.instance().zoomFactor();let n=this._sidebarWidget?this._sidebarWidget.constraints():new Constraints,r=this.isVertical()?n.minimum.width:n.minimum.height;r||(r=MinPadding),r*=s,this._sidebarMinimized&&(e=r);let a=this.isVertical()?n.preferred.width:n.preferred.height;a||(a=MinPadding),a*=s,e<a&&(a=Math.max(e,r)),a+=s,n=this._mainWidget?this._mainWidget.constraints():new Constraints;let h=this.isVertical()?n.minimum.width:n.minimum.height;h||(h=MinPadding),h*=s;let o=this.isVertical()?n.preferred.width:n.preferred.height;o||(o=MinPadding),o*=s;const d=this.isVertical()?this._savedVerticalMainSize:this._savedHorizontalMainSize;null!==d&&(o=Math.min(o,d*s)),t&&(o=h);const l=o+a;if(l<=i)return Platform.NumberUtilities.clamp(e,a,i-o);if(h+r<=i){return e=a-(l-i)*a/l,Platform.NumberUtilities.clamp(e,r,i-h)}return Math.max(0,i-h)}wasShown(){this._forceUpdateLayout(),ZoomManager.instance().addEventListener(ZoomManagerEvents.ZoomChanged,this._onZoomChanged,this)}willHide(){ZoomManager.instance().removeEventListener(ZoomManagerEvents.ZoomChanged,this._onZoomChanged,this)}onResize(){this._updateLayout()}onLayout(){this._updateLayout()}calculateConstraints(){if(this._showMode===ShowMode.OnlyMain)return this._mainWidget?this._mainWidget.constraints():new Constraints;if(this._showMode===ShowMode.OnlySidebar)return this._sidebarWidget?this._sidebarWidget.constraints():new Constraints;let e=this._mainWidget?this._mainWidget.constraints():new Constraints,t=this._sidebarWidget?this._sidebarWidget.constraints():new Constraints;const i=MinPadding;return this._isVertical?(e=e.widthToMax(i).addWidth(1),t=t.widthToMax(i),e.addWidth(t).heightToMax(t)):(e=e.heightToMax(i).addHeight(1),t=t.heightToMax(i),e.widthToMax(t).addHeight(t))}_onResizeStart(e){this._resizeStartSizeDIP=this._sidebarSizeDIP}_onResizeUpdate(e){const t=e.data.currentPosition-e.data.startPosition,i=ZoomManager.instance().cssToDIP(t),s=this._secondIsSidebar?this._resizeStartSizeDIP-i:this._resizeStartSizeDIP+i,n=this._applyConstraints(s,!0);this._savedSidebarSizeDIP=n,this._saveSetting(),this._innerSetSidebarSizeDIP(n,!1,!0),this.isVertical()?this._savedVerticalMainSize=this._totalSizeDIP()-this._sidebarSizeDIP:this._savedHorizontalMainSize=this._totalSizeDIP()-this._sidebarSizeDIP}_onResizeEnd(e){this._resizeStartSizeDIP=0}hideDefaultResizer(e){this.uninstallResizer(this._resizerElement),this._sidebarElement.classList.toggle("no-default-splitter",!!e)}installResizer(e){this._resizerWidget.addElement(e)}uninstallResizer(e){this._resizerWidget.removeElement(e)}hasCustomResizer(){const e=this._resizerWidget.elements();return e.length>1||1===e.length&&e[0]!==this._resizerElement}toggleResizer(e,t){t?this.installResizer(e):this.uninstallResizer(e)}_settingForOrientation(){const e=this._setting?this._setting.get():{};return this._isVertical?e.vertical:e.horizontal}_preferredSidebarSizeDIP(){let e=this._savedSidebarSizeDIP;return e||(e=this._isVertical?this._defaultSidebarWidth:this._defaultSidebarHeight,0<e&&e<1&&(e*=this._totalSizeDIP())),e}_restoreSidebarSizeFromSettings(){const e=this._settingForOrientation();this._savedSidebarSizeDIP=e?e.size:0}_restoreAndApplyShowModeFromSettings(){const e=this._settingForOrientation();switch(this._savedShowMode=e&&e.showMode?e.showMode:this._showMode,this._showMode=this._savedShowMode,this._savedShowMode){case ShowMode.Both:this.showBoth();break;case ShowMode.OnlyMain:this.hideSidebar();break;case ShowMode.OnlySidebar:this.hideMain()}}_saveShowModeToSettings(){this._savedShowMode=this._showMode,this._saveSetting()}_saveSetting(){if(!this._setting)return;const e=this._setting.get(),t=(this._isVertical?e.vertical:e.horizontal)||{};t.size=this._savedSidebarSizeDIP,this._shouldSaveShowMode&&(t.showMode=this._savedShowMode),this._isVertical?e.vertical=t:e.horizontal=t,this._setting.set(e)}_forceUpdateLayout(){this._sidebarSizeDIP=-1,this._updateLayout()}_onZoomChanged(e){this._forceUpdateLayout()}createShowHideSidebarButton(e){return this._showHideSidebarButtonTitle=e,this._showHideSidebarButton=new ToolbarButton("",""),this._showHideSidebarButton.addEventListener(ToolbarButton.Events.Click,(function(e){this._showMode!==ShowMode.Both?this.showBoth(!0):this.hideSidebar(!0)}),this),this._updateShowHideSidebarButton(),this._showHideSidebarButton}_updateShowHideSidebarButton(){if(!this._showHideSidebarButton)return;const e=this._showMode===ShowMode.OnlyMain;let t="";t=e?this.isVertical()?this.isSidebarSecond()?"largeicon-show-right-sidebar":"largeicon-show-left-sidebar":this.isSidebarSecond()?"largeicon-show-bottom-sidebar":"largeicon-show-top-sidebar":this.isVertical()?this.isSidebarSecond()?"largeicon-hide-right-sidebar":"largeicon-hide-left-sidebar":this.isSidebarSecond()?"largeicon-hide-bottom-sidebar":"largeicon-hide-top-sidebar",this._showHideSidebarButton.setGlyph(t),this._showHideSidebarButton.setTitle(e?Common.UIString.UIString("Show %s",this._showHideSidebarButtonTitle):Common.UIString.UIString("Hide %s",this._showHideSidebarButtonTitle))}}export const ShowMode={Both:"Both",OnlyMain:"OnlyMain",OnlySidebar:"OnlySidebar"};export const Events={SidebarSizeChanged:Symbol("SidebarSizeChanged"),ShowModeChanged:Symbol("ShowModeChanged")};const MinPadding=20;export let SettingForOrientation;