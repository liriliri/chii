import*as ARIAUtils from"./ARIAUtils.js";import{Size}from"./Geometry.js";import{AnchorBehavior,GlassPane}from"./GlassPane.js";import{Icon}from"./Icon.js";import{ListControl,ListDelegate,ListMode}from"./ListControl.js";import{ListModel}from"./ListModel.js";import{measurePreferredSize}from"./UIUtils.js";import{createShadowRootWithCoreStyles}from"./utils/create-shadow-root-with-core-styles.js";import{measuredScrollbarWidth}from"./utils/measured-scrollbar-width.js";export class SuggestBoxDelegate{applySuggestion(e,t){}acceptSuggestion(){}}export class SuggestBox{constructor(e,t){this._suggestBoxDelegate=e,this._maxItemsHeight=t,this._rowHeight=17,this._userEnteredText="",this._defaultSelectionIsDimmed=!1,this._onlyCompletion=null,this._items=new ListModel,this._list=new ListControl(this._items,this,ListMode.EqualHeightItems),this._element=this._list.element,this._element.classList.add("suggest-box"),this._element.addEventListener("mousedown",e=>e.preventDefault(),!0),this._element.addEventListener("click",this._onClick.bind(this),!1),this._glassPane=new GlassPane,this._glassPane.setAnchorBehavior(AnchorBehavior.PreferBottom),this._glassPane.setOutsideClickCallback(this.hide.bind(this));createShadowRootWithCoreStyles(this._glassPane.contentElement,"ui/suggestBox.css").appendChild(this._element)}visible(){return this._glassPane.isShowing()}setPosition(e){this._glassPane.setContentAnchorBox(e)}setAnchorBehavior(e){this._glassPane.setAnchorBehavior(e)}_updateMaxSize(e){const t=this._maxWidth(e),s=(this._maxItemsHeight?Math.min(this._maxItemsHeight,e.length):e.length)*this._rowHeight;this._glassPane.setMaxContentSize(new Size(t,s))}_maxWidth(e){if(!e.length)return 300;let t,s=-1/0;for(let i=0;i<e.length;i++){const n=(e[i].title||e[i].text).length+(e[i].subtitle||"").length;n>s&&(s=n,t=e[i])}const i=this.createElementForItem(t),n=measurePreferredSize(i,this._element).width+measuredScrollbarWidth(this._element.ownerDocument);return Math.min(300,n)}_show(){this.visible()||(this._glassPane.show(document),this._rowHeight=measurePreferredSize(this.createElementForItem({text:"1",subtitle:"12"}),this._element).height)}hide(){this.visible()&&this._glassPane.hide()}_applySuggestion(e){if(this._onlyCompletion)return ARIAUtils.alert(ls`${this._onlyCompletion.text}, suggestion`,this._element),this._suggestBoxDelegate.applySuggestion(this._onlyCompletion,e),!0;const t=this._list.selectedItem();return t&&t.text&&ARIAUtils.alert(ls`${t.title||t.text}, suggestion`,this._element),this._suggestBoxDelegate.applySuggestion(t,e),this.visible()&&!!t}acceptSuggestion(){const e=this._applySuggestion();return this.hide(),!!e&&(this._suggestBoxDelegate.acceptSuggestion(),!0)}createElementForItem(e){const t=this._userEnteredText,s=createElementWithClass("div","suggest-box-content-item source-code");if(e.iconType){const t=Icon.create(e.iconType,"suggestion-icon");s.appendChild(t)}e.isSecondary&&s.classList.add("secondary"),s.tabIndex=-1;const i=50+t.length,n=(e.title||e.text).trim().trimEndWithMaxLength(i).replace(/\n/g,"â†µ"),o=s.createChild("span","suggestion-title"),l=n.toLowerCase().indexOf(t.toLowerCase());if(l>0&&(o.createChild("span").textContent=n.substring(0,l)),l>-1&&(o.createChild("span","query").textContent=n.substring(l,l+t.length)),o.createChild("span").textContent=n.substring(l>-1?l+t.length:0),o.createChild("span","spacer"),e.subtitleRenderer){const t=e.subtitleRenderer.call(null);t.classList.add("suggestion-subtitle"),s.appendChild(t)}else if(e.subtitle){s.createChild("span","suggestion-subtitle").textContent=e.subtitle.trimEndWithMaxLength(i-n.length)}return s}heightForItem(e){return this._rowHeight}isItemSelectable(e){return!0}selectedItemChanged(e,t,s,i){s&&s.classList.remove("selected","force-white-icons"),i&&(i.classList.add("selected"),i.classList.add("force-white-icons")),this._applySuggestion(!0)}updateSelectedItemARIA(e,t){return!1}_onClick(e){const t=this._list.itemForNode(e.target);t&&(this._list.selectItem(t),this.acceptSuggestion(),e.consume(!0))}_canShowBox(e,t,s,i){return!(!e||!e.length)&&(e.length>1||(!(t&&!t.isSecondary&&t.text.startsWith(i))||s&&t.text!==i))}updateSuggestions(e,t,s,i,n){this._onlyCompletion=null;const o=s?t.reduce((e,t)=>(e.priority||0)>=(t.priority||0)?e:t):null;this._canShowBox(t,o,i,n)?(this._userEnteredText=n,this._show(),this._updateMaxSize(t),this._glassPane.setContentAnchorBox(e),this._list.invalidateItemHeight(),this._items.replaceAll(t),o&&!o.isSecondary?this._list.selectItem(o,!0):this._list.selectItem(null)):(1===t.length&&(this._onlyCompletion=t[0],this._applySuggestion(!0)),this.hide())}keyPressed(e){switch(e.key){case"Enter":return this.enterKeyPressed();case"ArrowUp":return this._list.selectPreviousItem(!0,!1);case"ArrowDown":return this._list.selectNextItem(!0,!1);case"PageUp":return this._list.selectItemPreviousPage(!1);case"PageDown":return this._list.selectItemNextPage(!1)}return!1}enterKeyPressed(){const e=!!this._list.selectedItem()||!!this._onlyCompletion;return this.acceptSuggestion(),e}}export let Suggestion;export let Suggestions;export let AutocompleteConfig;