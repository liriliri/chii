import*as Bindings from"../bindings/bindings.js";import*as Common from"../common/common.js";import*as Host from"../host/host.js";import*as SDK from"../sdk/sdk.js";import*as TextUtils from"../text_utils/text_utils.js";import*as UI from"../ui/ui.js";import*as Workspace from"../workspace/workspace.js";export class Linkifier{constructor(e,t){this._maxLength=e||UI.UIUtils.MaxLengthForDisplayedURLs,this._anchorsByTarget=new Map,this._locationPoolByTarget=new Map,this._useLinkDecorator=!!t,_instances.add(this),SDK.SDKModel.TargetManager.instance().observeTargets(this)}static setLinkDecorator(e){console.assert(!_decorator,"Cannot re-register link decorator."),_decorator=e,e.addEventListener(LinkDecorator.Events.LinkIconChanged,(function(e){const t=e.data[_sourceCodeAnchors]||[];for(const e of t)Linkifier._updateLinkDecorations(e)}));for(const e of _instances)e._updateAllAnchorDecorations()}_updateAllAnchorDecorations(){for(const e of this._anchorsByTarget.values())for(const t of e)Linkifier._updateLinkDecorations(t)}static _bindUILocation(e,t){if(Linkifier._linkInfo(e).uiLocation=t,!t)return;const n=t.uiSourceCode;let i=n[_sourceCodeAnchors];i||(i=new Set,n[_sourceCodeAnchors]=i),i.add(e)}static _unbindUILocation(e){const t=Linkifier._linkInfo(e);if(!t.uiLocation)return;const n=t.uiLocation.uiSourceCode;t.uiLocation=null;const i=n[_sourceCodeAnchors];i&&i.delete(e)}targetAdded(e){this._anchorsByTarget.set(e,[]),this._locationPoolByTarget.set(e,new Bindings.LiveLocation.LiveLocationPool)}targetRemoved(e){const t=this._locationPoolByTarget.get(e);this._locationPoolByTarget.delete(e),t.disposeAll();const n=this._anchorsByTarget.get(e);this._anchorsByTarget.delete(e);for(const e of n){const t=Linkifier._linkInfo(e);t.liveLocation=null,Linkifier._unbindUILocation(e),t.fallback&&(e.href=t.fallback.href,e.title=t.fallback.title,e.className=t.fallback.className,e.textContent=t.fallback.textContent,e[_infoSymbol]=t.fallback[_infoSymbol])}}maybeLinkifyScriptLocation(e,t,n,i,o){const r={className:"",columnNumber:0,...o},{columnNumber:s,className:a}=r;let l=null;if(n&&(l=Linkifier.linkifyURL(n,{lineNumber:i,maxLength:this._maxLength,...o})),!e||e.isDisposed())return l;const c=e.model(SDK.DebuggerModel.DebuggerModel);if(!c)return l;let d;if(t&&(d=c.createRawLocationByScriptId(t,i,s)),d||(d=c.createRawLocationByURL(n,i,s)),!d)return l;const u=Linkifier._createLink("​",a,o),k=Linkifier._linkInfo(u);k.enableDecorator=this._useLinkDecorator,k.fallback=l;const L=this._locationPoolByTarget.get(d.debuggerModel.target());Bindings.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance().createLiveLocation(d,this._updateAnchor.bind(this,u),L).then(e=>{k.liveLocation=e});return this._anchorsByTarget.get(d.debuggerModel.target()).push(u),u}linkifyScriptLocation(e,t,n,i,o){return this.maybeLinkifyScriptLocation(e,t,n,i,o)||Linkifier.linkifyURL(n,{lineNumber:i,maxLength:this._maxLength,...o})}linkifyRawLocation(e,t,n){return this.linkifyScriptLocation(e.debuggerModel.target(),e.scriptId,t,e.lineNumber,{columnNumber:e.columnNumber,className:n})}maybeLinkifyConsoleCallFrame(e,t,n){return this.maybeLinkifyScriptLocation(e,t.scriptId,t.url,t.lineNumber,{columnNumber:t.columnNumber,...n})}linkifyStackTraceTopFrame(e,t,n){console.assert(t.callFrames&&t.callFrames.length);const i=t.callFrames[0],o=Linkifier.linkifyURL(i.url,{className:n,lineNumber:i.lineNumber,columnNumber:i.columnNumber,maxLength:this._maxLength});if(e.isDisposed())return o;const r=e.model(SDK.DebuggerModel.DebuggerModel).createRawLocationsByStackTrace(t);if(0===r.length)return o;const s=Linkifier._createLink("​",n||""),a=Linkifier._linkInfo(s);a.enableDecorator=this._useLinkDecorator,a.fallback=o;const l=this._locationPoolByTarget.get(e);Bindings.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance().createStackTraceTopFrameLiveLocation(r,this._updateAnchor.bind(this,s),l).then(e=>{a.liveLocation=e});return this._anchorsByTarget.get(e).push(s),s}linkifyCSSLocation(e,t){const n=Linkifier._createLink("​",t||""),i=Linkifier._linkInfo(n);i.enableDecorator=this._useLinkDecorator;const o=this._locationPoolByTarget.get(e.cssModel().target());Bindings.CSSWorkspaceBinding.CSSWorkspaceBinding.instance().createLiveLocation(e,this._updateAnchor.bind(this,n),o).then(e=>{i.liveLocation=e});return this._anchorsByTarget.get(e.cssModel().target()).push(n),n}reset(){for(const e of[...this._anchorsByTarget.keys()])this.targetRemoved(e),this.targetAdded(e)}dispose(){for(const e of[...this._anchorsByTarget.keys()])this.targetRemoved(e);SDK.SDKModel.TargetManager.instance().unobserveTargets(this),_instances.delete(this)}async _updateAnchor(e,t){Linkifier._unbindUILocation(e);const n=await t.uiLocation();if(!n)return;Linkifier._bindUILocation(e,n);const i=n.linkText(!0);Linkifier._setTrimmedText(e,i,this._maxLength);let o=n.uiSourceCode.url();"number"==typeof n.lineNumber&&(o+=":"+(n.lineNumber+1)),e.title=o,e.classList.toggle("webkit-html-blackbox-link",await t.isBlackboxed()),Linkifier._updateLinkDecorations(e)}static _updateLinkDecorations(e){const t=Linkifier._linkInfo(e);if(!t||!t.enableDecorator)return;if(!_decorator||!t.uiLocation)return;t.icon&&t.icon.parentElement&&e.removeChild(t.icon);const n=_decorator.linkIcon(t.uiLocation.uiSourceCode);n&&(n.style.setProperty("margin-right","2px"),e.insertBefore(n,e.firstChild)),t.icon=n}static linkifyURL(e,t){const n=(t=t||{}).text,i=t.className||"",o=t.lineNumber,r=t.columnNumber,s=t.preventClick,a=t.maxLength||UI.UIUtils.MaxLengthForDisplayedURLs,l=t.bypassURLTrimming;if(!e||e.trim().toLowerCase().startsWith("javascript:")){const t=createElementWithClass("span",i);return t.textContent=n||e||Common.UIString.UIString("(unknown)"),t}let c=n||Bindings.ResourceUtils.displayNameForURL(e);"number"!=typeof o||n||(c+=":"+(o+1));const d={maxLength:a,title:c!==e?e:"",href:e,preventClick:s,tabStop:t.tabStop,bypassURLTrimming:l},u=Linkifier._createLink(c,i,d),k=Linkifier._linkInfo(u);return"number"==typeof o&&(k.lineNumber=o),"number"==typeof r&&(k.columnNumber=r),u}static linkifyRevealable(e,t,n){const i=Linkifier._createLink(t,"",{maxLength:UI.UIUtils.MaxLengthForDisplayedURLs,href:n});return Linkifier._linkInfo(i).revealable=e,i}static _createLink(e,t,n){n=n||{};const{maxLength:i,title:o,href:r,preventClick:s,tabStop:a,bypassURLTrimming:l}=n,c=createElementWithClass("span",t);return c.classList.add("devtools-link"),o&&(c.title=o),r&&(c.href=r),l?(c.classList.add("devtools-link-styled-trim"),Linkifier._appendTextWithoutHashes(c,e)):Linkifier._setTrimmedText(c,e,i),c[_infoSymbol]={icon:null,enableDecorator:!1,uiLocation:null,liveLocation:null,url:r||null,lineNumber:null,columnNumber:null,revealable:null,fallback:null},s?c.classList.add("devtools-link-prevent-click"):(c.addEventListener("click",e=>{Linkifier._handleClick(e)&&e.consume(!0)},!1),c.addEventListener("keydown",e=>{isEnterKey(e)&&Linkifier._handleClick(e)&&e.consume(!0)},!1)),UI.ARIAUtils.markAsLink(c),c.tabIndex=a?0:-1,c}static _setTrimmedText(e,t,n){if(e.removeChildren(),n&&t.length>n){const i=function(e,t){let n=Math.floor(t/2),i=e.length-Math.ceil(t/2)+1;e.codePointAt(i-1)>=65536&&(i++,n++);n>0&&e.codePointAt(n-1)>=65536&&n--;return[e.substring(0,n),e.substring(n,i),e.substring(i)]}(t,n);Linkifier._appendTextWithoutHashes(e,i[0]),Linkifier._appendHiddenText(e,i[1]),Linkifier._appendTextWithoutHashes(e,i[2])}else Linkifier._appendTextWithoutHashes(e,t)}static _appendTextWithoutHashes(e,t){const n=TextUtils.TextUtils.Utils.splitStringByRegexes(t,[/[a-f0-9]{20,}/g]);for(const t of n)-1===t.regexIndex?e.createTextChild(t.value):(e.createTextChild(t.value.substring(0,7)),Linkifier._appendHiddenText(e,t.value.substring(7)))}static _appendHiddenText(e,t){e.createChild("span","devtools-link-ellipsis").createTextChild("…")[_untruncatedNodeTextSymbol]=t}static untruncatedNodeText(e){return e[_untruncatedNodeTextSymbol]||e.textContent}static _linkInfo(e){return e&&e[_infoSymbol]||null}static _handleClick(e){const t=e.currentTarget;return!UI.UIUtils.isBeingEdited(e.target)&&!t.hasSelection()&&Linkifier.invokeFirstAction(t)}static invokeFirstAction(e){const t=Linkifier._linkActions(e);return!!t.length&&(t[0].handler.call(null),!0)}static _linkHandlerSetting(){return Linkifier._linkHandlerSettingInstance||(Linkifier._linkHandlerSettingInstance=Common.Settings.Settings.instance().createSetting("openLinkHandler",ls`auto`)),Linkifier._linkHandlerSettingInstance}static registerLinkHandler(e,t){_linkHandlers.set(e,t),self.runtime.sharedInstance(LinkHandlerSettingUI)._update()}static unregisterLinkHandler(e){_linkHandlers.delete(e),self.runtime.sharedInstance(LinkHandlerSettingUI)._update()}static uiLocation(e){const t=Linkifier._linkInfo(e);return t?t.uiLocation:null}static _linkActions(e){const t=Linkifier._linkInfo(e),n=[];if(!t)return n;let i="",o=null;if(t.uiLocation)o=t.uiLocation,i=o.uiSourceCode.contentURL();else if(t.url){i=t.url;const e=Workspace.Workspace.WorkspaceImpl.instance().uiSourceCodeForURL(i)||Workspace.Workspace.WorkspaceImpl.instance().uiSourceCodeForURL(Common.ParsedURL.ParsedURL.urlWithoutHash(i));o=e?e.uiLocation(t.lineNumber||0,t.columnNumber||0):null}const r=i?Bindings.ResourceUtils.resourceForURL(i):null,s=o?o.uiSourceCode:r,a=t.revealable||o||r;if(a){const e=Common.Revealer.revealDestination(a);n.push({section:"reveal",title:e?ls`Reveal in ${e}`:ls`Reveal`,handler:()=>Common.Revealer.reveal(a)})}if(s){const e=o?o.lineNumber:t.lineNumber||0;for(const t of _linkHandlers.keys()){const i=_linkHandlers.get(t),o={section:"reveal",title:Common.UIString.UIString("Open using %s",t),handler:i.bind(null,s,e)};t===Linkifier._linkHandlerSetting().get()?n.unshift(o):n.push(o)}}return(r||t.url)&&(n.push({section:"reveal",title:UI.UIUtils.openLinkExternallyLabel(),handler:()=>Host.InspectorFrontendHost.InspectorFrontendHostInstance.openInNewTab(i)}),n.push({section:"clipboard",title:UI.UIUtils.copyLinkAddressLabel(),handler:()=>Host.InspectorFrontendHost.InspectorFrontendHostInstance.copyText(i)})),n}}const _instances=new Set;let _decorator=null;const _sourceCodeAnchors=Symbol("Linkifier.anchors"),_infoSymbol=Symbol("Linkifier.info"),_untruncatedNodeTextSymbol=Symbol("Linkifier.untruncatedNodeText"),_linkHandlers=new Map;export class LinkDecorator{linkIcon(e){}}LinkDecorator.Events={LinkIconChanged:Symbol("LinkIconChanged")};export class LinkContextMenuProvider{appendApplicableItems(e,t,n){let i=n;for(;i&&!i[_infoSymbol];)i=i.parentNodeOrShadowHost();const o=i,r=Linkifier._linkActions(o);for(const e of r)t.section(e.section).appendItem(e.title,e.handler)}}export class LinkHandlerSettingUI{constructor(){this._element=createElementWithClass("select","chrome-select"),this._element.addEventListener("change",this._onChange.bind(this),!1),this._update()}_update(){this._element.removeChildren();const e=[..._linkHandlers.keys()];e.unshift(Common.UIString.UIString("auto"));for(const t of e){const e=createElement("option");e.textContent=t,e.selected=t===Linkifier._linkHandlerSetting().get(),this._element.appendChild(e)}this._element.disabled=e.length<=1}_onChange(e){const t=e.target.value;Linkifier._linkHandlerSetting().set(t)}settingElement(){return UI.SettingsUI.createCustomSetting(Common.UIString.UIString("Link handling:"),this._element)}}export class ContentProviderContextMenuProvider{appendApplicableItems(e,t,n){const i=n;if(i.contentURL()){t.revealSection().appendItem(UI.UIUtils.openLinkExternallyLabel(),()=>Host.InspectorFrontendHost.InspectorFrontendHostInstance.openInNewTab(i.contentURL()));for(const e of _linkHandlers.keys()){const n=_linkHandlers.get(e);t.revealSection().appendItem(Common.UIString.UIString("Open using %s",e),n.bind(null,i,0))}i instanceof SDK.NetworkRequest.NetworkRequest||t.clipboardSection().appendItem(UI.UIUtils.copyLinkAddressLabel(),()=>Host.InspectorFrontendHost.InspectorFrontendHostInstance.copyText(i.contentURL()))}}}export let _LinkInfo;export let LinkifyURLOptions;export let LinkifyOptions;export let _CreateLinkOptions;export let LinkHandler;