import*as Common from"../common/common.js";import*as SDK from"../sdk/sdk.js";import*as UI from"../ui/ui.js";export class LayerTreeModel extends SDK.SDKModel.SDKModel{constructor(e){super(e),this._layerTreeAgent=e.layerTreeAgent(),e.registerLayerTreeDispatcher(new LayerTreeDispatcher(this)),this._paintProfilerModel=e.model(SDK.PaintProfiler.PaintProfilerModel);const t=e.model(SDK.ResourceTreeModel.ResourceTreeModel);t&&t.addEventListener(SDK.ResourceTreeModel.Events.MainFrameNavigated,this._onMainFrameNavigated,this),this._layerTree=null,this._throttler=new Common.Throttler.Throttler(20)}disable(){this._enabled&&(this._enabled=!1,this._layerTreeAgent.disable())}enable(){this._enabled||(this._enabled=!0,this._forceEnable())}_forceEnable(){this._lastPaintRectByLayerId={},this._layerTree||(this._layerTree=new AgentLayerTree(this)),this._layerTreeAgent.enable()}layerTree(){return this._layerTree}async _layerTreeChanged(e){this._enabled&&this._throttler.schedule(this._innerSetLayers.bind(this,e))}async _innerSetLayers(e){const t=this._layerTree;await t.setLayers(e);for(const e in this._lastPaintRectByLayerId){const r=this._lastPaintRectByLayerId[e],a=t.layerById(e);a&&(a._lastPaintRect=r)}this._lastPaintRectByLayerId={},this.dispatchEventToListeners(Events.LayerTreeChanged)}_layerPainted(e,t){if(!this._enabled)return;const r=this._layerTree.layerById(e);r?(r._didPaint(t),this.dispatchEventToListeners(Events.LayerPainted,r)):this._lastPaintRectByLayerId[e]=t}_onMainFrameNavigated(){this._layerTree=null,this._enabled&&this._forceEnable()}}SDK.SDKModel.SDKModel.register(LayerTreeModel,SDK.SDKModel.Capability.DOM,!1);export const Events={LayerTreeChanged:Symbol("LayerTreeChanged"),LayerPainted:Symbol("LayerPainted")};export class AgentLayerTree extends SDK.LayerTreeBase.LayerTreeBase{constructor(e){super(e.target()),this._layerTreeModel=e}async setLayers(e){if(!e)return void this._innerSetLayers(e);const t=new Set;for(let r=0;r<e.length;++r){const a=e[r].backendNodeId;a&&!this.backendNodeIdToNode().has(a)&&t.add(a)}await this.resolveBackendNodeIds(t),this._innerSetLayers(e)}_innerSetLayers(e){if(this.setRoot(null),this.setContentRoot(null),!e)return;let t;const r=this._layersById;this._layersById={};for(let a=0;a<e.length;++a){const s=e[a].layerId;let i=r[s];i?i._reset(e[a]):i=new AgentLayer(this._layerTreeModel,e[a]),this._layersById[s]=i;const n=e[a].backendNodeId;n&&i._setNode(this.backendNodeIdToNode().get(n)),!this.contentRoot()&&i.drawsContent()&&this.setContentRoot(i);const o=i.parentId();if(o){const e=this._layersById[o];e||console.assert(e,"missing parent "+o+" for layer "+s),e.addChild(i)}else t&&console.assert(!1,"Multiple root layers"),t=i}t&&(this.setRoot(t),t._calculateQuad(new WebKitCSSMatrix))}}export class AgentLayer{constructor(e,t){this._layerTreeModel=e,this._reset(t)}id(){return this._layerPayload.layerId}parentId(){return this._layerPayload.parentLayerId}parent(){return this._parent}isRoot(){return!this.parentId()}children(){return this._children}addChild(e){const t=e;t._parent&&console.assert(!1,"Child already has a parent"),this._children.push(t),t._parent=this}_setNode(e){this._node=e}node(){return this._node}nodeForSelfOrAncestor(){for(let e=this;e;e=e._parent)if(e._node)return e._node;return null}offsetX(){return this._layerPayload.offsetX}offsetY(){return this._layerPayload.offsetY}width(){return this._layerPayload.width}height(){return this._layerPayload.height}transform(){return this._layerPayload.transform}quad(){return this._quad}anchorPoint(){return[this._layerPayload.anchorX||0,this._layerPayload.anchorY||0,this._layerPayload.anchorZ||0]}invisible(){return this._layerPayload.invisible}paintCount(){return this._paintCount||this._layerPayload.paintCount}lastPaintRect(){return this._lastPaintRect}scrollRects(){return this._scrollRects}stickyPositionConstraint(){return this._stickyPositionConstraint}async requestCompositingReasonIds(){return(await this._layerTreeModel._layerTreeAgent.invoke_compositingReasons({layerId:this.id()})).compositingReasonIds||[]}drawsContent(){return this._layerPayload.drawsContent}gpuMemoryUsage(){return this.drawsContent()?this.width()*this.height()*4:0}snapshots(){return[this._layerTreeModel._paintProfilerModel.makeSnapshot(this.id()).then(e=>e?{rect:{x:0,y:0,width:this.width(),height:this.height()},snapshot:e}:null)]}_didPaint(e){this._lastPaintRect=e,this._paintCount=this.paintCount()+1,this._image=null}_reset(e){this._node=null,this._children=[],this._parent=null,this._paintCount=0,this._layerPayload=e,this._image=null,this._scrollRects=this._layerPayload.scrollRects||[],this._stickyPositionConstraint=this._layerPayload.stickyPositionConstraint?new SDK.LayerTreeBase.StickyPositionConstraint(this._layerTreeModel.layerTree(),this._layerPayload.stickyPositionConstraint):null}_matrixFromArray(e){return new WebKitCSSMatrix("matrix3d("+e.map((function(e){return e.toFixed(9)})).join(",")+")")}_calculateTransformToViewport(e){let t=(new WebKitCSSMatrix).translate(this._layerPayload.offsetX,this._layerPayload.offsetY);if(this._layerPayload.transform){const e=this._matrixFromArray(this._layerPayload.transform),r=new UI.Geometry.Vector(this._layerPayload.width*this.anchorPoint()[0],this._layerPayload.height*this.anchorPoint()[1],this.anchorPoint()[2]),a=UI.Geometry.multiplyVectorByMatrixAndNormalize(r,t),s=(new WebKitCSSMatrix).translate(-a.x,-a.y,-a.z);t=s.inverse().multiply(e.multiply(s.multiply(t)))}return t=e.multiply(t),t}_createVertexArrayForRect(e,t){return[0,0,0,e,0,0,e,t,0,0,t,0]}_calculateQuad(e){const t=this._calculateTransformToViewport(e);this._quad=[];const r=this._createVertexArrayForRect(this._layerPayload.width,this._layerPayload.height);for(let e=0;e<4;++e){const a=UI.Geometry.multiplyVectorByMatrixAndNormalize(new UI.Geometry.Vector(r[3*e],r[3*e+1],r[3*e+2]),t);this._quad.push(a.x,a.y)}this._children.forEach((function(e){e._calculateQuad(t)}))}}class LayerTreeDispatcher{constructor(e){this._layerTreeModel=e}layerTreeDidChange(e){this._layerTreeModel._layerTreeChanged(e||null)}layerPainted(e,t){this._layerTreeModel._layerPainted(e,t)}}