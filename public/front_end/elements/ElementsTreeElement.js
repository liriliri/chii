import*as Common from"../common/common.js";import*as Components from"../components/components.js";import*as Host from"../host/host.js";import*as Platform from"../platform/platform.js";import*as ProtocolClient from"../protocol_client/protocol_client.js";import*as SDK from"../sdk/sdk.js";import*as TextUtils from"../text_utils/text_utils.js";import*as UI from"../ui/ui.js";import{canGetJSPath,cssPath,jsPath,xPath}from"./DOMPath.js";import{MappedCharToEntity,UpdateRecord}from"./ElementsTreeOutline.js";import{ImagePreviewPopover}from"./ImagePreviewPopover.js";import{MarkerDecorator}from"./MarkerDecorator.js";export class ElementsTreeElement extends UI.TreeOutline.TreeElement{constructor(t,e){super(),this._node=t,this._gutterContainer=this.listItemElement.createChild("div","gutter-container"),this._gutterContainer.addEventListener("click",this._showContextMenu.bind(this));const i=UI.Icon.Icon.create("largeicon-menu","gutter-menu-icon");this._gutterContainer.appendChild(i),this._decorationsElement=this._gutterContainer.createChild("div","hidden"),this._isClosingTag=e,this._node.nodeType()!==Node.ELEMENT_NODE||e||(this._canAddAttributes=!0),this._searchQuery=null,this._expandedChildrenLimit=InitialChildrenLimit,this._decorationsThrottler=new Common.Throttler.Throttler(100),this._htmlEditElement}static animateOnDOMUpdate(t){const e=t.listItemElement.querySelector(".webkit-html-tag-name");UI.UIUtils.runCSSAnimationOnce(e||t.listItemElement,"dom-update-highlight")}static visibleShadowRoots(t){let e=t.shadowRoots();return e.length&&!Common.Settings.Settings.instance().moduleSetting("showUAShadowDOM").get()&&(e=e.filter((function(t){return t.shadowRootType()!==SDK.DOMModel.DOMNode.ShadowRootTypes.UserAgent}))),e}static canShowInlineText(t){if(t.contentDocument()||t.importedDocument()||t.templateContent()||ElementsTreeElement.visibleShadowRoots(t).length||t.hasPseudoElements())return!1;if(t.nodeType()!==Node.ELEMENT_NODE)return!1;if(!t.firstChild||t.firstChild!==t.lastChild||t.firstChild.nodeType()!==Node.TEXT_NODE)return!1;return t.firstChild.nodeValue().length<80}static populateForcedPseudoStateItems(t,e){const i=["active","hover","focus","visited","focus-within"];try{document.querySelector(":focus-visible"),i.push("focus-visible")}catch(t){}const n=e.domModel().cssModel().pseudoState(e),s=t.debugSection().appendSubMenuItem(Common.UIString.UIString("Force state"));for(let t=0;t<i.length;++t){const e=n.indexOf(i[t])>=0;s.defaultSection().appendCheckboxItem(":"+i[t],o.bind(null,i[t],!e),e,!1)}function o(t,i){e.domModel().cssModel().forcePseudoState(e,t,i)}}isClosingTag(){return!!this._isClosingTag}node(){return this._node}isEditing(){return!!this._editing}highlightSearchResults(t){this._searchQuery!==t&&this._hideSearchHighlight(),this._searchQuery=t,this._searchHighlightsVisible=!0,this.updateTitle(null,!0)}hideSearchHighlights(){delete this._searchHighlightsVisible,this._hideSearchHighlight()}_hideSearchHighlight(){if(this._highlightResult){for(let e=this._highlightResult.length-1;e>=0;--e)t(this._highlightResult[e]);delete this._highlightResult}function t(t){switch(t.type){case"added":t.node.remove();break;case"changed":t.node.textContent=t.oldText}}}setInClipboard(t){this._inClipboard!==t&&(this._inClipboard=t,this.listItemElement.classList.toggle("in-clipboard",t))}get hovered(){return this._hovered}set hovered(t){this._hovered!==t&&(this._hovered=t,this.listItemElement&&(t?(this._createSelection(),this.listItemElement.classList.add("hovered")):this.listItemElement.classList.remove("hovered")))}expandedChildrenLimit(){return this._expandedChildrenLimit}setExpandedChildrenLimit(t){this._expandedChildrenLimit=t}_createSelection(){const t=this.listItemElement;t&&(this.selectionElement||(this.selectionElement=createElement("div"),this.selectionElement.className="selection fill",this.selectionElement.style.setProperty("margin-left",-this._computeLeftIndent()+"px"),t.insertBefore(this.selectionElement,t.firstChild)))}_createHint(){if(this.listItemElement&&!this._hintElement){this._hintElement=this.listItemElement.createChild("span","selected-hint");const t="$0";this._hintElement.title=ls`Use ${t} in the console to refer to this element.`,UI.ARIAUtils.markAsHidden(this._hintElement)}}onbind(){this._isClosingTag||(this._node[this.treeOutline.treeElementSymbol()]=this)}onunbind(){this._node[this.treeOutline.treeElementSymbol()]===this&&(this._node[this.treeOutline.treeElementSymbol()]=null)}onattach(){this._hovered&&(this._createSelection(),this.listItemElement.classList.add("hovered")),this.updateTitle(),this.listItemElement.draggable=!0}async onpopulate(){return this.treeOutline.populateTreeElement(this)}async expandRecursively(){await this._node.getSubtree(-1,!0),await super.expandRecursively(Number.MAX_VALUE)}onexpand(){this._isClosingTag||this.updateTitle()}oncollapse(){this._isClosingTag||this.updateTitle()}select(t,e){return!this._editing&&super.select(t,e)}onselect(t){return this.treeOutline.suppressRevealAndSelect=!0,this.treeOutline.selectDOMNode(this._node,t),t&&(this._node.highlight(),Host.userMetrics.actionTaken(Host.UserMetrics.Action.ChangeInspectedNodeInElementsPanel)),this._createSelection(),this._createHint(),this.treeOutline.suppressRevealAndSelect=!1,!0}ondelete(){const t=this.treeOutline.findTreeElement(this._node);return t?t.remove():this.remove(),!0}onenter(){return!this._editing&&(this._startEditing(),!0)}selectOnMouseDown(t){super.selectOnMouseDown(t),this._editing||t.detail>=2&&t.preventDefault()}ondblclick(t){return this._editing||this._isClosingTag||this._startEditingTarget(t.target)||this.isExpandable()&&!this.expanded&&this.expand(),!1}hasEditableNode(){return!this._node.isShadowRoot()&&!this._node.ancestorUserAgentShadowRoot()}_insertInLastAttributePosition(t,e){if(t.getElementsByClassName("webkit-html-attribute").length>0)t.insertBefore(e,t.lastChild);else{const i=t.textContent.match(/^<(.*?)>$/)[1];t.textContent="",t.createTextChild("<"+i),t.appendChild(e),t.createTextChild(">")}}_startEditingTarget(t){if(this.treeOutline.selectedDOMNode()!==this._node)return!1;if(this._node.nodeType()!==Node.ELEMENT_NODE&&this._node.nodeType()!==Node.TEXT_NODE)return!1;const e=t.enclosingNodeOrSelfWithClass("webkit-html-text-node");if(e)return this._startEditingTextNode(e);const i=t.enclosingNodeOrSelfWithClass("webkit-html-attribute");if(i)return this._startEditingAttribute(i,t);const n=t.enclosingNodeOrSelfWithClass("webkit-html-tag-name");if(n)return this._startEditingTagName(n);return!!t.enclosingNodeOrSelfWithClass("add-attribute")&&this._addNewAttribute()}_showContextMenu(t){this.treeOutline.showContextMenu(this,t)}populateTagContextMenu(t,e){const i=this._isClosingTag?this.treeOutline.findTreeElement(this._node):this;t.editSection().appendItem(Common.UIString.UIString("Add attribute"),i._addNewAttribute.bind(i));const n=e.target.enclosingNodeOrSelfWithClass("webkit-html-attribute"),s=e.target.enclosingNodeOrSelfWithClass("add-attribute");n&&!s&&t.editSection().appendItem(Common.UIString.UIString("Edit attribute"),this._startEditingAttribute.bind(this,n,e.target)),this.populateNodeContextMenu(t),ElementsTreeElement.populateForcedPseudoStateItems(t,i.node()),this.populateScrollIntoView(t),t.viewSection().appendItem(Common.UIString.UIString("Focus"),async()=>{await this._node.focus()})}populateScrollIntoView(t){t.viewSection().appendItem(Common.UIString.UIString("Scroll into view"),()=>this._node.scrollIntoView())}populateTextContextMenu(t,e){this._editing||t.editSection().appendItem(Common.UIString.UIString("Edit text"),this._startEditingTextNode.bind(this,e)),this.populateNodeContextMenu(t)}populateNodeContextMenu(t){const e=this.hasEditableNode();e&&!this._editing&&t.editSection().appendItem(Common.UIString.UIString("Edit as HTML"),this._editAsHTML.bind(this));const i=this._node.isShadowRoot(),n=t.clipboardSection().appendSubMenuItem(Common.UIString.UIString("Copy")),s=UI.KeyboardShortcut.KeyboardShortcut.shortcutToString.bind(null),o=UI.KeyboardShortcut.Modifiers.CtrlOrMeta,r=this.treeOutline;let l,d;i||(d=n.section(),l=d.appendItem(Common.UIString.UIString("Copy outerHTML"),r.performCopyOrCut.bind(r,!1,this._node)),l.setShortcut(s("V",o))),this._node.nodeType()===Node.ELEMENT_NODE&&(d.appendItem(Common.UIString.UIString("Copy selector"),this._copyCSSPath.bind(this)),d.appendItem(Common.UIString.UIString("Copy JS path"),this._copyJSPath.bind(this),!canGetJSPath(this._node)),d.appendItem(ls`Copy styles`,this._copyStyles.bind(this))),i||(d.appendItem(Common.UIString.UIString("Copy XPath"),this._copyXPath.bind(this)),d.appendItem(ls`Copy full XPath`,this._copyFullXPath.bind(this))),i||(l=n.clipboardSection().appendItem(Common.UIString.UIString("Cut element"),r.performCopyOrCut.bind(r,!0,this._node),!this.hasEditableNode()),l.setShortcut(s("X",o)),l=n.clipboardSection().appendItem(Common.UIString.UIString("Copy element"),r.performCopyOrCut.bind(r,!1,this._node)),l.setShortcut(s("C",o)),l=n.clipboardSection().appendItem(Common.UIString.UIString("Paste element"),r.pasteNode.bind(r,this._node),!r.canPaste(this._node)),l.setShortcut(s("V",o))),l=t.debugSection().appendCheckboxItem(Common.UIString.UIString("Hide element"),r.toggleHideElement.bind(r,this._node),r.isToggledToHidden(this._node)),l.setShortcut(self.UI.shortcutRegistry.shortcutTitleForAction("elements.hide-element")),e&&t.editSection().appendItem(Common.UIString.UIString("Delete element"),this.remove.bind(this)),t.viewSection().appendItem(ls`Expand recursively`,this.expandRecursively.bind(this)),t.viewSection().appendItem(ls`Collapse children`,this.collapseChildren.bind(this))}_startEditing(){if(this.treeOutline.selectedDOMNode()!==this._node)return;const t=this.listItemElement;if(this._canAddAttributes){const e=t.getElementsByClassName("webkit-html-attribute")[0];return e?this._startEditingAttribute(e,e.getElementsByClassName("webkit-html-attribute-value")[0]):this._addNewAttribute()}if(this._node.nodeType()===Node.TEXT_NODE){const e=t.getElementsByClassName("webkit-html-text-node")[0];return e?this._startEditingTextNode(e):void 0}}_addNewAttribute(){const t=createElement("span");this._buildAttributeDOM(t," ","",null);const e=t.firstElementChild;e.style.marginLeft="2px",e.style.marginRight="2px";const i=this.listItemElement.getElementsByClassName("webkit-html-tag")[0];return this._insertInLastAttributePosition(i,e),e.scrollIntoViewIfNeeded(!0),this._startEditingAttribute(e,e)}_triggerEditAttribute(t){const e=this.listItemElement.getElementsByClassName("webkit-html-attribute-name");for(let i=0,n=e.length;i<n;++i)if(e[i].textContent===t)for(let t=e[i].nextSibling;t;t=t.nextSibling)if(t.nodeType===Node.ELEMENT_NODE&&t.classList.contains("webkit-html-attribute-value"))return this._startEditingAttribute(t.parentNode,t)}_startEditingAttribute(t,e){if(console.assert(this.listItemElement.isAncestor(t)),UI.UIUtils.isBeingEdited(t))return!0;const i=t.getElementsByClassName("webkit-html-attribute-name")[0];if(!i)return!1;const n=i.textContent,s=t.getElementsByClassName("webkit-html-attribute-value")[0];e=s.isAncestor(e)?s:e;const o=n&&s?this._node.getAttribute(n):void 0;void 0!==o&&s.setTextContentTruncatedIfNeeded(o,Common.UIString.UIString("<value is too large to edit>")),function t(e){if(e.nodeType!==Node.TEXT_NODE){if(e.nodeType===Node.ELEMENT_NODE)for(let i=e.firstChild;i;i=i.nextSibling)t(i)}else e.nodeValue=e.nodeValue.replace(/\u200B/g,"")}(t);const r=new UI.InplaceEditor.Config(this._attributeEditingCommitted.bind(this),this._editingCancelled.bind(this),n);return Common.ParsedURL.ParsedURL.fromString(s.textContent)||r.setPostKeydownFinishHandler((function(e){return UI.UIUtils.handleElementValueModifications(e,t),""})),this._editing=UI.InplaceEditor.InplaceEditor.startEditing(t,r),this.listItemElement.getComponentSelection().selectAllChildren(e),!0}_startEditingTextNode(t){if(UI.UIUtils.isBeingEdited(t))return!0;let e=this._node;e.nodeType()===Node.ELEMENT_NODE&&e.firstChild&&(e=e.firstChild);const i=t.enclosingNodeOrSelfWithClass("webkit-html-text-node");i&&(i.textContent=e.nodeValue());const n=new UI.InplaceEditor.Config(this._textNodeEditingCommitted.bind(this,e),this._editingCancelled.bind(this));return this._editing=UI.InplaceEditor.InplaceEditor.startEditing(t,n),this.listItemElement.getComponentSelection().selectAllChildren(t),!0}_startEditingTagName(t){if(!t&&!(t=this.listItemElement.getElementsByClassName("webkit-html-tag-name")[0]))return!1;const e=t.textContent;if(EditTagBlacklist.has(e.toLowerCase()))return!1;if(UI.UIUtils.isBeingEdited(t))return!0;const i=this._distinctClosingTagElement();function n(e){i&&(i.textContent="</"+t.textContent+">")}const s=t=>{" "===t.key&&(this._editing.commit(),t.consume(!0))};t.addEventListener("keyup",n,!1),t.addEventListener("keydown",s,!1);const o=new UI.InplaceEditor.Config(function(e,i){t.removeEventListener("keyup",n,!1),t.removeEventListener("keydown",s,!1),this._tagNameEditingCommitted.apply(this,arguments)}.bind(this),function(){t.removeEventListener("keyup",n,!1),t.removeEventListener("keydown",s,!1),this._editingCancelled.apply(this,arguments)}.bind(this),e);return this._editing=UI.InplaceEditor.InplaceEditor.startEditing(t,o),this.listItemElement.getComponentSelection().selectAllChildren(t),!0}_startEditingAsHTML(t,e,i){if(null===i)return;let n=i;if(this._editing)return;n=this._convertWhitespaceToEntities(n).text,this._htmlEditElement=createElement("div"),this._htmlEditElement.className="source-code elements-tree-editor";let s=this.listItemElement.firstChild;for(;s;)s.style.display="none",s=s.nextSibling;function o(){this._htmlEditElement&&(this._htmlEditElement.style.width=this.treeOutline.visibleWidth()-this._computeLeftIndent()-30+"px"),this._editing.editor.onResize()}function r(){t(n,this._editing.editor.text()),l.call(this)}function l(){if(!this._editing||!this._editing.editor)return;this._editing.editor.widget().element.removeEventListener("blur",this._editing.commit,!0),this._editing.editor.widget().detach(),delete this._editing,this.listItemElement.removeChild(this._htmlEditElement),delete this._htmlEditElement,this.childrenListElement&&this.childrenListElement.style.removeProperty("display");let t=this.listItemElement.firstChild;for(;t;)t.style.removeProperty("display"),t=t.nextSibling;this.treeOutline&&(this.treeOutline.setMultilineEditing(null),this.treeOutline.focus()),e()}function d(t){const e=UI.KeyboardShortcut.KeyboardShortcut.eventHasCtrlOrMeta(t)&&!t.altKey&&!t.shiftKey;isEnterKey(t)&&(e||t.isMetaOrCtrlForTest)?(t.consume(!0),this._editing.commit()):t.keyCode!==UI.KeyboardShortcut.Keys.Esc.code&&"Escape"!==t.key||(t.consume(!0),this._editing.cancel())}this.childrenListElement&&(this.childrenListElement.style.display="none"),this.listItemElement.appendChild(this._htmlEditElement),self.runtime.extension(UI.TextEditor.TextEditorFactory).instance().then(function(t){const e=t.createEditor({lineNumbers:!1,lineWrapping:Common.Settings.Settings.instance().moduleSetting("domWordWrap").get(),mimeType:"text/html",autoHeight:!1,padBottom:!1});this._editing={commit:r.bind(this),cancel:l.bind(this),editor:e,resize:o.bind(this)},o.call(this),e.widget().show(this._htmlEditElement),e.setText(n),e.widget().focus(),e.widget().element.addEventListener("focusout",t=>{t.relatedTarget&&!t.relatedTarget.isSelfOrDescendant(e.widget().element)&&this._editing.commit()},!1),e.widget().element.addEventListener("keydown",d.bind(this),!0),this.treeOutline.setMultilineEditing(this._editing)}.bind(this))}_attributeEditingCommitted(t,e,i,n,s){delete this._editing;const o=this.treeOutline;function r(i){if(i&&this._editingCancelled(t,n),!s)return;o.runPendingUpdates(),o.focus();const r=this._node.attributes();for(let t=0;t<r.length;++t)if(r[t].name===n)return void("backward"===s?0===t?this._startEditingTagName():this._triggerEditAttribute(r[t-1].name):t===r.length-1?this._addNewAttribute():this._triggerEditAttribute(r[t+1].name));"backward"===s?" "===e?r.length>0&&this._triggerEditAttribute(r[r.length-1].name):r.length>1&&this._triggerEditAttribute(r[r.length-2].name):"forward"===s&&(Platform.StringUtilities.isWhitespace(e)?this._startEditingTagName():this._addNewAttribute())}!n.trim()&&!e.trim()||i===e?(this.updateTitle(),r.call(this)):this._node.setAttribute(n,e,r.bind(this))}_tagNameEditingCommitted(t,e,i,n,s){delete this._editing;const o=this;function r(){const e=o._distinctClosingTagElement();e&&(e.textContent="</"+n+">"),o._editingCancelled(t,n),l.call(o)}function l(){if("forward"!==s)return void this._addNewAttribute();const t=this._node.attributes();t.length>0?this._triggerEditAttribute(t[0].name):this._addNewAttribute()}if((e=e.trim())===i)return void r();const d=this.treeOutline,h=this.expanded;this._node.setNodeName(e,(t,e)=>{if(t||!e)return void r();const i=d.selectNodeAfterEdit(h,t,e);l.call(i)})}_textNodeEditingCommitted(t,e,i){delete this._editing,t.setNodeValue(i,function(){this.updateTitle()}.bind(this))}_editingCancelled(t,e){delete this._editing,this.updateTitle()}_distinctClosingTagElement(){if(this.expanded){const t=this.childrenListElement.querySelectorAll(".close");return t[t.length-1]}const t=this.listItemElement.getElementsByClassName("webkit-html-tag");return 1===t.length?null:t[t.length-1]}updateTitle(t,e){if(!this._editing){if(e)this._hideSearchHighlight();else{const e=this._nodeTitleInfo(t||null);if(this._node.nodeType()===Node.DOCUMENT_FRAGMENT_NODE&&this._node.isInShadowTree()&&this._node.shadowRootType()){this.childrenListElement.classList.add("shadow-root");let t=4;for(let e=this._node;t&&e;e=e.parentNode)e.nodeType()===Node.DOCUMENT_FRAGMENT_NODE&&t--;t?this.childrenListElement.classList.add("shadow-root-depth-"+t):this.childrenListElement.classList.add("shadow-root-deep")}const i=createElement("span");i.className="highlight",i.appendChild(e),this.title=i,this.updateDecorations(),this.listItemElement.insertBefore(this._gutterContainer,this.listItemElement.firstChild),delete this._highlightResult,delete this.selectionElement,delete this._hintElement,this.selected&&(this._createSelection(),this._createHint())}this._highlightSearchResults()}}_computeLeftIndent(){let t=this.parent,e=0;for(;null!==t;)e++,t=t.parent;return 12*(e-2)+(this.isExpandable()?1:12)}updateDecorations(){this._gutterContainer.style.left=-this._computeLeftIndent()+"px",this.isClosingTag()||this._node.nodeType()===Node.ELEMENT_NODE&&this._decorationsThrottler.schedule(this._updateDecorationsInternal.bind(this))}_updateDecorationsInternal(){if(!this.treeOutline)return Promise.resolve();const t=this._node;this.treeOutline._decoratorExtensions||(this.treeOutline._decoratorExtensions=self.runtime.extensions(MarkerDecorator));const e=new Map;for(let t=0;t<this.treeOutline._decoratorExtensions.length;++t)e.set(this.treeOutline._decoratorExtensions[t].descriptor().marker,this.treeOutline._decoratorExtensions[t]);const i=[],n=[],s=[];function o(e,i){const o=i.decorate(e);o&&(e===t?n:s).push(o)}return t.traverseMarkers((function(t,n){const s=e.get(n);if(!s)return;i.push(s.instance().then(o.bind(null,t)))})),Promise.all(i).then(function(){if(this._decorationsElement.removeChildren(),this._decorationsElement.classList.add("hidden"),this._gutterContainer.classList.toggle("has-decorations",n.length||s.length),!n.length&&!s.length)return;const t=new Set,e=createElement("div");for(const i of n){e.createChild("div").textContent=i.title,t.add(i.color)}if(this.expanded&&!n.length)return;const i=new Set;if(s.length){let t=e.createChild("div");t.textContent=Common.UIString.UIString("Children:");for(const n of s)t=e.createChild("div"),t.style.marginLeft="15px",t.textContent=n.title,i.add(n.color)}let o=0;r.call(this,t,"elements-gutter-decoration"),this.expanded||r.call(this,i,"elements-gutter-decoration elements-has-decorated-children");function r(t,e){for(const i of t){const t=this._decorationsElement.createChild("div",e);this._decorationsElement.classList.remove("hidden"),t.style.backgroundColor=i,t.style.borderColor=i,o&&(t.style.marginLeft=o+"px"),o+=3}}UI.Tooltip.Tooltip.install(this._decorationsElement,e)}.bind(this))}_buildAttributeDOM(t,e,i,n,s,o){const r=/[\/;:\)\]\}]/g;let l,d,h=0,a=0;function c(t,e){for(;h<l&&d.entityRanges[h].offset<e;)d.entityRanges[h].offset+=a,++h;return a+=1,t+"​"}function m(t,e){for(d=this._convertWhitespaceToEntities(e),l=d.entityRanges.length,e=d.text.replace(r,c);h<l;)d.entityRanges[h].offset+=a,++h;t.setTextContentTruncatedIfNeeded(e),UI.UIUtils.highlightRangesWithStyleClass(t,d.entityRanges,"webkit-html-entity-value")}const g=s||i.length>0,u=t.createChild("span","webkit-html-attribute"),p=u.createChild("span","webkit-html-attribute-name");p.textContent=e,g&&u.createTextChild('=​"');const _=u.createChild("span","webkit-html-attribute-value");function E(t){const e=o.resolveURL(t);if(null===e){const e=createElement("span");return m.call(this,e,t),e}(t=t.replace(r,"$&​")).startsWith("data:")&&(t=t.trimMiddle(60));const i="a"===o.nodeName().toLowerCase()?UI.XLink.XLink.create(e,t,"",!0):Components.Linkifier.Linkifier.linkifyURL(e,{text:t,preventClick:!0});return ImagePreviewPopover.setImageUrl(i,e)}n&&n.isAttributeModified(e)&&UI.UIUtils.runCSSAnimationOnce(g?_:p,"dom-update-highlight");const C=o?o.nodeName().toLowerCase():"";function b(t){const e=createDocumentFragment();let i=0;for(;t.length;){i++>0&&e.createTextChild(" ");let n="",s="";const o=(t=t.trim()).search(/\s/);if(-1===o)n=t;else if(o>0&&","===t[o-1])n=t.substring(0,o);else{n=t.substring(0,o);const e=t.indexOf(",",o);s=-1!==e?t.substring(o,e+1):t.substring(o)}n&&(n.endsWith(",")?(e.appendChild(E.call(this,n.substring(0,n.length-1))),e.createTextChild(",")):e.appendChild(E.call(this,n))),s&&e.createTextChild(s),t=t.substring(n.length+s.length)}return e}!C||"src"!==e&&"href"!==e?("img"!==C&&"source"!==C||"srcset"!==e)&&("image"!==C||"xlink:href"!==e&&"href"!==e)?m.call(this,_,i):_.appendChild(b.call(this,i)):_.appendChild(E.call(this,i)),g&&u.createTextChild('"')}_buildPseudoElementDOM(t,e){t.createChild("span","webkit-html-pseudo-element").textContent="::"+e,t.createTextChild("​")}_buildTagDOM(t,e,i,n,s){const o=this._node,r=["webkit-html-tag"];i&&n&&r.push("close");const l=t.createChild("span",r.join(" "));l.createTextChild("<");const d=l.createChild("span",i?"webkit-html-close-tag-name":"webkit-html-tag-name");if(d.textContent=(i?"/":"")+e,!i){if(o.hasAttributes()){const t=o.attributes();for(let e=0;e<t.length;++e){const i=t[e];l.createTextChild(" "),this._buildAttributeDOM(l,i.name,i.value,s,!1,o)}}if(s){let t=s.hasRemovedAttributes()||s.hasRemovedChildren();t|=!this.expanded&&s.hasChangedChildren(),t&&UI.UIUtils.runCSSAnimationOnce(d,"dom-update-highlight")}}l.createTextChild(">"),t.createTextChild("​")}_convertWhitespaceToEntities(t){let e="",i=0;const n=[],s=MappedCharToEntity;for(let o=0,r=t.length;o<r;++o){const r=t.charAt(o);if(s[r]){e+=t.substring(i,o);const l="&"+s[r]+";";n.push({offset:e.length,length:l.length}),e+=l,i=o+1}}return e&&(e+=t.substring(i)),{text:e||t,entityRanges:n}}_nodeTitleInfo(t){const e=this._node,i=createDocumentFragment();switch(e.nodeType()){case Node.ATTRIBUTE_NODE:this._buildAttributeDOM(i,e.name,e.value,t,!0);break;case Node.ELEMENT_NODE:{const n=e.pseudoType();if(n){this._buildPseudoElementDOM(i,n);break}const s=e.nodeNameInCorrectCase();if(this._isClosingTag){this._buildTagDOM(i,s,!0,!0,t);break}if(this._buildTagDOM(i,s,!1,!1,t),this.isExpandable()){if(!this.expanded){i.createChild("span","webkit-html-text-node bogus").textContent="…",i.createTextChild("​"),this._buildTagDOM(i,s,!0,!1,t)}break}if(ElementsTreeElement.canShowInlineText(e)){const n=i.createChild("span","webkit-html-text-node"),o=this._convertWhitespaceToEntities(e.firstChild.nodeValue());n.textContent=o.text,UI.UIUtils.highlightRangesWithStyleClass(n,o.entityRanges,"webkit-html-entity-value"),i.createTextChild("​"),this._buildTagDOM(i,s,!0,!1,t),t&&t.hasChangedChildren()&&UI.UIUtils.runCSSAnimationOnce(n,"dom-update-highlight"),t&&t.isCharDataModified()&&UI.UIUtils.runCSSAnimationOnce(n,"dom-update-highlight");break}!this.treeOutline.isXMLMimeType&&ForbiddenClosingTagElements.has(s)||this._buildTagDOM(i,s,!0,!1,t);break}case Node.TEXT_NODE:if(e.parentNode&&"script"===e.parentNode.nodeName().toLowerCase()){const t=i.createChild("span","webkit-html-text-node webkit-html-js-node"),s=e.nodeValue();t.textContent=s.startsWith("\n")?s.substring(1):s;new UI.SyntaxHighlighter.SyntaxHighlighter("text/javascript",!0).syntaxHighlightNode(t).then(n.bind(this))}else if(e.parentNode&&"style"===e.parentNode.nodeName().toLowerCase()){const t=i.createChild("span","webkit-html-text-node webkit-html-css-node"),s=e.nodeValue();t.textContent=s.startsWith("\n")?s.substring(1):s;new UI.SyntaxHighlighter.SyntaxHighlighter("text/css",!0).syntaxHighlightNode(t).then(n.bind(this))}else{i.createTextChild('"');const n=i.createChild("span","webkit-html-text-node"),s=this._convertWhitespaceToEntities(e.nodeValue());n.textContent=s.text,UI.UIUtils.highlightRangesWithStyleClass(n,s.entityRanges,"webkit-html-entity-value"),i.createTextChild('"'),t&&t.isCharDataModified()&&UI.UIUtils.runCSSAnimationOnce(n,"dom-update-highlight")}break;case Node.COMMENT_NODE:i.createChild("span","webkit-html-comment").createTextChild("\x3c!--"+e.nodeValue()+"--\x3e");break;case Node.DOCUMENT_TYPE_NODE:{const t=i.createChild("span","webkit-html-doctype");t.createTextChild("<!DOCTYPE "+e.nodeName()),e.publicId?(t.createTextChild(' PUBLIC "'+e.publicId+'"'),e.systemId&&t.createTextChild(' "'+e.systemId+'"')):e.systemId&&t.createTextChild(' SYSTEM "'+e.systemId+'"'),e.internalSubset&&t.createTextChild(" ["+e.internalSubset+"]"),t.createTextChild(">");break}case Node.CDATA_SECTION_NODE:i.createChild("span","webkit-html-text-node").createTextChild("<![CDATA["+e.nodeValue()+"]]>");break;case Node.DOCUMENT_FRAGMENT_NODE:i.createChild("span","webkit-html-fragment").textContent=Platform.StringUtilities.collapseWhitespace(e.nodeNameInCorrectCase());break;default:{const t=Platform.StringUtilities.collapseWhitespace(e.nodeNameInCorrectCase());i.createTextChild(t)}}function n(){delete this._highlightResult,this._highlightSearchResults()}return i}remove(){if(this._node.pseudoType())return;this.parent&&this._node.parentNode&&this._node.parentNode.nodeType()!==Node.DOCUMENT_NODE&&this._node.removeNode()}toggleEditAsHTML(t,e){if(this._editing&&this._htmlEditElement)return void this._editing.commit();if(!1===e)return;function i(e){t&&t(!e)}const n=this._node;n.getOuterHTML().then(this._startEditingAsHTML.bind(this,(function(t,e){t!==e&&n.setOuterHTML(e,i)}),(function(){t&&t(!1)})))}_copyCSSPath(){Host.InspectorFrontendHost.InspectorFrontendHostInstance.copyText(cssPath(this._node,!0))}_copyJSPath(){Host.InspectorFrontendHost.InspectorFrontendHostInstance.copyText(jsPath(this._node,!0))}_copyXPath(){Host.InspectorFrontendHost.InspectorFrontendHostInstance.copyText(xPath(this._node,!0))}_copyFullXPath(){Host.InspectorFrontendHost.InspectorFrontendHostInstance.copyText(xPath(this._node,!1))}async _copyStyles(){const t=this._node,e=t.domModel().cssModel(),i=await e.cachedMatchedCascadeForNode(t);if(!i)return;const n=[];for(const t of i.nodeStyles().reverse())for(const e of t.leadingProperties())e.parsedOk&&!e.disabled&&e.activeInStyle()&&!e.implicit&&(i.isInherited(t)&&!SDK.CSSMetadata.cssMetadata().isPropertyInherited(e.name)||t.parentRule&&t.parentRule.isUserAgent()||i.propertyState(e)===SDK.CSSMatchedStyles.PropertyState.Active&&n.push(`${e.name}: ${e.value};`));Host.InspectorFrontendHost.InspectorFrontendHostInstance.copyText(n.join("\n"))}_highlightSearchResults(){if(!this._searchQuery||!this._searchHighlightsVisible)return;this._hideSearchHighlight();const t=this.listItemElement.textContent,e=createPlainTextSearchRegex(this._searchQuery,"gi");let i=e.exec(t);const n=[];for(;i;)n.push(new TextUtils.TextRange.SourceRange(i.index,i[0].length)),i=e.exec(t);n.length||n.push(new TextUtils.TextRange.SourceRange(0,t.length)),this._highlightResult=[],UI.UIUtils.highlightSearchResults(this.listItemElement,n,this._highlightResult)}_editAsHTML(){Common.Revealer.reveal(this.node()).then(()=>self.UI.actionRegistry.action("elements.edit-as-html").execute())}}export const InitialChildrenLimit=500;export const ForbiddenClosingTagElements=new Set(["area","base","basefont","br","canvas","col","command","embed","frame","hr","img","input","keygen","link","menuitem","meta","param","source","track","wbr"]);export const EditTagBlacklist=new Set(["html","head","body"]);