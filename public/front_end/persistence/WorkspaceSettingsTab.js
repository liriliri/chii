import*as Common from"../common/common.js";import*as UI from"../ui/ui.js";import{EditFileSystemView}from"./EditFileSystemView.js";import{FileSystem}from"./FileSystemWorkspaceBinding.js";import{IsolatedFileSystem}from"./IsolatedFileSystem.js";import{Events,IsolatedFileSystemManager}from"./IsolatedFileSystemManager.js";import{PlatformFileSystem}from"./PlatformFileSystem.js";export class WorkspaceSettingsTab extends UI.Widget.VBox{constructor(){super(),this.registerRequiredCSS("persistence/workspaceSettingsTab.css");this.element.createChild("header").createChild("h1").createTextChild(Common.UIString.UIString("Workspace")),this.containerElement=this.element.createChild("div","settings-container-wrapper").createChild("div","settings-tab settings-content settings-container"),IsolatedFileSystemManager.instance().addEventListener(Events.FileSystemAdded,e=>this._fileSystemAdded(e.data),this),IsolatedFileSystemManager.instance().addEventListener(Events.FileSystemRemoved,e=>this._fileSystemRemoved(e.data),this);const e=this._createFolderExcludePatternInput();e.classList.add("folder-exclude-pattern"),this.containerElement.appendChild(e);this.containerElement.createChild("div","settings-info-message").createTextChild(Common.UIString.UIString("Mappings are inferred automatically.")),this._fileSystemsListContainer=this.containerElement.createChild("div","");const t=UI.UIUtils.createTextButton(ls`Add folderâ€¦`,this._addFileSystemClicked.bind(this));this.containerElement.appendChild(t),this.setDefaultFocusedElement(t),this._elementByPath=new Map,this._mappingViewByPath=new Map;const i=IsolatedFileSystemManager.instance().fileSystems();for(let e=0;e<i.length;++e)this._addItem(i[e])}_createFolderExcludePatternInput(){const e=createElement("p"),t=e.createChild("label");t.textContent=ls`Folder exclude pattern`;const i=UI.UIUtils.createInput("","text");UI.ARIAUtils.bindLabelToControl(t,i),e.appendChild(i),i.style.width="270px";const s=IsolatedFileSystemManager.instance().workspaceFolderExcludePatternSetting(),n=UI.UIUtils.bindInput(i,s.set.bind(s),(function(e){let t;try{t=new RegExp(e)}catch(e){}return{valid:!!t}}),!1);return s.addChangeListener(()=>n.call(null,s.get())),n(s.get()),e}_addItem(e){if(!(e instanceof IsolatedFileSystem))return;const t=self.Persistence.networkPersistenceManager.project();if(t&&IsolatedFileSystemManager.instance().fileSystem(t.fileSystemPath())===e)return;const i=this._renderFileSystem(e);this._elementByPath.set(e.path(),i),this._fileSystemsListContainer.appendChild(i);const s=new EditFileSystemView(e.path());this._mappingViewByPath.set(e.path(),s),s.element.classList.add("file-system-mapping-view"),s.show(i)}_renderFileSystem(e){const t=e.path(),i=t.lastIndexOf("/"),s=t.substr(i+1),n=createElementWithClass("div","file-system-container"),a=n.createChild("div","file-system-header"),l=a.createChild("div","file-system-name");l.textContent=s,UI.ARIAUtils.markAsHeading(l,2);const r=a.createChild("div","file-system-path");r.textContent=t,r.title=t;const d=new UI.Toolbar.Toolbar(""),o=new UI.Toolbar.ToolbarButton(Common.UIString.UIString("Remove"),"largeicon-delete");return o.addEventListener(UI.Toolbar.ToolbarButton.Events.Click,this._removeFileSystemClicked.bind(this,e)),d.appendToolbarItem(o),a.appendChild(d.element),n}_removeFileSystemClicked(e){IsolatedFileSystemManager.instance().removeFileSystem(e)}_addFileSystemClicked(){IsolatedFileSystemManager.instance().addFileSystem()}_fileSystemAdded(e){this._addItem(e)}_fileSystemRemoved(e){const t=this._mappingViewByPath.get(e.path());t&&(t.dispose(),this._mappingViewByPath.delete(e.path()));const i=this._elementByPath.get(e.path());i&&(this._elementByPath.delete(e.path()),i.remove())}}