import*as Common from"../common/common.js";import*as Host from"../host/host.js";import*as Platform from"../platform/platform.js";import*as SDK from"../sdk/sdk.js";import*as UI from"../ui/ui.js";import{AnimationGroupPreviewUI}from"./AnimationGroupPreviewUI.js";import{AnimationEffect,AnimationGroup,AnimationImpl,AnimationModel,Events}from"./AnimationModel.js";import{AnimationScreenshotPopover}from"./AnimationScreenshotPopover.js";import{AnimationUI}from"./AnimationUI.js";export class AnimationTimeline extends UI.Widget.VBox{constructor(){super(!0),this.registerRequiredCSS("animation/animationTimeline.css"),this.element.classList.add("animations-timeline"),this._grid=this.contentElement.createSVGChild("svg","animation-timeline-grid"),this._playbackRate=1,this._allPaused=!1,this._createHeader(),this._animationsContainer=this.contentElement.createChild("div","animation-timeline-rows");this.contentElement.createChild("div","animation-timeline-rows-hint").textContent=ls`Select an effect above to inspect and modify.`,this._defaultDuration=100,this._duration=this._defaultDuration,this._timelineControlsWidth=150,this._nodesMap=new Map,this._uiAnimations=[],this._groupBuffer=[],this._previewMap=new Map,this._symbol=Symbol("animationTimeline"),this._animationsMap=new Map,SDK.SDKModel.TargetManager.instance().addModelListener(SDK.DOMModel.DOMModel,SDK.DOMModel.Events.NodeRemoved,this._nodeRemoved,this),SDK.SDKModel.TargetManager.instance().observeModels(AnimationModel,this),self.UI.context.addFlavorChangeListener(SDK.DOMModel.DOMNode,this._nodeChanged,this)}wasShown(){for(const e of SDK.SDKModel.TargetManager.instance().models(AnimationModel))this._addEventListeners(e)}willHide(){for(const e of SDK.SDKModel.TargetManager.instance().models(AnimationModel))this._removeEventListeners(e);this._popoverHelper.hidePopover()}modelAdded(e){this.isShowing()&&this._addEventListeners(e)}modelRemoved(e){this._removeEventListeners(e)}_addEventListeners(e){e.ensureEnabled(),e.addEventListener(Events.AnimationGroupStarted,this._animationGroupStarted,this),e.addEventListener(Events.ModelReset,this._reset,this)}_removeEventListeners(e){e.removeEventListener(Events.AnimationGroupStarted,this._animationGroupStarted,this),e.removeEventListener(Events.ModelReset,this._reset,this)}_nodeChanged(){for(const e of this._nodesMap.values())e._nodeChanged()}_createScrubber(){return this._timelineScrubber=createElementWithClass("div","animation-scrubber hidden"),this._timelineScrubberLine=this._timelineScrubber.createChild("div","animation-scrubber-line"),this._timelineScrubberLine.createChild("div","animation-scrubber-head"),this._timelineScrubber.createChild("div","animation-time-overlay"),this._timelineScrubber}_createHeader(){const e=this.contentElement.createChild("div","animation-timeline-toolbar-container"),t=new UI.Toolbar.Toolbar("animation-timeline-toolbar",e);this._clearButton=new UI.Toolbar.ToolbarButton(ls`Clear all`,"largeicon-clear"),this._clearButton.addEventListener(UI.Toolbar.ToolbarButton.Events.Click,this._reset.bind(this)),t.appendToolbarItem(this._clearButton),t.appendSeparator(),this._pauseButton=new UI.Toolbar.ToolbarToggle(ls`Pause all`,"largeicon-pause","largeicon-resume"),this._pauseButton.addEventListener(UI.Toolbar.ToolbarButton.Events.Click,this._togglePauseAll.bind(this)),t.appendToolbarItem(this._pauseButton);const i=e.createChild("div","animation-playback-rate-control");i.addEventListener("keydown",this._handlePlaybackRateControlKeyDown.bind(this)),UI.ARIAUtils.markAsListBox(i),UI.ARIAUtils.setAccessibleName(i,ls`Playback rates`),this._playbackRateButtons=[];for(const e of GlobalPlaybackRates){const t=i.createChild("button","animation-playback-rate-button");t.textContent=e?ls`${100*e}%`:ls`Pause`,t.playbackRate=e,t.addEventListener("click",this._setPlaybackRate.bind(this,e)),UI.ARIAUtils.markAsOption(t),t.title=ls`Set speed to ${t.textContent}`,t.tabIndex=-1,this._playbackRateButtons.push(t)}this._updatePlaybackControls(),this._previewContainer=this.contentElement.createChild("div","animation-timeline-buffer"),UI.ARIAUtils.markAsListBox(this._previewContainer),UI.ARIAUtils.setAccessibleName(this._previewContainer,ls`Animation previews`),this._popoverHelper=new UI.PopoverHelper.PopoverHelper(this._previewContainer,this._getPopoverRequest.bind(this)),this._popoverHelper.setDisableOnClick(!0),this._popoverHelper.setTimeout(0);this.contentElement.createChild("div","animation-timeline-buffer-hint").textContent=ls`Listening for animations...`;const s=this.contentElement.createChild("div","animation-timeline-header"),n=s.createChild("div","animation-controls");this._currentTime=n.createChild("div","animation-timeline-current-time monospace");const r=new UI.Toolbar.Toolbar("animation-controls-toolbar",n);this._controlButton=new UI.Toolbar.ToolbarToggle(ls`Replay timeline`,"largeicon-replay-animation"),this._controlState=_ControlState.Replay,this._controlButton.setToggled(!0),this._controlButton.addEventListener(UI.Toolbar.ToolbarButton.Events.Click,this._controlButtonToggle.bind(this)),r.appendToolbarItem(this._controlButton);const o=s.createChild("div","animation-grid-header");return UI.UIUtils.installDragHandle(o,this._repositionScrubber.bind(this),this._scrubberDragMove.bind(this),this._scrubberDragEnd.bind(this),"text"),s.appendChild(this._createScrubber()),UI.UIUtils.installDragHandle(this._timelineScrubberLine,this._scrubberDragStart.bind(this),this._scrubberDragMove.bind(this),this._scrubberDragEnd.bind(this),"col-resize"),this._currentTime.textContent="",s}_handlePlaybackRateControlKeyDown(e){switch(e.key){case"ArrowLeft":case"ArrowUp":this._focusNextPlaybackRateButton(e.target,!0);break;case"ArrowRight":case"ArrowDown":this._focusNextPlaybackRateButton(e.target)}}_focusNextPlaybackRateButton(e,t){const i=this._playbackRateButtons.indexOf(e),s=t?i-1:i+1;if(s<0||s>=this._playbackRateButtons.length)return;const n=this._playbackRateButtons[s];n.tabIndex=0,n.focus(),e.tabIndex=-1}_getPopoverRequest(e){const t=e.target;return t.isDescendant(this._previewContainer)?{box:e.target.boxInWindow(),show:e=>{let i;for(const[e,s]of this._previewMap)s.element===t.parentElement&&(i=e);console.assert(i);const s=i.screenshots();if(!s.length)return Promise.resolve(!1);let n;const r=new Promise(e=>n=e);return s[0].complete?o(s):s[0].onload=o.bind(null,s),r;function o(t){new AnimationScreenshotPopover(t).show(e.contentElement),n(!0)}}}:null}_togglePauseAll(){this._allPaused=!this._allPaused,this._pauseButton.setToggled(this._allPaused),this._setPlaybackRate(this._playbackRate),this._pauseButton.setTitle(this._allPaused?ls`Resume all`:ls`Pause all`)}_setPlaybackRate(e){this._playbackRate=e;for(const e of SDK.SDKModel.TargetManager.instance().models(AnimationModel))e.setPlaybackRate(this._allPaused?0:this._playbackRate);Host.userMetrics.actionTaken(Host.UserMetrics.Action.AnimationsPlaybackRateChanged),this._scrubberPlayer&&(this._scrubberPlayer.playbackRate=this._effectivePlaybackRate()),this._updatePlaybackControls()}_updatePlaybackControls(){for(const e of this._playbackRateButtons){const t=this._playbackRate===e.playbackRate;e.classList.toggle("selected",t),e.tabIndex=t?0:-1}}_controlButtonToggle(){this._controlState===_ControlState.Play?this._togglePause(!1):this._controlState===_ControlState.Replay?this._replay():this._togglePause(!0)}_updateControlButton(){this._controlButton.setEnabled(!!this._selectedGroup),this._selectedGroup&&this._selectedGroup.paused()?(this._controlState=_ControlState.Play,this._controlButton.setToggled(!0),this._controlButton.setTitle(ls`Play timeline`),this._controlButton.setGlyph("largeicon-play-animation")):!this._scrubberPlayer||this._scrubberPlayer.currentTime>=this.duration()?(this._controlState=_ControlState.Replay,this._controlButton.setToggled(!0),this._controlButton.setTitle(ls`Replay timeline`),this._controlButton.setGlyph("largeicon-replay-animation")):(this._controlState=_ControlState.Pause,this._controlButton.setToggled(!1),this._controlButton.setTitle(ls`Pause timeline`),this._controlButton.setGlyph("largeicon-pause-animation"))}_effectivePlaybackRate(){return this._allPaused||this._selectedGroup&&this._selectedGroup.paused()?0:this._playbackRate}_togglePause(e){this._selectedGroup.togglePause(e),this._scrubberPlayer&&(this._scrubberPlayer.playbackRate=this._effectivePlaybackRate()),this._previewMap.get(this._selectedGroup).element.classList.toggle("paused",e),this._updateControlButton()}_replay(){this._selectedGroup&&(this._selectedGroup.seekTo(0),this._animateTime(0),this._updateControlButton())}duration(){return this._duration}setDuration(e){this._duration=e,this.scheduleRedraw()}_clearTimeline(){this._uiAnimations=[],this._nodesMap.clear(),this._animationsMap.clear(),this._animationsContainer.removeChildren(),this._duration=this._defaultDuration,this._timelineScrubber.classList.add("hidden"),delete this._selectedGroup,this._scrubberPlayer&&this._scrubberPlayer.cancel(),delete this._scrubberPlayer,this._currentTime.textContent="",this._updateControlButton()}_reset(){this._clearTimeline(),this._allPaused?this._togglePauseAll():this._setPlaybackRate(this._playbackRate);for(const e of this._groupBuffer)e.release();this._groupBuffer=[],this._previewMap.clear(),this._previewContainer.removeChildren(),this._popoverHelper.hidePopover(),this._renderGrid()}_animationGroupStarted(e){this._addAnimationGroup(e.data)}_addAnimationGroup(e){if(this._previewMap.get(e))return void(this._selectedGroup===e?this._syncScrubber():this._previewMap.get(e).replay());this._groupBuffer.sort((function(e,t){return e.startTime()>t.startTime()}));const t=[],i=this.width()/50;for(;this._groupBuffer.length>i;){const e=this._groupBuffer.splice(this._groupBuffer[0]===this._selectedGroup?1:0,1);t.push(e[0])}for(const e of t)this._previewMap.get(e).element.remove(),this._previewMap.delete(e),e.release();const s=new AnimationGroupPreviewUI(e);this._groupBuffer.push(e),this._previewMap.set(e,s),this._previewContainer.appendChild(s.element),s.removeButton().addEventListener("click",this._removeAnimationGroup.bind(this,e)),s.element.addEventListener("click",this._selectAnimationGroup.bind(this,e)),s.element.addEventListener("keydown",this._handleAnimationGroupKeyDown.bind(this,e)),UI.ARIAUtils.setAccessibleName(s.element,ls`Animation Preview ${this._groupBuffer.indexOf(e)+1}`),UI.ARIAUtils.markAsOption(s.element),1===this._previewMap.size&&(this._previewMap.get(this._groupBuffer[0]).element.tabIndex=0)}_handleAnimationGroupKeyDown(e,t){switch(t.key){case" ":case"Enter":this._selectAnimationGroup(e);break;case"Backspace":case"Delete":this._removeAnimationGroup(e,t);break;case"ArrowLeft":case"ArrowUp":this._focusNextGroup(e,t.target,!0);break;case"ArrowRight":case"ArrowDown":this._focusNextGroup(e,t.target)}}_focusNextGroup(e,t,i){const s=this._groupBuffer.indexOf(e),n=i?s-1:s+1;if(n<0||n>=this._groupBuffer.length)return;const r=this._previewMap.get(this._groupBuffer[n]);r.element.tabIndex=0,r.element.focus(),t.tabIndex=-1}_removeAnimationGroup(e,t){const i=this._groupBuffer.indexOf(e);Platform.ArrayUtilities.removeElement(this._groupBuffer,e),this._previewMap.get(e).element.remove(),this._previewMap.delete(e),e.release(),t.consume(!0),this._selectedGroup===e&&(this._clearTimeline(),this._renderGrid());if(0===this._groupBuffer.length)return void this._clearButton.element.focus();const s=i>=this._groupBuffer.length?this._previewMap.get(this._groupBuffer[this._groupBuffer.length-1]):this._previewMap.get(this._groupBuffer[i]);s.element.tabIndex=0,s.element.focus()}_selectAnimationGroup(e){if(this._selectedGroup===e)return this._togglePause(!1),void this._replay();this._clearTimeline(),this._selectedGroup=e,this._previewMap.forEach((function(e,t){e.element.classList.toggle("selected",this._selectedGroup===t)}),this),this.setDuration(Math.max(500,e.finiteDuration()+100));for(const t of e.animations())this._addAnimation(t);this.scheduleRedraw(),this._timelineScrubber.classList.remove("hidden"),this._togglePause(!1),this._replay()}_addAnimation(e){let t=this._nodesMap.get(e.source().backendNodeId());t||(t=new NodeUI(e.source()),this._animationsContainer.appendChild(t.element),this._nodesMap.set(e.source().backendNodeId(),t));const i=t.createNewRow(),s=new AnimationUI(e,this,i);e.source().deferredNode().resolve(function(e){t.nodeResolved(e),s.setNode(e),e&&(e[this._symbol]=t)}.bind(this)),this._uiAnimations.push(s),this._animationsMap.set(e.id(),e)}_nodeRemoved(e){const t=e.data.node;t[this._symbol]&&t[this._symbol].nodeRemoved()}_renderGrid(){this._grid.setAttribute("width",this.width()+10),this._grid.setAttribute("height",this._cachedTimelineHeight+30),this._grid.setAttribute("shape-rendering","crispEdges"),this._grid.removeChildren();let e=void 0;for(let e=0;e<this.duration();e+=250){const t=this._grid.createSVGChild("rect","animation-timeline-grid-line");t.setAttribute("x",e*this.pixelMsRatio()+10),t.setAttribute("y",23),t.setAttribute("height","100%"),t.setAttribute("width",1)}for(let t=0;t<this.duration();t+=250){const i=t*this.pixelMsRatio();if(void 0===e||i-e>50){e=i;const s=this._grid.createSVGChild("text","animation-timeline-grid-label");s.textContent=Number.millisToString(t),s.setAttribute("x",i+10),s.setAttribute("y",16)}}}scheduleRedraw(){this._renderQueue=[];for(const e of this._uiAnimations)this._renderQueue.push(e);this._redrawing||(this._redrawing=!0,this._renderGrid(),this._animationsContainer.window().requestAnimationFrame(this._render.bind(this)))}_render(e){for(;this._renderQueue.length&&(!e||window.performance.now()-e<50);)this._renderQueue.shift().redraw();this._renderQueue.length?this._animationsContainer.window().requestAnimationFrame(this._render.bind(this)):delete this._redrawing}onResize(){this._cachedTimelineWidth=Math.max(0,this._animationsContainer.offsetWidth-this._timelineControlsWidth)||0,this._cachedTimelineHeight=this._animationsContainer.offsetHeight,this.scheduleRedraw(),this._scrubberPlayer&&this._syncScrubber(),delete this._gridOffsetLeft}width(){return this._cachedTimelineWidth||0}_resizeWindow(e){let t=!1;const i=e.source().duration()*Math.min(2,e.source().iterations()),s=e.source().delay()+i+e.source().endDelay();return s>this._duration&&(t=!0,this._duration=s+200),t}_syncScrubber(){this._selectedGroup&&this._selectedGroup.currentTimePromise().then(this._animateTime.bind(this)).then(this._updateControlButton.bind(this))}_animateTime(e){this._scrubberPlayer&&this._scrubberPlayer.cancel(),this._scrubberPlayer=this._timelineScrubber.animate([{transform:"translateX(0px)"},{transform:"translateX("+this.width()+"px)"}],{duration:this.duration(),fill:"forwards"}),this._scrubberPlayer.playbackRate=this._effectivePlaybackRate(),this._scrubberPlayer.onfinish=this._updateControlButton.bind(this),this._scrubberPlayer.currentTime=e,this.element.window().requestAnimationFrame(this._updateScrubber.bind(this))}pixelMsRatio(){return this.width()/this.duration()||0}_updateScrubber(e){this._scrubberPlayer&&(this._currentTime.textContent=Number.millisToString(this._scrubberPlayer.currentTime),"pending"===this._scrubberPlayer.playState||"running"===this._scrubberPlayer.playState?this.element.window().requestAnimationFrame(this._updateScrubber.bind(this)):"finished"===this._scrubberPlayer.playState&&(this._currentTime.textContent=""))}_repositionScrubber(e){if(!this._selectedGroup)return!1;this._gridOffsetLeft||(this._gridOffsetLeft=this._grid.totalOffsetLeft()+10);const t=Math.max(0,e.x-this._gridOffsetLeft)/this.pixelMsRatio();return this._selectedGroup.seekTo(t),this._togglePause(!0),this._animateTime(t),this._originalScrubberTime=t,this._originalMousePosition=e.x,!0}_scrubberDragStart(e){return!(!this._scrubberPlayer||!this._selectedGroup)&&(this._originalScrubberTime=this._scrubberPlayer.currentTime,this._timelineScrubber.classList.remove("animation-timeline-end"),this._scrubberPlayer.pause(),this._originalMousePosition=e.x,this._togglePause(!0),!0)}_scrubberDragMove(e){const t=e.x-this._originalMousePosition,i=Math.max(0,Math.min(this._originalScrubberTime+t/this.pixelMsRatio(),this.duration()));this._scrubberPlayer.currentTime=i,this._currentTime.textContent=Number.millisToString(Math.round(i)),this._selectedGroup.seekTo(i)}_scrubberDragEnd(e){const t=Math.max(0,this._scrubberPlayer.currentTime);this._scrubberPlayer.play(),this._scrubberPlayer.currentTime=t,this._currentTime.window().requestAnimationFrame(this._updateScrubber.bind(this))}}export const GlobalPlaybackRates=[1,.25,.1];export const _ControlState={Play:"play-outline",Replay:"replay-outline",Pause:"pause-outline"};export class NodeUI{constructor(e){this.element=createElementWithClass("div","animation-node-row"),this._description=this.element.createChild("div","animation-node-description"),this._description.tabIndex=0,this._timelineElement=this.element.createChild("div","animation-node-timeline"),UI.ARIAUtils.markAsApplication(this._timelineElement)}nodeResolved(e){e?(this._node=e,this._nodeChanged(),Common.Linkifier.Linkifier.linkify(e,{preventKeyboardFocus:!0}).then(t=>{this._description.appendChild(t),this._description.addEventListener("keydown",t=>{isEnterOrSpaceKey(t)&&this._node&&(Common.Revealer.reveal(e,!1),t.consume(!0))})}),e.ownerDocument||this.nodeRemoved()):this._description.createTextChild("<node>")}createNewRow(){return this._timelineElement.createChild("div","animation-timeline-row")}nodeRemoved(){this.element.classList.add("animation-node-removed"),this._node=null}_nodeChanged(){this.element.classList.toggle("animation-node-selected",this._node&&this._node===self.UI.context.flavor(SDK.DOMModel.DOMNode))}}export class StepTimingFunction{constructor(e,t){this.steps=e,this.stepAtPosition=t}static parse(e){let t=e.match(/^steps\((\d+), (start|middle)\)$/);return t?new StepTimingFunction(parseInt(t[1],10),t[2]):(t=e.match(/^steps\((\d+)\)$/),t?new StepTimingFunction(parseInt(t[1],10),"end"):null)}}