import{cssMetadata,VariableRegex}from"./CSSMetadata.js";import{CSSModel}from"./CSSModel.js";import{CSSProperty}from"./CSSProperty.js";import{CSSKeyframesRule,CSSStyleRule}from"./CSSRule.js";import{CSSStyleDeclaration,Type}from"./CSSStyleDeclaration.js";import{DOMNode}from"./DOMModel.js";export class CSSMatchedStyles{constructor(e,t,s,r,i,a,o,n){this._cssModel=e,this._node=t,this._addedStyles=new Map,this._matchingSelectors=new Map,this._keyframes=[],n&&(this._keyframes=n.map(t=>new CSSKeyframesRule(e,t))),this._nodeForStyle=new Map,this._inheritedStyles=new Set,i=l(i);for(const e of o)e.matchedCSSRules=l(e.matchedCSSRules);this._mainDOMCascade=this._buildMainCascade(s,r,i,o),this._pseudoDOMCascades=this._buildPseudoCascades(a),this._styleToDOMCascade=new Map;for(const e of Array.from(this._pseudoDOMCascades.values()).concat(this._mainDOMCascade))for(const t of e.styles())this._styleToDOMCascade.set(t,e);function l(e){for(const t of e)i(t);const t=[];for(const i of e){const e=t.peekLast();e&&"user-agent"===i.rule.origin&&"user-agent"===e.rule.origin&&i.rule.selectorList.text===e.rule.selectorList.text&&r(i)===r(e)?s(i,e):t.push(i)}return t;function s(e,t){const s=new Map,r=new Map;for(const e of t.rule.style.shorthandEntries)s.set(e.name,e.value);for(const e of t.rule.style.cssProperties)r.set(e.name,e.value);for(const t of e.rule.style.shorthandEntries)s.set(t.name,t.value);for(const t of e.rule.style.cssProperties)r.set(t.name,t.value);t.rule.style.shorthandEntries=[...s.keys()].map(e=>({name:e,value:s.get(e)})),t.rule.style.cssProperties=[...r.keys()].map(e=>({name:e,value:r.get(e)}))}function r(e){return e.rule.media?e.rule.media.map(e=>e.text).join(", "):null}function i(e){const{matchingSelectors:t,rule:s}=e;"user-agent"===s.origin&&t.length&&(s.selectorList.selectors=s.selectorList.selectors.filter((e,s)=>t.includes(s)),s.selectorList.text=s.selectorList.selectors.map(e=>e.text).join(", "),e.matchingSelectors=t.map((e,t)=>t))}}}_buildMainCascade(e,t,s,r){const i=[],a=[];function o(){if(!t)return;const e=new CSSStyleDeclaration(this._cssModel,null,t,Type.Attributes);this._nodeForStyle.set(e,this._node),a.push(e)}if(e&&this._node.nodeType()===Node.ELEMENT_NODE){const t=new CSSStyleDeclaration(this._cssModel,null,e,Type.Inline);this._nodeForStyle.set(t,this._node),a.push(t)}let n;for(let e=s.length-1;e>=0;--e){const t=new CSSStyleRule(this._cssModel,s[e].rule);!t.isInjected()&&!t.isUserAgent()||n||(n=!0,o.call(this)),this._nodeForStyle.set(t.style,this._node),a.push(t.style),this._addMatchingSelectors(this._node,t,s[e].matchingSelectors)}n||o.call(this),i.push(new NodeCascade(this,a,!1));let l=this._node.parentNode;for(let e=0;l&&r&&e<r.length;++e){const t=[],s=r[e],o=s.inlineStyle?new CSSStyleDeclaration(this._cssModel,null,s.inlineStyle,Type.Inline):null;o&&this._containsInherited(o)&&(this._nodeForStyle.set(o,l),t.push(o),this._inheritedStyles.add(o));const n=s.matchedCSSRules||[];for(let e=n.length-1;e>=0;--e){const s=new CSSStyleRule(this._cssModel,n[e].rule);this._addMatchingSelectors(l,s,n[e].matchingSelectors),this._containsInherited(s.style)&&(c(a,s.style)||c(this._inheritedStyles,s.style)||(this._nodeForStyle.set(s.style,l),t.push(s.style),this._inheritedStyles.add(s.style)))}l=l.parentNode,i.push(new NodeCascade(this,t,!0))}return new DOMInheritanceCascade(i);function c(e,t){if(!t.styleSheetId||!t.range)return!1;for(const s of e)if(t.styleSheetId===s.styleSheetId&&s.range&&t.range.equal(s.range))return!0;return!1}}_buildPseudoCascades(e){const t=new Map;if(!e)return t;for(let s=0;s<e.length;++s){const r=e[s],i=this._node.pseudoElements().get(r.pseudoType)||null,a=[],o=r.matches||[];for(let e=o.length-1;e>=0;--e){const t=new CSSStyleRule(this._cssModel,o[e].rule);a.push(t.style),this._nodeForStyle.set(t.style,i),i&&this._addMatchingSelectors(i,t,o[e].matchingSelectors)}const n=new NodeCascade(this,a,!1);t.set(r.pseudoType,new DOMInheritanceCascade([n]))}return t}_addMatchingSelectors(e,t,s){for(const r of s){const s=t.selectors[r];this._setSelectorMatches(e,s.text,!0)}}node(){return this._node}cssModel(){return this._cssModel}hasMatchingSelectors(e){return this.matchingSelectors(e).length>0&&this.mediaMatches(e.style)}matchingSelectors(e){const t=this.nodeForStyle(e.style);if(!t)return[];const s=this._matchingSelectors.get(t.id);if(!s)return[];const r=[];for(let t=0;t<e.selectors.length;++t)s.get(e.selectors[t].text)&&r.push(t);return r}recomputeMatchingSelectors(e){const t=this.nodeForStyle(e.style);if(!t)return Promise.resolve();const s=[];for(const i of e.selectors)s.push(r.call(this,t,i.text));return Promise.all(s);async function r(e,t){const s=e.ownerDocument||null,r=this._matchingSelectors.get(e.id);if(r&&r.has(t)||!s)return;const i=await this._node.domModel().querySelectorAll(s.id,t);i&&this._setSelectorMatches(e,t,-1!==i.indexOf(e.id))}}addNewRule(e,t){return this._addedStyles.set(e.style,t),this.recomputeMatchingSelectors(e)}_setSelectorMatches(e,t,s){let r=this._matchingSelectors.get(e.id);r||(r=new Map,this._matchingSelectors.set(e.id,r)),r.set(t,s)}mediaMatches(e){const t=e.parentRule?e.parentRule.media:[];for(let e=0;t&&e<t.length;++e)if(!t[e].active())return!1;return!0}nodeStyles(){return this._mainDOMCascade.styles()}keyframes(){return this._keyframes}pseudoStyles(e){const t=this._pseudoDOMCascades.get(e);return t?t.styles():[]}pseudoTypes(){return new Set(this._pseudoDOMCascades.keys())}_containsInherited(e){const t=e.allProperties();for(let e=0;e<t.length;++e){const s=t[e];if(s.activeInStyle()&&cssMetadata().isPropertyInherited(s.name))return!0}return!1}nodeForStyle(e){return this._addedStyles.get(e)||this._nodeForStyle.get(e)||null}availableCSSVariables(e){const t=this._styleToDOMCascade.get(e)||null;return t?t.availableCSSVariables(e):[]}computeCSSVariable(e,t){const s=this._styleToDOMCascade.get(e)||null;return s?s.computeCSSVariable(e,t):null}computeValue(e,t){const s=this._styleToDOMCascade.get(e)||null;return s?s.computeValue(e,t):null}isInherited(e){return this._inheritedStyles.has(e)}propertyState(e){const t=this._styleToDOMCascade.get(e.ownerStyle);return t?t.propertyState(e):null}resetActiveProperties(){this._mainDOMCascade.reset();for(const e of this._pseudoDOMCascades.values())e.reset()}}class NodeCascade{constructor(e,t,s){this._matchedStyles=e,this._styles=t,this._isInherited=s,this._propertiesState=new Map,this._activeProperties=new Map}_computeActiveProperties(){this._propertiesState.clear(),this._activeProperties.clear();for(const e of this._styles){const t=e.parentRule;if((!t||t instanceof CSSStyleRule)&&(!t||this._matchedStyles.hasMatchingSelectors(t)))for(const t of e.allProperties()){if(this._isInherited&&!cssMetadata().isPropertyInherited(t.name))continue;if(!t.activeInStyle()){this._propertiesState.set(t,PropertyState.Overloaded);continue}const e=cssMetadata().canonicalPropertyName(t.name),s=this._activeProperties.get(e);!s||!s.important&&t.important?(s&&this._propertiesState.set(s,PropertyState.Overloaded),this._propertiesState.set(t,PropertyState.Active),this._activeProperties.set(e,t)):this._propertiesState.set(t,PropertyState.Overloaded)}}}}class DOMInheritanceCascade{constructor(e){this._nodeCascades=e,this._propertiesState=new Map,this._availableCSSVariables=new Map,this._computedCSSVariables=new Map,this._initialized=!1,this._styleToNodeCascade=new Map;for(const t of e)for(const e of t._styles)this._styleToNodeCascade.set(e,t)}availableCSSVariables(e){const t=this._styleToNodeCascade.get(e);return t?(this._ensureInitialized(),Array.from(this._availableCSSVariables.get(t).keys())):[]}computeCSSVariable(e,t){const s=this._styleToNodeCascade.get(e);if(!s)return null;this._ensureInitialized();const r=this._availableCSSVariables.get(s),i=this._computedCSSVariables.get(s);return this._innerComputeCSSVariable(r,i,t)}computeValue(e,t){const s=this._styleToNodeCascade.get(e);if(!s)return null;this._ensureInitialized();const r=this._availableCSSVariables.get(s),i=this._computedCSSVariables.get(s);return this._innerComputeValue(r,i,t)}_innerComputeCSSVariable(e,t,s){if(!e.has(s))return null;if(t.has(s))return t.get(s);t.set(s,null);const r=e.get(s),i=this._innerComputeValue(e,t,r);return t.set(s,i),i}_innerComputeValue(e,t,s){const r=TextUtils.TextUtils.splitStringByRegexes(s,[VariableRegex]),i=[];for(const s of r){if(-1===s.regexIndex){i.push(s.value);continue}const r=s.value.match(/^var\((--[a-zA-Z0-9-_]+)[,]?\s*(.*)\)$/);if(!r)return null;const a=r[1],o=this._innerComputeCSSVariable(e,t,a);if(null===o&&!r[2])return null;null===o?i.push(r[2]):i.push(o)}return i.map(e=>e.trim()).join(" ")}styles(){return Array.from(this._styleToNodeCascade.keys())}propertyState(e){return this._ensureInitialized(),this._propertiesState.get(e)||null}reset(){this._initialized=!1,this._propertiesState.clear(),this._availableCSSVariables.clear(),this._computedCSSVariables.clear()}_ensureInitialized(){if(this._initialized)return;this._initialized=!0;const e=new Map;for(const t of this._nodeCascades){t._computeActiveProperties();for(const s of t._propertiesState.entries()){const t=s[0];if(s[1]===PropertyState.Overloaded){this._propertiesState.set(t,PropertyState.Overloaded);continue}const r=cssMetadata().canonicalPropertyName(t.name);e.has(r)?this._propertiesState.set(t,PropertyState.Overloaded):(e.set(r,t),this._propertiesState.set(t,PropertyState.Active))}}for(const t of e.entries()){const s=t[0],r=t[1],i=r.ownerStyle,a=i.longhandProperties(r.name);if(!a.length)continue;let o=!1;for(const t of a){const s=cssMetadata().canonicalPropertyName(t.name),r=e.get(s);if(r&&r.ownerStyle===i){o=!0;break}}o||(e.delete(s),this._propertiesState.set(r,PropertyState.Overloaded))}const t=new Map;for(let e=this._nodeCascades.length-1;e>=0;--e){const s=this._nodeCascades[e];for(const e of s._activeProperties.entries()){const s=e[0],r=e[1];s.startsWith("--")&&t.set(s,r.value)}this._availableCSSVariables.set(s,new Map(t)),this._computedCSSVariables.set(s,new Map)}}}export const PropertyState={Active:"Active",Overloaded:"Overloaded"};