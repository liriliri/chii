import*as Components from"../components/components.js";import*as UI from"../ui/ui.js";export class ConsoleViewport{constructor(e){this.element=createElement("div"),this.element.style.overflow="auto",this._topGapElement=this.element.createChild("div"),this._topGapElement.style.height="0px",this._topGapElement.style.color="transparent",this._contentElement=this.element.createChild("div"),this._bottomGapElement=this.element.createChild("div"),this._bottomGapElement.style.height="0px",this._bottomGapElement.style.color="transparent",this._topGapElement.textContent="\ufeff",this._bottomGapElement.textContent="\ufeff",UI.ARIAUtils.markAsHidden(this._topGapElement),UI.ARIAUtils.markAsHidden(this._bottomGapElement),this._provider=e,this.element.addEventListener("scroll",this._onScroll.bind(this),!1),this.element.addEventListener("copy",this._onCopy.bind(this),!1),this.element.addEventListener("dragstart",this._onDragStart.bind(this),!1),this._contentElement.addEventListener("focusin",this._onFocusIn.bind(this),!1),this._contentElement.addEventListener("focusout",this._onFocusOut.bind(this),!1),this._contentElement.addEventListener("keydown",this._onKeyDown.bind(this),!1),this._virtualSelectedIndex=-1,this._contentElement.tabIndex=-1,this._firstActiveIndex=-1,this._lastActiveIndex=-1,this._renderedItems=[],this._anchorSelection=null,this._headSelection=null,this._itemCount=0,this._cumulativeHeights=new Int32Array(0),this._muteCopyHandler=!1,this._observer=new MutationObserver(this.refresh.bind(this)),this._observerConfig={childList:!0,subtree:!0}}stickToBottom(){return this._stickToBottom}setStickToBottom(e){this._stickToBottom=e,this._stickToBottom?this._observer.observe(this._contentElement,this._observerConfig):this._observer.disconnect()}hasVirtualSelection(){return-1!==this._virtualSelectedIndex}copyWithStyles(){this._muteCopyHandler=!0,this.element.ownerDocument.execCommand("copy"),this._muteCopyHandler=!1}_onCopy(e){if(this._muteCopyHandler)return;const t=this._selectedText();t&&(e.preventDefault(),e.clipboardData.setData("text/plain",t))}_onFocusIn(e){const t=this._renderedItems.findIndex(t=>t.element().isSelfOrAncestor(e.target));-1!==t&&(this._virtualSelectedIndex=this._firstActiveIndex+t);let i=!1;-1===this._virtualSelectedIndex&&this._isOutsideViewport(e.relatedTarget)&&e.target===this._contentElement&&this._itemCount&&(i=!0,this._virtualSelectedIndex=this._itemCount-1,this.refresh(),this.scrollItemIntoView(this._virtualSelectedIndex)),this._updateFocusedItem(i)}_onFocusOut(e){this._isOutsideViewport(e.relatedTarget)&&(this._virtualSelectedIndex=-1),this._updateFocusedItem()}_isOutsideViewport(e){return!!e&&!e.isSelfOrDescendant(this._contentElement)}_onDragStart(e){const t=this._selectedText();return!!t&&(e.dataTransfer.clearData(),e.dataTransfer.setData("text/plain",t),e.dataTransfer.effectAllowed="copy",!0)}_onKeyDown(e){if(UI.UIUtils.isEditing()||!this._itemCount||e.shiftKey)return;let t=!1;switch(e.key){case"ArrowUp":if(!(this._virtualSelectedIndex>0))return;t=!0,this._virtualSelectedIndex--;break;case"ArrowDown":if(!(this._virtualSelectedIndex<this._itemCount-1))return;this._virtualSelectedIndex++;break;case"Home":this._virtualSelectedIndex=0;break;case"End":this._virtualSelectedIndex=this._itemCount-1;break;default:return}e.consume(!0),this.scrollItemIntoView(this._virtualSelectedIndex),this._updateFocusedItem(t)}_updateFocusedItem(e){const t=this.renderedElementAt(this._virtualSelectedIndex),i=this._lastSelectedElement!==t,s=this._contentElement===this.element.ownerDocument.deepActiveElement();this._lastSelectedElement&&i&&this._lastSelectedElement.classList.remove("console-selected"),t&&(e||i||s)&&this.element.hasFocus()&&(t.classList.add("console-selected"),e?(this.setStickToBottom(!1),this._renderedItems[this._virtualSelectedIndex-this._firstActiveIndex].focusLastChildOrSelf()):t.hasFocus()||t.focus({preventScroll:!0})),this._itemCount&&!this._contentElement.hasFocus()?this._contentElement.tabIndex=0:this._contentElement.tabIndex=-1,this._lastSelectedElement=t}contentElement(){return this._contentElement}invalidate(){delete this._cachedProviderElements,this._itemCount=this._provider.itemCount(),this._virtualSelectedIndex>this._itemCount-1&&(this._virtualSelectedIndex=this._itemCount-1),this._rebuildCumulativeHeights(),this.refresh()}_providerElement(e){this._cachedProviderElements||(this._cachedProviderElements=new Array(this._itemCount));let t=this._cachedProviderElements[e];return t||(t=this._provider.itemElement(e),this._cachedProviderElements[e]=t),t}_rebuildCumulativeHeights(){const e=this._firstActiveIndex,t=this._lastActiveIndex;let i=0;this._cumulativeHeights=new Int32Array(this._itemCount);for(let s=0;s<this._itemCount;++s)e<=s&&s-e<this._renderedItems.length&&s<=t?i+=this._renderedItems[s-e].element().offsetHeight:i+=this._provider.fastHeight(s),this._cumulativeHeights[s]=i}_rebuildCumulativeHeightsIfNeeded(){let e=0,t=0;for(let i=0;i<this._renderedItems.length;++i){const s=this._cachedItemHeight(this._firstActiveIndex+i),n=this._renderedItems[i].element().offsetHeight;if(Math.abs(s-n)>1)return void this._rebuildCumulativeHeights();if(t+=n,e+=s,Math.abs(e-t)>1)return void this._rebuildCumulativeHeights()}}_cachedItemHeight(e){return 0===e?this._cumulativeHeights[0]:this._cumulativeHeights[e]-this._cumulativeHeights[e-1]}_isSelectionBackwards(e){if(!e||!e.rangeCount)return!1;const t=document.createRange();return t.setStart(e.anchorNode,e.anchorOffset),t.setEnd(e.focusNode,e.focusOffset),t.collapsed}_createSelectionModel(e,t,i){return{item:e,node:t,offset:i}}_updateSelectionModel(e){const t=e&&e.rangeCount?e.getRangeAt(0):null;if(!t||e.isCollapsed||!this.element.hasSelection())return this._headSelection=null,this._anchorSelection=null,!1;let i=Number.MAX_VALUE,s=-1,n=!1;for(let e=0;e<this._renderedItems.length;++e)if(t.intersectsNode(this._renderedItems[e].element())){const t=e+this._firstActiveIndex;i=Math.min(i,t),s=Math.max(s,t),n=!0}n&&(i=this._createSelectionModel(i,t.startContainer,t.startOffset),s=this._createSelectionModel(s,t.endContainer,t.endOffset));const o=t.intersectsNode(this._topGapElement)&&this._topGapElement._active,h=t.intersectsNode(this._bottomGapElement)&&this._bottomGapElement._active;if(!o&&!h&&!n)return this._headSelection=null,this._anchorSelection=null,!1;this._anchorSelection&&this._headSelection||(this._anchorSelection=this._createSelectionModel(0,this.element,0),this._headSelection=this._createSelectionModel(this._itemCount-1,this.element,this.element.children.length),this._selectionIsBackward=!1);const l=this._isSelectionBackwards(e),r=this._selectionIsBackward?this._headSelection:this._anchorSelection,c=this._selectionIsBackward?this._anchorSelection:this._headSelection;return o&&h&&n?(i=i.item<r.item?i:r,s=s.item>c.item?s:c):n?o?i=l?this._headSelection:this._anchorSelection:h&&(s=l?this._anchorSelection:this._headSelection):(i=r,s=c),l?(this._anchorSelection=s,this._headSelection=i):(this._anchorSelection=i,this._headSelection=s),this._selectionIsBackward=l,!0}_restoreSelection(e){let t,i=null;this._firstActiveIndex<=this._anchorSelection.item&&this._anchorSelection.item<=this._lastActiveIndex?(i=this._anchorSelection.node,t=this._anchorSelection.offset):(this._anchorSelection.item<this._firstActiveIndex?i=this._topGapElement:this._anchorSelection.item>this._lastActiveIndex&&(i=this._bottomGapElement),t=this._selectionIsBackward?1:0);let s,n=null;this._firstActiveIndex<=this._headSelection.item&&this._headSelection.item<=this._lastActiveIndex?(n=this._headSelection.node,s=this._headSelection.offset):(this._headSelection.item<this._firstActiveIndex?n=this._topGapElement:this._headSelection.item>this._lastActiveIndex&&(n=this._bottomGapElement),s=this._selectionIsBackward?0:1),e.setBaseAndExtent(i,t,n,s)}refresh(){this._observer.disconnect(),this._innerRefresh(),this._stickToBottom&&this._observer.observe(this._contentElement,this._observerConfig)}_innerRefresh(){if(!this._visibleHeight())return;if(!this._itemCount){for(let e=0;e<this._renderedItems.length;++e)this._renderedItems[e].willHide();return this._renderedItems=[],this._contentElement.removeChildren(),this._topGapElement.style.height="0px",this._bottomGapElement.style.height="0px",this._firstActiveIndex=-1,this._lastActiveIndex=-1,void this._updateFocusedItem()}const e=this.element.getComponentSelection(),t=this._updateSelectionModel(e),i=this.element.scrollTop,s=this._visibleHeight(),n=2*s;this._rebuildCumulativeHeightsIfNeeded(),this._stickToBottom?(this._firstActiveIndex=Math.max(this._itemCount-Math.ceil(n/this._provider.minimumRowHeight()),0),this._lastActiveIndex=this._itemCount-1):(this._firstActiveIndex=Math.max(this._cumulativeHeights.lowerBound(i+1-(n-s)/2),0),this._lastActiveIndex=this._firstActiveIndex+Math.ceil(n/this._provider.minimumRowHeight())-1,this._lastActiveIndex=Math.min(this._lastActiveIndex,this._itemCount-1));const o=this._cumulativeHeights[this._firstActiveIndex-1]||0,h=this._cumulativeHeights[this._cumulativeHeights.length-1]-this._cumulativeHeights[this._lastActiveIndex];this._partialViewportUpdate(function(){this._topGapElement.style.height=o+"px",this._bottomGapElement.style.height=h+"px",this._topGapElement._active=!!o,this._bottomGapElement._active=!!h,this._contentElement.style.setProperty("height","10000000px")}.bind(this)),this._contentElement.style.removeProperty("height"),t&&this._restoreSelection(e),this._stickToBottom&&(this.element.scrollTop=1e7)}_partialViewportUpdate(e){const t=new Set;for(let e=this._firstActiveIndex;e<=this._lastActiveIndex;++e)t.add(this._providerElement(e));const i=this._renderedItems.filter(e=>!t.has(e));for(let e=0;e<i.length;++e)i[e].willHide();e();let s=!1;for(let e=0;e<i.length;++e)s=s||i[e].element().hasFocus(),i[e].element().remove();const n=[];let o=this._contentElement.firstChild;for(const e of t){const t=e.element();if(t!==o){!t.parentElement&&n.push(e),this._contentElement.insertBefore(t,o)}else o=o.nextSibling}for(let e=0;e<n.length;++e)n[e].wasShown();this._renderedItems=Array.from(t),s&&this._contentElement.focus(),this._updateFocusedItem()}_selectedText(){if(this._updateSelectionModel(this.element.getComponentSelection()),!this._headSelection||!this._anchorSelection)return null;let e=null,t=null;this._selectionIsBackward?(e=this._headSelection,t=this._anchorSelection):(e=this._anchorSelection,t=this._headSelection);const i=[];for(let s=e.item;s<=t.item;++s){const e=this._providerElement(s).element().childTextNodes().map(Components.Linkifier.Linkifier.untruncatedNodeText).join("");i.push(e)}const s=this._providerElement(t.item).element();if(t.node&&t.node.isSelfOrDescendant(s)){const e=this._textOffsetInNode(s,t.node,t.offset);i[i.length-1]=i.peekLast().substring(0,e)}const n=this._providerElement(e.item).element();if(e.node&&e.node.isSelfOrDescendant(n)){const t=this._textOffsetInNode(n,e.node,e.offset);i[0]=i[0].substring(t)}return i.join("\n")}_textOffsetInNode(e,t,i){t.nodeType!==Node.TEXT_NODE&&(i<t.childNodes.length?(t=t.childNodes.item(i),i=0):i=t.textContent.length);let s=0,n=e;for(;(n=n.traverseNextNode(e))&&n!==t;)n.nodeType===Node.TEXT_NODE&&"STYLE"!==n.parentElement.nodeName&&"SCRIPT"!==n.parentElement.nodeName&&(s+=Components.Linkifier.Linkifier.untruncatedNodeText(n).length);const o=Components.Linkifier.Linkifier.untruncatedNodeText(t).length;return i>0&&o!==t.textContent.length&&(i=o),s+i}_onScroll(e){this.refresh()}firstVisibleIndex(){return this._cumulativeHeights.length?(this._rebuildCumulativeHeightsIfNeeded(),this._cumulativeHeights.lowerBound(this.element.scrollTop+1)):-1}lastVisibleIndex(){if(!this._cumulativeHeights.length)return-1;this._rebuildCumulativeHeightsIfNeeded();const e=this.element.scrollTop+this.element.clientHeight,t=this._itemCount-1;return this._cumulativeHeights.lowerBound(e,void 0,void 0,t)}renderedElementAt(e){return-1===e||e<this._firstActiveIndex||e>this._lastActiveIndex?null:this._renderedItems[e-this._firstActiveIndex].element()}scrollItemIntoView(e,t){const i=this.firstVisibleIndex(),s=this.lastVisibleIndex();e>i&&e<s||e===s&&this._cumulativeHeights[e]<=this.element.scrollTop+this._visibleHeight()||(t?this.forceScrollItemToBeLast(e):e<=i?this.forceScrollItemToBeFirst(e):e>=s&&this.forceScrollItemToBeLast(e))}forceScrollItemToBeFirst(e){console.assert(e>=0&&e<this._itemCount,"Cannot scroll item at invalid index"),this.setStickToBottom(!1),this._rebuildCumulativeHeightsIfNeeded(),this.element.scrollTop=e>0?this._cumulativeHeights[e-1]:0,this.element.isScrolledToBottom()&&this.setStickToBottom(!0),this.refresh(),this.renderedElementAt(e).scrollIntoView(!0)}forceScrollItemToBeLast(e){console.assert(e>=0&&e<this._itemCount,"Cannot scroll item at invalid index"),this.setStickToBottom(!1),this._rebuildCumulativeHeightsIfNeeded(),this.element.scrollTop=this._cumulativeHeights[e]-this._visibleHeight(),this.element.isScrolledToBottom()&&this.setStickToBottom(!0),this.refresh(),this.renderedElementAt(e).scrollIntoView(!1)}_visibleHeight(){return this.element.offsetHeight}}export class ConsoleViewportProvider{fastHeight(e){return 0}itemCount(){return 0}minimumRowHeight(){return 0}itemElement(e){return null}}export class ConsoleViewportElement{willHide(){}wasShown(){}element(){}}