import*as Common from"../common/common.js";import*as Components from"../components/components.js";import*as DataGrid from"../data_grid/data_grid.js";import*as ObjectUI from"../object_ui/object_ui.js";import*as Platform from"../platform/platform.js";import*as SDK from"../sdk/sdk.js";import*as TextUtils from"../text_utils/text_utils.js";import*as UI from"../ui/ui.js";import{ConsoleViewportElement}from"./ConsoleViewport.js";export class ConsoleViewMessage{constructor(e,t,s,n){this._message=e,this._linkifier=t,this._repeatCount=1,this._closeGroupDecorationCount=0,this._nestingLevel=s,this._selectableChildren=[],this._messageResized=n,this._dataGrid=null,this._previewFormatter=new ObjectUI.RemoteObjectPreviewFormatter.RemoteObjectPreviewFormatter,this._searchRegex=null,this._messageLevelIcon=null,this._traceExpanded=!1,this._expandTrace=null,this._anchorElement=null}element(){return this.toMessageElement()}wasShown(){this._dataGrid&&this._dataGrid.updateWidths(),this._isVisible=!0}onResize(){this._isVisible&&this._dataGrid&&this._dataGrid.onResize()}willHide(){this._isVisible=!1,this._cachedHeight=this.element().offsetHeight}fastHeight(){if(this._cachedHeight)return this._cachedHeight;if(this._message.type===SDK.ConsoleModel.MessageType.Table){const e=this._message.parameters[0];if(e&&e.preview)return 19*e.preview.properties.length}return 19}consoleMessage(){return this._message}_buildTableMessage(){const e=createElementWithClass("span","source-code");this._anchorElement=this._buildMessageAnchor(),this._anchorElement&&e.appendChild(this._anchorElement);let t=this._message.parameters&&this._message.parameters.length?this._message.parameters[0]:null;if(t&&(t=this._parameterToRemoteObject(t)),!t||!t.preview)return this._buildMessage();const s=Symbol("rawValueColumn"),n=[],i=t.preview,r=[];for(let e=0;e<i.properties.length;++e){const o=i.properties[e];let a;if(o.valuePreview)a=o.valuePreview.properties;else{if(!o.value)continue;a=[{name:s,type:o.type,value:o.value}]}const l={},c=20;for(let e=0;e<a.length;++e){const s=a[e];let i=-1!==n.indexOf(s.name);if(!i){if(n.length===c)continue;i=!0,n.push(s.name)}if(i){const e=this._renderPropertyPreviewOrAccessor(t,[o,s]);e.classList.add("console-message-nowrap-below"),l[s.name]=e}}r.push([o.name,l])}const o=[];for(let e=0;e<r.length;++e){const t=r[e][0],s=r[e][1];o.push(t);for(let e=0;e<n.length;++e)o.push(s[n[e]])}n.unshift(Common.UIString.UIString("(index)"));const a=n.map(e=>e===s?Common.UIString.UIString("Value"):e);if(o.length){this._dataGrid=DataGrid.SortableDataGrid.SortableDataGrid.create(a,o,ls`Console`),this._dataGrid.setStriped(!0),this._dataGrid.setFocusable(!1);const s=createElementWithClass("span","console-message-text"),n=s.createChild("div","console-message-formatted-table"),i=n.createChild("span");n.appendChild(this._formatParameter(t,!0,!1)),i.appendChild(this._dataGrid.element),e.appendChild(s),this._dataGrid.renderInline()}return e}_buildMessage(){let e,t=this._message.messageText;if(this._message.source===SDK.ConsoleModel.MessageSource.ConsoleAPI)switch(this._message.type){case SDK.ConsoleModel.MessageType.Trace:e=this._format(this._message.parameters||["console.trace"]);break;case SDK.ConsoleModel.MessageType.Clear:e=createElementWithClass("span","console-info"),Common.Settings.Settings.instance().moduleSetting("preserveConsoleLog").get()?e.textContent=Common.UIString.UIString("console.clear() was prevented due to 'Preserve log'"):e.textContent=Common.UIString.UIString("Console was cleared"),e.title=ls`Clear all messages with ${self.UI.shortcutRegistry.shortcutTitleForAction("console.clear")}`;break;case SDK.ConsoleModel.MessageType.Dir:{const t=["%O",this._message.parameters?this._message.parameters[0]:void 0];e=this._format(t);break}case SDK.ConsoleModel.MessageType.Profile:case SDK.ConsoleModel.MessageType.ProfileEnd:e=this._format([t]);break;case SDK.ConsoleModel.MessageType.Assert:this._messagePrefix=ls`Assertion failed: `;default:{this._message.parameters&&1===this._message.parameters.length&&"string"===this._message.parameters[0].type&&(e=this._tryFormatAsError(this._message.parameters[0].value));const s=this._message.parameters||[t];e=e||this._format(s)}}else if(this._message.source===SDK.ConsoleModel.MessageSource.Network)e=this._formatAsNetworkRequest()||this._format([t]);else{const s=this._message.parameters&&t===this._message.parameters[0];this._message.source===SDK.ConsoleModel.MessageSource.Violation?t=Common.UIString.UIString("[Violation] %s",t):this._message.source===SDK.ConsoleModel.MessageSource.Intervention?t=Common.UIString.UIString("[Intervention] %s",t):this._message.source===SDK.ConsoleModel.MessageSource.Deprecation&&(t=Common.UIString.UIString("[Deprecation] %s",t));const n=this._message.parameters||[t];s&&(n[0]=t),e=this._format(n)}e.classList.add("console-message-text");const s=createElementWithClass("span","source-code");return this._anchorElement=this._buildMessageAnchor(),this._anchorElement&&s.appendChild(this._anchorElement),s.appendChild(e),s}_formatAsNetworkRequest(){const e=SDK.NetworkLog.NetworkLog.requestForConsoleMessage(this._message);if(!e)return null;const t=createElement("span");if(this._message.level===SDK.ConsoleModel.MessageLevel.Error){t.createTextChild(e.requestMethod+" ");const s=Components.Linkifier.Linkifier.linkifyRevealable(e,e.url(),e.url());s.tabIndex=-1,this._selectableChildren.push({element:s,forceSelect:()=>s.focus()}),t.appendChild(s),e.failed&&t.createTextChildren(" ",e.localizedFailDescription),0!==e.statusCode&&t.createTextChildren(" ",String(e.statusCode)),e.statusText&&t.createTextChildren(" (",e.statusText,")")}else{const s=this._message.messageText,n=this._linkifyWithCustomLinkifier(s,(t,s,n,i)=>{let r;return r=s===e.url()?Components.Linkifier.Linkifier.linkifyRevealable(e,s,e.url()):Components.Linkifier.Linkifier.linkifyURL(s,{text:t,lineNumber:n,columnNumber:i}),r.tabIndex=-1,this._selectableChildren.push({element:r,forceSelect:()=>r.focus()}),r});t.appendChild(n)}return t}_buildMessageAnchor(){let e=null;if(this._message.scriptId?e=this._linkifyScriptId(this._message.scriptId,this._message.url||"",this._message.line,this._message.column):this._message.stackTrace&&this._message.stackTrace.callFrames.length?e=this._linkifyStackTraceTopFrame(this._message.stackTrace):this._message.url&&"undefined"!==this._message.url&&(e=this._linkifyLocation(this._message.url,this._message.line,this._message.column)),e){e.tabIndex=-1,this._selectableChildren.push({element:e,forceSelect:()=>e.focus()});const t=createElementWithClass("span","console-message-anchor");return t.appendChild(e),t.createTextChild(" "),t}return null}_buildMessageWithStackTrace(){const e=createElementWithClass("div","console-message-stack-trace-toggle"),t=e.createChild("div","console-message-stack-trace-wrapper"),s=this._buildMessage(),n=UI.Icon.Icon.create("smallicon-triangle-right","console-message-expand-icon"),i=t.createChild("div");i.appendChild(n),i.tabIndex=-1,i.appendChild(s);const r=t.createChild("div"),o=Components.JSPresentationUtils.buildStackTracePreviewContents(this._message.runtimeModel().target(),this._linkifier,{stackTrace:this._message.stackTrace});r.appendChild(o.element);for(const e of o.links)this._selectableChildren.push({element:e,forceSelect:()=>e.focus()});return r.classList.add("hidden"),UI.ARIAUtils.markAsTreeitem(this.element()),UI.ARIAUtils.setExpanded(this.element(),!1),this._expandTrace=e=>{n.setIconType(e?"smallicon-triangle-down":"smallicon-triangle-right"),r.classList.toggle("hidden",!e),UI.ARIAUtils.setExpanded(this.element(),e),this._traceExpanded=e},i.addEventListener("click",function(e){UI.UIUtils.isEditing()||t.hasSelection()||(this._expandTrace(r.classList.contains("hidden")),e.consume())}.bind(this),!1),this._message.type===SDK.ConsoleModel.MessageType.Trace&&this._expandTrace(!0),e._expandStackTraceForTest=this._expandTrace.bind(this,!0),e}_linkifyLocation(e,t,s){return this._message.runtimeModel()?this._linkifier.linkifyScriptLocation(this._message.runtimeModel().target(),null,e,t,{columnNumber:s}):null}_linkifyStackTraceTopFrame(e){return this._message.runtimeModel()?this._linkifier.linkifyStackTraceTopFrame(this._message.runtimeModel().target(),e):null}_linkifyScriptId(e,t,s,n){return this._message.runtimeModel()?this._linkifier.linkifyScriptLocation(this._message.runtimeModel().target(),e,t,s,{columnNumber:n}):null}_parameterToRemoteObject(e){if(e instanceof SDK.RemoteObject.RemoteObject)return e;const t=this._message.runtimeModel();return t?"object"==typeof e?t.createRemoteObject(e):t.createRemoteObjectFromPrimitiveValue(e):SDK.RemoteObject.RemoteObject.fromLocalObject(e)}_format(e){const t=createElement("span");if(this._messagePrefix&&(t.createChild("span").textContent=this._messagePrefix),!e.length)return t;let s=[];for(let t=0;t<e.length;++t)s[t]=this._parameterToRemoteObject(e[t]);const n="string"===SDK.RemoteObject.RemoteObject.type(s[0])&&(this._message.type!==SDK.ConsoleModel.MessageType.Result||this._message.level===SDK.ConsoleModel.MessageLevel.Error);if(n){const e=this._formatWithSubstitutionString(s[0].description,s.slice(1),t);s=e.unusedSubstitutions,s.length&&t.createTextChild(" ")}for(let e=0;e<s.length;++e)n&&"string"===s[e].type?t.appendChild(this._linkifyStringAsFragment(s[e].description)):t.appendChild(this._formatParameter(s[e],!1,!0)),e<s.length-1&&t.createTextChild(" ");return t}_formatParameter(e,t,s){if(e.customPreview())return new ObjectUI.CustomPreviewComponent.CustomPreviewComponent(e).element;const n=t?"object":e.subtype||e.type;let i;switch(n){case"error":i=this._formatParameterAsError(e);break;case"function":i=this._formatParameterAsFunction(e,s);break;case"array":case"arraybuffer":case"blob":case"dataview":case"generator":case"iterator":case"map":case"object":case"promise":case"proxy":case"set":case"typedarray":case"weakmap":case"weakset":i=this._formatParameterAsObject(e,s);break;case"node":i=e.isNode()?this._formatParameterAsNode(e):this._formatParameterAsObject(e,!1);break;case"string":i=this._formatParameterAsString(e);break;case"boolean":case"date":case"null":case"number":case"regexp":case"symbol":case"undefined":case"bigint":i=this._formatParameterAsValue(e);break;default:i=this._formatParameterAsValue(e),console.error("Tried to format remote object of unknown type.")}return i.classList.add("object-value-"+n),i.classList.add("source-code"),i}_formatParameterAsValue(e){const t=createElement("span"),s=e.description||"";if(s.length>Console.ConsoleViewMessage._MaxTokenizableStringLength){const e=new ObjectUI.ObjectPropertiesSection.ExpandableTextPropertyValue(createElement("span"),s,Console.ConsoleViewMessage._LongStringVisibleLength);t.appendChild(e.element)}else t.createTextChild(s);return e.objectId&&t.addEventListener("contextmenu",this._contextMenuEventFired.bind(this,e),!1),t}_formatParameterAsObject(e,t){const s=createElementWithClass("span","console-object");if(t&&e.preview)s.classList.add("console-object-preview"),this._previewFormatter.appendObjectPreview(s,e.preview,!1);else if("function"===e.type){const t=s.createChild("span");ObjectUI.ObjectPropertiesSection.ObjectPropertiesSection.formatObjectAsFunction(e,t,!1),s.classList.add("object-value-function")}else s.createTextChild(e.description||"");if(!e.hasChildren||e.customPreview())return s;const n=s.createChild("span","object-state-note info-note");this._message.type===SDK.ConsoleModel.MessageType.QueryObjectResult?n.title=ls`This value will not be collected until console is cleared.`:n.title=ls`Value below was evaluated just now.`;const i=new ObjectUI.ObjectPropertiesSection.ObjectPropertiesSection(e,s,this._linkifier);return i.element.classList.add("console-view-object-properties-section"),i.enableContextMenu(),i.setShowSelectionOnKeyboardFocus(!0,!0),this._selectableChildren.push(i),i.addEventListener(UI.TreeOutline.Events.ElementAttached,this._messageResized),i.addEventListener(UI.TreeOutline.Events.ElementExpanded,this._messageResized),i.addEventListener(UI.TreeOutline.Events.ElementCollapsed,this._messageResized),i.element}_formatParameterAsFunction(e,t){const s=createElement("span");return SDK.RemoteObject.RemoteFunction.objectAsFunction(e).targetFunction().then(function(n){const i=createElement("span"),r=ObjectUI.ObjectPropertiesSection.ObjectPropertiesSection.formatObjectAsFunction(n,i,!0,t);if(s.appendChild(i),n!==e){s.createChild("span","object-info-state-note").title=Common.UIString.UIString("Function was resolved from bound function.")}s.addEventListener("contextmenu",this._contextMenuEventFired.bind(this,n),!1),r.then(()=>this._formattedParameterAsFunctionForTest())}.bind(this)),s}_formattedParameterAsFunctionForTest(){}_contextMenuEventFired(e,t){const s=new UI.ContextMenu.ContextMenu(t);s.appendApplicableItems(e),s.show()}_renderPropertyPreviewOrAccessor(e,t){const s=t.peekLast();return"accessor"===s.type?this._formatAsAccessorProperty(e,t.map(e=>e.name),!1):this._previewFormatter.renderPropertyPreview(s.type,s.subtype,s.value)}_formatParameterAsNode(e){const t=createElement("span"),s=e.runtimeModel().target().model(SDK.DOMModel.DOMModel);return s?(s.pushObjectAsNodeToFrontend(e).then(async s=>{if(!s)return void t.appendChild(this._formatParameterAsObject(e,!1));const n=await UI.UIUtils.Renderer.render(s);n?(n.tree&&(this._selectableChildren.push(n.tree),n.tree.addEventListener(UI.TreeOutline.Events.ElementAttached,this._messageResized),n.tree.addEventListener(UI.TreeOutline.Events.ElementExpanded,this._messageResized),n.tree.addEventListener(UI.TreeOutline.Events.ElementCollapsed,this._messageResized)),t.appendChild(n.node)):t.appendChild(this._formatParameterAsObject(e,!1)),this._formattedParameterAsNodeForTest()}),t):t}_formattedParameterAsNodeForTest(){}_formatParameterAsString(e){const t=createElement("span");t.appendChild(this._linkifyStringAsFragment(e.description||""));const s=createElement("span");return s.createChild("span","object-value-string-quote").textContent='"',s.appendChild(t),s.createChild("span","object-value-string-quote").textContent='"',s}_formatParameterAsError(e){const t=createElement("span"),s=this._tryFormatAsError(e.description||"");return t.appendChild(s||this._linkifyStringAsFragment(e.description||"")),t}_formatAsArrayEntry(e){return this._previewFormatter.renderPropertyPreview(e.type,e.subtype,e.description)}_formatAsAccessorProperty(e,t,s){const n=ObjectUI.ObjectPropertiesSection.ObjectPropertyTreeElement.createRemoteObjectAccessorPropertySpan(e,t,function(e){const t=e.wasThrown,i=e.object;if(!i)return;if(n.removeChildren(),t){const e=n.createChild("span");e.textContent=Common.UIString.UIString("<exception>"),e.title=i.description}else if(s)n.appendChild(this._formatAsArrayEntry(i));else{const e=100,t=i.type,s=i.subtype;let r="";"function"!==t&&i.description&&(r="string"===t||"regexp"===s?i.description.trimMiddle(e):i.description.trimEndWithMaxLength(e)),n.appendChild(this._previewFormatter.renderPropertyPreview(t,s,r))}}.bind(this));return n}_formatWithSubstitutionString(e,t,s){const n={};function i(e,t,s){return this._formatParameter(s,e,t)}function r(e){return"bigint"===e.type?e.description:"number"!=typeof e.value?"NaN":Math.floor(e.value)}let o=null;function a(e){const t=["background","border","color","font","line","margin","padding","text","-webkit-background","-webkit-border","-webkit-font","-webkit-margin","-webkit-padding","-webkit-text"];for(let s=0;s<t.length;s++)if(e.startsWith(t[s]))return!0;return!1}function l(e){for(const t in o)e.style[t]=o[t]}return n.o=i.bind(this,!1,!0),n.s=function(e){return e.description},n.f=function(e){return"number"!=typeof e.value?"NaN":e.value},n.i=r,n.d=r,n.c=function(e){o={};const t=createElement("span");t.setAttribute("style",e.description);for(let e=0;e<t.style.length;e++){const s=t.style[e];a(s)&&(o[s]=t.style[s])}},n.O=i.bind(this,!0,!1),n._=function(e){return e instanceof Node?e:""},Platform.StringUtilities.format(e,t,n,s,function(e,t){if(t instanceof Node)return e.appendChild(t),e;if(void 0===t)return e;if(!o)return e.appendChild(this._linkifyStringAsFragment(String(t))),e;const s=String(t).split("\n");for(let t=0;t<s.length;t++){const n=s[t],i=this._linkifyStringAsFragment(n),r=createElement("span");r.style.setProperty("contain","paint"),r.style.setProperty("display","inline-block"),r.style.setProperty("max-width","100%"),r.appendChild(i),l(r);for(const e of r.children)e.classList.contains("devtools-link")&&this._applyForcedVisibleStyle(e);e.appendChild(r),t<s.length-1&&e.appendChild(createElement("br"))}return e}.bind(this))}_applyForcedVisibleStyle(e){e.style.setProperty("-webkit-text-stroke","0","important"),e.style.setProperty("text-decoration","underline","important");const t=self.UI.themeSupport.patchColorText("rgb(33%, 33%, 33%)",UI.UIUtils.ThemeSupport.ColorUsage.Foreground);e.style.setProperty("color",t,"important");let s="hsl(0, 0%, 100%)";this._message.level===SDK.ConsoleModel.MessageLevel.Error?s="hsl(0, 100%, 97%)":(this._message.level===SDK.ConsoleModel.MessageLevel.Warning||this._shouldRenderAsWarning())&&(s="hsl(50, 100%, 95%)");const n=self.UI.themeSupport.patchColorText(s,UI.UIUtils.ThemeSupport.ColorUsage.Background);e.style.setProperty("background-color",n,"important")}matchesFilterRegex(e){e.lastIndex=0;const t=this.contentElement(),s=this._anchorElement?this._anchorElement.deepTextContent():"";return s&&e.test(s.trim())||e.test(t.deepTextContent().slice(s.length))}matchesFilterText(e){return this.contentElement().deepTextContent().toLowerCase().includes(e.toLowerCase())}updateTimestamp(){this._contentElement&&(Common.Settings.Settings.instance().moduleSetting("consoleTimestampsEnabled").get()?(this._timestampElement||(this._timestampElement=createElementWithClass("span","console-timestamp")),this._timestampElement.textContent=UI.UIUtils.formatTimestamp(this._message.timestamp,!1)+" ",this._timestampElement.title=UI.UIUtils.formatTimestamp(this._message.timestamp,!0),this._contentElement.insertBefore(this._timestampElement,this._contentElement.firstChild)):this._timestampElement&&(this._timestampElement.remove(),delete this._timestampElement))}nestingLevel(){return this._nestingLevel}setInSimilarGroup(e,t){this._inSimilarGroup=e,this._lastInSimilarGroup=e&&!!t,this._similarGroupMarker&&!e?(this._similarGroupMarker.remove(),this._similarGroupMarker=null):this._element&&!this._similarGroupMarker&&e&&(this._similarGroupMarker=createElementWithClass("div","nesting-level-marker"),this._element.insertBefore(this._similarGroupMarker,this._element.firstChild),this._similarGroupMarker.classList.toggle("group-closed",this._lastInSimilarGroup))}isLastInSimilarGroup(){return this._inSimilarGroup&&this._lastInSimilarGroup}resetCloseGroupDecorationCount(){this._closeGroupDecorationCount&&(this._closeGroupDecorationCount=0,this._updateCloseGroupDecorations())}incrementCloseGroupDecorationCount(){++this._closeGroupDecorationCount,this._updateCloseGroupDecorations()}_updateCloseGroupDecorations(){if(this._nestingLevelMarkers)for(let e=0,t=this._nestingLevelMarkers.length;e<t;++e){this._nestingLevelMarkers[e].classList.toggle("group-closed",t-e<=this._closeGroupDecorationCount)}}_focusedChildIndex(){return this._selectableChildren.length?this._selectableChildren.findIndex(e=>e.element.hasFocus()):-1}_onKeyDown(e){UI.UIUtils.isEditing()||!this._element.hasFocus()||this._element.hasSelection()||this.maybeHandleOnKeyDown(e)&&e.consume(!0)}maybeHandleOnKeyDown(e){const t=this._focusedChildIndex(),s=-1===t;if(this._expandTrace&&s&&("ArrowLeft"===e.key&&this._traceExpanded||"ArrowRight"===e.key&&!this._traceExpanded))return this._expandTrace(!this._traceExpanded),!0;if(!this._selectableChildren.length)return!1;if("ArrowLeft"===e.key)return this._element.focus(),!0;if("ArrowRight"===e.key&&s&&this._selectNearestVisibleChild(0))return!0;if("ArrowUp"===e.key){const e=this._nearestVisibleChild(0);if(this._selectableChildren[t]===e&&e)return this._element.focus(),!0;if(this._selectNearestVisibleChild(t-1,!0))return!0}if("ArrowDown"===e.key){if(s&&this._selectNearestVisibleChild(0))return!0;if(!s&&this._selectNearestVisibleChild(t+1))return!0}return!1}_selectNearestVisibleChild(e,t){const s=this._nearestVisibleChild(e,t);return!!s&&(s.forceSelect(),!0)}_nearestVisibleChild(e,t){const s=this._selectableChildren.length;if(e<0||e>=s)return null;const n=t?-1:1;let i=e;for(;!this._selectableChildren[i].element.offsetParent;)if(i+=n,i<0||i>=s)return null;return this._selectableChildren[i]}focusLastChildOrSelf(){this._element&&!this._selectNearestVisibleChild(this._selectableChildren.length-1,!0)&&this._element.focus()}contentElement(){if(this._contentElement)return this._contentElement;const e=createElementWithClass("div","console-message");let t;this._messageLevelIcon&&e.appendChild(this._messageLevelIcon),this._contentElement=e;const s=!!this._message.stackTrace&&(this._message.source===SDK.ConsoleModel.MessageSource.Network||this._message.source===SDK.ConsoleModel.MessageSource.Violation||this._message.level===SDK.ConsoleModel.MessageLevel.Error||this._message.level===SDK.ConsoleModel.MessageLevel.Warning||this._message.type===SDK.ConsoleModel.MessageType.Trace);return t=this._message.runtimeModel()&&s?this._buildMessageWithStackTrace():this._message.type===SDK.ConsoleModel.MessageType.Table?this._buildTableMessage():this._buildMessage(),e.appendChild(t),this.updateTimestamp(),this._contentElement}toMessageElement(){return this._element||(this._element=createElement("div"),this._element.tabIndex=-1,this._element.addEventListener("keydown",this._onKeyDown.bind(this)),this.updateMessageElement()),this._element}updateMessageElement(){if(this._element){this._element.className="console-message-wrapper",this._element.removeChildren(),this._message.isGroupStartMessage()&&this._element.classList.add("console-group-title"),this._message.source===SDK.ConsoleModel.MessageSource.ConsoleAPI&&this._element.classList.add("console-from-api"),this._inSimilarGroup&&(this._similarGroupMarker=this._element.createChild("div","nesting-level-marker"),this._similarGroupMarker.classList.toggle("group-closed",this._lastInSimilarGroup)),this._nestingLevelMarkers=[];for(let e=0;e<this._nestingLevel;++e)this._nestingLevelMarkers.push(this._element.createChild("div","nesting-level-marker"));switch(this._updateCloseGroupDecorations(),this._element.message=this,this._message.level){case SDK.ConsoleModel.MessageLevel.Verbose:this._element.classList.add("console-verbose-level");break;case SDK.ConsoleModel.MessageLevel.Info:this._element.classList.add("console-info-level"),this._message.type===SDK.ConsoleModel.MessageType.System&&this._element.classList.add("console-system-type");break;case SDK.ConsoleModel.MessageLevel.Warning:this._element.classList.add("console-warning-level");break;case SDK.ConsoleModel.MessageLevel.Error:this._element.classList.add("console-error-level")}this._updateMessageLevelIcon(),this._shouldRenderAsWarning()&&this._element.classList.add("console-warning-level"),this._element.appendChild(this.contentElement()),this._repeatCount>1&&this._showRepeatCountElement()}}_shouldRenderAsWarning(){return!(this._message.level!==SDK.ConsoleModel.MessageLevel.Verbose&&this._message.level!==SDK.ConsoleModel.MessageLevel.Info||this._message.source!==SDK.ConsoleModel.MessageSource.Violation&&this._message.source!==SDK.ConsoleModel.MessageSource.Deprecation&&this._message.source!==SDK.ConsoleModel.MessageSource.Intervention&&this._message.source!==SDK.ConsoleModel.MessageSource.Recommendation)}_updateMessageLevelIcon(){let e="",t="";this._message.level===SDK.ConsoleModel.MessageLevel.Warning?(e="smallicon-warning",t=ls`Warning`):this._message.level===SDK.ConsoleModel.MessageLevel.Error&&(e="smallicon-error",t=ls`Error`),(e||this._messageLevelIcon)&&(e&&!this._messageLevelIcon&&(this._messageLevelIcon=UI.Icon.Icon.create("","message-level-icon"),this._contentElement&&this._contentElement.insertBefore(this._messageLevelIcon,this._contentElement.firstChild)),this._messageLevelIcon.setIconType(e),UI.ARIAUtils.setAccessibleName(this._messageLevelIcon,t))}repeatCount(){return this._repeatCount||1}resetIncrementRepeatCount(){this._repeatCount=1,this._repeatCountElement&&(this._repeatCountElement.remove(),this._contentElement&&this._contentElement.classList.remove("repeated-message"),delete this._repeatCountElement)}incrementRepeatCount(){this._repeatCount++,this._showRepeatCountElement()}setRepeatCount(e){this._repeatCount=e,this._showRepeatCountElement()}_showRepeatCountElement(){if(!this._element)return;if(!this._repeatCountElement){switch(this._repeatCountElement=createElementWithClass("span","console-message-repeat-count","dt-small-bubble"),this._message.level){case SDK.ConsoleModel.MessageLevel.Warning:this._repeatCountElement.type="warning";break;case SDK.ConsoleModel.MessageLevel.Error:this._repeatCountElement.type="error";break;case SDK.ConsoleModel.MessageLevel.Verbose:this._repeatCountElement.type="verbose";break;default:this._repeatCountElement.type="info"}this._shouldRenderAsWarning()&&(this._repeatCountElement.type="warning"),this._element.insertBefore(this._repeatCountElement,this._contentElement),this._contentElement.classList.add("repeated-message")}this._repeatCountElement.textContent=this._repeatCount;let e=ls`Repeat ${this._repeatCount}`;this._message.level===SDK.ConsoleModel.MessageLevel.Warning?e=ls`Warning ${e}`:this._message.level===SDK.ConsoleModel.MessageLevel.Error&&(e=ls`Error ${e}`),UI.ARIAUtils.setAccessibleName(this._repeatCountElement,e)}get text(){return this._message.messageText}toExportString(){const e=[],t=this.contentElement().childTextNodes().map(Components.Linkifier.Linkifier.untruncatedNodeText).join("");for(let s=0;s<this.repeatCount();++s)e.push(t);return e.join("\n")}setSearchRegex(e){if(this._searchHiglightNodeChanges&&this._searchHiglightNodeChanges.length&&UI.UIUtils.revertDomChanges(this._searchHiglightNodeChanges),this._searchRegex=e,this._searchHighlightNodes=[],this._searchHiglightNodeChanges=[],!this._searchRegex)return;const t=this.contentElement().deepTextContent();let s;this._searchRegex.lastIndex=0;const n=[];for(;(s=this._searchRegex.exec(t))&&s[0];)n.push(new TextUtils.TextRange.SourceRange(s.index,s[0].length));n.length&&(this._searchHighlightNodes=UI.UIUtils.highlightSearchResults(this.contentElement(),n,this._searchHiglightNodeChanges))}searchRegex(){return this._searchRegex}searchCount(){return this._searchHighlightNodes.length}searchHighlightNode(e){return this._searchHighlightNodes[e]}_tryFormatAsError(e){if(!this._message.runtimeModel()||!["EvalError","ReferenceError","SyntaxError","TypeError","RangeError","Error","URIError"].some((function(t){return e.startsWith(t)})))return null;const t=this._message.runtimeModel().debuggerModel(),s=this._message.runtimeModel().target().inspectedURL(),n=e.split("\n"),i=[];let r=0;for(let e=0;e<n.length;++e){r+=e>0?n[e-1].length+1:0;const t=/^\s*at\s/.test(n[e]);if(!t&&i.length)return null;if(!t)continue;let o=-1,a=-1;const c=/\([^\)\(]+:\d+:\d+\)/g,h=/\([^\)\(]+\)/g;let m,d=null;for(;m=c.exec(n[e]);)d=m;if(!d)for(;m=h.exec(n[e]);)d=m;d&&(o=d.index,a=d.index+d[0].length-1);const p=-1!==o,u=p?o+1:n[e].indexOf("at")+3,g=p?a:n[e].length,_=n[e].substring(u,g),C=Common.ParsedURL.ParsedURL.splitLineAndColumn(_);if(!C)return null;if("<anonymous>"===C.url)continue;let f=l(C.url);if(!f&&Common.ParsedURL.ParsedURL.isRelativeURL(C.url)&&(f=l(Common.ParsedURL.ParsedURL.completeURL(s,C.url))),!f)return null;i.push({url:f,positionLeft:r+u,positionRight:r+g,lineNumber:C.lineNumber,columnNumber:C.columnNumber})}if(!i.length)return null;const o=createElement("span");let a=0;for(let s=0;s<i.length;++s){o.appendChild(this._linkifyStringAsFragment(e.substring(a,i[s].positionLeft)));const n=this._linkifier.linkifyScriptLocation(t.target(),null,i[s].url,i[s].lineNumber,{columnNumber:i[s].columnNumber});n.tabIndex=-1,this._selectableChildren.push({element:n,forceSelect:()=>n.focus()}),o.appendChild(n),a=i[s].positionRight}return a!==e.length&&o.appendChild(this._linkifyStringAsFragment(e.substring(a))),o;function l(e){if(!e)return null;const s=Common.ParsedURL.ParsedURL.fromString(e);return s?s.url:t.scriptsForSourceURL(e).length?e:null}}_linkifyWithCustomLinkifier(e,t){if(e.length>Console.ConsoleViewMessage._MaxTokenizableStringLength){const t=new ObjectUI.ObjectPropertiesSection.ExpandableTextPropertyValue(createElement("span"),e,Console.ConsoleViewMessage._LongStringVisibleLength),s=createDocumentFragment();return s.appendChild(t.element),s}const s=createDocumentFragment(),n=ConsoleViewMessage._tokenizeMessageText(e);for(const e of n)if(e.text)switch(e.type){case"url":{const n=e.text.startsWith("www.")?"http://"+e.text:e.text,i=Common.ParsedURL.ParsedURL.splitLineAndColumn(n),r=Common.ParsedURL.ParsedURL.removeWasmFunctionInfoFromURL(i.url);let o;o=i?t(e.text,r,i.lineNumber,i.columnNumber):t(e.text,e.value),s.appendChild(o);break}default:s.appendChild(createTextNode(e.text))}return s}_linkifyStringAsFragment(e){return this._linkifyWithCustomLinkifier(e,(e,t,s,n)=>{const i=Components.Linkifier.Linkifier.linkifyURL(t,{text:e,lineNumber:s,columnNumber:n});return i.tabIndex=-1,this._selectableChildren.push({element:i,forceSelect:()=>i.focus()}),i})}static _tokenizeMessageText(e){if(!ConsoleViewMessage._tokenizerRegexes){const e="\\u0000-\\u0020\\u007f-\\u009f",t=new RegExp("(?:[a-zA-Z][a-zA-Z0-9+.-]{2,}:\\/\\/|data:|www\\.)[^\\s"+e+'"]{2,}[^\\s'+e+"\"')}\\],:;.!?]","u"),s=/(?:\/[\w\.-]*)+\:[\d]+/,n=/took [\d]+ms/,i=/'\w+' event/,r=/\sM[6-7]\d/,o=/\(suggested: \"[\w-]+\"\)/,a=new Map;a.set(t,"url"),a.set(s,"url"),a.set(n,"time"),a.set(i,"event"),a.set(r,"milestone"),a.set(o,"autofill"),ConsoleViewMessage._tokenizerRegexes=Array.from(a.keys()),ConsoleViewMessage._tokenizerTypes=Array.from(a.values())}if(e.length>Console.ConsoleViewMessage._MaxTokenizableStringLength)return[{text:e,type:void 0}];return TextUtils.TextUtils.Utils.splitStringByRegexes(e,ConsoleViewMessage._tokenizerRegexes).map(e=>({text:e.value,type:ConsoleViewMessage._tokenizerTypes[e.regexIndex]}))}groupKey(){return this._groupKey||(this._groupKey=this._message.groupCategoryKey()+":"+this.groupTitle()),this._groupKey}groupTitle(){return ConsoleViewMessage._tokenizeMessageText(this._message.messageText).reduce((e,t)=>{let s=t.text;return"url"===t.type?s=Common.UIString.UIString("<URL>"):"time"===t.type?s=Common.UIString.UIString("took <N>ms"):"event"===t.type?s=Common.UIString.UIString("<some> event"):"milestone"===t.type?s=Common.UIString.UIString(" M<XX>"):"autofill"===t.type&&(s=Common.UIString.UIString("<attribute>")),e+s},"").replace(/[%]o/g,"")}}export class ConsoleGroupViewMessage extends ConsoleViewMessage{constructor(e,t,s,n,i){console.assert(e.isGroupStartMessage()),super(e,t,s,i),this._collapsed=e.type===SDK.ConsoleModel.MessageType.StartGroupCollapsed,this._expandGroupIcon=null,this._onToggle=n}_setCollapsed(e){this._collapsed=e,this._expandGroupIcon&&this._expandGroupIcon.setIconType(this._collapsed?"smallicon-triangle-right":"smallicon-triangle-down"),this._onToggle.call(null)}collapsed(){return this._collapsed}maybeHandleOnKeyDown(e){return-1===this._focusedChildIndex()&&("ArrowLeft"===e.key&&!this._collapsed||"ArrowRight"===e.key&&this._collapsed)?(this._setCollapsed(!this._collapsed),!0):super.maybeHandleOnKeyDown(e)}toMessageElement(){if(!this._element){super.toMessageElement();const e=this._collapsed?"smallicon-triangle-right":"smallicon-triangle-down";this._expandGroupIcon=UI.Icon.Icon.create(e,"expand-group-icon"),this._contentElement.tabIndex=-1,this._repeatCountElement?this._repeatCountElement.insertBefore(this._expandGroupIcon,this._repeatCountElement.firstChild):this._element.insertBefore(this._expandGroupIcon,this._contentElement),this._element.addEventListener("click",()=>this._setCollapsed(!this._collapsed))}return this._element}_showRepeatCountElement(){super._showRepeatCountElement(),this._repeatCountElement&&this._expandGroupIcon&&this._repeatCountElement.insertBefore(this._expandGroupIcon,this._repeatCountElement.firstChild)}}export const MaxLengthForLinks=40;export const _MaxTokenizableStringLength=1e4;export const _LongStringVisibleLength=5e3;