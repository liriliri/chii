import*as Common from"../common/common.js";import*as Host from"../host/host.js";import*as Platform from"../platform/platform.js";import*as SDK from"../sdk/sdk.js";import*as SourceFrame from"../source_frame/source_frame.js";import*as UI from"../ui/ui.js";import{ApplicationCacheItemsView}from"./ApplicationCacheItemsView.js";import{ApplicationCacheModel,Events as ApplicationCacheModelEvents}from"./ApplicationCacheModel.js";import{AppManifestView}from"./AppManifestView.js";import{BackgroundServiceModel}from"./BackgroundServiceModel.js";import{BackgroundServiceView}from"./BackgroundServiceView.js";import{ClearStorageView}from"./ClearStorageView.js";import{Database as DatabaseModelDatabase,DatabaseModel,Events as DatabaseModelEvents}from"./DatabaseModel.js";import{DatabaseQueryView,Events as DatabaseQueryViewEvents}from"./DatabaseQueryView.js";import{DatabaseTableView}from"./DatabaseTableView.js";import{DOMStorage,DOMStorageModel,Events as DOMStorageModelEvents}from"./DOMStorageModel.js";import{Database as IndexedDBModelDatabase,DatabaseId,Events as IndexedDBModelEvents,Index,IndexedDBModel,ObjectStore}from"./IndexedDBModel.js";import{IDBDatabaseView,IDBDataView}from"./IndexedDBViews.js";import{ServiceWorkerCacheView}from"./ServiceWorkerCacheViews.js";import{ServiceWorkersView}from"./ServiceWorkersView.js";export class ApplicationPanelSidebar extends UI.Widget.VBox{constructor(e){super(),this._panel=e,this._sidebarTree=new UI.TreeOutline.TreeOutlineInShadow,this._sidebarTree.element.classList.add("resources-sidebar"),this._sidebarTree.registerRequiredCSS("resources/resourcesSidebar.css"),this._sidebarTree.element.classList.add("filter-all"),this._sidebarTree.addEventListener(UI.TreeOutline.Events.ElementAttached,this._treeElementAdded,this),this.contentElement.appendChild(this._sidebarTree.element),this._applicationTreeElement=this._addSidebarSection(Common.UIString.UIString("Application"));const t=new AppManifestTreeElement(e);this._applicationTreeElement.appendChild(t),this.serviceWorkersTreeElement=new ServiceWorkersTreeElement(e),this._applicationTreeElement.appendChild(this.serviceWorkersTreeElement);const s=new ClearStorageTreeElement(e);this._applicationTreeElement.appendChild(s);const i=this._addSidebarSection(Common.UIString.UIString("Storage"));this.localStorageListTreeElement=new StorageCategoryTreeElement(e,Common.UIString.UIString("Local Storage"),"LocalStorage"),this.localStorageListTreeElement.setLink("https://developers.google.com/web/tools/chrome-devtools/storage/localstorage?utm_source=devtools");const a=UI.Icon.Icon.create("mediumicon-table","resource-tree-item");this.localStorageListTreeElement.setLeadingIcons([a]),i.appendChild(this.localStorageListTreeElement),this.sessionStorageListTreeElement=new StorageCategoryTreeElement(e,Common.UIString.UIString("Session Storage"),"SessionStorage"),this.sessionStorageListTreeElement.setLink("https://developers.google.com/web/tools/chrome-devtools/storage/sessionstorage?utm_source=devtools");const r=UI.Icon.Icon.create("mediumicon-table","resource-tree-item");this.sessionStorageListTreeElement.setLeadingIcons([r]),i.appendChild(this.sessionStorageListTreeElement),this.indexedDBListTreeElement=new IndexedDBTreeElement(e),this.indexedDBListTreeElement.setLink("https://developers.google.com/web/tools/chrome-devtools/storage/indexeddb?utm_source=devtools"),i.appendChild(this.indexedDBListTreeElement),this.databasesListTreeElement=new StorageCategoryTreeElement(e,Common.UIString.UIString("Web SQL"),"Databases"),this.databasesListTreeElement.setLink("https://developers.google.com/web/tools/chrome-devtools/storage/websql?utm_source=devtools");const n=UI.Icon.Icon.create("mediumicon-database","resource-tree-item");this.databasesListTreeElement.setLeadingIcons([n]),i.appendChild(this.databasesListTreeElement),this.cookieListTreeElement=new StorageCategoryTreeElement(e,Common.UIString.UIString("Cookies"),"Cookies"),this.cookieListTreeElement.setLink("https://developers.google.com/web/tools/chrome-devtools/storage/cookies?utm_source=devtools");const o=UI.Icon.Icon.create("mediumicon-cookie","resource-tree-item");this.cookieListTreeElement.setLeadingIcons([o]),i.appendChild(this.cookieListTreeElement);const d=this._addSidebarSection(Common.UIString.UIString("Cache"));this.cacheStorageListTreeElement=new ServiceWorkerCacheTreeElement(e),d.appendChild(this.cacheStorageListTreeElement),this.applicationCacheListTreeElement=new StorageCategoryTreeElement(e,Common.UIString.UIString("Application Cache"),"ApplicationCache"),this.applicationCacheListTreeElement.setLink("https://developers.google.com/web/tools/chrome-devtools/storage/applicationcache?utm_source=devtools");const c=UI.Icon.Icon.create("mediumicon-table","resource-tree-item");if(this.applicationCacheListTreeElement.setLeadingIcons([c]),d.appendChild(this.applicationCacheListTreeElement),Root.Runtime.experiments.isEnabled("backgroundServices")){const t=this._addSidebarSection(ls`Background Services`);this.backgroundFetchTreeElement=new BackgroundServiceTreeElement(e,Protocol.BackgroundService.ServiceName.BackgroundFetch),t.appendChild(this.backgroundFetchTreeElement),this.backgroundSyncTreeElement=new BackgroundServiceTreeElement(e,Protocol.BackgroundService.ServiceName.BackgroundSync),t.appendChild(this.backgroundSyncTreeElement),Root.Runtime.experiments.isEnabled("backgroundServicesNotifications")&&(this.notificationsTreeElement=new BackgroundServiceTreeElement(e,Protocol.BackgroundService.ServiceName.Notifications),t.appendChild(this.notificationsTreeElement)),Root.Runtime.experiments.isEnabled("backgroundServicesPaymentHandler")&&(this.paymentHandlerTreeElement=new BackgroundServiceTreeElement(e,Protocol.BackgroundService.ServiceName.PaymentHandler),t.appendChild(this.paymentHandlerTreeElement)),this.periodicBackgroundSyncTreeElement=new BackgroundServiceTreeElement(e,Protocol.BackgroundService.ServiceName.PeriodicBackgroundSync),t.appendChild(this.periodicBackgroundSyncTreeElement),Root.Runtime.experiments.isEnabled("backgroundServicesPushMessaging")&&(this.pushMessagingTreeElement=new BackgroundServiceTreeElement(e,Protocol.BackgroundService.ServiceName.PushMessaging),t.appendChild(this.pushMessagingTreeElement))}this._resourcesSection=new ResourcesSection(e,this._addSidebarSection(Common.UIString.UIString("Frames"))),this._databaseTableViews=new Map,this._databaseQueryViews=new Map,this._databaseTreeElements=new Map,this._domStorageTreeElements=new Map,this._domains={},this._sidebarTree.contentElement.addEventListener("mousemove",this._onmousemove.bind(this),!1),this._sidebarTree.contentElement.addEventListener("mouseleave",this._onmouseleave.bind(this),!1),SDK.SDKModel.TargetManager.instance().observeTargets(this),SDK.SDKModel.TargetManager.instance().addModelListener(SDK.ResourceTreeModel.ResourceTreeModel,SDK.ResourceTreeModel.Events.FrameNavigated,this._frameNavigated,this);this._panel.lastSelectedItemPath().length||t.select()}_addSidebarSection(e){const t=new UI.TreeOutline.TreeElement(e,!0);return t.listItemElement.classList.add("storage-group-list-item"),t.setCollapsible(!1),t.selectable=!1,this._sidebarTree.appendChild(t),t}targetAdded(e){if(this._target)return;this._target=e,this._databaseModel=e.model(DatabaseModel),this._databaseModel&&(this._databaseModel.addEventListener(DatabaseModelEvents.DatabaseAdded,this._databaseAdded,this),this._databaseModel.addEventListener(DatabaseModelEvents.DatabasesRemoved,this._resetWebSQL,this));const t=e.model(SDK.ResourceTreeModel.ResourceTreeModel);t&&(t.cachedResourcesLoaded()&&this._initialize(),t.addEventListener(SDK.ResourceTreeModel.Events.CachedResourcesLoaded,this._initialize,this),t.addEventListener(SDK.ResourceTreeModel.Events.WillLoadCachedResources,this._resetWithFrames,this))}targetRemoved(e){if(e!==this._target)return;delete this._target;const t=e.model(SDK.ResourceTreeModel.ResourceTreeModel);t&&(t.removeEventListener(SDK.ResourceTreeModel.Events.CachedResourcesLoaded,this._initialize,this),t.removeEventListener(SDK.ResourceTreeModel.Events.WillLoadCachedResources,this._resetWithFrames,this)),this._databaseModel&&(this._databaseModel.removeEventListener(DatabaseModelEvents.DatabaseAdded,this._databaseAdded,this),this._databaseModel.removeEventListener(DatabaseModelEvents.DatabasesRemoved,this._resetWebSQL,this),this._databaseModel=null),this._resetWithFrames()}focus(){this._sidebarTree.focus()}_initialize(){for(const e of SDK.ResourceTreeModel.ResourceTreeModel.frames())this._addCookieDocument(e);this._databaseModel&&this._databaseModel.enable();const e=this._target.model(SDK.ServiceWorkerCacheModel.ServiceWorkerCacheModel);e&&e.enable();const t=this._target.model(SDK.ResourceTreeModel.ResourceTreeModel);t&&this._populateApplicationCacheTree(t),SDK.SDKModel.TargetManager.instance().observeModels(DOMStorageModel,{modelAdded:e=>this._domStorageModelAdded(e),modelRemoved:e=>this._domStorageModelRemoved(e)}),this.indexedDBListTreeElement._initialize(),SDK.SDKModel.TargetManager.instance().observeModels(IndexedDBModel,{modelAdded:e=>e.enable(),modelRemoved:e=>this.indexedDBListTreeElement.removeIndexedDBForModel(e)});const s=this._target.model(SDK.ServiceWorkerCacheModel.ServiceWorkerCacheModel);this.cacheStorageListTreeElement._initialize(s);const i=this._target.model(BackgroundServiceModel);Root.Runtime.experiments.isEnabled("backgroundServices")&&(this.backgroundFetchTreeElement._initialize(i),this.backgroundSyncTreeElement._initialize(i),Root.Runtime.experiments.isEnabled("backgroundServicesNotifications")&&this.notificationsTreeElement._initialize(i),Root.Runtime.experiments.isEnabled("backgroundServicesPaymentHandler")&&this.paymentHandlerTreeElement._initialize(i),this.periodicBackgroundSyncTreeElement._initialize(i),Root.Runtime.experiments.isEnabled("backgroundServicesPushMessaging")&&this.pushMessagingTreeElement._initialize(i))}_domStorageModelAdded(e){e.enable(),e.storages().forEach(this._addDOMStorage.bind(this)),e.addEventListener(DOMStorageModelEvents.DOMStorageAdded,this._domStorageAdded,this),e.addEventListener(DOMStorageModelEvents.DOMStorageRemoved,this._domStorageRemoved,this)}_domStorageModelRemoved(e){e.storages().forEach(this._removeDOMStorage.bind(this)),e.removeEventListener(DOMStorageModelEvents.DOMStorageAdded,this._domStorageAdded,this),e.removeEventListener(DOMStorageModelEvents.DOMStorageRemoved,this._domStorageRemoved,this)}_resetWithFrames(){this._resourcesSection.reset(),this._reset()}_resetWebSQL(){for(const e of this._databaseQueryViews.values())e.removeEventListener(DatabaseQueryViewEvents.SchemaUpdated,e=>{this._updateDatabaseTables(e)},this);this._databaseTableViews.clear(),this._databaseQueryViews.clear(),this._databaseTreeElements.clear(),this.databasesListTreeElement.removeChildren(),this.databasesListTreeElement.setExpandable(!1)}_resetAppCache(){for(const e of Object.keys(this._applicationCacheFrameElements))this._applicationCacheFrameManifestRemoved({data:e});this.applicationCacheListTreeElement.setExpandable(!1)}_treeElementAdded(e){const t=this._panel.lastSelectedItemPath();if(!t.length)return;const s=e.data,i=t.indexOf(s.itemURL);if(!(i<0)){for(let e=s.parent;e;e=e.parent)e.expand();i>0&&s.expand(),s.select()}}_reset(){this._domains={},this._resetWebSQL(),this.cookieListTreeElement.removeChildren()}_frameNavigated(e){const t=e.data;t.isTopFrame()&&this._reset();const s=this._applicationCacheFrameElements[t.id];s&&s.frameNavigated(t),this._addCookieDocument(t)}_databaseAdded(e){const t=e.data,s=new DatabaseTreeElement(this,t);this._databaseTreeElements.set(t,s),this.databasesListTreeElement.appendChild(s)}_addCookieDocument(e){const t=e.unreachableUrl()||e.url,s=Common.ParsedURL.ParsedURL.fromString(t);if(!s||"http"!==s.scheme&&"https"!==s.scheme&&"file"!==s.scheme)return;const i=s.securityOrigin();if(!this._domains[i]){this._domains[i]=!0;const t=new CookieTreeElement(this._panel,e,i);this.cookieListTreeElement.appendChild(t)}}_domStorageAdded(e){const t=e.data;this._addDOMStorage(t)}_addDOMStorage(e){console.assert(!this._domStorageTreeElements.get(e));const t=new DOMStorageTreeElement(this._panel,e);this._domStorageTreeElements.set(e,t),e.isLocalStorage?this.localStorageListTreeElement.appendChild(t):this.sessionStorageListTreeElement.appendChild(t)}_domStorageRemoved(e){const t=e.data;this._removeDOMStorage(t)}_removeDOMStorage(e){const t=this._domStorageTreeElements.get(e);if(!t)return;const s=t.selected,i=t.parent;i.removeChild(t),s&&i.select(),this._domStorageTreeElements.delete(e)}selectDatabase(e){e&&(this._showDatabase(e),this._databaseTreeElements.get(e).select())}async showResource(e,t,s){await this._resourcesSection.revealResource(e,t,s)}_showDatabase(e,t){if(!e)return;let s;if(t){let i=this._databaseTableViews.get(e);i||(i={},this._databaseTableViews.set(e,i)),s=i[t],s||(s=new DatabaseTableView(e,t),i[t]=s)}else s=this._databaseQueryViews.get(e),s||(s=new DatabaseQueryView(e),this._databaseQueryViews.set(e,s),s.addEventListener(DatabaseQueryViewEvents.SchemaUpdated,e=>{this._updateDatabaseTables(e)},this));this._innerShowView(s)}_showApplicationCache(e){this._applicationCacheViews[e]||(this._applicationCacheViews[e]=new ApplicationCacheItemsView(this._applicationCacheModel,e)),this._innerShowView(this._applicationCacheViews[e])}showFileSystem(e){this._innerShowView(e)}_innerShowView(e){this._panel.showView(e)}async _updateDatabaseTables(e){const t=e.data;if(!t)return;const s=this._databaseTreeElements.get(t);if(!s)return;s.invalidateChildren();const i=this._databaseTableViews.get(t);if(!i)return;const a={},r=this._panel,n=await t.tableNames(),o=n.length;for(let e=0;e<o;++e)a[n[e]]=!0;for(const e in i)e in a||(r.visibleView===i[e]&&r.showView(null),delete i[e]);await s.updateChildren()}_populateApplicationCacheTree(e){this._applicationCacheModel=this._target.model(ApplicationCacheModel),this._applicationCacheViews={},this._applicationCacheFrameElements={},this._applicationCacheManifestElements={},this._applicationCacheModel.addEventListener(ApplicationCacheModelEvents.FrameManifestAdded,this._applicationCacheFrameManifestAdded,this),this._applicationCacheModel.addEventListener(ApplicationCacheModelEvents.FrameManifestRemoved,this._applicationCacheFrameManifestRemoved,this),this._applicationCacheModel.addEventListener(ApplicationCacheModelEvents.FrameManifestsReset,this._resetAppCache,this),this._applicationCacheModel.addEventListener(ApplicationCacheModelEvents.FrameManifestStatusUpdated,this._applicationCacheFrameManifestStatusChanged,this),this._applicationCacheModel.addEventListener(ApplicationCacheModelEvents.NetworkStateChanged,this._applicationCacheNetworkStateChanged,this)}_applicationCacheFrameManifestAdded(e){const t=e.data,s=this._applicationCacheModel.frameManifestURL(t);let i=this._applicationCacheManifestElements[s];i||(i=new ApplicationCacheManifestTreeElement(this._panel,s),this.applicationCacheListTreeElement.appendChild(i),this._applicationCacheManifestElements[s]=i);const a=this._target.model(SDK.ResourceTreeModel.ResourceTreeModel),r=new ApplicationCacheFrameTreeElement(this,a.frameForId(t),s);i.appendChild(r),i.expand(),this._applicationCacheFrameElements[t]=r}_applicationCacheFrameManifestRemoved(e){const t=e.data,s=this._applicationCacheFrameElements[t];if(!s)return;const i=s.manifestURL;delete this._applicationCacheFrameElements[t],delete this._applicationCacheViews[t],s.parent.removeChild(s);const a=this._applicationCacheManifestElements[i];a.childCount()||(delete this._applicationCacheManifestElements[i],a.parent.removeChild(a))}_applicationCacheFrameManifestStatusChanged(e){const t=e.data,s=this._applicationCacheModel.frameManifestStatus(t);this._applicationCacheViews[t]&&this._applicationCacheViews[t].updateStatus(s)}_applicationCacheNetworkStateChanged(e){const t=e.data;for(const e in this._applicationCacheViews)this._applicationCacheViews[e].updateNetworkState(t)}showView(e){e&&this.showResource(e.resource)}_onmousemove(e){const t=e.target;if(!t)return;const s=t.enclosingNodeOrSelfWithNodeName("li");if(!s)return;const i=s.treeElement;this._previousHoveredElement!==i&&(this._previousHoveredElement&&(this._previousHoveredElement.hovered=!1,delete this._previousHoveredElement),i instanceof FrameTreeElement&&(this._previousHoveredElement=i,i.hovered=!0))}_onmouseleave(e){this._previousHoveredElement&&(this._previousHoveredElement.hovered=!1,delete this._previousHoveredElement)}}export class BaseStorageTreeElement extends UI.TreeOutline.TreeElement{constructor(e,t,s){super(t,s),this._storagePanel=e,UI.ARIAUtils.setAccessibleName(this.listItemElement,t)}onselect(e){if(!e)return!1;const t=[];for(let e=this;e;e=e.parent){const s=e.itemURL;if(!s)break;t.push(s)}return this._storagePanel.setLastSelectedItemPath(t),!1}showView(e){this._storagePanel.showView(e)}}export class StorageCategoryTreeElement extends BaseStorageTreeElement{constructor(e,t,s){super(e,t,!1),this._expandedSetting=Common.Settings.Settings.instance().createSetting("resources"+s+"Expanded","Frames"===s),this._categoryName=t,this._categoryLink=null}get itemURL(){return"category://"+this._categoryName}setLink(e){this._categoryLink=e}onselect(e){return super.onselect(e),this._storagePanel.showCategoryView(this._categoryName,this._categoryLink),!1}onattach(){super.onattach(),this._expandedSetting.get()&&this.expand()}onexpand(){this._expandedSetting.set(!0)}oncollapse(){this._expandedSetting.set(!1)}}export class BackgroundServiceTreeElement extends BaseStorageTreeElement{constructor(e,t){super(e,BackgroundServiceView.getUIString(t),!1),this._serviceName=t,this._selected=!1,this._view=null,this._model=null;const s=UI.Icon.Icon.create(this._getIconType(),"resource-tree-item");this.setLeadingIcons([s])}_getIconType(){switch(this._serviceName){case Protocol.BackgroundService.ServiceName.BackgroundFetch:return"mediumicon-fetch";case Protocol.BackgroundService.ServiceName.BackgroundSync:return"mediumicon-sync";case Protocol.BackgroundService.ServiceName.PushMessaging:return"mediumicon-cloud";case Protocol.BackgroundService.ServiceName.Notifications:return"mediumicon-bell";case Protocol.BackgroundService.ServiceName.PaymentHandler:return"mediumicon-payment";case Protocol.BackgroundService.ServiceName.PeriodicBackgroundSync:return"mediumicon-schedule";default:return console.error(`Service ${this._serviceName} does not have a dedicated icon`),"mediumicon-table"}}_initialize(e){this._model=e,this._selected&&!this._view&&this.onselect(!1)}get itemURL(){return"background-service://"+this._serviceName}onselect(e){return super.onselect(e),this._selected=!0,!!this._model&&(this._view||(this._view=new BackgroundServiceView(this._serviceName,this._model)),this.showView(this._view),self.UI.context.setFlavor(BackgroundServiceView,this._view),!1)}}export class DatabaseTreeElement extends BaseStorageTreeElement{constructor(e,t){super(e._panel,t.name,!0),this._sidebar=e,this._database=t;const s=UI.Icon.Icon.create("mediumicon-database","resource-tree-item");this.setLeadingIcons([s])}get itemURL(){return"database://"+encodeURI(this._database.name)}onselect(e){return super.onselect(e),this._sidebar._showDatabase(this._database),!1}onexpand(){this.updateChildren()}async updateChildren(){this.removeChildren();const e=await this._database.tableNames();for(const t of e)this.appendChild(new DatabaseTableTreeElement(this._sidebar,this._database,t))}}export class DatabaseTableTreeElement extends BaseStorageTreeElement{constructor(e,t,s){super(e._panel,s,!1),this._sidebar=e,this._database=t,this._tableName=s;const i=UI.Icon.Icon.create("mediumicon-table","resource-tree-item");this.setLeadingIcons([i])}get itemURL(){return"database://"+encodeURI(this._database.name)+"/"+encodeURI(this._tableName)}onselect(e){return super.onselect(e),this._sidebar._showDatabase(this._database,this._tableName),!1}}export class ServiceWorkerCacheTreeElement extends StorageCategoryTreeElement{constructor(e){super(e,Common.UIString.UIString("Cache Storage"),"CacheStorage");const t=UI.Icon.Icon.create("mediumicon-database","resource-tree-item");this.setLeadingIcons([t]),this._swCacheModel=null}_initialize(e){if(this._swCacheTreeElements=new Set,this._swCacheModel=e,e)for(const t of e.caches())this._addCache(e,t);SDK.SDKModel.TargetManager.instance().addModelListener(SDK.ServiceWorkerCacheModel.ServiceWorkerCacheModel,SDK.ServiceWorkerCacheModel.Events.CacheAdded,this._cacheAdded,this),SDK.SDKModel.TargetManager.instance().addModelListener(SDK.ServiceWorkerCacheModel.ServiceWorkerCacheModel,SDK.ServiceWorkerCacheModel.Events.CacheRemoved,this._cacheRemoved,this)}onattach(){super.onattach(),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)}_handleContextMenuEvent(e){const t=new UI.ContextMenu.ContextMenu(e);t.defaultSection().appendItem(Common.UIString.UIString("Refresh Caches"),this._refreshCaches.bind(this)),t.show()}_refreshCaches(){this._swCacheModel&&this._swCacheModel.refreshCacheNames()}_cacheAdded(e){const t=e.data.cache,s=e.data.model;this._addCache(s,t)}_addCache(e,t){const s=new SWCacheTreeElement(this._storagePanel,e,t);this._swCacheTreeElements.add(s),this.appendChild(s)}_cacheRemoved(e){const t=e.data.cache,s=e.data.model,i=this._cacheTreeElement(s,t);i&&(this.removeChild(i),this._swCacheTreeElements.delete(i),this.setExpandable(this.childCount()>0))}_cacheTreeElement(e,t){for(const s of this._swCacheTreeElements)if(s._cache.equals(t)&&s._model===e)return s;return null}}export class SWCacheTreeElement extends BaseStorageTreeElement{constructor(e,t,s){super(e,s.cacheName+" - "+s.securityOrigin,!1),this._model=t,this._cache=s,this._view=null;const i=UI.Icon.Icon.create("mediumicon-table","resource-tree-item");this.setLeadingIcons([i])}get itemURL(){return"cache://"+this._cache.cacheId}onattach(){super.onattach(),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)}_handleContextMenuEvent(e){const t=new UI.ContextMenu.ContextMenu(e);t.defaultSection().appendItem(Common.UIString.UIString("Delete"),this._clearCache.bind(this)),t.show()}_clearCache(){this._model.deleteCache(this._cache)}update(e){this._cache=e,this._view&&this._view.update(e)}onselect(e){return super.onselect(e),this._view||(this._view=new ServiceWorkerCacheView(this._model,this._cache)),this.showView(this._view),!1}}export class ServiceWorkersTreeElement extends BaseStorageTreeElement{constructor(e){super(e,Common.UIString.UIString("Service Workers"),!1);const t=UI.Icon.Icon.create("mediumicon-service-worker","resource-tree-item");this.setLeadingIcons([t])}get itemURL(){return"service-workers://"}onselect(e){return super.onselect(e),this._view||(this._view=new ServiceWorkersView),this.showView(this._view),!1}}export class AppManifestTreeElement extends BaseStorageTreeElement{constructor(e){super(e,Common.UIString.UIString("Manifest"),!1);const t=UI.Icon.Icon.create("mediumicon-manifest","resource-tree-item");this.setLeadingIcons([t])}get itemURL(){return"manifest://"}onselect(e){return super.onselect(e),this._view||(this._view=new AppManifestView),this.showView(this._view),!1}}export class ClearStorageTreeElement extends BaseStorageTreeElement{constructor(e){super(e,Common.UIString.UIString("Clear storage"),!1);const t=UI.Icon.Icon.create("mediumicon-clear-storage","resource-tree-item");this.setLeadingIcons([t])}get itemURL(){return"clear-storage://"}onselect(e){return super.onselect(e),this._view||(this._view=new ClearStorageView),this.showView(this._view),!1}}export class IndexedDBTreeElement extends StorageCategoryTreeElement{constructor(e){super(e,Common.UIString.UIString("IndexedDB"),"IndexedDB");const t=UI.Icon.Icon.create("mediumicon-database","resource-tree-item");this.setLeadingIcons([t])}_initialize(){SDK.SDKModel.TargetManager.instance().addModelListener(IndexedDBModel,IndexedDBModelEvents.DatabaseAdded,this._indexedDBAdded,this),SDK.SDKModel.TargetManager.instance().addModelListener(IndexedDBModel,IndexedDBModelEvents.DatabaseRemoved,this._indexedDBRemoved,this),SDK.SDKModel.TargetManager.instance().addModelListener(IndexedDBModel,IndexedDBModelEvents.DatabaseLoaded,this._indexedDBLoaded,this),SDK.SDKModel.TargetManager.instance().addModelListener(IndexedDBModel,IndexedDBModelEvents.IndexedDBContentUpdated,this._indexedDBContentUpdated,this),this._idbDatabaseTreeElements=[];for(const e of SDK.SDKModel.TargetManager.instance().models(IndexedDBModel)){const t=e.databases();for(let s=0;s<t.length;++s)this._addIndexedDB(e,t[s])}}removeIndexedDBForModel(e){const t=this._idbDatabaseTreeElements.filter(t=>t._model===e);for(const e of t)this._removeIDBDatabaseTreeElement(e)}onattach(){super.onattach(),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)}_handleContextMenuEvent(e){const t=new UI.ContextMenu.ContextMenu(e);t.defaultSection().appendItem(Common.UIString.UIString("Refresh IndexedDB"),this.refreshIndexedDB.bind(this)),t.show()}refreshIndexedDB(){for(const e of SDK.SDKModel.TargetManager.instance().models(IndexedDBModel))e.refreshDatabaseNames()}_indexedDBAdded(e){const t=e.data.databaseId,s=e.data.model;this._addIndexedDB(s,t)}_addIndexedDB(e,t){const s=new IDBDatabaseTreeElement(this._storagePanel,e,t);this._idbDatabaseTreeElements.push(s),this.appendChild(s),e.refreshDatabase(t)}_indexedDBRemoved(e){const t=e.data.databaseId,s=e.data.model,i=this._idbDatabaseTreeElement(s,t);i&&this._removeIDBDatabaseTreeElement(i)}_removeIDBDatabaseTreeElement(e){e.clear(),this.removeChild(e),Platform.ArrayUtilities.removeElement(this._idbDatabaseTreeElements,e),this.setExpandable(this.childCount()>0)}_indexedDBLoaded(e){const t=e.data.database,s=e.data.model,i=e.data.entriesUpdated,a=this._idbDatabaseTreeElement(s,t.databaseId);a&&(a.update(t,i),this._indexedDBLoadedForTest())}_indexedDBLoadedForTest(){}_indexedDBContentUpdated(e){const t=e.data.databaseId,s=e.data.objectStoreName,i=e.data.model,a=this._idbDatabaseTreeElement(i,t);a&&a.indexedDBContentUpdated(s)}_idbDatabaseTreeElement(e,t){return this._idbDatabaseTreeElements.find(s=>s._databaseId.equals(t)&&s._model===e)||null}}export class IDBDatabaseTreeElement extends BaseStorageTreeElement{constructor(e,t,s){super(e,s.name+" - "+s.securityOrigin,!1),this._model=t,this._databaseId=s,this._idbObjectStoreTreeElements={};const i=UI.Icon.Icon.create("mediumicon-database","resource-tree-item");this.setLeadingIcons([i]),this._model.addEventListener(IndexedDBModelEvents.DatabaseNamesRefreshed,this._refreshIndexedDB,this)}get itemURL(){return"indexedDB://"+this._databaseId.securityOrigin+"/"+this._databaseId.name}onattach(){super.onattach(),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)}_handleContextMenuEvent(e){const t=new UI.ContextMenu.ContextMenu(e);t.defaultSection().appendItem(Common.UIString.UIString("Refresh IndexedDB"),this._refreshIndexedDB.bind(this)),t.show()}_refreshIndexedDB(){this._model.refreshDatabase(this._databaseId)}indexedDBContentUpdated(e){this._idbObjectStoreTreeElements[e]&&this._idbObjectStoreTreeElements[e].markNeedsRefresh()}update(e,t){this._database=e;const s={},i=Object.keys(this._database.objectStores).sort();for(const e of i){const i=this._database.objectStores[e];if(s[i.name]=!0,!this._idbObjectStoreTreeElements[i.name]){const e=new IDBObjectStoreTreeElement(this._storagePanel,this._model,this._databaseId,i);this._idbObjectStoreTreeElements[i.name]=e,this.appendChild(e)}this._idbObjectStoreTreeElements[i.name].update(i,t)}for(const e in this._idbObjectStoreTreeElements)s[e]||this._objectStoreRemoved(e);this._view&&this._view.update(e),this._updateTooltip()}_updateTooltip(){0===Object.keys(this._idbObjectStoreTreeElements).length?this.tooltip=ls`Version: ${this._database.version} (empty)`:this.tooltip=ls`Version: ${this._database.version}`}onselect(e){return super.onselect(e),this._view||(this._view=new IDBDatabaseView(this._model,this._database)),this.showView(this._view),!1}_objectStoreRemoved(e){const t=this._idbObjectStoreTreeElements[e];t.clear(),this.removeChild(t),delete this._idbObjectStoreTreeElements[e],this._updateTooltip()}clear(){for(const e in this._idbObjectStoreTreeElements)this._objectStoreRemoved(e)}}export class IDBObjectStoreTreeElement extends BaseStorageTreeElement{constructor(e,t,s,i){super(e,i.name,!1),this._model=t,this._databaseId=s,this._idbIndexTreeElements={},this._objectStore=i,this._view=null;const a=UI.Icon.Icon.create("mediumicon-table","resource-tree-item");this.setLeadingIcons([a])}get itemURL(){return"indexedDB://"+this._databaseId.securityOrigin+"/"+this._databaseId.name+"/"+this._objectStore.name}onattach(){super.onattach(),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)}markNeedsRefresh(){this._view&&this._view.markNeedsRefresh();for(const e in this._idbIndexTreeElements)this._idbIndexTreeElements[e].markNeedsRefresh()}_handleContextMenuEvent(e){const t=new UI.ContextMenu.ContextMenu(e);t.defaultSection().appendItem(Common.UIString.UIString("Clear"),this._clearObjectStore.bind(this)),t.show()}_refreshObjectStore(){this._view&&this._view.refreshData();for(const e in this._idbIndexTreeElements)this._idbIndexTreeElements[e].refreshIndex()}async _clearObjectStore(){await this._model.clearObjectStore(this._databaseId,this._objectStore.name),this.update(this._objectStore,!0)}update(e,t){this._objectStore=e;const s={};for(const e in this._objectStore.indexes){const i=this._objectStore.indexes[e];if(s[i.name]=!0,!this._idbIndexTreeElements[i.name]){const e=new IDBIndexTreeElement(this._storagePanel,this._model,this._databaseId,this._objectStore,i,this._refreshObjectStore.bind(this));this._idbIndexTreeElements[i.name]=e,this.appendChild(e)}this._idbIndexTreeElements[i.name].update(this._objectStore,i,t)}for(const e in this._idbIndexTreeElements)s[e]||this._indexRemoved(e);for(const e in this._idbIndexTreeElements)s[e]||(this.removeChild(this._idbIndexTreeElements[e]),delete this._idbIndexTreeElements[e]);this.childCount()&&this.expand(),this._view&&t&&this._view.update(this._objectStore,null),this._updateTooltip()}_updateTooltip(){const e=this._objectStore.keyPathString;let t=null!==e?ls`Key path: ${e}`:"";this._objectStore.autoIncrement&&(t+="\n"+Common.UIString.UIString("autoIncrement")),this.tooltip=t}onselect(e){return super.onselect(e),this._view||(this._view=new IDBDataView(this._model,this._databaseId,this._objectStore,null,this._refreshObjectStore.bind(this))),this.showView(this._view),!1}_indexRemoved(e){const t=this._idbIndexTreeElements[e];t.clear(),this.removeChild(t),delete this._idbIndexTreeElements[e]}clear(){for(const e in this._idbIndexTreeElements)this._indexRemoved(e);this._view&&this._view.clear()}}export class IDBIndexTreeElement extends BaseStorageTreeElement{constructor(e,t,s,i,a,r){super(e,a.name,!1),this._model=t,this._databaseId=s,this._objectStore=i,this._index=a,this._refreshObjectStore=r}get itemURL(){return"indexedDB://"+this._databaseId.securityOrigin+"/"+this._databaseId.name+"/"+this._objectStore.name+"/"+this._index.name}markNeedsRefresh(){this._view&&this._view.markNeedsRefresh()}refreshIndex(){this._view&&this._view.refreshData()}update(e,t,s){this._objectStore=e,this._index=t,this._view&&s&&this._view.update(this._objectStore,this._index),this._updateTooltip()}_updateTooltip(){const e=[],t=this._index.keyPathString;e.push(ls`Key path: ${t}`),this._index.unique&&e.push(Common.UIString.UIString("unique")),this._index.multiEntry&&e.push(Common.UIString.UIString("multiEntry")),this.tooltip=e.join("\n")}onselect(e){return super.onselect(e),this._view||(this._view=new IDBDataView(this._model,this._databaseId,this._objectStore,this._index,this._refreshObjectStore)),this.showView(this._view),!1}clear(){this._view&&this._view.clear()}}export class DOMStorageTreeElement extends BaseStorageTreeElement{constructor(e,t){super(e,t.securityOrigin?t.securityOrigin:Common.UIString.UIString("Local Files"),!1),this._domStorage=t;const s=UI.Icon.Icon.create("mediumicon-table","resource-tree-item");this.setLeadingIcons([s])}get itemURL(){return"storage://"+this._domStorage.securityOrigin+"/"+(this._domStorage.isLocalStorage?"local":"session")}onselect(e){return super.onselect(e),this._storagePanel.showDOMStorage(this._domStorage),!1}onattach(){super.onattach(),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)}_handleContextMenuEvent(e){const t=new UI.ContextMenu.ContextMenu(e);t.defaultSection().appendItem(Common.UIString.UIString("Clear"),()=>this._domStorage.clear()),t.show()}}export class CookieTreeElement extends BaseStorageTreeElement{constructor(e,t,s){super(e,s||Common.UIString.UIString("Local Files"),!1),this._target=t.resourceTreeModel().target(),this._cookieDomain=s,this.tooltip=ls`Cookies used by frames from ${s}`;const i=UI.Icon.Icon.create("mediumicon-cookie","resource-tree-item");this.setLeadingIcons([i])}get itemURL(){return"cookies://"+this._cookieDomain}onattach(){super.onattach(),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)}_handleContextMenuEvent(e){const t=new UI.ContextMenu.ContextMenu(e);t.defaultSection().appendItem(Common.UIString.UIString("Clear"),()=>this._storagePanel.clearCookies(this._target,this._cookieDomain)),t.show()}onselect(e){return super.onselect(e),this._storagePanel.showCookies(this._target,this._cookieDomain),!1}}export class ApplicationCacheManifestTreeElement extends BaseStorageTreeElement{constructor(e,t){super(e,new Common.ParsedURL.ParsedURL(t).displayName,!1),this.tooltip=t,this._manifestURL=t}get itemURL(){return"appcache://"+this._manifestURL}get manifestURL(){return this._manifestURL}onselect(e){return super.onselect(e),this._storagePanel.showCategoryView(this._manifestURL,null),!1}}export class ApplicationCacheFrameTreeElement extends BaseStorageTreeElement{constructor(e,t,s){super(e._panel,"",!1),this._sidebar=e,this._frameId=t.id,this._manifestURL=s,this._refreshTitles(t);const i=UI.Icon.Icon.create("largeicon-navigator-folder","navigator-tree-item");i.classList.add("navigator-folder-tree-item"),this.setLeadingIcons([i])}get itemURL(){return"appcache://"+this._manifestURL+"/"+encodeURI(this.titleAsText())}get frameId(){return this._frameId}get manifestURL(){return this._manifestURL}_refreshTitles(e){this.title=e.displayName()}frameNavigated(e){this._refreshTitles(e)}onselect(e){return super.onselect(e),this._sidebar._showApplicationCache(this._frameId),!1}}export class StorageCategoryView extends UI.Widget.VBox{constructor(){super(),this.element.classList.add("storage-view"),this._emptyWidget=new UI.EmptyWidget.EmptyWidget(""),this._linkElement=null,this._emptyWidget.show(this.element)}setText(e){this._emptyWidget.text=e}setLink(e){e&&!this._linkElement&&(this._linkElement=this._emptyWidget.appendLink(e)),!e&&this._linkElement&&this._linkElement.classList.add("hidden"),e&&this._linkElement&&(this._linkElement.setAttribute("href",e),this._linkElement.classList.remove("hidden"))}}export class ResourcesSection{constructor(e,t){function s(e,t,s){SDK.SDKModel.TargetManager.instance().addModelListener(SDK.ResourceTreeModel.ResourceTreeModel,e,e=>t.call(s,e.data))}this._panel=e,this._treeElement=t,this._treeElementForFrameId=new Map,s(SDK.ResourceTreeModel.Events.FrameAdded,this._frameAdded,this),s(SDK.ResourceTreeModel.Events.FrameNavigated,this._frameNavigated,this),s(SDK.ResourceTreeModel.Events.FrameDetached,this._frameDetached,this),s(SDK.ResourceTreeModel.Events.ResourceAdded,this._resourceAdded,this);const i=SDK.SDKModel.TargetManager.instance().mainTarget(),a=i&&i.model(SDK.ResourceTreeModel.ResourceTreeModel),r=a&&a.mainFrame;r&&this._frameAdded(r)}static _getParentFrame(e){const t=e.parentFrame;if(t)return t;const s=e.resourceTreeModel().target().parentTarget();return s?s.model(SDK.ResourceTreeModel.ResourceTreeModel).mainFrame:null}_expandFrame(e){if(!e)return!1;let t=this._treeElementForFrameId.get(e.id);return!(!t&&!this._expandFrame(ResourcesSection._getParentFrame(e)))&&(t=this._treeElementForFrameId.get(e.id),!!t&&(t.expand(),!0))}async revealResource(e,t,s){if(!this._expandFrame(e.frame()))return;const i=FrameResourceTreeElement.forResource(e);i&&await i.revealResource(t,s)}_frameAdded(e){const t=ResourcesSection._getParentFrame(e),s=t?this._treeElementForFrameId.get(t.id):this._treeElement;if(!s)return;const i=new FrameTreeElement(this,e);this._treeElementForFrameId.set(e.id,i),s.appendChild(i)}_frameDetached(e){const t=this._treeElementForFrameId.get(e.id);t&&(this._treeElementForFrameId.delete(e.id),t.parent&&t.parent.removeChild(t))}_frameNavigated(e){const t=this._treeElementForFrameId.get(e.id);t&&t.frameNavigated(e)}_resourceAdded(e){const t=this._treeElementForFrameId.get(e.frameId);t&&t.appendResource(e)}reset(){this._treeElement.removeChildren(),this._treeElementForFrameId.clear()}}export class FrameTreeElement extends BaseStorageTreeElement{constructor(e,t){super(e._panel,"",!1),this._populated=!1,this._section=e,this._frame=t,this._frameId=t.id,this._categoryElements={},this._treeElementForResource={},this.setExpandable(!0),this.frameNavigated(t);const s=UI.Icon.Icon.create("largeicon-navigator-frame","navigator-tree-item");s.classList.add("navigator-frame-tree-item"),this.setLeadingIcons([s])}frameNavigated(e){this.invalidateChildren(),this._frameId=e.id,this.title=e.displayName(),this._categoryElements={},this._treeElementForResource={}}get itemURL(){return"frame://"+encodeURI(this.titleAsText())}onselect(e){return super.onselect(e),this._section._panel.showCategoryView(this.titleAsText(),null),this.listItemElement.classList.remove("hovered"),SDK.OverlayModel.OverlayModel.hideDOMNodeHighlight(),!1}set hovered(e){e?(this.listItemElement.classList.add("hovered"),this._frame.resourceTreeModel().domModel().overlayModel().highlightFrame(this._frameId)):(this.listItemElement.classList.remove("hovered"),SDK.OverlayModel.OverlayModel.hideDOMNodeHighlight())}appendResource(e){if(!this._populated)return;const t=e.statusCode;if(t>=301&&t<=303)return;const s=e.resourceType(),i=s.name();let a=s===Common.ResourceType.resourceTypes.Document?this:this._categoryElements[i];a||(a=new StorageCategoryTreeElement(this._section._panel,e.resourceType().category().title,i),this._categoryElements[s.name()]=a,this._insertInPresentationOrder(this,a));const r=new FrameResourceTreeElement(this._section._panel,e);this._insertInPresentationOrder(a,r),this._treeElementForResource[e.url]=r}resourceByURL(e){const t=this._treeElementForResource[e];return t?t._resource:null}appendChild(e){this._populated&&this._insertInPresentationOrder(this,e)}_insertInPresentationOrder(e,t){function s(e){return e instanceof StorageCategoryTreeElement?2:e instanceof FrameTreeElement?1:3}function i(e,t){const i=s(e),a=s(t);let r;return r=i>a?1:i<a?-1:e.titleAsText().localeCompare(t.titleAsText()),r}const a=e.childCount();let r;for(r=0;r<a&&!(i(t,e.childAt(r))<0);++r);e.insertChild(t,r)}async onpopulate(){this._populated=!0;for(const e of this._frame.childFrames)this._section._frameAdded(e);for(const e of this._frame.resources())this.appendResource(e)}}export class FrameResourceTreeElement extends BaseStorageTreeElement{constructor(e,t){super(e,t.displayName,!1),this._panel=e,this._resource=t,this._previewPromise=null,this.tooltip=t.url,this._resource[FrameResourceTreeElement._symbol]=this;const s=UI.Icon.Icon.create("largeicon-navigator-file","navigator-tree-item");s.classList.add("navigator-file-tree-item"),s.classList.add("navigator-"+t.resourceType().name()+"-tree-item"),this.setLeadingIcons([s])}static forResource(e){return e[FrameResourceTreeElement._symbol]}get itemURL(){return this._resource.url}_preparePreview(){if(this._previewPromise)return this._previewPromise;const e=SourceFrame.PreviewFactory.PreviewFactory.createPreview(this._resource,this._resource.mimeType);return this._previewPromise=e.then(e=>e||new UI.EmptyWidget.EmptyWidget(this._resource.url)),this._previewPromise}onselect(e){return super.onselect(e),this._panel.scheduleShowView(this._preparePreview()),!1}ondblclick(e){return Host.InspectorFrontendHost.InspectorFrontendHostInstance.openInNewTab(this._resource.url),!1}onattach(){super.onattach(),this.listItemElement.draggable=!0,this.listItemElement.addEventListener("dragstart",this._ondragstart.bind(this),!1),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)}_ondragstart(e){return e.dataTransfer.setData("text/plain",this._resource.content||""),e.dataTransfer.effectAllowed="copy",!0}_handleContextMenuEvent(e){const t=new UI.ContextMenu.ContextMenu(e);t.appendApplicableItems(this._resource),t.show()}async revealResource(e,t){this.revealAndSelect(!0);const s=await this._panel.scheduleShowView(this._preparePreview());s instanceof SourceFrame.ResourceSourceFrame.ResourceSourceFrame&&"number"==typeof e&&s.revealPosition(e,t,!0)}}FrameResourceTreeElement._symbol=Symbol("treeElement");