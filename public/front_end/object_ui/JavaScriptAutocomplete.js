import*as Common from"../common/common.js";import*as Formatter from"../formatter/formatter.js";import*as Platform from"../platform/platform.js";import*as SDK from"../sdk/sdk.js";import*as TextUtils from"../text_utils/text_utils.js";import*as UI from"../ui/ui.js";const DEFAULT_TIMEOUT=500;export class JavaScriptAutocomplete{constructor(){this._expressionCache=new Map,SDK.ConsoleModel.ConsoleModel.instance().addEventListener(SDK.ConsoleModel.Events.CommandEvaluated,this._clearCache,this),self.UI.context.addFlavorChangeListener(SDK.RuntimeModel.ExecutionContext,this._clearCache,this),SDK.SDKModel.TargetManager.instance().addModelListener(SDK.DebuggerModel.DebuggerModel,SDK.DebuggerModel.Events.DebuggerResumed,this._clearCache,this),SDK.SDKModel.TargetManager.instance().addModelListener(SDK.DebuggerModel.DebuggerModel,SDK.DebuggerModel.Events.DebuggerPaused,this._clearCache,this)}_clearCache(){this._expressionCache.clear()}async completionsForTextInCurrentContext(t,e,n){const o=t.trim(),[r,i]=await Promise.all([this._mapCompletions(o,e),this._completionsForExpression(o,e,n)]);return r.concat(i)}async argumentsHint(t){const e=await Formatter.FormatterWorkerPool.formatterWorkerPool().findLastFunctionCall(t);if(!e)return null;const n=self.UI.context.flavor(SDK.RuntimeModel.ExecutionContext);if(!n)return null;const o=await n.evaluate({expression:e.baseExpression,objectGroup:"argumentsHint",includeCommandLineAPI:!0,silent:!0,returnByValue:!1,generatePreview:!1,throwOnSideEffect:!0,timeout:500},!1,!1);if(!o||o.exceptionDetails||!o.object||"function"!==o.object.type)return n.runtimeModel.releaseObjectGroup("argumentsHint"),null;const r=await this._argumentsForFunction(o.object,async()=>{const t=await n.evaluate({expression:e.receiver,objectGroup:"argumentsHint",includeCommandLineAPI:!0,silent:!0,returnByValue:!1,generatePreview:!1,throwOnSideEffect:!0,timeout:500},!1,!1);return t&&!t.exceptionDetails&&t.object?t.object:null},e.functionName);return n.runtimeModel.releaseObjectGroup("argumentsHint"),!r.length||1===r.length&&!r[0].length?null:{args:r,argumentIndex:e.argumentIndex}}async _argumentsForFunction(t,e,n){const o=t.description;if(!o.endsWith("{ [native code] }"))return[await Formatter.FormatterWorkerPool.formatterWorkerPool().argumentsList(o)];if("function () { [native code] }"===o){const e=(await t.getOwnProperties(!1)).internalProperties||[],n=e.find(t=>"[[TargetFunction]]"===t.name),o=e.find(t=>"[[BoundArgs]]"===t.name),r=e.find(t=>"[[BoundThis]]"===t.name);if(r&&n&&o){const t=await this._argumentsForFunction(n.value,()=>Promise.resolve(r.value)),e=SDK.RemoteObject.RemoteObject.arrayLength(o.value),i=[];for(const n of t){const t=n.slice(0,e).findIndex(t=>t.startsWith("..."));-1!==t?i.push(n.slice(t)):i.push(n.slice(e))}return i}}const r=await self.runtime.extension(Common.JavaScriptMetaData.JavaScriptMetaData).instance(),i=/^function ([^(]*)\(/.exec(o)[1]||n;if(!i)return[];const s=r.signaturesForNativeFunction(i);if(s)return s;const a=await e(),c=a.className;if(r.signaturesForInstanceMethod(i,c))return r.signaturesForInstanceMethod(i,c);if("function"===a.type&&a.description.endsWith("{ [native code] }")){const t=/^function ([^(]*)\(/.exec(a.description)[1],e=r.signaturesForStaticMethod(i,t);if(e)return e}let l;if(l="number"===a.type?["Number","Object"]:"string"===a.type?["String","Object"]:"symbol"===a.type?["Symbol","Object"]:"bigint"===a.type?["BigInt","Object"]:"boolean"===a.type?["Boolean","Object"]:"undefined"===a.type||"null"===a.subtype?[]:await a.callFunctionJSON((function(){const t=[];for(let e=this;e;e=Object.getPrototypeOf(e))"object"==typeof e&&e.constructor&&e.constructor.name&&(t[t.length]=e.constructor.name);return t}),[]),!l)return[];for(const t of l){const e=r.signaturesForInstanceMethod(i,t);if(e)return e}return[]}async _mapCompletions(t,e){const n=t.match(/\.\s*(get|set|delete)\s*\(\s*$/),o=self.UI.context.flavor(SDK.RuntimeModel.ExecutionContext);if(!o||!n)return[];const r=await Formatter.FormatterWorkerPool.formatterWorkerPool().findLastExpression(t.substring(0,n.index));if(!r)return[];const i=await o.evaluate({expression:r,objectGroup:"mapCompletion",includeCommandLineAPI:!0,silent:!0,returnByValue:!1,generatePreview:!1,throwOnSideEffect:!0,timeout:500},!1,!1);if(i.error||i.exceptionDetails||"map"!==i.object.subtype)return[];const s=((await i.object.getOwnProperties(!1)).internalProperties||[]).find(t=>"[[Entries]]"===t.name);if(!s)return[];const a=await s.value.callFunctionJSON((function(){const t={__proto__:null};for(let e=0;e<this.length;e++)"string"==typeof this[e].key&&(t[this[e].key]=!0);return t}));return o.runtimeModel.releaseObjectGroup("mapCompletion"),function(t){const o=[],r=[],i=[],s=[];let a='"';e.startsWith("'")&&(a="'");let c=")";-1!==n[0].indexOf("set")&&(c=", ");const l=t.length<1e3?String.naturalOrderComparator:void 0,u=t.sort(l).map(t=>a+t+a);for(const t of u){if(t.length<e.length)continue;if(e.length&&-1===t.toLowerCase().indexOf(e.toLowerCase()))continue;const n=t.split("\n").join("\\n"),a=n+c;t.startsWith(e)?o.push({text:a,title:n,priority:4}):t.toLowerCase().startsWith(e.toLowerCase())?r.push({text:a,title:n,priority:3}):-1!==t.indexOf(e)?i.push({text:a,title:n,priority:2}):s.push({text:a,title:n,priority:1})}const m=o.concat(r,i,s);m.length&&(m[0].subtitle=Common.UIString.UIString("Keys"));return m}(Object.keys(a))}async _completionsForExpression(t,e,n){const o=self.UI.context.flavor(SDK.RuntimeModel.ExecutionContext);if(!o)return[];let r;if((t.endsWith(".")||t.endsWith("["))&&(r=await Formatter.FormatterWorkerPool.formatterWorkerPool().findLastExpression(t.substring(0,t.length-1))),!r){if(t.endsWith("."))return[];r=""}const i=r,s=t.endsWith("."),a=!!i&&t.endsWith("[");if(i&&!isNaN(i)||!i&&e&&!isNaN(e))return[];if(!e&&!i&&!n)return[];const c=o.debuggerModel.selectedCallFrame();let l;let u=this._expressionCache.get(i);if(u&&u.date+1e4>Date.now())l=await u.value;else if(!i&&c)u={date:Date.now(),value:async function(t){const e=[{items:["this"]}],n=t.scopeChain(),r=[];for(const t of n)r.push(t.object().getAllProperties(!1,!1).then(e=>({properties:e.properties,name:t.name()})));const i=await Promise.all(r);o.runtimeModel.releaseObjectGroup("completion");for(const t of i)e.push({title:t.name,items:t.properties.map(t=>t.name).sort()});return e}(c)},this._expressionCache.set(i,u),l=await u.value;else{const t=o.evaluate({expression:i,objectGroup:"completion",includeCommandLineAPI:!0,silent:!0,returnByValue:!1,generatePreview:!1,throwOnSideEffect:!0,timeout:500},!1,!1);u={date:Date.now(),value:t.then(t=>m.call(this,t))},this._expressionCache.set(i,u),l=await u.value}return this._receivedPropertyNames(l.slice(0),s,a,i,e);async function m(t){if(t.error||t.exceptionDetails||!t.object)return[];let e=t.object;for(;e&&"object"===e.type&&"proxy"===e.subtype;){const t=((await e.getOwnProperties(!1)).internalProperties||[]).find(t=>"[[Target]]"===t.name);e=t?t.value:null}if(!e)return[];let n=[];if("object"===e.type||"function"===e.type)n=await e.callFunctionJSON(r,[SDK.RemoteObject.RemoteObject.toCallArgument(e.subtype)])||[];else if("string"===e.type||"number"===e.type||"boolean"===e.type||"bigint"===e.type){const t=await o.evaluate({expression:"("+r+')("'+e.type+'")',objectGroup:"completion",includeCommandLineAPI:!1,silent:!0,returnByValue:!0,generatePreview:!1},!1,!1);t.object&&!t.exceptionDetails&&(n=t.object.value||[])}if(o.runtimeModel.releaseObjectGroup("completion"),!i){const t=await o.globalLexicalScopeNames();n.length?n[0].items=n[0].items.concat(t):n.push({items:t.sort(),title:Common.UIString.UIString("Lexical scope variables")})}for(const t of n){for(let e=0;e<t.items.length;e++)t.items[e]=t.items[e].replace(/\n/g,"\\n");t.items.sort(t.items.length<1e3?this._itemComparator:void 0)}return n;function r(t){let e;e="string"===t?new String(""):"number"===t?new Number(0):"bigint"===t?Object(BigInt(0)):"boolean"===t?new Boolean(!1):this;const n=[];try{for(let o=e;o;o=Object.getPrototypeOf(o)){if(("array"===t||"typedarray"===t)&&o===e&&o.length>9999)continue;const r={items:[],__proto__:null};try{"object"==typeof o&&Object.prototype.hasOwnProperty.call(o,"constructor")&&o.constructor&&o.constructor.name&&(r.title=o.constructor.name)}catch(t){}n[n.length]=r;const i=Object.getOwnPropertyNames(o),s=Array.isArray(o);for(let t=0;t<i.length&&r.items.length<1e4;++t)s&&/^[0-9]/.test(i[t])||(r.items[r.items.length]=i[t])}}catch(t){}return n}}}_receivedPropertyNames(t,e,n,o,r){if(!t)return[];if(!e&&!n){const e=["dir","dirxml","keys","values","profile","profileEnd","monitorEvents","unmonitorEvents","inspect","copy","clear","getEventListeners","debug","undebug","monitor","unmonitor","table","queryObjects","$","$$","$x","$0","$_"];t.push({items:e})}return this._completionsForQuery(e,n,o,r,t)}_completionsForQuery(t,e,n,o,r){const i=e&&o.startsWith("'")?"'":'"';if(!n){const t=["await","break","case","catch","class","const","continue","debugger","default","delete","do","else","exports","extends","finally","for","function","if","import","in","instanceof","new","return","super","switch","this","throw","try","typeof","var","void","while","with","yield","let","static","async","of"];r.push({title:ls`keywords`,items:t.sort()})}const s=new Set;let a,c=[];const l=/^[a-zA-Z_$\u008F-\uFFFF][a-zA-Z0-9_$\u008F-\uFFFF]*$/,u=o.toLowerCase();for(const t of r){const n=[],r=[],m=[],p=[];for(let a=0;a<t.items.length;a++){let c=t.items[a];if(!e&&!l.test(c))continue;if(e&&(/^[0-9]+$/.test(c)||(c=i+Platform.StringUtilities.escapeCharacters(c,i+"\\")+i),c+="]"),s.has(c))continue;if(c.length<o.length)continue;const d=c.toLowerCase();o.length&&-1===d.indexOf(u)||(s.add(c),c.startsWith(o)?n.push({text:c,priority:c===o?5:4}):d.startsWith(u)?r.push({text:c,priority:3}):-1!==c.indexOf(o)?m.push({text:c,priority:2}):p.push({text:c,priority:1}))}const d=n.concat(r,m,p);d.length&&t.title!==a&&(d[0].subtitle=t.title,a=t.title),c=c.concat(d),c.forEach(t=>{t.text.endsWith("]")&&(t.title=t.text.substring(0,t.text.length-1))})}return c}_itemComparator(t,e){const n=t.startsWith("_"),o=e.startsWith("_");return n&&!o?1:o&&!n?-1:String.naturalOrderComparator(t,e)}static async isExpressionComplete(t){const e=self.UI.context.flavor(SDK.RuntimeModel.ExecutionContext);if(!e)return!0;const n=await e.runtimeModel.compileScript(t,"",!1,e.id);if(!n||!n.exceptionDetails)return!0;const o=n.exceptionDetails.exception.description;return!o.startsWith("SyntaxError: Unexpected end of input")&&!o.startsWith("SyntaxError: Unterminated template literal")}}export class JavaScriptAutocompleteConfig{constructor(t){this._editor=t}static createConfigForEditor(t){const e=new JavaScriptAutocompleteConfig(t);return{substituteRangeCallback:e._substituteRange.bind(e),suggestionsCallback:e._suggestionsCallback.bind(e),tooltipCallback:e._tooltipCallback.bind(e)}}_substituteRange(t,e){const n=this._editor.tokenAtTextPosition(t,e);if(n&&"js-string"===n.type)return new TextUtils.TextRange.TextRange(t,n.startColumn,t,e);const o=this._editor.line(t);let r;for(r=e-1;r>=0&&-1===" =:[({;,!+-*/&|^<>.\t\r\n".indexOf(o.charAt(r));r--);return new TextUtils.TextRange.TextRange(t,r+1,t,e)}async _suggestionsCallback(t,e,n){const o=this._editor.text(t),r=this._editor.text(new TextUtils.TextRange.TextRange(0,0,t.startLine,t.startColumn)),i=this._editor.tokenAtTextPosition(e.startLine,e.startColumn);if(i){const t=new Set(["js-comment","js-string-2","js-def"]),e=r.trim();if(e.endsWith("[")||e.match(/\.\s*(get|set|delete)\s*\(\s*$/)||t.add("js-string"),e.endsWith(".")||t.add("js-property"),t.has(i.type))return[]}const s=this._editor.line(t.startLine).substring(t.startColumn),a=await ObjectUI.javaScriptAutocomplete.completionsForTextInCurrentContext(r,o,n);return!n&&s&&s!==o&&a.some(t=>s.startsWith(t.text)&&o.length!==t.text.length)?[]:a}async _tooltipCallback(t,e){const n=this._editor.text(new TextUtils.TextRange.TextRange(0,0,t,e)),o=await ObjectUI.javaScriptAutocomplete.argumentsHint(n);if(!o)return null;const r=o.argumentIndex,i=createElement("div");for(const t of o.args){const e=createElement("span");for(let n=0;n<t.length;n++)n===r||n<r&&t[n].startsWith("...")?e.appendChild(UI.Fragment.html`<b>${t[n]}</b>`):e.createTextChild(t[n]),n<t.length-1&&e.createTextChild(", ");i.appendChild(UI.Fragment.html`<div class='source-code'>\u0192(${e})</div>`)}return i}}export let CompletionGroup;