import*as Common from"../common/common.js";import*as ObjectUI from"../object_ui/object_ui.js";import*as SDK from"../sdk/sdk.js";import*as UI from"../ui/ui.js";export class RequestHeadersView extends UI.Widget.VBox{constructor(e){super(),this.registerRequiredCSS("network/requestHeadersView.css"),this.element.classList.add("request-headers-view"),this._request=e,this._decodeRequestParameters=!0,this._showRequestHeadersText=!1,this._showResponseHeadersText=!1;const t=e.requestContentType();t&&(this._decodeRequestParameters=!!t.match(/^application\/x-www-form-urlencoded\s*(;.*)?$/i)),this._highlightedElement=null;const s=new UI.TreeOutline.TreeOutlineInShadow;s.registerRequiredCSS("object_ui/objectValue.css"),s.registerRequiredCSS("object_ui/objectPropertiesSection.css"),s.registerRequiredCSS("network/requestHeadersTree.css"),s.element.classList.add("request-headers-tree"),s.makeDense(),this.element.appendChild(s.element);const r=new Category(s,"general",Common.UIString.UIString("General"));r.hidden=!1,this._root=r,this._urlItem=r.createLeaf(),this._requestMethodItem=r.createLeaf(),this._statusCodeItem=r.createLeaf(),this._remoteAddressItem=r.createLeaf(),this._remoteAddressItem.hidden=!0,this._referrerPolicyItem=r.createLeaf(),this._referrerPolicyItem.hidden=!0,this._responseHeadersCategory=new Category(s,"responseHeaders",""),this._requestHeadersCategory=new Category(s,"requestHeaders",""),this._queryStringCategory=new Category(s,"queryString",""),this._formDataCategory=new Category(s,"formData",""),this._requestPayloadCategory=new Category(s,"requestPayload",Common.UIString.UIString("Request Payload"))}wasShown(){this._clearHighlight(),this._request.addEventListener(SDK.NetworkRequest.Events.RemoteAddressChanged,this._refreshRemoteAddress,this),this._request.addEventListener(SDK.NetworkRequest.Events.RequestHeadersChanged,this._refreshRequestHeaders,this),this._request.addEventListener(SDK.NetworkRequest.Events.ResponseHeadersChanged,this._refreshResponseHeaders,this),this._request.addEventListener(SDK.NetworkRequest.Events.FinishedLoading,this._refreshHTTPInformation,this),this._refreshURL(),this._refreshQueryString(),this._refreshRequestHeaders(),this._refreshResponseHeaders(),this._refreshHTTPInformation(),this._refreshRemoteAddress(),this._refreshReferrerPolicy(),this._root.select(!0,!1)}willHide(){this._request.removeEventListener(SDK.NetworkRequest.Events.RemoteAddressChanged,this._refreshRemoteAddress,this),this._request.removeEventListener(SDK.NetworkRequest.Events.RequestHeadersChanged,this._refreshRequestHeaders,this),this._request.removeEventListener(SDK.NetworkRequest.Events.ResponseHeadersChanged,this._refreshResponseHeaders,this),this._request.removeEventListener(SDK.NetworkRequest.Events.FinishedLoading,this._refreshHTTPInformation,this)}_formatHeader(e,t){const s=createDocumentFragment();return s.createChild("div","header-name").textContent=e+": ",s.createChild("span","header-separator"),s.createChild("div","header-value source-code").textContent=t,s}_formatHeaderObject(e){const t=createDocumentFragment();e.headerNotSet&&(t.createChild("div","header-badge header-badge-text").textContent="not-set");const s=e.value?": ":"";if(t.createChild("div","header-name").textContent=e.name+s,t.createChild("span","header-separator"),e.value&&(e.headerValueIncorrect?t.createChild("div","header-value source-code header-warning").textContent=e.value:t.createChild("div","header-value source-code").textContent=e.value),e.details){const s=t.createChild("div","header-details").createChild("div","call-to-action").createChild("div","call-to-action-body");s.createChild("div","explanation").textContent=e.details.explanation;for(const t of e.details.examples){const e=s.createChild("div","example");e.createChild("code").textContent=t.codeSnippet,t.comment&&(e.createChild("span","comment").textContent=t.comment)}if(Root.Runtime.experiments.isEnabled("issuesPane")&&SDK.RelatedIssue.hasIssueOfCategory(this._request,SDK.Issue.IssueCategory.CrossOriginEmbedderPolicy)){const e=createElementWithClass("div","devtools-link");e.onclick=()=>{SDK.RelatedIssue.reveal(this._request,SDK.Issue.IssueCategory.CrossOriginEmbedderPolicy)};const t=createElementWithClass("span","devtools-link");t.textContent="Learn more in the issues panel",e.appendChild(t),e.prepend(UI.Icon.Icon.create("largeicon-breaking-change","icon")),s.appendChild(e)}else if(e.details.link){const t=UI.XLink.XLink.create(e.details.link.url,ls`Learn more`,"link");t.prepend(UI.Icon.Icon.create("largeicon-link","link-icon")),s.appendChild(t)}}return t}_formatParameter(e,t,s){let r=!1;if(s&&(e=e.replace(/\+/g," ")).indexOf("%")>=0)try{e=decodeURIComponent(e)}catch(e){r=!0}const o=createElementWithClass("div",t);return""===e&&o.classList.add("empty-value"),r?o.createChild("span","header-decode-error").textContent=Common.UIString.UIString("(unable to decode value)"):o.textContent=e,o}_refreshURL(){this._urlItem.title=this._formatHeader(Common.UIString.UIString("Request URL"),this._request.url())}_refreshQueryString(){const e=this._request.queryString(),t=this._request.queryParameters;this._queryStringCategory.hidden=!t,t&&this._refreshParams(Common.UIString.UIString("Query String Parameters"),t,e,this._queryStringCategory)}async _refreshFormData(){const e=await this._request.requestFormData();if(!e)return this._formDataCategory.hidden=!0,void(this._requestPayloadCategory.hidden=!0);const t=await this._request.formParameters();if(t)this._formDataCategory.hidden=!1,this._requestPayloadCategory.hidden=!0,this._refreshParams(Common.UIString.UIString("Form Data"),t,e,this._formDataCategory);else{this._requestPayloadCategory.hidden=!1,this._formDataCategory.hidden=!0;try{const t=JSON.parse(e);this._refreshRequestJSONPayload(t,e)}catch(t){this._populateTreeElementWithSourceText(this._requestPayloadCategory,e)}}}_populateTreeElementWithSourceText(e,t){const s=(t||"").trim(),r=s.length>3e3,o=createElementWithClass("span","header-value source-code");o.textContent=r?s.substr(0,3e3):s;const n=new UI.TreeOutline.TreeElement(o);if(e.removeChildren(),e.appendChild(n),!r)return;const i=createElementWithClass("button","request-headers-show-more-button");function a(){i.remove(),o.textContent=s,n.listItemElement.removeEventListener("contextmenu",d)}function d(e){const t=new UI.ContextMenu.ContextMenu(e);t.newSection().appendItem(ls`Show more`,a),t.show()}i.textContent=Common.UIString.UIString("Show more"),i.addEventListener("click",a),n.listItemElement.addEventListener("contextmenu",d),o.appendChild(i)}_refreshParams(e,t,s,r){r.removeChildren(),r.listItemElement.removeChildren(),r.listItemElement.createChild("div","selection fill"),r.listItemElement.createTextChild(e);const o=createElementWithClass("span","header-count");o.textContent=Common.UIString.UIString(" (%d)",t.length),r.listItemElement.appendChild(o);r[_viewSourceSymbol]?this._appendParamsSource(e,t,s,r):this._appendParamsParsed(e,t,s,r)}_appendParamsSource(e,t,s,r){this._populateTreeElementWithSourceText(r,s);const o=r.listItemElement,n=function(n){o.removeEventListener("contextmenu",i),r[_viewSourceSymbol]=!1,this._refreshParams(e,t,s,r),n.consume()},i=function(e){if(!r.expanded)return;const t=new UI.ContextMenu.ContextMenu(e);t.newSection().appendItem(ls`View parsed`,n.bind(this,e)),t.show()}.bind(this),a=this._createViewSourceToggle(!0,n.bind(this));o.appendChild(a),o.addEventListener("contextmenu",i)}_appendParamsParsed(e,t,s,r){for(let e=0;e<t.length;++e){const s=createDocumentFragment();if(""!==t[e].name){const r=this._formatParameter(t[e].name+": ","header-name",this._decodeRequestParameters),o=this._formatParameter(t[e].value,"header-value source-code",this._decodeRequestParameters);s.appendChild(r),s.createChild("span","header-separator"),s.appendChild(o)}else s.appendChild(this._formatParameter(Common.UIString.UIString("(empty)"),"empty-request-header",this._decodeRequestParameters));const o=new UI.TreeOutline.TreeElement(s);r.appendChild(o)}const o=r.listItemElement,n=function(n){o.removeEventListener("contextmenu",a),r[_viewSourceSymbol]=!0,this._refreshParams(e,t,s,r),n.consume()},i=function(e){o.removeEventListener("contextmenu",a),this._toggleURLDecoding(e)},a=function(e){if(!r.expanded)return;const t=new UI.ContextMenu.ContextMenu(e),s=t.newSection();s.appendItem(ls`View source`,n.bind(this,e));const o=this._decodeRequestParameters?ls`View URL encoded`:ls`View decoded`;s.appendItem(o,i.bind(this,e)),t.show()}.bind(this),d=this._createViewSourceToggle(!1,n.bind(this));o.appendChild(d);const h=this._decodeRequestParameters?ls`view URL encoded`:ls`view decoded`,l=this._createToggleButton(h);l.addEventListener("click",i.bind(this),!1),o.appendChild(l),o.addEventListener("contextmenu",a)}_refreshRequestJSONPayload(e,t){const s=this._requestPayloadCategory;s.removeChildren();const r=s.listItemElement;r.removeChildren(),r.createChild("div","selection fill"),r.createTextChild(this._requestPayloadCategory.title);s[_viewSourceSymbol]?this._appendJSONPayloadSource(s,e,t):this._appendJSONPayloadParsed(s,e,t)}_appendJSONPayloadSource(e,t,s){const r=e.listItemElement;this._populateTreeElementWithSourceText(e,s);const o=function(o){r.removeEventListener("contextmenu",i),e[_viewSourceSymbol]=!1,this._refreshRequestJSONPayload(t,s),o.consume()},n=this._createViewSourceToggle(!0,o.bind(this));r.appendChild(n);const i=function(t){if(!e.expanded)return;const s=new UI.ContextMenu.ContextMenu(t);s.newSection().appendItem(ls`View parsed`,o.bind(this,t)),s.show()}.bind(this);r.addEventListener("contextmenu",i)}_appendJSONPayloadParsed(e,t,s){const r=SDK.RemoteObject.RemoteObject.fromLocalObject(t),o=new ObjectUI.ObjectPropertiesSection.RootElement(r);o.title=r.description,o.expand(),o.editable=!1,e.childrenListElement.classList.add("source-code","object-properties-section"),e.appendChild(o);const n=e.listItemElement,i=function(r){n.removeEventListener("contextmenu",a),e[_viewSourceSymbol]=!0,this._refreshRequestJSONPayload(t,s),r.consume()},a=function(t){if(!e.expanded)return;const s=new UI.ContextMenu.ContextMenu(t);s.newSection().appendItem(ls`View source`,i.bind(this,t)),s.show()}.bind(this),d=this._createViewSourceToggle(!1,i.bind(this));n.appendChild(d),n.addEventListener("contextmenu",a)}_createViewSourceToggle(e,t){const s=e?Common.UIString.UIString("view parsed"):Common.UIString.UIString("view source"),r=this._createToggleButton(s);return r.addEventListener("click",t,!1),r}_toggleURLDecoding(e){this._decodeRequestParameters=!this._decodeRequestParameters,this._refreshQueryString(),this._refreshFormData(),e.consume()}_refreshRequestHeaders(){const e=this._requestHeadersCategory,t=this._request.requestHeaders().slice();t.sort((function(e,t){return e.name.toLowerCase().compareTo(t.name.toLowerCase())}));const s=this._request.requestHeadersText();if(this._showRequestHeadersText&&s?this._refreshHeadersText(Common.UIString.UIString("Request Headers"),t.length,s,e):this._refreshHeaders(Common.UIString.UIString("Request Headers"),t,e,void 0===s),s){const t=this._createHeadersToggleButton(this._showRequestHeadersText);t.addEventListener("click",this._toggleRequestHeadersText.bind(this),!1),e.listItemElement.appendChild(t)}this._refreshFormData()}_refreshResponseHeaders(){const e=this._responseHeadersCategory,t=this._request.sortedResponseHeaders.slice(),s=this._request.responseHeadersText;if(this._showResponseHeadersText)this._refreshHeadersText(Common.UIString.UIString("Response Headers"),t.length,s,e);else{const s=[];if(this._request.wasBlocked()){const e=BlockedReasonDetails.get(this._request.blockedReason());e&&s.push(e)}this._refreshHeaders(Common.UIString.UIString("Response Headers"),function(e,t){let s=0,r=0;const o=[];for(;s<e.length||r<t.length;)s<e.length&&(r>=t.length||e[s].name<t[r].name)?o.push({...e[s++],headerNotSet:!1}):r<t.length&&(s>=e.length||e[s].name>t[r].name)?o.push({...t[r++],headerNotSet:!0}):s<e.length&&r<t.length&&e[s].name===t[r].name&&o.push({...t[r++],...e[s++],headerNotSet:!1});return o}(t,s),e,!1,this._request.blockedResponseCookies())}if(s){const t=this._createHeadersToggleButton(this._showResponseHeadersText);t.addEventListener("click",this._toggleResponseHeadersText.bind(this),!1),e.listItemElement.appendChild(t)}}_refreshHTTPInformation(){const e=this._requestMethodItem;e.hidden=!this._request.statusCode;const t=this._statusCodeItem;if(t.hidden=!this._request.statusCode,this._request.statusCode){const s=createDocumentFragment();s.createChild("div","header-name").textContent=ls`Status Code`+": ",s.createChild("span","header-separator");const r=s.createChild("span","resource-status-image","dt-icon-label");r.title=this._request.statusCode+" "+this._request.statusText,this._request.statusCode<300||304===this._request.statusCode?r.type="smallicon-green-ball":this._request.statusCode<400?r.type="smallicon-orange-ball":r.type="smallicon-red-ball",e.title=this._formatHeader(ls`Request Method`,this._request.requestMethod);const o=s.createChild("div","header-value source-code");let n=this._request.statusCode+" "+this._request.statusText;this._request.cachedInMemory()?(n+=" "+ls`(from memory cache)`,o.classList.add("status-from-cache")):this._request.fetchedViaServiceWorker?(n+=" "+ls`(from ServiceWorker)`,o.classList.add("status-from-cache")):this._request.redirectSource()&&this._request.redirectSource().signedExchangeInfo()&&!this._request.redirectSource().signedExchangeInfo().errors?(n+=" "+ls`(from signed-exchange)`,o.classList.add("status-from-cache")):this._request.fromPrefetchCache()?(n+=" "+ls`(from prefetch cache)`,o.classList.add("status-from-cache")):this._request.cached()&&(n+=" "+ls`(from disk cache)`,o.classList.add("status-from-cache")),o.textContent=n,t.title=s}}_refreshHeadersTitle(e,t,s){t.listItemElement.removeChildren(),t.listItemElement.createChild("div","selection fill"),t.listItemElement.createTextChild(e);const r=Common.UIString.UIString(" (%d)",s);t.listItemElement.createChild("span","header-count").textContent=r}_refreshHeaders(e,t,s,r,o){s.removeChildren();const n=t.length;if(this._refreshHeadersTitle(e,s,n),r){let e,t="";this._request.cachedInMemory()||this._request.cached()?(e=ls`Provisional headers are shown. Disable cache to see full headers.`,t=ls`Only provisional headers are available because this request was not sent over the network and instead was served from a local cache, which doesn't store the original request headers. Disable cache to see full request headers.`):e=ls`Provisional headers are shown`;const r=createElement("div");r.title=t,r.createChild("span","","dt-icon-label").type="smallicon-warning",r.createChild("div","caution").textContent=e;const o=new UI.TreeOutline.TreeElement(r);s.appendChild(o)}const i=new Map;o&&o.forEach(e=>{i.set(e.cookieLine,e.blockedReasons)}),s.hidden=!n&&!r;for(let e=0;e<n;++e){const r=new UI.TreeOutline.TreeElement(this._formatHeaderObject(t[e]));if(r[_headerNameSymbol]=t[e].name,"set-cookie"===t[e].name.toLowerCase()){const s=i.get(t[e].value);if(s){const e=UI.Icon.Icon.create("smallicon-warning","");r.listItemElement.appendChild(e);let t="";for(const e of s)t&&(t+="\n"),t+=SDK.NetworkRequest.setCookieBlockedReasonToUiString(e);e.title=t}}s.appendChild(r)}}_refreshHeadersText(e,t,s,r){this._populateTreeElementWithSourceText(r,s),this._refreshHeadersTitle(e,r,t)}_refreshRemoteAddress(){const e=this._request.remoteAddress(),t=this._remoteAddressItem;t.hidden=!e,e&&(t.title=this._formatHeader(Common.UIString.UIString("Remote Address"),e))}_refreshReferrerPolicy(){const e=this._request.referrerPolicy(),t=this._referrerPolicyItem;t.hidden=!e,e&&(t.title=this._formatHeader(Common.UIString.UIString("Referrer Policy"),e))}_toggleRequestHeadersText(e){this._showRequestHeadersText=!this._showRequestHeadersText,this._refreshRequestHeaders(),e.consume()}_toggleResponseHeadersText(e){this._showResponseHeadersText=!this._showResponseHeadersText,this._refreshResponseHeaders(),e.consume()}_createToggleButton(e){const t=createElementWithClass("span","header-toggle");return t.textContent=e,t}_createHeadersToggleButton(e){const t=e?Common.UIString.UIString("view parsed"):Common.UIString.UIString("view source");return this._createToggleButton(t)}_clearHighlight(){this._highlightedElement&&this._highlightedElement.listItemElement.classList.remove("header-highlight"),this._highlightedElement=null}_revealAndHighlight(e,t){this._clearHighlight();for(const s of e.children())if(s[_headerNameSymbol]===t)return this._highlightedElement=s,s.reveal(),void s.listItemElement.classList.add("header-highlight")}revealRequestHeader(e){this._revealAndHighlight(this._requestHeadersCategory,e)}revealResponseHeader(e){this._revealAndHighlight(this._responseHeadersCategory,e)}}export const _headerNameSymbol=Symbol("HeaderName");export const _viewSourceSymbol=Symbol("ViewSource");export class Category extends UI.TreeOutline.TreeElement{constructor(e,t,s){super(s||"",!0),this.toggleOnClick=!0,this.hidden=!0,this._expandedSetting=Common.Settings.Settings.instance().createSetting("request-info-"+t+"-category-expanded",!0),this.expanded=this._expandedSetting.get(),e.appendChild(this)}createLeaf(){const e=new UI.TreeOutline.TreeElement;return this.appendChild(e),e}onexpand(){this._expandedSetting.set(!0)}oncollapse(){this._expandedSetting.set(!1)}}const BlockedReasonDetails=new Map([[Protocol.Network.BlockedReason.CoepFrameResourceNeedsCoepHeader,{name:"cross-origin-embedder-policy",value:null,details:{explanation:ls`To embed this frame in your document, the response needs to enable the cross-origin embedder policy by specifying the following response header:`,examples:[{codeSnippet:"Cross-Origin-Embedder-Policy: require-corp"}],link:{url:"https://web.dev/coop-coep/"}}}],[Protocol.Network.BlockedReason.CorpNotSameOriginAfterDefaultedToSameOriginByCoep,{name:"cross-origin-resource-policy",value:null,details:{explanation:ls`To use this resource from a different origin, the server needs to specify a cross-origin resource policy in the response headers:`,examples:[{codeSnippet:"Cross-Origin-Resource-Policy: same-site",comment:ls`Choose this option if the resource and the document are served from the same site.`},{codeSnippet:"Cross-Origin-Resource-Policy: cross-origin",comment:ls`Only choose this option if an arbitrary website including this resource does not impose a security risk.`}],link:{url:"https://web.dev/coop-coep/"}}}],[Protocol.Network.BlockedReason.CoopSandboxedIframeCannotNavigateToCoopPage,{name:"cross-origin-opener-policy",value:null,headerValueIncorrect:!1,details:{explanation:ls`This document was blocked from loading in an iframe with a sandbox attribute because this document specified a cross-origin opener policy.`,examples:[],link:{url:"https://web.dev/coop-coep/"}}}],[Protocol.Network.BlockedReason.CorpNotSameSite,{name:"cross-origin-resource-policy",value:null,headerValueIncorrect:!0,details:{explanation:ls`To use this resource from a different site, the server may relax the cross-origin resource policy response header:`,examples:[{codeSnippet:"Cross-Origin-Resource-Policy: cross-origin",comment:ls`Only choose this option if an arbitrary website including this resource does not impose a security risk.`}]}}],[Protocol.Network.BlockedReason.CorpNotSameOrigin,{name:"cross-origin-resource-policy",value:null,headerValueIncorrect:!0,details:{explanation:ls`To use this resource from a different origin, the server may relax the cross-origin resource policy response header:`,examples:[{codeSnippet:"Cross-Origin-Resource-Policy: same-site",comment:ls`Choose this option if the resource and the document are served from the same site.`},{codeSnippet:"Cross-Origin-Resource-Policy: cross-origin",comment:ls`Only choose this option if an arbitrary website including this resource does not impose a security risk.`}]}}]]);