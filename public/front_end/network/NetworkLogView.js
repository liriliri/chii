import*as Bindings from"../bindings/bindings.js";import*as Common from"../common/common.js";import*as Components from"../components/components.js";import*as DataGrid from"../data_grid/data_grid.js";import*as HARImporter from"../har_importer/har_importer.js";import*as Host from"../host/host.js";import*as PerfUI from"../perf_ui/perf_ui.js";import*as SDK from"../sdk/sdk.js";import*as TextUtils from"../text_utils/text_utils.js";import*as UI from"../ui/ui.js";import{HARWriter}from"./HARWriter.js";import{Events,NetworkGroupNode,NetworkLogViewInterface,NetworkNode,NetworkRequestNode}from"./NetworkDataGridNode.js";import{NetworkFrameGrouper}from"./NetworkFrameGrouper.js";import{NetworkLogViewColumns}from"./NetworkLogViewColumns.js";import{NetworkTimeBoundary,NetworkTimeCalculator,NetworkTransferDurationCalculator,NetworkTransferTimeCalculator}from"./NetworkTimeCalculator.js";export class NetworkLogView extends UI.Widget.VBox{constructor(e,t,r){function i(){this._rawRowHeight=this._networkLogLargeRowsSetting.get()?41:21,this._rowHeight=this._computeRowHeight()}super(),this.setMinimumSize(50,64),this.registerRequiredCSS("network/networkLogView.css"),this.element.id="network-container",this.element.classList.add("no-node-selected"),this._networkHideDataURLSetting=Common.Settings.Settings.instance().createSetting("networkHideDataURL",!1),this._networkShowIssuesOnlySetting=Common.Settings.Settings.instance().createSetting("networkShowIssuesOnly",!1),this._networkOnlyBlockedRequestsSetting=Common.Settings.Settings.instance().createSetting("networkOnlyBlockedRequests",!1),this._networkResourceTypeFiltersSetting=Common.Settings.Settings.instance().createSetting("networkResourceTypeFilters",{}),this._rawRowHeight=0,this._progressBarContainer=t,this._networkLogLargeRowsSetting=r,this._networkLogLargeRowsSetting.addChangeListener(i.bind(this),this),this._rawRowHeight=0,this._rowHeight=0,i.call(this),this._timeCalculator=new NetworkTransferTimeCalculator,this._durationCalculator=new NetworkTransferDurationCalculator,this._calculator=this._timeCalculator,this._columns=new NetworkLogViewColumns(this,this._timeCalculator,this._durationCalculator,r),this._columns.show(this.element),this._staleRequests=new Set,this._mainRequestLoadTime=-1,this._mainRequestDOMContentLoadedTime=-1,this._highlightedSubstringChanges=[],this._filters=[],this._timeFilter=null,this._hoveredNode=null,this._recordingHint=null,this._refreshRequestId=null,this._highlightedNode=null,this.linkifier=new Components.Linkifier.Linkifier,this._recording=!1,this._needsRefresh=!1,this._headerHeight=0,this._groupLookups=new Map,this._groupLookups.set("Frame",new NetworkFrameGrouper(this)),this._activeGroupLookup=null,this._textFilterUI=new UI.FilterBar.TextFilterUI,this._textFilterUI.addEventListener(UI.FilterBar.FilterUI.Events.FilterChanged,this._filterChanged,this),e.addFilter(this._textFilterUI),this._dataURLFilterUI=new UI.FilterBar.CheckboxFilterUI("hide-data-url",Common.UIString.UIString("Hide data URLs"),!0,this._networkHideDataURLSetting),this._dataURLFilterUI.addEventListener(UI.FilterBar.FilterUI.Events.FilterChanged,this._filterChanged.bind(this),this),this._dataURLFilterUI.element().title=ls`Hides data: and blob: URLs`,e.addFilter(this._dataURLFilterUI);const o=Object.values(Common.ResourceType.resourceCategories).map(e=>({name:e.title,label:e.shortTitle,title:e.title}));this._resourceCategoryFilterUI=new UI.FilterBar.NamedBitSetFilterUI(o,this._networkResourceTypeFiltersSetting),UI.ARIAUtils.setAccessibleName(this._resourceCategoryFilterUI.element(),ls`Resource types to include`),this._resourceCategoryFilterUI.addEventListener(UI.FilterBar.FilterUI.Events.FilterChanged,this._filterChanged.bind(this),this),e.addFilter(this._resourceCategoryFilterUI),this._onlyIssuesFilterUI=new UI.FilterBar.CheckboxFilterUI("only-show-issues",ls`Has blocked cookies`,!0,this._networkShowIssuesOnlySetting),this._onlyIssuesFilterUI.addEventListener(UI.FilterBar.FilterUI.Events.FilterChanged,this._filterChanged.bind(this),this),this._onlyIssuesFilterUI.element().title=ls`Only show requests with blocked response cookies`,e.addFilter(this._onlyIssuesFilterUI),this._onlyBlockedRequestsUI=new UI.FilterBar.CheckboxFilterUI("only-show-blocked-requests",ls`Blocked Requests`,!0,this._networkOnlyBlockedRequestsSetting),this._onlyBlockedRequestsUI.addEventListener(UI.FilterBar.FilterUI.Events.FilterChanged,this._filterChanged.bind(this),this),this._onlyBlockedRequestsUI.element().title=ls`Only show blocked requests`,e.addFilter(this._onlyBlockedRequestsUI),this._filterParser=new TextUtils.TextUtils.FilterParser(_searchKeys),this._suggestionBuilder=new UI.FilterSuggestionBuilder.FilterSuggestionBuilder(_searchKeys,NetworkLogView._sortSearchValues),this._resetSuggestionBuilder(),this._dataGrid=this._columns.dataGrid(),this._setupDataGrid(),this._columns.sortByCurrentColumn(),e.filterButton().addEventListener(UI.Toolbar.ToolbarButton.Events.Click,this._dataGrid.scheduleUpdate.bind(this._dataGrid,!0)),this._summaryToolbar=new UI.Toolbar.Toolbar("network-summary-bar",this.element),new UI.DropTarget.DropTarget(this.element,[UI.DropTarget.Type.File],Common.UIString.UIString("Drop HAR files here"),this._handleDrop.bind(this)),Common.Settings.Settings.instance().moduleSetting("networkColorCodeResourceTypes").addChangeListener(this._invalidateAllItems.bind(this,!1),this),SDK.SDKModel.TargetManager.instance().observeModels(SDK.NetworkManager.NetworkManager,this),self.SDK.networkLog.addEventListener(SDK.NetworkLog.Events.RequestAdded,this._onRequestUpdated,this),self.SDK.networkLog.addEventListener(SDK.NetworkLog.Events.RequestUpdated,this._onRequestUpdated,this),self.SDK.networkLog.addEventListener(SDK.NetworkLog.Events.Reset,this._reset,this),this._updateGroupByFrame(),Common.Settings.Settings.instance().moduleSetting("network.group-by-frame").addChangeListener(()=>this._updateGroupByFrame()),this._filterBar=e}_updateGroupByFrame(){const e=Common.Settings.Settings.instance().moduleSetting("network.group-by-frame").get();this._setGrouping(e?"Frame":null)}static _sortSearchValues(e,t){e===FilterType.Priority?t.sort((e,t)=>{const r=PerfUI.NetworkPriorities.uiLabelToNetworkPriority(e),i=PerfUI.NetworkPriorities.uiLabelToNetworkPriority(t);return PerfUI.NetworkPriorities.networkPriorityWeight(r)-PerfUI.NetworkPriorities.networkPriorityWeight(i)}):t.sort()}static _negativeFilter(e,t){return!e(t)}static _requestPathFilter(e,t){return!!e&&e.test(t.path()+"/"+t.name())}static _subdomains(e){const t=[e];let r=e.indexOf(".");for(;-1!==r;)t.push("*"+e.substring(r)),r=e.indexOf(".",r+1);return t}static _createRequestDomainFilter(e){const t=e.split("*").map((function(e){return e.escapeForRegExp()})).join(".*");return NetworkLogView._requestDomainFilter.bind(null,new RegExp("^"+t+"$","i"))}static _requestDomainFilter(e,t){return e.test(t.domain)}static _runningRequestFilter(e){return!e.finished}static _fromCacheRequestFilter(e){return e.cached()}static _interceptedByServiceWorkerFilter(e){return e.fetchedViaServiceWorker}static _initiatedByServiceWorkerFilter(e){return e.initiatedByServiceWorker()}static _requestResponseHeaderFilter(e,t){return void 0!==t.responseHeaderValue(e)}static _requestMethodFilter(e,t){return t.requestMethod===e}static _requestPriorityFilter(e,t){return t.priority()===e}static _requestMimeTypeFilter(e,t){return t.mimeType===e}static _requestMixedContentFilter(e,t){return e===MixedContentFilterValues.Displayed?t.mixedContentType===Protocol.Security.MixedContentType.OptionallyBlockable:e===MixedContentFilterValues.Blocked?t.mixedContentType===Protocol.Security.MixedContentType.Blockable&&t.wasBlocked():e===MixedContentFilterValues.BlockOverridden?t.mixedContentType===Protocol.Security.MixedContentType.Blockable&&!t.wasBlocked():e===MixedContentFilterValues.All&&t.mixedContentType!==Protocol.Security.MixedContentType.None}static _requestSchemeFilter(e,t){return t.scheme===e}static _requestCookieDomainFilter(e,t){return t.allCookiesIncludingBlockedOnes().some(t=>t.domain()===e)}static _requestCookieNameFilter(e,t){return t.allCookiesIncludingBlockedOnes().some(t=>t.name()===e)}static _requestCookiePathFilter(e,t){return t.allCookiesIncludingBlockedOnes().some(t=>t.path()===e)}static _requestCookieValueFilter(e,t){return t.allCookiesIncludingBlockedOnes().some(t=>t.value()===e)}static _requestSetCookieDomainFilter(e,t){return t.responseCookies.some(t=>t.domain()===e)}static _requestSetCookieNameFilter(e,t){return t.responseCookies.some(t=>t.name()===e)}static _requestSetCookieValueFilter(e,t){return t.responseCookies.some(t=>t.value()===e)}static _requestSizeLargerThanFilter(e,t){return t.transferSize>=e}static _statusCodeFilter(e,t){return""+t.statusCode===e}static HTTPRequestsFilter(e){return e.parsedURL.isValid&&e.scheme in HTTPSchemas}static _requestTimeFilter(e,t,r){return!(r.issueTime()>t)&&!(-1!==r.endTime&&r.endTime<e)}static _copyRequestHeaders(e){Host.InspectorFrontendHost.InspectorFrontendHostInstance.copyText(e.requestHeadersText())}static _copyResponseHeaders(e){Host.InspectorFrontendHost.InspectorFrontendHostInstance.copyText(e.responseHeadersText)}static async _copyResponse(e){const t=await e.contentData();let r=t.content||"";e.contentType().isTextType()?t.encoded&&(r=window.atob(r)):r=TextUtils.ContentProvider.contentAsDataURL(r,e.mimeType,t.encoded),Host.InspectorFrontendHost.InspectorFrontendHostInstance.copyText(r)}_handleDrop(e){const t=e.items;if(!t.length)return;const r=t[0].webkitGetAsEntry();r.isDirectory||r.file(this.onLoadFromFile.bind(this))}async onLoadFromFile(e){const t=new Common.StringOutputStream.StringOutputStream,r=new Bindings.FileUtils.ChunkedFileReader(e,1e7);if(!await r.read(t))return void this._harLoadFailed(r.error().message);let i;try{i=new HARImporter.HARFormat.HARRoot(JSON.parse(t.data()))}catch(e){return void this._harLoadFailed(e)}self.SDK.networkLog.importRequests(HARImporter.HARImporter.Importer.requestsFromHARLog(i.log))}_harLoadFailed(e){Common.Console.Console.instance().error("Failed to load HAR file with following error: "+e)}_setGrouping(e){this._activeGroupLookup&&this._activeGroupLookup.reset();const t=e&&this._groupLookups.get(e)||null;this._activeGroupLookup=t,this._invalidateAllItems()}_computeRowHeight(){return Math.round(this._rawRowHeight*window.devicePixelRatio)/window.devicePixelRatio}nodeForRequest(e){return e[_networkNodeSymbol]||null}headerHeight(){return this._headerHeight}setRecording(e){this._recording=e,this._updateSummaryBar()}modelAdded(e){if(e.target().parentTarget())return;const t=e.target().model(SDK.ResourceTreeModel.ResourceTreeModel);t&&(t.addEventListener(SDK.ResourceTreeModel.Events.Load,this._loadEventFired,this),t.addEventListener(SDK.ResourceTreeModel.Events.DOMContentLoaded,this._domContentLoadedEventFired,this))}modelRemoved(e){if(!e.target().parentTarget()){const t=e.target().model(SDK.ResourceTreeModel.ResourceTreeModel);t&&(t.removeEventListener(SDK.ResourceTreeModel.Events.Load,this._loadEventFired,this),t.removeEventListener(SDK.ResourceTreeModel.Events.DOMContentLoaded,this._domContentLoadedEventFired,this))}}setWindow(e,t){e||t?(this._timeFilter=NetworkLogView._requestTimeFilter.bind(null,e,t),this._timeCalculator.setWindow(new NetworkTimeBoundary(e,t))):(this._timeFilter=null,this._timeCalculator.setWindow(null)),this._filterRequests()}resetFocus(){this._dataGrid.element.focus()}_resetSuggestionBuilder(){this._suggestionBuilder.clear(),this._suggestionBuilder.addItem(FilterType.Is,IsFilterType.Running),this._suggestionBuilder.addItem(FilterType.Is,IsFilterType.FromCache),this._suggestionBuilder.addItem(FilterType.Is,IsFilterType.ServiceWorkerIntercepted),this._suggestionBuilder.addItem(FilterType.Is,IsFilterType.ServiceWorkerInitiated),this._suggestionBuilder.addItem(FilterType.LargerThan,"100"),this._suggestionBuilder.addItem(FilterType.LargerThan,"10k"),this._suggestionBuilder.addItem(FilterType.LargerThan,"1M"),this._textFilterUI.setSuggestionProvider(this._suggestionBuilder.completions.bind(this._suggestionBuilder))}_filterChanged(e){this.removeAllNodeHighlights(),this._parseFilterQuery(this._textFilterUI.value()),this._filterRequests()}async resetFilter(){this._textFilterUI.clear()}_showRecordingHint(){this._hideRecordingHint(),this._recordingHint=this.element.createChild("div","network-status-pane fill");const e=this._recordingHint.createChild("div","recording-hint");let t=null;const r=self.UI.shortcutRegistry.shortcutsForAction("inspector_main.reload")[0];if(r&&(t=this._recordingHint.createChild("b"),t.textContent=r.title()),this._recording){e.createChild("span").textContent=Common.UIString.UIString("Recording network activityâ€¦"),t&&(e.createChild("br"),e.appendChild(UI.UIUtils.formatLocalized("Perform a request or hit %s to record the reload.",[t])))}else{const r=e.createChild("b");r.textContent=self.UI.shortcutRegistry.shortcutTitleForAction("network.toggle-recording"),t?e.appendChild(UI.UIUtils.formatLocalized("Record (%s) or reload (%s) to display network activity.",[r,t])):e.appendChild(UI.UIUtils.formatLocalized("Record (%s) to display network activity.",[r]))}e.createChild("br"),e.appendChild(UI.XLink.XLink.create("https://developers.google.com/web/tools/chrome-devtools/network/?utm_source=devtools&utm_campaign=2019Q1","Learn more")),this._setHidden(!0),this._dataGrid.updateGridAccessibleName("")}_hideRecordingHint(){this._setHidden(!1),this._recordingHint&&this._recordingHint.remove(),this._dataGrid.updateGridAccessibleName(ls`Network Data Available`),this._recordingHint=null}_setHidden(e){this._columns.setHidden(e),UI.ARIAUtils.setHidden(this._summaryToolbar.element,e)}elementsToRestoreScrollPositionsFor(){return this._dataGrid?[this._dataGrid.scrollContainer]:[]}columnExtensionResolved(){this._invalidateAllItems(!0)}_setupDataGrid(){return this._dataGrid.setRowContextMenuCallback((e,t)=>{const r=t.request();r&&this.handleContextMenuForRequest(e,r)}),this._dataGrid.setStickToBottom(!0),this._dataGrid.setName("networkLog"),this._dataGrid.setResizeMethod(DataGrid.DataGrid.ResizeMethod.Last),this._dataGrid.element.classList.add("network-log-grid"),this._dataGrid.element.addEventListener("mousedown",this._dataGridMouseDown.bind(this),!0),this._dataGrid.element.addEventListener("mousemove",this._dataGridMouseMove.bind(this),!0),this._dataGrid.element.addEventListener("mouseleave",()=>this._setHoveredNode(null),!0),this._dataGrid.element.addEventListener("keydown",e=>{isEnterOrSpaceKey(e)&&(this.dispatchEventToListeners(Events.RequestActivated,{showPanel:!0}),e.consume(!0))}),this._dataGrid.element.addEventListener("focus",this._onDataGridFocus.bind(this),!0),this._dataGrid.element.addEventListener("blur",this._onDataGridBlur.bind(this),!0),this._dataGrid}_dataGridMouseMove(e){const t=this._dataGrid.dataGridNodeFromNode(e.target),r=e.shiftKey;this._setHoveredNode(t,r)}hoveredNode(){return this._hoveredNode}_setHoveredNode(e,t){this._hoveredNode&&this._hoveredNode.setHovered(!1,!1),this._hoveredNode=e,this._hoveredNode&&this._hoveredNode.setHovered(!0,!!t)}_dataGridMouseDown(e){!this._dataGrid.selectedNode&&e.button&&e.consume()}_updateSummaryBar(){this._hideRecordingHint();let e=0,t=0,r=0,i=0,o=0,s=-1,n=-1,a=0;for(const l of self.SDK.networkLog.requests()){const d=l[_networkNodeSymbol];if(!d)continue;a++;const u=l.transferSize;e+=u;const h=l.resourceSize;t+=h,d[isFilteredOutSymbol]||(r++,i+=u,o+=h);const c=SDK.NetworkManager.NetworkManager.forRequest(l);c&&l.url()===c.target().inspectedURL()&&l.resourceType()===Common.ResourceType.resourceTypes.Document&&!c.target().parentTarget()&&(s=l.startTime),l.endTime>n&&(n=l.endTime)}if(!a)return void this._showRecordingHint();this._summaryToolbar.removeToolbarItems();const l=(e,t)=>{const r=new UI.Toolbar.ToolbarText(e);return r.setTitle(t||e),this._summaryToolbar.appendToolbarItem(r),r.element};if(r!==a?(l(ls`${r} / ${a} requests`),this._summaryToolbar.appendSeparator(),l(ls`${Number.bytesToString(i)} / ${Number.bytesToString(e)} transferred`,ls`${i} B / ${e} B transferred over network`),this._summaryToolbar.appendSeparator(),l(ls`${Number.bytesToString(o)} / ${Number.bytesToString(t)} resources`,ls`${o} B / ${t} B resources loaded by the page`)):(l(ls`${a} requests`),this._summaryToolbar.appendSeparator(),l(ls`${Number.bytesToString(e)} transferred`,ls`${e} B transferred over network`),this._summaryToolbar.appendSeparator(),l(ls`${Number.bytesToString(t)} resources`,ls`${t} B resources loaded by the page`)),-1!==s&&-1!==n){if(this._summaryToolbar.appendSeparator(),l(ls`Finish: ${Number.secondsToString(n-s)}`),-1!==this._mainRequestDOMContentLoadedTime&&this._mainRequestDOMContentLoadedTime>s){this._summaryToolbar.appendSeparator();l(ls`DOMContentLoaded: ${Number.secondsToString(this._mainRequestDOMContentLoadedTime-s)}`).style.color=NetworkLogView.getDCLEventColor()}if(-1!==this._mainRequestLoadTime){this._summaryToolbar.appendSeparator();l(ls`Load: ${Number.secondsToString(this._mainRequestLoadTime-s)}`).style.color=NetworkLogView.getLoadEventColor()}}}scheduleRefresh(){this._needsRefresh||(this._needsRefresh=!0,this.isShowing()&&!this._refreshRequestId&&(this._refreshRequestId=this.element.window().requestAnimationFrame(this._refresh.bind(this))))}addFilmStripFrames(e){this._columns.addEventDividers(e,"network-frame-divider")}selectFilmStripFrame(e){this._columns.selectFilmStripFrame(e)}clearFilmStripFrame(){this._columns.clearFilmStripFrame()}_refreshIfNeeded(){this._needsRefresh&&this._refresh()}_invalidateAllItems(e){this._staleRequests=new Set(self.SDK.networkLog.requests()),e?this.scheduleRefresh():this._refresh()}timeCalculator(){return this._timeCalculator}calculator(){return this._calculator}setCalculator(e){e&&this._calculator!==e&&(this._calculator!==e&&(this._calculator=e,this._columns.setCalculator(this._calculator)),this._calculator.reset(),this._calculator.startAtZero?this._columns.hideEventDividers():this._columns.showEventDividers(),this._invalidateAllItems())}_loadEventFired(e){if(!this._recording)return;const t=e.data.loadTime;t&&(this._mainRequestLoadTime=t,this._columns.addEventDividers([t],"network-load-divider"))}_domContentLoadedEventFired(e){if(!this._recording)return;const t=e.data;t&&(this._mainRequestDOMContentLoadedTime=t,this._columns.addEventDividers([t],"network-dcl-divider"))}wasShown(){this._refreshIfNeeded(),this._columns.wasShown()}willHide(){this._columns.willHide()}onResize(){this._rowHeight=this._computeRowHeight()}flatNodesList(){return this._dataGrid.rootNode().flatChildren()}_onDataGridFocus(){this.element.classList.add("grid-focused"),this.updateNodeBackground()}_onDataGridBlur(){this.element.classList.remove("grid-focused"),this.updateNodeBackground()}updateNodeBackground(){this._dataGrid.selectedNode&&this._dataGrid.selectedNode.updateBackgroundColor()}updateNodeSelectedClass(e){e?this.element.classList.remove("no-node-selected"):this.element.classList.add("no-node-selected")}stylesChanged(){this._columns.scheduleRefresh()}_refresh(){this._needsRefresh=!1,this._refreshRequestId&&(this.element.window().cancelAnimationFrame(this._refreshRequestId),this._refreshRequestId=null),this.removeAllNodeHighlights(),this._timeCalculator.updateBoundariesForEventTime(this._mainRequestLoadTime),this._durationCalculator.updateBoundariesForEventTime(this._mainRequestLoadTime),this._timeCalculator.updateBoundariesForEventTime(this._mainRequestDOMContentLoadedTime),this._durationCalculator.updateBoundariesForEventTime(this._mainRequestDOMContentLoadedTime);const e=new Map,t=[],r=new Set;for(;this._staleRequests.size;){const e=this._staleRequests.firstValue();this._staleRequests.delete(e);let t=e[_networkNodeSymbol];t||(t=this._createNodeForRequest(e)),r.add(t)}for(const i of r){const r=!this._applyFilter(i);r&&i===this._hoveredNode&&this._setHoveredNode(null),r||t.push(i);const o=i.request();this._timeCalculator.updateBoundaries(o),this._durationCalculator.updateBoundaries(o);const s=this._parentNodeForInsert(i);if(i[isFilteredOutSymbol]===r&&i.parent===s)continue;i[isFilteredOutSymbol]=r;if(i.parent&&(r||i.parent!==s)){let e=i.parent;for(e.removeChild(i);e&&!e.hasChildren()&&e.dataGrid&&e.dataGrid.rootNode()!==e;){const t=e.parent;t.removeChild(e),e=t}}s&&!r&&(s.dataGrid||e.has(s)||(e.set(s,this._dataGrid.rootNode()),t.push(s)),e.set(i,s))}for(const t of e.keys())e.get(t).appendChild(t);for(const e of t)e.refresh();this._updateSummaryBar(),e.size&&this._columns.sortByCurrentColumn(),this._dataGrid.updateInstantly(),this._didRefreshForTest()}_didRefreshForTest(){}_parentNodeForInsert(e){if(!this._activeGroupLookup)return this._dataGrid.rootNode();const t=this._activeGroupLookup.groupNodeForRequest(e.request());return t||this._dataGrid.rootNode()}_reset(){this.dispatchEventToListeners(Events.RequestActivated,{showPanel:!1}),this._setHoveredNode(null),this._columns.reset(),this._timeFilter=null,this._calculator.reset(),this._timeCalculator.setWindow(null),this.linkifier.reset(),this._activeGroupLookup&&this._activeGroupLookup.reset(),this._staleRequests.clear(),this._resetSuggestionBuilder(),this._mainRequestLoadTime=-1,this._mainRequestDOMContentLoadedTime=-1,this._dataGrid.rootNode().removeChildren(),this._updateSummaryBar(),this._dataGrid.setStickToBottom(!0),this.scheduleRefresh()}setTextFilterValue(e){this._textFilterUI.setValue(e),this._dataURLFilterUI.setChecked(!1),this._onlyIssuesFilterUI.setChecked(!1),this._onlyBlockedRequestsUI.setChecked(!1),this._resourceCategoryFilterUI.reset()}_createNodeForRequest(e){const t=new NetworkRequestNode(this,e);e[_networkNodeSymbol]=t,t[isFilteredOutSymbol]=!0;for(let t=e.redirectSource();t;t=t.redirectSource())this._refreshRequest(t);return t}_onRequestUpdated(e){const t=e.data;this._refreshRequest(t)}_refreshRequest(e){NetworkLogView._subdomains(e.domain).forEach(this._suggestionBuilder.addItem.bind(this._suggestionBuilder,FilterType.Domain)),this._suggestionBuilder.addItem(FilterType.Method,e.requestMethod),this._suggestionBuilder.addItem(FilterType.MimeType,e.mimeType),this._suggestionBuilder.addItem(FilterType.Scheme,""+e.scheme),this._suggestionBuilder.addItem(FilterType.StatusCode,""+e.statusCode);const t=e.priority();if(t&&this._suggestionBuilder.addItem(FilterType.Priority,PerfUI.NetworkPriorities.uiLabelForNetworkPriority(t)),e.mixedContentType!==Protocol.Security.MixedContentType.None&&this._suggestionBuilder.addItem(FilterType.MixedContent,MixedContentFilterValues.All),e.mixedContentType===Protocol.Security.MixedContentType.OptionallyBlockable&&this._suggestionBuilder.addItem(FilterType.MixedContent,MixedContentFilterValues.Displayed),e.mixedContentType===Protocol.Security.MixedContentType.Blockable){const t=e.wasBlocked()?MixedContentFilterValues.Blocked:MixedContentFilterValues.BlockOverridden;this._suggestionBuilder.addItem(FilterType.MixedContent,t)}const r=e.responseHeaders;for(let e=0,t=r.length;e<t;++e)this._suggestionBuilder.addItem(FilterType.HasResponseHeader,r[e].name);for(const t of e.responseCookies)this._suggestionBuilder.addItem(FilterType.SetCookieDomain,t.domain()),this._suggestionBuilder.addItem(FilterType.SetCookieName,t.name()),this._suggestionBuilder.addItem(FilterType.SetCookieValue,t.value());for(const t of e.allCookiesIncludingBlockedOnes())this._suggestionBuilder.addItem(FilterType.CookieDomain,t.domain()),this._suggestionBuilder.addItem(FilterType.CookieName,t.name()),this._suggestionBuilder.addItem(FilterType.CookiePath,t.path()),this._suggestionBuilder.addItem(FilterType.CookieValue,t.value());this._staleRequests.add(e),this.scheduleRefresh()}rowHeight(){return this._rowHeight}switchViewMode(e){this._columns.switchViewMode(e)}handleContextMenuForRequest(e,t){e.appendApplicableItems(t);let r=e.clipboardSection().appendSubMenuItem(Common.UIString.UIString("Copy"));const i=r.footerSection();if(t){r.defaultSection().appendItem(UI.UIUtils.copyLinkAddressLabel(),Host.InspectorFrontendHost.InspectorFrontendHostInstance.copyText.bind(Host.InspectorFrontendHost.InspectorFrontendHostInstance,t.contentURL())),t.requestHeadersText()&&r.defaultSection().appendItem(Common.UIString.UIString("Copy request headers"),NetworkLogView._copyRequestHeaders.bind(null,t)),t.responseHeadersText&&r.defaultSection().appendItem(Common.UIString.UIString("Copy response headers"),NetworkLogView._copyResponseHeaders.bind(null,t)),t.finished&&r.defaultSection().appendItem(Common.UIString.UIString("Copy response"),NetworkLogView._copyResponse.bind(null,t));const e=t.isBlobRequest();Host.Platform.isWin()?(i.appendItem(Common.UIString.UIString("Copy as PowerShell"),this._copyPowerShellCommand.bind(this,t),e),i.appendItem(Common.UIString.UIString("Copy as fetch"),this._copyFetchCall.bind(this,t,!1),e),i.appendItem(Common.UIString.UIString("Copy as Node.js fetch"),this._copyFetchCall.bind(this,t,!0),e),i.appendItem(Common.UIString.UIString("Copy as cURL (cmd)"),this._copyCurlCommand.bind(this,t,"win"),e),i.appendItem(Common.UIString.UIString("Copy as cURL (bash)"),this._copyCurlCommand.bind(this,t,"unix"),e),i.appendItem(Common.UIString.UIString("Copy all as PowerShell"),this._copyAllPowerShellCommand.bind(this)),i.appendItem(Common.UIString.UIString("Copy all as fetch"),this._copyAllFetchCall.bind(this,!1)),i.appendItem(Common.UIString.UIString("Copy all as Node.js fetch"),this._copyAllFetchCall.bind(this,!0)),i.appendItem(Common.UIString.UIString("Copy all as cURL (cmd)"),this._copyAllCurlCommand.bind(this,"win")),i.appendItem(Common.UIString.UIString("Copy all as cURL (bash)"),this._copyAllCurlCommand.bind(this,"unix"))):(i.appendItem(Common.UIString.UIString("Copy as fetch"),this._copyFetchCall.bind(this,t,!1),e),i.appendItem(Common.UIString.UIString("Copy as Node.js fetch"),this._copyFetchCall.bind(this,t,!0),e),i.appendItem(Common.UIString.UIString("Copy as cURL"),this._copyCurlCommand.bind(this,t,"unix"),e),i.appendItem(Common.UIString.UIString("Copy all as fetch"),this._copyAllFetchCall.bind(this,!1)),i.appendItem(Common.UIString.UIString("Copy all as Node.js fetch"),this._copyAllFetchCall.bind(this,!0)),i.appendItem(Common.UIString.UIString("Copy all as cURL"),this._copyAllCurlCommand.bind(this,"unix")))}else r=e.clipboardSection().appendSubMenuItem(Common.UIString.UIString("Copy"));if(i.appendItem(Common.UIString.UIString("Copy all as HAR"),this._copyAll.bind(this)),e.saveSection().appendItem(ls`Save all as HAR with content`,this.exportAll.bind(this)),e.editSection().appendItem(Common.UIString.UIString("Clear browser cache"),this._clearBrowserCache.bind(this)),e.editSection().appendItem(Common.UIString.UIString("Clear browser cookies"),this._clearBrowserCookies.bind(this)),t){const r=20,i=self.SDK.multitargetNetworkManager;let n=i.blockedPatterns();function o(e){n.push({enabled:!0,url:e}),i.setBlockedPatterns(n),i.setBlockingEnabled(!0),UI.ViewManager.ViewManager.instance().showView("network.blocked-urls")}function s(e){n=n.filter(t=>t.url!==e),i.setBlockedPatterns(n),UI.ViewManager.ViewManager.instance().showView("network.blocked-urls")}const a=t.parsedURL.urlWithoutScheme();if(a&&!n.find(e=>e.url===a))e.debugSection().appendItem(Common.UIString.UIString("Block request URL"),o.bind(null,a));else if(a){const t=a.trimMiddle(r);e.debugSection().appendItem(Common.UIString.UIString("Unblock %s",t),s.bind(null,a))}const l=t.parsedURL.domain();if(l&&!n.find(e=>e.url===l))e.debugSection().appendItem(Common.UIString.UIString("Block request domain"),o.bind(null,l));else if(l){const t=l.trimMiddle(r);e.debugSection().appendItem(Common.UIString.UIString("Unblock %s",t),s.bind(null,l))}SDK.NetworkManager.NetworkManager.canReplayRequest(t)&&e.debugSection().appendItem(Common.UIString.UIString("Replay XHR"),SDK.NetworkManager.NetworkManager.replayRequest.bind(null,t))}}_harRequests(){return self.SDK.networkLog.requests().filter(NetworkLogView.HTTPRequestsFilter).filter(e=>e.finished||e.resourceType()===Common.ResourceType.resourceTypes.WebSocket&&e.responseReceivedTime)}async _copyAll(){const e={log:await SDK.HARLog.HARLog.build(this._harRequests())};Host.InspectorFrontendHost.InspectorFrontendHostInstance.copyText(JSON.stringify(e,null,2))}async _copyCurlCommand(e,t){const r=await this._generateCurlCommand(e,t);Host.InspectorFrontendHost.InspectorFrontendHostInstance.copyText(r)}async _copyAllCurlCommand(e){const t=await this._generateAllCurlCommand(self.SDK.networkLog.requests(),e);Host.InspectorFrontendHost.InspectorFrontendHostInstance.copyText(t)}async _copyFetchCall(e,t){const r=await this._generateFetchCall(e,t);Host.InspectorFrontendHost.InspectorFrontendHostInstance.copyText(r)}async _copyAllFetchCall(e){const t=await this._generateAllFetchCall(self.SDK.networkLog.requests(),e);Host.InspectorFrontendHost.InspectorFrontendHostInstance.copyText(t)}async _copyPowerShellCommand(e){const t=await this._generatePowerShellCommand(e);Host.InspectorFrontendHost.InspectorFrontendHostInstance.copyText(t)}async _copyAllPowerShellCommand(){const e=await this._generateAllPowerShellCommand(self.SDK.networkLog.requests());Host.InspectorFrontendHost.InspectorFrontendHostInstance.copyText(e)}async exportAll(){const e=SDK.SDKModel.TargetManager.instance().mainTarget().inspectedURL(),t=Common.ParsedURL.ParsedURL.fromString(e),r=t?t.host:"network-log",i=new Bindings.FileUtils.FileOutputStream;if(!await i.open(r+".har"))return;const o=new UI.ProgressIndicator.ProgressIndicator;this._progressBarContainer.appendChild(o.element),await HARWriter.write(i,this._harRequests(),o),o.done(),i.close()}_clearBrowserCache(){confirm(Common.UIString.UIString("Are you sure you want to clear browser cache?"))&&self.SDK.multitargetNetworkManager.clearBrowserCache()}_clearBrowserCookies(){confirm(Common.UIString.UIString("Are you sure you want to clear browser cookies?"))&&self.SDK.multitargetNetworkManager.clearBrowserCookies()}_removeAllHighlights(){this.removeAllNodeHighlights();for(let e=0;e<this._highlightedSubstringChanges.length;++e)UI.UIUtils.revertDomChanges(this._highlightedSubstringChanges[e]);this._highlightedSubstringChanges=[]}_applyFilter(e){const t=e.request();if(this._timeFilter&&!this._timeFilter(t))return!1;const r=t.resourceType().category().title;if(!this._resourceCategoryFilterUI.accept(r))return!1;if(this._dataURLFilterUI.checked()&&(t.parsedURL.isDataURL()||t.parsedURL.isBlobURL()))return!1;if(this._onlyIssuesFilterUI.checked()&&!SDK.RelatedIssue.hasIssues(t))return!1;if(this._onlyBlockedRequestsUI.checked()&&!t.wasBlocked())return!1;if("Service Worker Fallback Required"===t.statusText)return!1;for(let e=0;e<this._filters.length;++e)if(!this._filters[e](t))return!1;return!0}_parseFilterQuery(e){const t=this._filterParser.parse(e);this._filters=t.map(e=>{const t=e.key,r=e.text||"",i=e.regex;let o;if(t){const e=(t+":"+r).escapeForRegExp();o=this._createSpecialFilter(t,r)||NetworkLogView._requestPathFilter.bind(null,new RegExp(e,"i"))}else o=e.regex?NetworkLogView._requestPathFilter.bind(null,i):NetworkLogView._requestPathFilter.bind(null,new RegExp(r.escapeForRegExp(),"i"));return e.negative?NetworkLogView._negativeFilter.bind(null,o):o})}_createSpecialFilter(e,t){switch(e){case FilterType.Domain:return NetworkLogView._createRequestDomainFilter(t);case FilterType.HasResponseHeader:return NetworkLogView._requestResponseHeaderFilter.bind(null,t);case FilterType.Is:if(t.toLowerCase()===IsFilterType.Running)return NetworkLogView._runningRequestFilter;if(t.toLowerCase()===IsFilterType.FromCache)return NetworkLogView._fromCacheRequestFilter;if(t.toLowerCase()===IsFilterType.ServiceWorkerIntercepted)return NetworkLogView._interceptedByServiceWorkerFilter;if(t.toLowerCase()===IsFilterType.ServiceWorkerInitiated)return NetworkLogView._initiatedByServiceWorkerFilter;break;case FilterType.LargerThan:return this._createSizeFilter(t.toLowerCase());case FilterType.Method:return NetworkLogView._requestMethodFilter.bind(null,t);case FilterType.MimeType:return NetworkLogView._requestMimeTypeFilter.bind(null,t);case FilterType.MixedContent:return NetworkLogView._requestMixedContentFilter.bind(null,t);case FilterType.Scheme:return NetworkLogView._requestSchemeFilter.bind(null,t);case FilterType.SetCookieDomain:return NetworkLogView._requestSetCookieDomainFilter.bind(null,t);case FilterType.SetCookieName:return NetworkLogView._requestSetCookieNameFilter.bind(null,t);case FilterType.SetCookieValue:return NetworkLogView._requestSetCookieValueFilter.bind(null,t);case FilterType.CookieDomain:return NetworkLogView._requestCookieDomainFilter.bind(null,t);case FilterType.CookieName:return NetworkLogView._requestCookieNameFilter.bind(null,t);case FilterType.CookiePath:return NetworkLogView._requestCookiePathFilter.bind(null,t);case FilterType.CookieValue:return NetworkLogView._requestCookieValueFilter.bind(null,t);case FilterType.Priority:return NetworkLogView._requestPriorityFilter.bind(null,PerfUI.NetworkPriorities.uiLabelToNetworkPriority(t));case FilterType.StatusCode:return NetworkLogView._statusCodeFilter.bind(null,t)}return null}_createSizeFilter(e){let t=1;e.endsWith("k")?(t=1024,e=e.substring(0,e.length-1)):e.endsWith("m")&&(t=1048576,e=e.substring(0,e.length-1));const r=Number(e);return isNaN(r)?null:NetworkLogView._requestSizeLargerThanFilter.bind(null,r*t)}_filterRequests(){this._removeAllHighlights(),this._invalidateAllItems()}_reveal(e){this.removeAllNodeHighlights();const t=e[_networkNodeSymbol];return t&&t.dataGrid?(t.parent&&t.parent instanceof NetworkGroupNode&&(t.parent.reveal(),t.parent.expand()),t.reveal(),t):null}revealAndHighlightRequest(e){const t=this._reveal(e);t&&this._highlightNode(t)}selectRequest(e){this.setTextFilterValue("");const t=this._reveal(e);t&&t.select()}removeAllNodeHighlights(){this._highlightedNode&&(this._highlightedNode.element().classList.remove("highlighted-row"),this._highlightedNode=null)}_highlightNode(e){UI.UIUtils.runCSSAnimationOnce(e.element(),"highlighted-row"),this._highlightedNode=e}_filterOutBlobRequests(e){return e.filter(e=>!e.isBlobRequest())}async _generateFetchCall(e,t){const r={method:1,path:1,scheme:1,version:1,"accept-charset":1,"accept-encoding":1,"access-control-request-headers":1,"access-control-request-method":1,connection:1,"content-length":1,cookie:1,cookie2:1,date:1,dnt:1,expect:1,host:1,"keep-alive":1,origin:1,referer:1,te:1,trailer:1,"transfer-encoding":1,upgrade:1,via:1,"user-agent":1},i={cookie:1,authorization:1},o=JSON.stringify(e.url()),s=e.requestHeaders(),n=s.reduce((e,t)=>{const i=t.name;return r[i.toLowerCase()]||i.includes(":")||e.append(i,t.value),e},new Headers),a={};for(const e of n)a[e[0]]=e[1];const l=e.requestCookies.length||s.some(({name:e})=>i[e.toLowerCase()])?"include":"omit",d=s.find(({name:e})=>"referer"===e.toLowerCase()),u=d?d.value:void 0,h=e.referrerPolicy()||void 0,c=await e.requestFormData(),m={headers:Object.keys(a).length?a:void 0,referrer:u,referrerPolicy:h,body:c,method:e.requestMethod,mode:"cors"};if(t){const e=s.find(e=>"cookie"===e.name.toLowerCase());e&&(m.headers={...a,cookie:e.value})}else m.credentials=l;return`fetch(${o}, ${JSON.stringify(m,null,2)});`}async _generateAllFetchCall(e,t){const r=this._filterOutBlobRequests(e);return(await Promise.all(r.map(e=>this._generateFetchCall(e,t)))).join(" ;\n")}async _generateCurlCommand(e,t){let r=[];const i={"accept-encoding":1,host:1,method:1,path:1,scheme:1,version:1};const o="win"===t?function(e){const t=/[\r\n]/.test(e)?'^"':'"';return t+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/[^a-zA-Z0-9\s_\-:=+~'\/.',?;()*`]/g,"^$&").replace(/%(?=[a-zA-Z0-9_])/g,"%^").replace(/\r\n|[\n\r]/g,"^\n\n")+t}:function(e){return/[\0-\x1F\x7F-\x9F!]|\'/.test(e)?"$'"+e.replace(/\\/g,"\\\\").replace(/\'/g,"\\'").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\0-\x1F\x7F-\x9F!]/g,(function(e){let t=e.charCodeAt(0).toString(16);for(;t.length<4;)t="0"+t;return"\\u"+t}))+"'":"'"+e+"'"};r.push(o(e.url()).replace(/[[{}\]]/g,"\\$&"));let s="GET";const n=[],a=e.requestContentType(),l=await e.requestFormData();a&&a.startsWith("application/x-www-form-urlencoded")&&l?(n.push("--data-raw "+o(l)),i["content-length"]=!0,s="POST"):l&&(n.push("--data-binary "+o(l)),i["content-length"]=!0,s="POST"),e.requestMethod!==s&&r.push("-X "+o(e.requestMethod));const d=e.requestHeaders();for(let e=0;e<d.length;e++){const t=d[e],s=t.name.replace(/^:/,"");s.toLowerCase()in i||r.push("-H "+o(s+": "+t.value))}return r=r.concat(n),r.push("--compressed"),e.securityState()===Protocol.Security.SecurityState.Insecure&&r.push("--insecure"),"curl "+r.join(r.length>=3?"win"===t?" ^\n  ":" \\\n  ":" ")}async _generateAllCurlCommand(e,t){const r=this._filterOutBlobRequests(e),i=await Promise.all(r.map(e=>this._generateCurlCommand(e,t)));return"win"===t?i.join(" &\r\n"):i.join(" ;\n")}async _generatePowerShellCommand(e){const t=[],r=new Set(["host","connection","proxy-connection","content-length","expect","range","content-type"]);function i(e){return'"'+e.replace(/[`\$"]/g,"`$&").replace(/[^\x20-\x7E]/g,e=>"$([char]"+e.charCodeAt(0)+")")+'"'}t.push("-Uri "+i(e.url())),"GET"!==e.requestMethod&&t.push("-Method "+i(e.requestMethod));const o=e.requestHeaders(),s=[];for(const e of o){const t=e.name.replace(/^:/,"");r.has(t.toLowerCase())||s.push(i(t)+"="+i(e.value))}s.length&&t.push("-Headers @{\n"+s.join("\n  ")+"\n}");const n=o.find(({name:e})=>"content-type"===e.toLowerCase());n&&t.push("-ContentType "+i(n.value));const a=await e.requestFormData();if(a){const e=i(a);/[^\x20-\x7E]/.test(a)?t.push("-Body ([System.Text.Encoding]::UTF8.GetBytes("+e+"))"):t.push("-Body "+e)}return"Invoke-WebRequest "+t.join(t.length>=3?" `\n":" ")}async _generateAllPowerShellCommand(e){const t=this._filterOutBlobRequests(e);return(await Promise.all(t.map(e=>this._generatePowerShellCommand(e)))).join(";\r\n")}static getDCLEventColor(){return"dark"===self.UI.themeSupport.themeName()?"#03A9F4":"#0867CB"}static getLoadEventColor(){return self.UI.themeSupport.patchColorText("#B31412",UI.UIUtils.ThemeSupport.ColorUsage.Foreground)}}export const isFilteredOutSymbol=Symbol("isFilteredOut");export const _networkNodeSymbol=Symbol("NetworkNode");export const HTTPSchemas={http:!0,https:!0,ws:!0,wss:!0};export const FilterType={Domain:"domain",HasResponseHeader:"has-response-header",Is:"is",LargerThan:"larger-than",Method:"method",MimeType:"mime-type",MixedContent:"mixed-content",Priority:"priority",Scheme:"scheme",SetCookieDomain:"set-cookie-domain",SetCookieName:"set-cookie-name",SetCookieValue:"set-cookie-value",CookieDomain:"cookie-domain",CookieName:"cookie-name",CookiePath:"cookie-path",CookieValue:"cookie-value",StatusCode:"status-code"};export const MixedContentFilterValues={All:"all",Displayed:"displayed",Blocked:"blocked",BlockOverridden:"block-overridden"};export const IsFilterType={Running:"running",FromCache:"from-cache",ServiceWorkerIntercepted:"service-worker-intercepted",ServiceWorkerInitiated:"service-worker-initiated"};export const _searchKeys=Object.keys(FilterType).map(e=>FilterType[e]);export class GroupLookupInterface{groupNodeForRequest(e){}reset(){}}export let Filter;