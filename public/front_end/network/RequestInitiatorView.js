import*as Common from"../common/common.js";import*as Components from"../components/components.js";import*as SDK from"../sdk/sdk.js";import*as UI from"../ui/ui.js";export class RequestInitiatorView extends UI.Widget.VBox{constructor(e){super(),this.registerRequiredCSS("network/requestInitiatorView.css"),this.element.classList.add("request-initiator-view"),this._linkifier=new Components.Linkifier.Linkifier,this._request=e,this._emptyWidget=new UI.EmptyWidget.EmptyWidget(Common.UIString.UIString("This request has no initiator data.")),this._emptyWidget.show(this.element),this._hasShown=!1}static createStackTracePreview(e,t,i,n){const s=e.initiator();if(!s||!s.stack)return null;const r=SDK.NetworkManager.NetworkManager.forRequest(e),o=r?r.target():null;return Components.JSPresentationUtils.buildStackTracePreviewContents(o,t,{stackTrace:s.stack,contentUpdated:n,tabStops:i})}_appendExpandableSection(e,t,i){const n=createElementWithClass("div","request-initiator-view-section"),s=UI.Icon.Icon.create("smallicon-triangle-right"),r=n.createChild("div","request-initiator-view-section-title");r.appendChild(s),r.createTextChild(t),r.tabIndex=0,e.classList.add("hidden","request-initiator-view-section-content"),n.appendChild(e);const o=t=>{s.setIconType(t?"smallicon-triangle-down":"smallicon-triangle-right"),e.classList.toggle("hidden",!t)};self.onInvokeElement(r,t=>{o(e.classList.contains("hidden")),t.consume()}),o(i),this.element.appendChild(n)}_buildRequestChainTree(e){const t=new UI.TreeOutline.TreeOutlineInShadow,i=e.initiators;let n=t;for(const e of Array.from(i).reverse()){const i=new UI.TreeOutline.TreeElement(e.url());n.appendChild(i),n!==t&&n.expand(),n=i}n.select(),n.titleElement.style.fontWeight="bold";const s=e.initiated;return this._depthFirstSearchTreeBuilder(s,n,this._request),t}_depthFirstSearchTreeBuilder(e,t,i){const n=new Set;n.add(this._request);for(const s of e.keys())if(e.get(s)===i){const i=new UI.TreeOutline.TreeElement(s.url());t.appendChild(i),t.expand(),n.has(s)||(n.add(s),this._depthFirstSearchTreeBuilder(e,i,s))}}wasShown(){if(this._hasShown)return;let e=!1;const t=RequestInitiatorView.createStackTracePreview(this._request,this._linkifier,!0);t&&(e=!0,this._appendExpandableSection(t.element,ls`Request call stack`,!0));const i=self.SDK.networkLog.initiatorGraphForRequest(this._request);(i.initiators.size>1||i.initiated.size>1)&&(e=!0,this._appendExpandableSection(this._buildRequestChainTree(i).element,ls`Request initiator chain`,!0)),e&&this._emptyWidget.hideWidget(),this._hasShown=!0}}