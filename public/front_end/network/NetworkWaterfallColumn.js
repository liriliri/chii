import*as Common from"../common/common.js";import*as PerfUI from"../perf_ui/perf_ui.js";import*as SDK from"../sdk/sdk.js";import*as UI from"../ui/ui.js";import{NetworkNode}from"./NetworkDataGridNode.js";import{NetworkTimeCalculator}from"./NetworkTimeCalculator.js";import{RequestTimeRangeNames,RequestTimingView}from"./RequestTimingView.js";export class NetworkWaterfallColumn extends UI.Widget.VBox{constructor(e){super(!1),this.registerRequiredCSS("network/networkWaterfallColumn.css"),this._canvas=this.contentElement.createChild("canvas"),this._canvas.tabIndex=-1,this.setDefaultFocusedElement(this._canvas),this._canvasPosition=this._canvas.getBoundingClientRect(),this._leftPadding=5,this._fontSize=10,this._rightPadding=0,this._scrollTop=0,this._headerHeight=0,this._calculator=e,this._rawRowHeight=0,this._rowHeight=0,this._offsetWidth=0,this._offsetHeight=0,this._startTime=this._calculator.minimumBoundary(),this._endTime=this._calculator.maximumBoundary(),this._popoverHelper=new UI.PopoverHelper.PopoverHelper(this.element,this._getPopoverRequest.bind(this)),this._popoverHelper.setHasPadding(!0),this._popoverHelper.setTimeout(300,300),this._nodes=[],this._hoveredNode=null,this._eventDividers=new Map,this._updateRequestID,this.element.addEventListener("mousemove",this._onMouseMove.bind(this),!0),this.element.addEventListener("mouseleave",e=>this._setHoveredNode(null,!1),!0),this.element.addEventListener("click",this._onClick.bind(this),!0),this._styleForTimeRangeName=NetworkWaterfallColumn._buildRequestTimeRangeStyle();const t=NetworkWaterfallColumn._buildResourceTypeStyle();this._styleForWaitingResourceType=t[0],this._styleForDownloadingResourceType=t[1];const i=self.UI.themeSupport.patchColorText("#a5a5a5",UI.UIUtils.ThemeSupport.ColorUsage.Foreground);this._wiskerStyle={borderColor:i,lineWidth:1},this._hoverDetailsStyle={fillStyle:i,lineWidth:1,borderColor:i},this._pathForStyle=new Map,this._textLayers=[],this._computedDatagridStyle=null}static _buildRequestTimeRangeStyle(){const e=RequestTimeRangeNames,t=new Map;return t.set(e.Connecting,{fillStyle:"#FF9800"}),t.set(e.SSL,{fillStyle:"#9C27B0"}),t.set(e.DNS,{fillStyle:"#009688"}),t.set(e.Proxy,{fillStyle:"#A1887F"}),t.set(e.Blocking,{fillStyle:"#AAAAAA"}),t.set(e.Push,{fillStyle:"#8CDBff"}),t.set(e.Queueing,{fillStyle:"white",lineWidth:2,borderColor:"lightgrey"}),t.set(e.Receiving,{fillStyle:"#03A9F4",lineWidth:2,borderColor:"#03A9F4"}),t.set(e.Waiting,{fillStyle:"#00C853"}),t.set(e.ReceivingPush,{fillStyle:"#03A9F4"}),t.set(e.ServiceWorker,{fillStyle:"orange"}),t.set(e.ServiceWorkerPreparation,{fillStyle:"orange"}),t}static _buildResourceTypeStyle(){const e=new Map([["document","hsl(215, 100%, 80%)"],["font","hsl(8, 100%, 80%)"],["media","hsl(90, 50%, 80%)"],["image","hsl(90, 50%, 80%)"],["script","hsl(31, 100%, 80%)"],["stylesheet","hsl(272, 64%, 80%)"],["texttrack","hsl(8, 100%, 80%)"],["websocket","hsl(0, 0%, 95%)"],["xhr","hsl(53, 100%, 80%)"],["fetch","hsl(53, 100%, 80%)"],["other","hsl(0, 0%, 95%)"]]),t=new Map,i=new Map;for(const r of Object.values(Common.ResourceType.resourceTypes)){let a=e.get(r.name());a||(a=e.get("other"));const h=s(a);t.set(r,{fillStyle:o(a),lineWidth:1,borderColor:h}),i.set(r,{fillStyle:a,lineWidth:1,borderColor:h})}return[t,i];function s(e){const t=Common.Color.Color.parse(e),i=t.hsla();return i[1]/=2,i[2]-=Math.min(i[2],.2),t.asString(null)}function o(e){const t=Common.Color.Color.parse(e);return t.hsla()[2]*=1.1,t.asString(null)}}_resetPaths(){this._pathForStyle.clear(),this._pathForStyle.set(this._wiskerStyle,new Path2D),this._styleForTimeRangeName.forEach(e=>this._pathForStyle.set(e,new Path2D)),this._styleForWaitingResourceType.forEach(e=>this._pathForStyle.set(e,new Path2D)),this._styleForDownloadingResourceType.forEach(e=>this._pathForStyle.set(e,new Path2D)),this._pathForStyle.set(this._hoverDetailsStyle,new Path2D)}willHide(){this._popoverHelper.hidePopover()}wasShown(){this.update()}_onMouseMove(e){this._setHoveredNode(this.getNodeFromPoint(e.offsetX,e.offsetY),e.shiftKey)}_onClick(e){this._setSelectedNode(this.getNodeFromPoint(e.offsetX,e.offsetY))&&e.consume(!0)}_getPopoverRequest(e){if(!this._hoveredNode)return null;const t=this._hoveredNode.request();if(!t)return null;let i,s,o;if(!Common.Settings.Settings.instance().moduleSetting("networkColorCodeResourceTypes").get()&&!this._calculator.startAtZero?(i=RequestTimingView.calculateRequestTimeRanges(t,0).find(e=>e.name===RequestTimeRangeNames.Total),s=this._timeToPosition(i.start),o=this._timeToPosition(i.end)):(i=this._getSimplifiedBarRange(t,0),s=i.start,o=i.end),o-s<50){const e=(o-s)/2;s=s+e-25,o=o-e+25}if(e.clientX<this._canvasPosition.left+s||e.clientX>this._canvasPosition.left+o)return null;const r=this._nodes.findIndex(e=>e.hovered()),a=this._getBarHeight(i.name),h=this._headerHeight+(this._rowHeight*r-this._scrollTop)+(this._rowHeight-a)/2;if(e.clientY<this._canvasPosition.top+h||e.clientY>this._canvasPosition.top+h+a)return null;const l=this.element.boxInWindow();return l.x+=s,l.y+=h,l.width=o-s,l.height=a,{box:l,show:e=>{const i=RequestTimingView.createTimingTable(t,this._calculator);return e.contentElement.appendChild(i),Promise.resolve(!0)}}}_setHoveredNode(e,t){this._hoveredNode&&this._hoveredNode.setHovered(!1,!1),this._hoveredNode=e,this._hoveredNode&&this._hoveredNode.setHovered(!0,t)}_setSelectedNode(e){return!(!e||!e.dataGrid)&&(e.select(),e.dataGrid.element.focus(),!0)}setRowHeight(e){this._rawRowHeight=e,this._updateRowHeight()}_updateRowHeight(){this._rowHeight=Math.round(this._rawRowHeight*window.devicePixelRatio)/window.devicePixelRatio}setHeaderHeight(e){this._headerHeight=e}setRightPadding(e){this._rightPadding=e,this._calculateCanvasSize()}setCalculator(e){this._calculator=e}getNodeFromPoint(e,t){return t<=this._headerHeight?null:this._nodes[Math.floor((this._scrollTop+t-this._headerHeight)/this._rowHeight)]}scheduleDraw(){this._updateRequestID||(this._updateRequestID=this.element.window().requestAnimationFrame(()=>this.update()))}update(e,t,i){void 0!==e&&this._scrollTop!==e&&(this._popoverHelper.hidePopover(),this._scrollTop=e),i&&(this._nodes=i,this._calculateCanvasSize()),void 0!==t&&(this._eventDividers=t),this._updateRequestID&&(this.element.window().cancelAnimationFrame(this._updateRequestID),delete this._updateRequestID),this._startTime=this._calculator.minimumBoundary(),this._endTime=this._calculator.maximumBoundary(),this._resetCanvas(),this._resetPaths(),this._textLayers=[],this._draw()}_resetCanvas(){const e=window.devicePixelRatio;this._canvas.width=this._offsetWidth*e,this._canvas.height=this._offsetHeight*e,this._canvas.style.width=this._offsetWidth+"px",this._canvas.style.height=this._offsetHeight+"px"}onResize(){super.onResize(),this._updateRowHeight(),this._calculateCanvasSize(),this.scheduleDraw()}_calculateCanvasSize(){this._offsetWidth=this.contentElement.offsetWidth-this._rightPadding,this._offsetHeight=this.contentElement.offsetHeight,this._calculator.setDisplayWidth(this._offsetWidth),this._canvasPosition=this._canvas.getBoundingClientRect()}_timeToPosition(e){const t=(this._offsetWidth-this._leftPadding)/(this._endTime-this._startTime);return Math.floor(this._leftPadding+(e-this._startTime)*t)}_didDrawForTest(){}_draw(){const e=!Common.Settings.Settings.instance().moduleSetting("networkColorCodeResourceTypes").get()&&!this._calculator.startAtZero,t=this._nodes,i=this._canvas.getContext("2d");i.save(),i.scale(window.devicePixelRatio,window.devicePixelRatio),i.translate(0,this._headerHeight),i.rect(0,0,this._offsetWidth,this._offsetHeight),i.clip();const s=Math.floor(this._scrollTop/this._rowHeight),o=Math.min(t.length,s+Math.ceil(this._offsetHeight/this._rowHeight));for(let r=s;r<o;r++){const s=this._rowHeight*r,o=t[r];this._decorateRow(i,o,s-this._scrollTop);let a=[];o.hasChildren()&&!o.expanded&&(a=o.flatChildren()),a.push(o);for(const t of a)e?this._buildTimingBarLayers(t,s-this._scrollTop):this._buildSimplifiedBarLayers(i,t,s-this._scrollTop)}this._drawLayers(i),i.save(),i.fillStyle=self.UI.themeSupport.patchColorText("#888",UI.UIUtils.ThemeSupport.ColorUsage.Foreground);for(const e of this._textLayers)i.fillText(e.text,e.x,e.y);i.restore(),this._drawEventDividers(i),i.restore();const r=PerfUI.TimelineGrid.TimelineGrid.calculateGridOffsets(this._calculator);PerfUI.TimelineGrid.TimelineGrid.drawCanvasGrid(i,r),PerfUI.TimelineGrid.TimelineGrid.drawCanvasHeaders(i,r,e=>this._calculator.formatValue(e,r.precision),this._fontSize,this._headerHeight,75),i.clearRect(this._offsetWidth-18,0,18,this._headerHeight),this._didDrawForTest()}_drawLayers(e){for(const t of this._pathForStyle){const i=t[0],s=t[1];e.save(),e.beginPath(),i.lineWidth&&(e.lineWidth=i.lineWidth,e.strokeStyle=i.borderColor,e.stroke(s)),i.fillStyle&&(e.fillStyle=i.fillStyle,e.fill(s)),e.restore()}}_drawEventDividers(e){e.save(),e.lineWidth=1;for(const t of this._eventDividers.keys()){e.strokeStyle=t;for(const i of this._eventDividers.get(t)){e.beginPath();const t=this._timeToPosition(i);e.moveTo(t,0),e.lineTo(t,this._offsetHeight)}e.stroke()}e.restore()}_getBarHeight(e){const t=RequestTimeRangeNames;switch(e){case t.Connecting:case t.SSL:case t.DNS:case t.Proxy:case t.Blocking:case t.Push:case t.Queueing:return 7;default:return 13}}_getSimplifiedBarRange(e,t){const i=this._offsetWidth-this._leftPadding,s=this._calculator.computeBarGraphPercentages(e);return{start:this._leftPadding+Math.floor(s.start/100*i)+t,mid:this._leftPadding+Math.floor(s.middle/100*i)+t,end:this._leftPadding+Math.floor(s.end/100*i)+t}}_buildSimplifiedBarLayers(e,t,i){const s=t.request();if(!s)return;const o=this._getSimplifiedBarRange(s,.5),r=this._getBarHeight();i+=Math.floor(this._rowHeight/2-r/2+1)-.5;const a=this._styleForWaitingResourceType.get(s.resourceType());this._pathForStyle.get(a).rect(o.start,i,o.mid-o.start,r-1);const h=Math.max(2,o.end-o.mid),l=this._styleForDownloadingResourceType.get(s.resourceType());this._pathForStyle.get(l).rect(o.mid,i,h,r-1);let n=null;if(t.hovered()){n=this._calculator.computeBarGraphLabels(s);const t=10,a=e.measureText(n.left).width,l=e.measureText(n.right).width,d=this._pathForStyle.get(this._hoverDetailsStyle);if(a<o.mid-o.start){const e=o.start+(o.mid-o.start-a)/2;this._textLayers.push({text:n.left,x:e,y:i+this._fontSize})}else t+a+this._leftPadding<o.start&&(this._textLayers.push({text:n.left,x:o.start-a-t-1,y:i+this._fontSize}),d.moveTo(o.start-t,i+Math.floor(r/2)),d.arc(o.start,i+Math.floor(r/2),2,0,2*Math.PI),d.moveTo(o.start-t,i+Math.floor(r/2)),d.lineTo(o.start,i+Math.floor(r/2)));const _=o.mid+h+.5;if(l<_-o.mid){const e=o.mid+(_-o.mid-l)/2;this._textLayers.push({text:n.right,x:e,y:i+this._fontSize})}else _+t+l<this._offsetWidth-this._leftPadding&&(this._textLayers.push({text:n.right,x:_+t+1,y:i+this._fontSize}),d.moveTo(_,i+Math.floor(r/2)),d.arc(_,i+Math.floor(r/2),2,0,2*Math.PI),d.moveTo(_,i+Math.floor(r/2)),d.lineTo(_+t,i+Math.floor(r/2)))}if(!this._calculator.startAtZero){const t=RequestTimingView.calculateRequestTimeRanges(s,0).find(e=>e.name===RequestTimeRangeNames.Total),a=n?e.measureText(n.left).width:0,h=a<o.mid-o.start,l=13,d=n&&!h?a+l:0,_=this._timeToPosition(t.start);if(o.start-d>_){const e=this._pathForStyle.get(this._wiskerStyle);e.moveTo(_,i+Math.floor(r/2)),e.lineTo(o.start-d,i+Math.floor(r/2));const t=r/2;e.moveTo(_+.5,i+t/2),e.lineTo(_+.5,i+r-t/2-1)}}}_buildTimingBarLayers(e,t){const i=e.request();if(!i)return;const s=RequestTimingView.calculateRequestTimeRanges(i,0);for(const e of s){if(e.name===RequestTimeRangeNames.Total||e.name===RequestTimeRangeNames.Sending||e.end-e.start==0)continue;const i=this._styleForTimeRangeName.get(e.name),s=this._pathForStyle.get(i),o=i.lineWidth||0,r=this._getBarHeight(e.name),a=t+Math.floor(this._rowHeight/2-r/2)+o/2,h=this._timeToPosition(e.start),l=this._timeToPosition(e.end);s.rect(h,a,l-h,r-o)}}_decorateRow(e,t,i){if(!this._computedDatagridStyle&&t.dataGrid&&(this._computedDatagridStyle=window.getComputedStyle(t.dataGrid.element)),!this._computedDatagridStyle)return void e.restore();const s=t.backgroundColor();e.save(),e.beginPath(),e.fillStyle=this._computedDatagridStyle.getPropertyValue(s),e.rect(0,i,this._offsetWidth,this._rowHeight),e.fill(),e.restore()}}export let _TextLayer;export let _LayerStyle;