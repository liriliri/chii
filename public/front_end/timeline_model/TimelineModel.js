import*as Common from"../common/common.js";import*as SDK from"../sdk/sdk.js";import{TimelineJSProfileProcessor}from"./TimelineJSProfile.js";export class TimelineModelImpl{constructor(){this._reset()}static forEachEvent(e,t,a,i,r,n,s){r=r||0,n=n||1/0;const o=[];for(let l=TimelineModelImpl._topLevelEventEndingAfter(e,r);l<e.length;++l){const c=e[l];if(!((c.endTime||c.startTime)<r)){if(c.startTime>=n)break;if(!SDK.TracingModel.TracingModel.isAsyncPhase(c.phase)&&!SDK.TracingModel.TracingModel.isFlowPhase(c.phase)){for(;o.length&&o.peekLast().endTime<=c.startTime;)a(o.pop());s&&!s(c)||(c.duration?(t(c),o.push(c)):i&&i(c,o.peekLast()||null))}}}for(;o.length;)a(o.pop())}static _topLevelEventEndingAfter(e,t){let a=e.upperBound(t,(e,t)=>e-t.startTime)-1;for(;a>0&&!SDK.TracingModel.TracingModel.isTopLevelEvent(e[a]);)a--;return Math.max(a,0)}isMarkerEvent(e){const t=RecordType;switch(e.name){case t.TimeStamp:return!0;case t.MarkFirstPaint:case t.MarkFCP:case t.MarkFMP:return this._mainFrame&&e.args.frame===this._mainFrame.frameId&&!!e.args.data;case t.MarkDOMContent:case t.MarkLoad:case t.MarkLCPCandidate:case t.MarkLCPInvalidate:return!!e.args.data.isMainFrame;default:return!1}}isInteractiveTimeEvent(e){return e.name===RecordType.InteractiveTime}isLayoutShiftEvent(e){return e.name===RecordType.LayoutShift}isLCPCandidateEvent(e){return e.name===RecordType.MarkLCPCandidate&&!!e.args.data.isMainFrame}isLCPInvalidateEvent(e){return e.name===RecordType.MarkLCPInvalidate&&!!e.args.data.isMainFrame}static globalEventId(e,t){const a=e.args.data||e.args.beginData,i=a&&a[t];return i?`${e.thread.process().id()}.${i}`:""}static eventFrameId(e){const t=e.args.data||e.args.beginData;return t&&t.frame||""}cpuProfiles(){return this._cpuProfiles}totalBlockingTime(){return this._totalBlockingTime}targetByEvent(e){const t=this._workerIdByThread.get(e.thread),a=SDK.SDKModel.TargetManager.instance().mainTarget();return t?SDK.SDKModel.TargetManager.instance().targetById(t):a}setEvents(e){this._reset(),this._resetProcessingState(),this._tracingModel=e,this._minimumRecordTime=e.minimumRecordTime(),this._maximumRecordTime=e.maximumRecordTime();const t=e.extractEventsFromThreadByName("Renderer","CrRendererMain",RecordType.LayoutShift);if(this._processSyncBrowserEvents(e),this._browserFrameTracking)this._processThreadsForBrowserFrames(e);else{const t=this._processMetadataEvents(e);this._isGenericTrace=!t,t?this._processMetadataAndThreads(e,t):this._processGenericTrace(e)}this._inspectedTargetEvents.sort(SDK.TracingModel.Event.compareStartTime),this._processAsyncBrowserEvents(e),this._buildGPUEvents(e),this._buildLoadingEvents(e,t),this._resetProcessingState()}_processGenericTrace(e){let t=SDK.TracingModel.TracingModel.browserMainThread(e);!t&&e.sortedProcesses().length&&(t=e.sortedProcesses()[0].sortedThreads()[0]);for(const a of e.sortedProcesses())for(const i of a.sortedThreads())this._processThreadEvents(e,[{from:0,to:1/0}],i,i===t,!1,!0,null)}_processMetadataAndThreads(e,t){let a=0;for(let i=0,r=t.page.length;i<r;i++){const n=t.page[i],s=n.thread.process(),o=i+1<r?t.page[i+1].startTime:1/0;if(a!==o){this._legacyCurrentPage=n.args.data&&n.args.data.page;for(const i of s.sortedThreads()){let r=null;if(i.name()===TimelineModelImpl.WorkerThreadName||i.name()===TimelineModelImpl.WorkerThreadNameLegacy){const e=t.workers.find(e=>e.args.data.workerThreadId===i.id()&&(e.args.data.sessionId===this._sessionId||!!this._pageFrames.get(TimelineModelImpl.eventFrameId(e))));if(!e)continue;const a=e.args.data.workerId;a&&this._workerIdByThread.set(i,a),r=e.args.data.url||""}this._processThreadEvents(e,[{from:a,to:o}],i,i===n.thread,!!r,!0,r)}a=o}}}_processThreadsForBrowserFrames(e){const t=new Map;for(const e of this._pageFrames.values())for(let a=0;a<e.processes.length;a++){const i=e.processes[a].processId;let r=t.get(i);r||(r=[],t.set(i,r));const n=a===e.processes.length-1?e.deletedTime||1/0:e.processes[a+1].time;r.push({from:e.processes[a].time,to:n,main:!e.parent,url:e.processes[a].url})}const a=e.devToolsMetadataEvents();for(const i of e.sortedProcesses()){const r=t.get(i.id());if(!r)continue;r.sort((e,t)=>e.from-t.from||e.to-t.to);const n=[];let s=null,o=null,l=!1;for(const e of r)!n.length||e.from>n.peekLast().to?n.push({from:e.from,to:e.to}):n.peekLast().to=e.to,e.main&&(l=!0),e.url&&(e.main&&(o=e.url),s=e.url);for(const t of i.sortedThreads())if(t.name()===TimelineModelImpl.RendererMainThreadName)this._processThreadEvents(e,n,t,!0,!1,l,l?o:s);else if(t.name()===TimelineModelImpl.WorkerThreadName||t.name()===TimelineModelImpl.WorkerThreadNameLegacy){const r=a.find(e=>e.name===TimelineModelImpl.DevToolsMetadataEvent.TracingSessionIdForWorker&&(e.thread.process()===i&&(e.args.data.workerThreadId===t.id()&&!!this._pageFrames.get(TimelineModelImpl.eventFrameId(e)))));if(!r)continue;this._workerIdByThread.set(t,r.args.data.workerId||""),this._processThreadEvents(e,n,t,!1,!0,!1,r.args.data.url||"")}else this._processThreadEvents(e,n,t,!1,!1,!1,null)}}_processMetadataEvents(e){const t=e.devToolsMetadataEvents(),a=[],i=[];for(const e of t)if(e.name===TimelineModelImpl.DevToolsMetadataEvent.TracingStartedInPage){a.push(e),e.args.data&&e.args.data.persistentIds&&(this._persistentIds=!0);(e.args.data&&e.args.data.frames||[]).forEach(t=>this._addPageFrame(e,t)),this._mainFrame=this.rootFrames()[0]}else e.name===TimelineModelImpl.DevToolsMetadataEvent.TracingSessionIdForWorker?i.push(e):e.name===TimelineModelImpl.DevToolsMetadataEvent.TracingStartedInBrowser&&(console.assert(!this._mainFrameNodeId,"Multiple sessions in trace"),this._mainFrameNodeId=e.args.frameTreeNodeId);if(!a.length)return null;const r=a[0].args.sessionId||a[0].args.data.sessionId;this._sessionId=r;const n=new Set;const s={page:a.filter((function(e){let t=e.args;t.data&&(t=t.data);const a=t.sessionId;return a===r||(n.add(a),!1)})).sort(SDK.TracingModel.Event.compareStartTime),workers:i.sort(SDK.TracingModel.Event.compareStartTime)};return n.size&&Common.Console.Console.instance().error("Timeline recording was started in more than one page simultaneously. Session id mismatch: "+this._sessionId+" and "+[...n]+"."),s}_processSyncBrowserEvents(e){const t=SDK.TracingModel.TracingModel.browserMainThread(e);t&&t.events().forEach(this._processBrowserEvent,this)}_processAsyncBrowserEvents(e){const t=SDK.TracingModel.TracingModel.browserMainThread(e);t&&this._processAsyncEvents(t,[{from:0,to:1/0}])}_buildGPUEvents(e){const t=e.threadByName("GPU Process","CrGpuMain");if(!t)return;const a=RecordType.GPUTask,i=this._ensureNamedTrack(TrackType.GPU);i.thread=t,i.events=t.events().filter(e=>e.name===a)}_buildLoadingEvents(e,t){const a=e.threadByName("Renderer","CrRendererMain");if(!a)return;const i=this._ensureNamedTrack(TrackType.Experience);i.thread=a,i.events=t;for(const e of i.events)e.categoriesString="experience"}_resetProcessingState(){this._asyncEventTracker=new TimelineAsyncEventTracker,this._invalidationTracker=new InvalidationTracker,this._layoutInvalidate={},this._lastScheduleStyleRecalculation={},this._paintImageEventByPixelRefId={},this._lastPaintForLayer={},this._lastRecalculateStylesEvent=null,this._currentScriptEvent=null,this._eventStack=[],this._knownInputEvents=new Set,this._browserFrameTracking=!1,this._persistentIds=!1,this._legacyCurrentPage=null}_extractCpuProfile(e,t){const a=t.events();let i,r=null,n=a.peekLast();if(n&&n.name===RecordType.CpuProfile){const e=n.args.data;i=e&&e.cpuProfile,r=this.targetByEvent(n)}if(!i){if(n=a.find(e=>e.name===RecordType.Profile),!n)return null;r=this.targetByEvent(n);const t=e.profileGroup(n);if(!t)return Common.Console.Console.instance().error("Invalid CPU profile format."),null;i={startTime:1e3*n.startTime,endTime:0,nodes:[],samples:[],timeDeltas:[],lines:[]};for(const e of t.children){const t=e.args.data;"startTime"in t&&(i.startTime=1e3*e.startTime),"endTime"in t&&(i.endTime=1e3*e.startTime);const a=t.cpuProfile||{},r=a.samples||[],n=t.lines||Array(r.length).fill(0);if(i.nodes.push(...a.nodes||[]),i.lines.push(...n),i.samples.push(...r),i.timeDeltas.push(...t.timeDeltas||[]),i.samples.length!==i.timeDeltas.length)return Common.Console.Console.instance().error("Failed to parse CPU profile."),null}i.endTime||(i.endTime=i.timeDeltas.reduce((e,t)=>e+t,i.startTime))}try{const e=new SDK.CPUProfileDataModel.CPUProfileDataModel(i,r);return this._cpuProfiles.push(e),e}catch(e){Common.Console.Console.instance().error("Failed to parse CPU profile.")}return null}_injectJSFrameEvents(e,t){const a=this._extractCpuProfile(e,t);let i=t.events();const r=a?TimelineJSProfileProcessor.generateTracingEventsFromCpuProfile(a,t):null;if(r&&r.length&&(i=i.mergeOrdered(r,SDK.TracingModel.Event.orderedCompareStartTime)),r||i.some(e=>e.name===RecordType.JSSample)){const e=TimelineJSProfileProcessor.generateJSFrameEvents(i);e&&e.length&&(i=e.mergeOrdered(i,SDK.TracingModel.Event.orderedCompareStartTime))}return i}_processThreadEvents(e,t,a,i,r,n,s){const o=new Track;o.name=a.name()||ls`Thread ${a.id()}`,o.type=TrackType.Other,o.thread=a,i?(o.type=TrackType.MainThread,o.url=s||null,o.forMainFrame=n):r?(o.type=TrackType.Worker,o.url=s):a.name().startsWith("CompositorTileWorker")&&(o.type=TrackType.Raster),this._tracks.push(o);const l=this._injectJSFrameEvents(e,a);this._eventStack=[];const c=this._eventStack;for(const e of t){let t=l.lowerBound(e.from,(e,t)=>e-t.startTime);for(;t<l.length;t++){const a=l[t];if(a.startTime>=e.to)break;for(this.isInteractiveTimeEvent(a)&&-1===this._totalBlockingTime&&(this._totalBlockingTime=a.args.args.total_blocking_time_ms);c.length&&c.peekLast().endTime<=a.startTime;)c.pop();if(this._processEvent(a)){if(!SDK.TracingModel.TracingModel.isAsyncPhase(a.phase)&&a.duration){if(c.length){const e=c.peekLast();e.selfTime-=a.duration,e.selfTime<0&&this._fixNegativeDuration(e,a)}a.selfTime=a.duration,c.length||o.tasks.push(a),c.push(a)}this.isMarkerEvent(a)&&this._timeMarkerEvents.push(a),o.events.push(a),this._inspectedTargetEvents.push(a)}}}this._processAsyncEvents(a,t)}_fixNegativeDuration(e,t){e.selfTime<-.001&&console.error(`Children are longer than parent at ${e.startTime} (${(t.startTime-this.minimumRecordTime()).toFixed(3)} by ${(-e.selfTime).toFixed(3)}`),e.selfTime=0}_processAsyncEvents(e,t){const a=e.asyncEvents(),i=new Map;function r(e){return i.has(e)||i.set(e,[]),i.get(e)}for(const e of t){let t=a.lowerBound(e.from,(function(e,t){return e-t.startTime}));for(;t<a.length;++t){const i=a[t];if(i.startTime>=e.to)break;if(i.hasCategory(TimelineModelImpl.Category.Console))r(TrackType.Console).push(i);else if(i.hasCategory(TimelineModelImpl.Category.UserTiming))r(TrackType.Timings).push(i);else if(i.name!==RecordType.Animation)if(i.hasCategory(TimelineModelImpl.Category.LatencyInfo)||i.name===RecordType.ImplSideFling){const e=i.steps.peekLast();if(e.phase!==SDK.TracingModel.Phase.AsyncEnd)continue;const t=e.args.data;if(i.causedFrame=!(!t||!t.INPUT_EVENT_LATENCY_RENDERER_SWAP_COMPONENT),i.hasCategory(TimelineModelImpl.Category.LatencyInfo)){if(!this._knownInputEvents.has(e.id))continue;if(i.name===RecordType.InputLatencyMouseMove&&!i.causedFrame)continue;if(t.is_coalesced)continue;const a=t.INPUT_EVENT_LATENCY_RENDERER_MAIN_COMPONENT;if(a){const e=a.time/1e3;TimelineData.forEvent(i.steps[0]).timeWaitingForMainThread=e-i.steps[0].startTime}}r(TrackType.Input).push(i)}else;else r(TrackType.Animation).push(i)}}for(const[t,a]of i){const i=this._ensureNamedTrack(t);i.thread=e,i.asyncEvents=i.asyncEvents.mergeOrdered(a,SDK.TracingModel.Event.compareStartTime)}}_processEvent(e){const t=RecordType,a=this._eventStack;if(!a.length){if(this._currentTaskLayoutAndRecalcEvents&&this._currentTaskLayoutAndRecalcEvents.length){if(this._currentTaskLayoutAndRecalcEvents.reduce((e,t)=>e+t.duration,0)>TimelineModelImpl.Thresholds.ForcedLayout)for(const e of this._currentTaskLayoutAndRecalcEvents){TimelineData.forEvent(e).warning=e.name===t.Layout?TimelineModelImpl.WarningType.ForcedLayout:TimelineModelImpl.WarningType.ForcedStyle}}this._currentTaskLayoutAndRecalcEvents=[]}this._currentScriptEvent&&e.startTime>this._currentScriptEvent.endTime&&(this._currentScriptEvent=null);const i=e.args.data||e.args.beginData||{},r=TimelineData.forEvent(e);if(i.stackTrace&&(r.stackTrace=i.stackTrace),r.stackTrace&&e.name!==t.JSSample)for(let e=0;e<r.stackTrace.length;++e)--r.stackTrace[e].lineNumber,--r.stackTrace[e].columnNumber;let n=TimelineModelImpl.eventFrameId(e);switch(!n&&a.length&&(n=TimelineData.forEvent(a.peekLast()).frameId),r.frameId=n||this._mainFrame&&this._mainFrame.frameId||"",this._asyncEventTracker.processEvent(e),this.isMarkerEvent(e)&&this._ensureNamedTrack(TrackType.Timings),e.name){case t.ResourceSendRequest:case t.WebSocketCreate:r.setInitiator(a.peekLast()||null),r.url=i.url;break;case t.ScheduleStyleRecalculation:this._lastScheduleStyleRecalculation[i.frame]=e;break;case t.UpdateLayoutTree:case t.RecalculateStyles:this._invalidationTracker.didRecalcStyle(e),e.args.beginData&&r.setInitiator(this._lastScheduleStyleRecalculation[e.args.beginData.frame]),this._lastRecalculateStylesEvent=e,this._currentScriptEvent&&this._currentTaskLayoutAndRecalcEvents.push(e);break;case t.ScheduleStyleInvalidationTracking:case t.StyleRecalcInvalidationTracking:case t.StyleInvalidatorInvalidationTracking:case t.LayoutInvalidationTracking:this._invalidationTracker.addInvalidation(new InvalidationTrackingEvent(e));break;case t.InvalidateLayout:{let t=e;const a=i.frame;!this._layoutInvalidate[a]&&this._lastRecalculateStylesEvent&&this._lastRecalculateStylesEvent.endTime>e.startTime&&(t=TimelineData.forEvent(this._lastRecalculateStylesEvent).initiator()),this._layoutInvalidate[a]=t;break}case t.Layout:{this._invalidationTracker.didLayout(e);const t=e.args.beginData.frame;r.setInitiator(this._layoutInvalidate[t]),e.args.endData&&(r.backendNodeId=e.args.endData.rootNode),this._layoutInvalidate[t]=null,this._currentScriptEvent&&this._currentTaskLayoutAndRecalcEvents.push(e);break}case t.Task:e.duration>TimelineModelImpl.Thresholds.LongTask&&(r.warning=TimelineModelImpl.WarningType.LongTask);break;case t.EventDispatch:e.duration>TimelineModelImpl.Thresholds.RecurringHandler&&(r.warning=TimelineModelImpl.WarningType.LongHandler);break;case t.TimerFire:case t.FireAnimationFrame:e.duration>TimelineModelImpl.Thresholds.RecurringHandler&&(r.warning=TimelineModelImpl.WarningType.LongRecurringHandler);break;case t.FunctionCall:"string"==typeof i.scriptName&&(i.url=i.scriptName),"number"==typeof i.scriptLine&&(i.lineNumber=i.scriptLine);case t.EvaluateScript:case t.CompileScript:"number"==typeof i.lineNumber&&--i.lineNumber,"number"==typeof i.columnNumber&&--i.columnNumber;case t.RunMicrotasks:this._currentScriptEvent||(this._currentScriptEvent=e);break;case t.SetLayerTreeId:{if(this._sessionId&&i.sessionId&&this._sessionId===i.sessionId){this._mainFrameLayerTreeId=i.layerTreeId;break}const t=TimelineModelImpl.eventFrameId(e),a=this._pageFrames.get(t);if(!a||a.parent)return!1;this._mainFrameLayerTreeId=i.layerTreeId;break}case t.Paint:{if(this._invalidationTracker.didPaint(e),r.backendNodeId=i.nodeId,!i.layerId)break;const t=i.layerId;this._lastPaintForLayer[t]=e;break}case t.DisplayItemListSnapshot:case t.PictureSnapshot:{const a=this._findAncestorEvent(t.UpdateLayer);if(!a||a.args.layerTreeId!==this._mainFrameLayerTreeId)break;const i=this._lastPaintForLayer[a.args.layerId];i&&(TimelineData.forEvent(i).picture=e);break}case t.ScrollLayer:r.backendNodeId=i.nodeId;break;case t.PaintImage:r.backendNodeId=i.nodeId,r.url=i.url;break;case t.DecodeImage:case t.ResizeImage:{let e=this._findAncestorEvent(t.PaintImage);if(!e){const a=this._findAncestorEvent(t.DecodeLazyPixelRef);e=a&&this._paintImageEventByPixelRefId[a.args.LazyPixelRef]}if(!e)break;const a=TimelineData.forEvent(e);r.backendNodeId=a.backendNodeId,r.url=a.url;break}case t.DrawLazyPixelRef:{const a=this._findAncestorEvent(t.PaintImage);if(!a)break;this._paintImageEventByPixelRefId[e.args.LazyPixelRef]=a;const i=TimelineData.forEvent(a);r.backendNodeId=i.backendNodeId,r.url=i.url;break}case t.FrameStartedLoading:if(r.frameId!==e.args.frame)return!1;break;case t.MarkLCPCandidate:r.backendNodeId=i.nodeId;break;case t.MarkDOMContent:case t.MarkLoad:{const t=TimelineModelImpl.eventFrameId(e);if(!this._pageFrames.has(t))return!1;break}case t.CommitLoad:{if(this._browserFrameTracking)break;const t=TimelineModelImpl.eventFrameId(e),a=!!i.isMainFrame,r=this._pageFrames.get(t);if(r)r.update(e.startTime,i);else if(this._persistentIds){if(a)return!1;if(!this._addPageFrame(e,i))return!1}else if(i.page&&i.page!==this._legacyCurrentPage)return!1;a&&(this._mainFrame=this._pageFrames.get(t));break}case t.FireIdleCallback:e.duration>i.allottedMilliseconds+TimelineModelImpl.Thresholds.IdleCallbackAddon&&(r.warning=TimelineModelImpl.WarningType.IdleDeadlineExceeded)}return!0}_processBrowserEvent(e){if(e.name!==RecordType.LatencyInfoFlow)if(e.name!==RecordType.ResourceWillSendRequest){if(e.hasCategory(SDK.TracingModel.DevToolsMetadataEventCategory)&&e.args.data){const t=e.args.data;if(e.name===TimelineModelImpl.DevToolsMetadataEvent.TracingStartedInBrowser){if(!t.persistentIds)return;this._browserFrameTracking=!0,this._mainFrameNodeId=t.frameTreeNodeId;return void(t.frames||[]).forEach(e=>{const t=e.parent&&this._pageFrames.get(e.parent);if(e.parent&&!t)return;let a=this._pageFrames.get(e.frame);a||(a=new PageFrame(e),this._pageFrames.set(a.frameId,a),t?t.addChild(a):this._mainFrame=a),a.update(this._minimumRecordTime,e)})}if(e.name===TimelineModelImpl.DevToolsMetadataEvent.FrameCommittedInBrowser&&this._browserFrameTracking){let a=this._pageFrames.get(t.frame);if(!a){const e=t.parent&&this._pageFrames.get(t.parent);if(!e)return;a=new PageFrame(t),this._pageFrames.set(a.frameId,a),e.addChild(a)}return void a.update(e.startTime,t)}if(e.name===TimelineModelImpl.DevToolsMetadataEvent.ProcessReadyInBrowser&&this._browserFrameTracking){const e=this._pageFrames.get(t.frame);return void(e&&e.processReady(t.processPseudoId,t.processId))}if(e.name===TimelineModelImpl.DevToolsMetadataEvent.FrameDeletedInBrowser&&this._browserFrameTracking){const a=this._pageFrames.get(t.frame);return void(a&&(a.deletedTime=e.startTime))}}}else{const t=e.args.data.requestId;"string"==typeof t&&this._requestsFromBrowser.set(t,e)}else{const t=e.args.frameTreeNodeId;"number"==typeof t&&t===this._mainFrameNodeId&&this._knownInputEvents.add(e.bind_id)}}_ensureNamedTrack(e){if(!this._namedTracks.has(e)){const t=new Track;t.type=e,this._tracks.push(t),this._namedTracks.set(e,t)}return this._namedTracks.get(e)}_findAncestorEvent(e){for(let t=this._eventStack.length-1;t>=0;--t){const a=this._eventStack[t];if(a.name===e)return a}return null}_addPageFrame(e,t){const a=t.parent&&this._pageFrames.get(t.parent);if(t.parent&&!a)return!1;const i=new PageFrame(t);return this._pageFrames.set(i.frameId,i),i.update(e.startTime,t),a&&a.addChild(i),!0}_reset(){this._isGenericTrace=!1,this._tracks=[],this._namedTracks=new Map,this._inspectedTargetEvents=[],this._timeMarkerEvents=[],this._sessionId=null,this._mainFrameNodeId=null,this._cpuProfiles=[],this._workerIdByThread=new WeakMap,this._pageFrames=new Map,this._mainFrame=null,this._requestsFromBrowser=new Map,this._minimumRecordTime=0,this._maximumRecordTime=0,this._totalBlockingTime=-1}isGenericTrace(){return this._isGenericTrace}tracingModel(){return this._tracingModel}minimumRecordTime(){return this._minimumRecordTime}maximumRecordTime(){return this._maximumRecordTime}inspectedTargetEvents(){return this._inspectedTargetEvents}tracks(){return this._tracks}isEmpty(){return 0===this.minimumRecordTime()&&0===this.maximumRecordTime()}timeMarkerEvents(){return this._timeMarkerEvents}rootFrames(){return Array.from(this._pageFrames.values()).filter(e=>!e.parent)}pageURL(){return this._mainFrame&&this._mainFrame.url||""}pageFrameById(e){return e&&this._pageFrames.get(e)||null}networkRequests(){if(this.isGenericTrace())return[];const e=new Map,t=[],a=[],i=RecordType,r=new Set([i.ResourceWillSendRequest,i.ResourceSendRequest,i.ResourceReceiveResponse,i.ResourceReceivedData,i.ResourceFinish,i.ResourceMarkAsCached]),n=this.inspectedTargetEvents();for(let e=0;e<n.length;++e){const t=n[e];if(!r.has(t.name))continue;const a=TimelineModelImpl.globalEventId(t,"requestId");t.name===i.ResourceSendRequest&&this._requestsFromBrowser.has(t.args.data.requestId)&&s(this._requestsFromBrowser.get(t.args.data.requestId),a),s(t,a)}function s(i,r){let n=e.get(r);n?n.addEvent(i):(n=new NetworkRequest(i),e.set(r,n),n.startTime?t.push(n):a.push(n))}return a.concat(t)}}export const RecordType={Task:"RunTask",Program:"Program",EventDispatch:"EventDispatch",GPUTask:"GPUTask",Animation:"Animation",RequestMainThreadFrame:"RequestMainThreadFrame",BeginFrame:"BeginFrame",NeedsBeginFrameChanged:"NeedsBeginFrameChanged",BeginMainThreadFrame:"BeginMainThreadFrame",ActivateLayerTree:"ActivateLayerTree",DrawFrame:"DrawFrame",HitTest:"HitTest",ScheduleStyleRecalculation:"ScheduleStyleRecalculation",RecalculateStyles:"RecalculateStyles",UpdateLayoutTree:"UpdateLayoutTree",InvalidateLayout:"InvalidateLayout",Layout:"Layout",LayoutShift:"LayoutShift",UpdateLayer:"UpdateLayer",UpdateLayerTree:"UpdateLayerTree",PaintSetup:"PaintSetup",Paint:"Paint",PaintImage:"PaintImage",Rasterize:"Rasterize",RasterTask:"RasterTask",ScrollLayer:"ScrollLayer",CompositeLayers:"CompositeLayers",InteractiveTime:"InteractiveTime",ScheduleStyleInvalidationTracking:"ScheduleStyleInvalidationTracking",StyleRecalcInvalidationTracking:"StyleRecalcInvalidationTracking",StyleInvalidatorInvalidationTracking:"StyleInvalidatorInvalidationTracking",LayoutInvalidationTracking:"LayoutInvalidationTracking",ParseHTML:"ParseHTML",ParseAuthorStyleSheet:"ParseAuthorStyleSheet",TimerInstall:"TimerInstall",TimerRemove:"TimerRemove",TimerFire:"TimerFire",XHRReadyStateChange:"XHRReadyStateChange",XHRLoad:"XHRLoad",CompileScript:"v8.compile",EvaluateScript:"EvaluateScript",CompileModule:"v8.compileModule",EvaluateModule:"v8.evaluateModule",WasmStreamFromResponseCallback:"v8.wasm.streamFromResponseCallback",WasmCompiledModule:"v8.wasm.compiledModule",WasmCachedModule:"v8.wasm.cachedModule",WasmModuleCacheHit:"v8.wasm.moduleCacheHit",WasmModuleCacheInvalid:"v8.wasm.moduleCacheInvalid",FrameStartedLoading:"FrameStartedLoading",CommitLoad:"CommitLoad",MarkLoad:"MarkLoad",MarkDOMContent:"MarkDOMContent",MarkFirstPaint:"firstPaint",MarkFCP:"firstContentfulPaint",MarkFMP:"firstMeaningfulPaint",MarkLCPCandidate:"largestContentfulPaint::Candidate",MarkLCPInvalidate:"largestContentfulPaint::Invalidate",TimeStamp:"TimeStamp",ConsoleTime:"ConsoleTime",UserTiming:"UserTiming",ResourceWillSendRequest:"ResourceWillSendRequest",ResourceSendRequest:"ResourceSendRequest",ResourceReceiveResponse:"ResourceReceiveResponse",ResourceReceivedData:"ResourceReceivedData",ResourceFinish:"ResourceFinish",ResourceMarkAsCached:"ResourceMarkAsCached",RunMicrotasks:"RunMicrotasks",FunctionCall:"FunctionCall",GCEvent:"GCEvent",MajorGC:"MajorGC",MinorGC:"MinorGC",JSFrame:"JSFrame",JSSample:"JSSample",V8Sample:"V8Sample",JitCodeAdded:"JitCodeAdded",JitCodeMoved:"JitCodeMoved",StreamingCompileScript:"v8.parseOnBackground",StreamingCompileScriptWaiting:"v8.parseOnBackgroundWaiting",StreamingCompileScriptParsing:"v8.parseOnBackgroundParsing",V8Execute:"V8.Execute",UpdateCounters:"UpdateCounters",RequestAnimationFrame:"RequestAnimationFrame",CancelAnimationFrame:"CancelAnimationFrame",FireAnimationFrame:"FireAnimationFrame",RequestIdleCallback:"RequestIdleCallback",CancelIdleCallback:"CancelIdleCallback",FireIdleCallback:"FireIdleCallback",WebSocketCreate:"WebSocketCreate",WebSocketSendHandshakeRequest:"WebSocketSendHandshakeRequest",WebSocketReceiveHandshakeResponse:"WebSocketReceiveHandshakeResponse",WebSocketDestroy:"WebSocketDestroy",EmbedderCallback:"EmbedderCallback",SetLayerTreeId:"SetLayerTreeId",TracingStartedInPage:"TracingStartedInPage",TracingSessionIdForWorker:"TracingSessionIdForWorker",DecodeImage:"Decode Image",ResizeImage:"Resize Image",DrawLazyPixelRef:"Draw LazyPixelRef",DecodeLazyPixelRef:"Decode LazyPixelRef",LazyPixelRef:"LazyPixelRef",LayerTreeHostImplSnapshot:"cc::LayerTreeHostImpl",PictureSnapshot:"cc::Picture",DisplayItemListSnapshot:"cc::DisplayItemList",LatencyInfo:"LatencyInfo",LatencyInfoFlow:"LatencyInfo.Flow",InputLatencyMouseMove:"InputLatency::MouseMove",InputLatencyMouseWheel:"InputLatency::MouseWheel",ImplSideFling:"InputHandlerProxy::HandleGestureFling::started",GCCollectGarbage:"BlinkGC.AtomicPhase",CryptoDoEncrypt:"DoEncrypt",CryptoDoEncryptReply:"DoEncryptReply",CryptoDoDecrypt:"DoDecrypt",CryptoDoDecryptReply:"DoDecryptReply",CryptoDoDigest:"DoDigest",CryptoDoDigestReply:"DoDigestReply",CryptoDoSign:"DoSign",CryptoDoSignReply:"DoSignReply",CryptoDoVerify:"DoVerify",CryptoDoVerifyReply:"DoVerifyReply",CpuProfile:"CpuProfile",Profile:"Profile",AsyncTask:"AsyncTask"};TimelineModelImpl.Category={Console:"blink.console",UserTiming:"blink.user_timing",LatencyInfo:"latencyInfo",Loading:"loading"},TimelineModelImpl.WarningType={LongTask:"LongTask",ForcedStyle:"ForcedStyle",ForcedLayout:"ForcedLayout",IdleDeadlineExceeded:"IdleDeadlineExceeded",LongHandler:"LongHandler",LongRecurringHandler:"LongRecurringHandler",V8Deopt:"V8Deopt"},TimelineModelImpl.WorkerThreadName="DedicatedWorker thread",TimelineModelImpl.WorkerThreadNameLegacy="DedicatedWorker Thread",TimelineModelImpl.RendererMainThreadName="CrRendererMain",TimelineModelImpl.BrowserMainThreadName="CrBrowserMain",TimelineModelImpl.DevToolsMetadataEvent={TracingStartedInBrowser:"TracingStartedInBrowser",TracingStartedInPage:"TracingStartedInPage",TracingSessionIdForWorker:"TracingSessionIdForWorker",FrameCommittedInBrowser:"FrameCommittedInBrowser",ProcessReadyInBrowser:"ProcessReadyInBrowser",FrameDeletedInBrowser:"FrameDeletedInBrowser"},TimelineModelImpl.Thresholds={LongTask:50,Handler:150,RecurringHandler:50,ForcedLayout:30,IdleCallbackAddon:5};export class Track{constructor(){this.name="",this.type=TrackType.Other,this.forMainFrame=!1,this.url="",this.events=[],this.asyncEvents=[],this.tasks=[],this._syncEvents=null,this.thread=null}syncEvents(){if(this.events.length)return this.events;if(this._syncEvents)return this._syncEvents;const e=[];this._syncEvents=[];for(const t of this.asyncEvents){const a=t.startTime,i=t.endTime;for(;e.length&&a>=e.peekLast().endTime;)e.pop();if(e.length&&i>e.peekLast().endTime){this._syncEvents=[];break}const r=new SDK.TracingModel.Event(t.categoriesString,t.name,SDK.TracingModel.Phase.Complete,a,t.thread);r.setEndTime(i),r.addArgs(t.args),this._syncEvents.push(r),e.push(r)}return this._syncEvents}}export const TrackType={MainThread:Symbol("MainThread"),Worker:Symbol("Worker"),Input:Symbol("Input"),Animation:Symbol("Animation"),Timings:Symbol("Timings"),Console:Symbol("Console"),Raster:Symbol("Raster"),GPU:Symbol("GPU"),Experience:Symbol("Experience"),Other:Symbol("Other")};export class PageFrame{constructor(e){this.frameId=e.frame,this.url=e.url||"",this.name=e.name,this.children=[],this.parent=null,this.processes=[],this.deletedTime=null,this.ownerNode=null}update(e,t){this.url=t.url||"",this.name=t.name,t.processId?this.processes.push({time:e,processId:t.processId,processPseudoId:"",url:t.url||""}):this.processes.push({time:e,processId:-1,processPseudoId:t.processPseudoId,url:t.url||""})}processReady(e,t){for(const a of this.processes)a.processPseudoId===e&&(a.processPseudoId="",a.processId=t)}addChild(e){this.children.push(e),e.parent=this}}export class NetworkRequest{constructor(e){const t=RecordType,a=e.name===t.ResourceSendRequest||e.name===t.ResourceWillSendRequest;this.startTime=a?e.startTime:0,this.endTime=1/0,this.encodedDataLength=0,this.decodedBodyLength=0,this.children=[],this.timing,this.mimeType,this.url,this.requestMethod,this._transferSize=0,this._maybeDiskCached=!1,this._memoryCached=!1,this.addEvent(e)}addEvent(e){this.children.push(e);const t=RecordType;this.startTime=Math.min(this.startTime,e.startTime);const a=e.args.data;a.mimeType&&(this.mimeType=a.mimeType),"priority"in a&&(this.priority=a.priority),e.name===t.ResourceFinish&&(this.endTime=e.startTime),a.finishTime&&(this.finishTime=1e3*a.finishTime),this.responseTime||e.name!==t.ResourceReceiveResponse&&e.name!==t.ResourceReceivedData||(this.responseTime=e.startTime);const i=a.encodedDataLength||0;e.name===t.ResourceMarkAsCached&&(this._memoryCached=!0),e.name===t.ResourceReceiveResponse&&(a.fromCache&&(this._maybeDiskCached=!0),a.fromServiceWorker&&(this.fromServiceWorker=!0),a.hasCachedResource&&(this.hasCachedResource=!0),this.encodedDataLength=i),e.name===t.ResourceReceivedData&&(this.encodedDataLength+=i),e.name===t.ResourceFinish&&i&&(this.encodedDataLength=i,this._transferSize=i);const r=a.decodedBodyLength;e.name===t.ResourceFinish&&r&&(this.decodedBodyLength=r),this.url||(this.url=a.url),this.requestMethod||(this.requestMethod=a.requestMethod),this.timing||(this.timing=a.timing),a.fromServiceWorker&&(this.fromServiceWorker=!0)}cached(){return!!this._memoryCached||!!this._maybeDiskCached&&!this._transferSize&&!this.fromServiceWorker}memoryCached(){return this._memoryCached}getSendReceiveTiming(){if(this.cached()||!this.timing)return{sendStartTime:this.startTime,headersEndTime:this.startTime};const e=1e3*this.timing.requestTime;return{sendStartTime:e+this.timing.sendStart,headersEndTime:e+this.timing.receiveHeadersEnd}}getStartTime(){return Math.min(this.startTime,!this.cached()&&this.timing&&1e3*this.timing.requestTime||1/0)}beginTime(){return Math.min(this.getStartTime(),!this.cached()&&this.timing&&1e3*this.timing.pushStart||1/0)}}export class InvalidationTrackingEvent{constructor(e){this.type=e.name,this.startTime=e.startTime,this._tracingEvent=e;const t=e.args.data;this.frame=t.frame,this.nodeId=t.nodeId,this.nodeName=t.nodeName,this.invalidationSet=t.invalidationSet,this.invalidatedSelectorId=t.invalidatedSelectorId,this.changedId=t.changedId,this.changedClass=t.changedClass,this.changedAttribute=t.changedAttribute,this.changedPseudo=t.changedPseudo,this.selectorPart=t.selectorPart,this.extraData=t.extraData,this.invalidationList=t.invalidationList,this.cause={reason:t.reason,stackTrace:t.stackTrace},!this.cause.reason&&this.cause.stackTrace&&this.type===RecordType.LayoutInvalidationTracking&&(this.cause.reason="Layout forced")}}export class InvalidationTracker{constructor(){this._lastRecalcStyle=null,this._lastPaintWithLayer=null,this._didPaint=!1,this._initializePerFrameState()}static invalidationEventsFor(e){return e[InvalidationTracker._invalidationTrackingEventsSymbol]||null}addInvalidation(e){if(this._startNewFrameIfNeeded(),!e.nodeId)return console.error("Invalidation lacks node information."),void console.error(e);const t=RecordType;if(e.type===t.StyleRecalcInvalidationTracking&&"StyleInvalidator"===e.cause.reason)return;if(e.type===t.ScheduleStyleInvalidationTracking||e.type===t.StyleInvalidatorInvalidationTracking||e.type===t.StyleRecalcInvalidationTracking){e.startTime&&this._lastRecalcStyle&&e.startTime>=this._lastRecalcStyle.startTime&&e.startTime<=this._lastRecalcStyle.endTime&&this._associateWithLastRecalcStyleEvent(e)}this._invalidations[e.type]?this._invalidations[e.type].push(e):this._invalidations[e.type]=[e],e.nodeId&&(this._invalidationsByNodeId[e.nodeId]?this._invalidationsByNodeId[e.nodeId].push(e):this._invalidationsByNodeId[e.nodeId]=[e])}didRecalcStyle(e){this._lastRecalcStyle=e;const t=[RecordType.ScheduleStyleInvalidationTracking,RecordType.StyleInvalidatorInvalidationTracking,RecordType.StyleRecalcInvalidationTracking];for(const e of this._invalidationsOfTypes(t))this._associateWithLastRecalcStyleEvent(e)}_associateWithLastRecalcStyleEvent(e){if(e.linkedRecalcStyleEvent)return;const t=RecordType,a=this._lastRecalcStyle.args.beginData.frame;e.type===t.StyleInvalidatorInvalidationTracking?this._addSyntheticStyleRecalcInvalidations(this._lastRecalcStyle,a,e):e.type===t.ScheduleStyleInvalidationTracking||this._addInvalidationToEvent(this._lastRecalcStyle,a,e),e.linkedRecalcStyleEvent=!0}_addSyntheticStyleRecalcInvalidations(e,t,a){if(a.invalidationList){if(!a.nodeId)return console.error("Invalidation lacks node information."),void console.error(a);for(let e=0;e<a.invalidationList.length;e++){const i=a.invalidationList[e].id;let r;const n=this._invalidationsByNodeId[a.nodeId]||[];for(let e=0;e<n.length;e++){const a=n[e];a.frame===t&&a.invalidationSet===i&&a.type===RecordType.ScheduleStyleInvalidationTracking&&(r=a)}r?this._addSyntheticStyleRecalcInvalidation(r._tracingEvent,a):console.error("Failed to lookup the event that scheduled a style invalidator invalidation.")}}else this._addSyntheticStyleRecalcInvalidation(a._tracingEvent,a)}_addSyntheticStyleRecalcInvalidation(e,t){const a=new InvalidationTrackingEvent(e);a.type=RecordType.StyleRecalcInvalidationTracking,t.cause.reason&&(a.cause.reason=t.cause.reason),t.selectorPart&&(a.selectorPart=t.selectorPart),this.addInvalidation(a),a.linkedRecalcStyleEvent||this._associateWithLastRecalcStyleEvent(a)}didLayout(e){const t=e.args.beginData.frame;for(const a of this._invalidationsOfTypes([RecordType.LayoutInvalidationTracking]))a.linkedLayoutEvent||(this._addInvalidationToEvent(e,t,a),a.linkedLayoutEvent=!0)}didPaint(e){this._didPaint=!0}_addInvalidationToEvent(e,t,a){t===a.frame&&(e[InvalidationTracker._invalidationTrackingEventsSymbol]?e[InvalidationTracker._invalidationTrackingEventsSymbol].push(a):e[InvalidationTracker._invalidationTrackingEventsSymbol]=[a])}_invalidationsOfTypes(e){const t=this._invalidations;return e||(e=Object.keys(t)),function*(){for(let a=0;a<e.length;++a){const i=t[e[a]]||[];for(let e=0;e<i.length;++e)yield i[e]}}()}_startNewFrameIfNeeded(){this._didPaint&&this._initializePerFrameState()}_initializePerFrameState(){this._invalidations={},this._invalidationsByNodeId={},this._lastRecalcStyle=null,this._lastPaintWithLayer=null,this._didPaint=!1}}InvalidationTracker._invalidationTrackingEventsSymbol=Symbol("invalidationTrackingEvents");export class TimelineAsyncEventTracker{constructor(){TimelineAsyncEventTracker._initialize(),this._initiatorByType=new Map;for(const e of TimelineAsyncEventTracker._asyncEvents.keys())this._initiatorByType.set(e,new Map)}static _initialize(){if(TimelineAsyncEventTracker._asyncEvents)return;const e=new Map;let t=RecordType;e.set(t.TimerInstall,{causes:[t.TimerFire],joinBy:"timerId"}),e.set(t.ResourceSendRequest,{causes:[t.ResourceMarkAsCached,t.ResourceReceiveResponse,t.ResourceReceivedData,t.ResourceFinish],joinBy:"requestId"}),e.set(t.RequestAnimationFrame,{causes:[t.FireAnimationFrame],joinBy:"id"}),e.set(t.RequestIdleCallback,{causes:[t.FireIdleCallback],joinBy:"id"}),e.set(t.WebSocketCreate,{causes:[t.WebSocketSendHandshakeRequest,t.WebSocketReceiveHandshakeResponse,t.WebSocketDestroy],joinBy:"identifier"}),TimelineAsyncEventTracker._asyncEvents=e,TimelineAsyncEventTracker._typeToInitiator=new Map;for(const a of e){const e=a[1].causes;for(t of e)TimelineAsyncEventTracker._typeToInitiator.set(t,a[0])}}processEvent(e){let t=TimelineAsyncEventTracker._typeToInitiator.get(e.name);const a=!t;t||(t=e.name);const i=TimelineAsyncEventTracker._asyncEvents.get(t);if(!i)return;const r=TimelineModelImpl.globalEventId(e,i.joinBy);if(!r)return;const n=this._initiatorByType.get(t);if(a)return void n.set(r,e);const s=n.get(r)||null,o=TimelineData.forEvent(e);o.setInitiator(s),!o.frameId&&s&&(o.frameId=TimelineModelImpl.eventFrameId(s))}}export class TimelineData{constructor(){this.warning=null,this.previewElement=null,this.url=null,this.backendNodeId=0,this.stackTrace=null,this.picture=null,this._initiator=null,this.frameId="",this.timeWaitingForMainThread}setInitiator(e){if(this._initiator=e,!e||this.url)return;const t=TimelineData.forEvent(e).url;t&&(this.url=t)}initiator(){return this._initiator}topFrame(){const e=this.stackTraceForSelfOrInitiator();return e&&e[0]||null}stackTraceForSelfOrInitiator(){return this.stackTrace||this._initiator&&TimelineData.forEvent(this._initiator).stackTrace}static forEvent(e){let t=e[TimelineData._symbol];return t||(t=new TimelineData,e[TimelineData._symbol]=t),t}}TimelineData._symbol=Symbol("timelineData");export let InvalidationCause;export let MetadataEvents;