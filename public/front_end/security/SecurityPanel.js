import*as Common from"../common/common.js";import*as Host from"../host/host.js";import*as Network from"../network/network.js";import*as SDK from"../sdk/sdk.js";import*as UI from"../ui/ui.js";import{Events,PageSecurityState,PageVisibleSecurityState,SecurityModel,SecurityStyleExplanation,SummaryMessages}from"./SecurityModel.js";export class SecurityPanel extends UI.Panel.PanelWithSidebar{constructor(){super("security"),this._mainView=new SecurityMainView(this);const e=createElementWithClass("span","title");e.textContent=Common.UIString.UIString("Overview"),this._sidebarMainViewElement=new SecurityPanelSidebarTreeElement(e,this._setVisibleView.bind(this,this._mainView),"security-main-view-sidebar-tree-item","lock-icon"),this._sidebarMainViewElement.tooltip=e.textContent,this._sidebarTree=new SecurityPanelSidebarTree(this._sidebarMainViewElement,this.showOrigin.bind(this)),this.panelSidebarElement().appendChild(this._sidebarTree.element),this._lastResponseReceivedForLoaderId=new Map,this._origins=new Map,this._filterRequestCounts=new Map,SDK.SDKModel.TargetManager.instance().observeModels(SecurityModel,this)}static _instance(){return self.runtime.sharedInstance(SecurityPanel)}static createCertificateViewerButtonForOrigin(e,t){const i=UI.UIUtils.createTextButton(e,async e=>{e.consume();const i=await self.SDK.multitargetNetworkManager.getCertificate(t);i.length>0&&Host.InspectorFrontendHost.InspectorFrontendHostInstance.showCertificateViewer(i)},"origin-button");return UI.ARIAUtils.markAsButton(i),i}static createCertificateViewerButtonForCert(e,t){const i=UI.UIUtils.createTextButton(e,e=>{e.consume(),Host.InspectorFrontendHost.InspectorFrontendHostInstance.showCertificateViewer(t)},"origin-button");return UI.ARIAUtils.markAsButton(i),i}static createHighlightedUrl(e,t){const i=e.indexOf("://");if(-1===i){const t=createElement("span","");return t.textContent=e,t}const r=createElement("span"),s=e.substr(0,i),n=e.substr(i+"://".length);return r.createChild("span","url-scheme-"+t).textContent=s,r.createChild("span","url-scheme-separator").textContent="://",r.createChild("span").textContent=n,r}_updateSecurityState(e,t,i){this._sidebarMainViewElement.setSecurityState(e),this._mainView.updateSecurityState(e,t,i)}_onSecurityStateChanged(e){const t=e.data,i=t.securityState,r=t.explanations,s=t.summary;this._updateSecurityState(i,r,s)}_updateVisibleSecurityState(e){this._sidebarMainViewElement.setSecurityState(e.securityState),this._mainView.updateVisibleSecurityState(e)}_onVisibleSecurityStateChanged(e){const t=e.data;this._updateVisibleSecurityState(t)}selectAndSwitchToMainView(){this._sidebarMainViewElement.select(!0)}showOrigin(e){const t=this._origins.get(e);t.originView||(t.originView=new SecurityOriginView(this,e,t)),this._setVisibleView(t.originView)}wasShown(){super.wasShown(),this._visibleView||this.selectAndSwitchToMainView()}focus(){this._sidebarTree.focus()}_setVisibleView(e){this._visibleView!==e&&(this._visibleView&&this._visibleView.detach(),this._visibleView=e,e&&this.splitWidget().setMainWidget(e))}_onResponseReceived(e){const t=e.data;t.resourceType()===Common.ResourceType.resourceTypes.Document&&this._lastResponseReceivedForLoaderId.set(t.loaderId,t)}_processRequest(e){const t=Common.ParsedURL.ParsedURL.extractOrigin(e.url());if(!t)return;let i=e.securityState();if(e.mixedContentType!==Protocol.Security.MixedContentType.Blockable&&e.mixedContentType!==Protocol.Security.MixedContentType.OptionallyBlockable||(i=Protocol.Security.SecurityState.Insecure),this._origins.has(t)){const r=this._origins.get(t),s=r.securityState;if(r.securityState=this._securityStateMin(s,i),s!==r.securityState){const s=e.securityDetails();s&&(r.securityDetails=s),this._sidebarTree.updateOrigin(t,i),r.originView&&r.originView.setSecurityState(i)}}else{const r={};r.securityState=i;const s=e.securityDetails();s&&(r.securityDetails=s),r.loadedFromCache=e.cached(),this._origins.set(t,r),this._sidebarTree.addOrigin(t,i)}}_onRequestFinished(e){const t=e.data;this._updateFilterRequestCounts(t),this._processRequest(t)}_updateFilterRequestCounts(e){if(e.mixedContentType===Protocol.Security.MixedContentType.None)return;let t=Network.NetworkLogView.MixedContentFilterValues.All;e.wasBlocked()?t=Network.NetworkLogView.MixedContentFilterValues.Blocked:e.mixedContentType===Protocol.Security.MixedContentType.Blockable?t=Network.NetworkLogView.MixedContentFilterValues.BlockOverridden:e.mixedContentType===Protocol.Security.MixedContentType.OptionallyBlockable&&(t=Network.NetworkLogView.MixedContentFilterValues.Displayed),this._filterRequestCounts.has(t)?this._filterRequestCounts.set(t,this._filterRequestCounts.get(t)+1):this._filterRequestCounts.set(t,1),this._mainView.refreshExplanations()}filterRequestCount(e){return this._filterRequestCounts.get(e)||0}_securityStateMin(e,t){return SecurityModel.SecurityStateComparator(e,t)<0?e:t}modelAdded(e){if(this._securityModel)return;this._securityModel=e;const t=e.resourceTreeModel(),i=e.networkManager();this._eventListeners=[e.addEventListener(Events.VisibleSecurityStateChanged,this._onVisibleSecurityStateChanged,this),t.addEventListener(SDK.ResourceTreeModel.Events.MainFrameNavigated,this._onMainFrameNavigated,this),t.addEventListener(SDK.ResourceTreeModel.Events.InterstitialShown,this._onInterstitialShown,this),t.addEventListener(SDK.ResourceTreeModel.Events.InterstitialHidden,this._onInterstitialHidden,this),i.addEventListener(SDK.NetworkManager.Events.ResponseReceived,this._onResponseReceived,this),i.addEventListener(SDK.NetworkManager.Events.RequestFinished,this._onRequestFinished,this)],t.isInterstitialShowing()&&this._onInterstitialShown()}modelRemoved(e){this._securityModel===e&&(delete this._securityModel,Common.EventTarget.EventTarget.removeEventListeners(this._eventListeners))}_onMainFrameNavigated(e){const t=e.data,i=this._lastResponseReceivedForLoaderId.get(t.loaderId);this.selectAndSwitchToMainView(),this._sidebarTree.clearOrigins(),this._origins.clear(),this._lastResponseReceivedForLoaderId.clear(),this._filterRequestCounts.clear(),this._mainView.refreshExplanations();const r=Common.ParsedURL.ParsedURL.extractOrigin(i?i.url():t.url);this._sidebarTree.setMainOrigin(r),i&&this._processRequest(i)}_onInterstitialShown(){this.selectAndSwitchToMainView(),this._sidebarTree.toggleOriginsList(!0)}_onInterstitialHidden(){this._sidebarTree.toggleOriginsList(!1)}}export class SecurityPanelSidebarTree extends UI.TreeOutline.TreeOutlineInShadow{constructor(e,t){super(),this.registerRequiredCSS("security/sidebar.css"),this.registerRequiredCSS("security/lockIcon.css"),this.appendChild(e),this._showOriginInPanel=t,this._mainOrigin=null,this._originGroups=new Map,this._originGroupTitles=new Map([[OriginGroup.MainOrigin,ls`Main origin`],[OriginGroup.NonSecure,ls`Non-secure origins`],[OriginGroup.Secure,ls`Secure origins`],[OriginGroup.Unknown,ls`Unknown / canceled`]]);for(const e in OriginGroup){const t=OriginGroup[e],i=this._createOriginGroupElement(this._originGroupTitles.get(t));this._originGroups.set(t,i),this.appendChild(i)}this._clearOriginGroups();const i=new UI.TreeOutline.TreeElement(Common.UIString.UIString("Reload to view details"));i.selectable=!1,i.listItemElement.classList.add("security-main-view-reload-message"),this._originGroups.get(OriginGroup.MainOrigin).appendChild(i),this._elementsByOrigin=new Map}_createOriginGroupElement(e){const t=new UI.TreeOutline.TreeElement(e,!0);return t.selectable=!1,t.setCollapsible(!1),t.expand(),t.listItemElement.classList.add("security-sidebar-origins"),UI.ARIAUtils.setAccessibleName(t.childrenListElement,e),t}toggleOriginsList(e){for(const t of this._originGroups.values())t.hidden=e}addOrigin(e,t){const i=new SecurityPanelSidebarTreeElement(SecurityPanel.createHighlightedUrl(e,t),this._showOriginInPanel.bind(this,e),"security-sidebar-tree-item","security-property");i.tooltip=e,this._elementsByOrigin.set(e,i),this.updateOrigin(e,t)}setMainOrigin(e){this._mainOrigin=e}updateOrigin(e,t){const i=this._elementsByOrigin.get(e);let r;if(i.setSecurityState(t),e===this._mainOrigin)r=this._originGroups.get(OriginGroup.MainOrigin),t===Protocol.Security.SecurityState.Secure?r.title=ls`Main origin (secure)`:r.title=ls`Main origin (non-secure)`,UI.ARIAUtils.setAccessibleName(r.childrenListElement,r.title);else switch(t){case Protocol.Security.SecurityState.Secure:r=this._originGroups.get(OriginGroup.Secure);break;case Protocol.Security.SecurityState.Unknown:r=this._originGroups.get(OriginGroup.Unknown);break;default:r=this._originGroups.get(OriginGroup.NonSecure)}const s=i.parent;s!==r&&(s&&(s.removeChild(i),0===s.childCount()&&(s.hidden=!0)),r.appendChild(i),r.hidden=!1)}_clearOriginGroups(){for(const e of this._originGroups.values())e.removeChildren(),e.hidden=!0;const e=this._originGroups.get(OriginGroup.MainOrigin);e.title=this._originGroupTitles.get(OriginGroup.MainOrigin),e.hidden=!1}clearOrigins(){this._clearOriginGroups(),this._elementsByOrigin.clear()}}export const OriginGroup={MainOrigin:Symbol("MainOrigin"),NonSecure:Symbol("NonSecure"),Secure:Symbol("Secure"),Unknown:Symbol("Unknown")};export class SecurityPanelSidebarTreeElement extends UI.TreeOutline.TreeElement{constructor(e,t,i,r){super("",!1),this._selectCallback=t,this._cssPrefix=r,this.listItemElement.classList.add(i),this._iconElement=this.listItemElement.createChild("div","icon"),this._iconElement.classList.add(this._cssPrefix),this.listItemElement.appendChild(e),this.setSecurityState(Protocol.Security.SecurityState.Unknown)}static SecurityStateComparator(e,t){return SecurityModel.SecurityStateComparator(e.securityState(),t.securityState())}setSecurityState(e){this._securityState&&this._iconElement.classList.remove(this._cssPrefix+"-"+this._securityState),this._securityState=e,this._iconElement.classList.add(this._cssPrefix+"-"+e)}securityState(){return this._securityState}onselect(){return this._selectCallback(),!0}}export class SecurityMainView extends UI.Widget.VBox{constructor(e){super(!0),this.registerRequiredCSS("security/mainView.css"),this.registerRequiredCSS("security/lockIcon.css"),this.setMinimumSize(200,100),this.contentElement.classList.add("security-main-view"),this._panel=e,this._summarySection=this.contentElement.createChild("div","security-summary"),this._securityExplanationsMain=this.contentElement.createChild("div","security-explanation-list security-explanations-main"),this._securityExplanationsExtra=this.contentElement.createChild("div","security-explanation-list security-explanations-extra");const t=this._summarySection.createChild("div","security-summary-section-title");t.textContent=ls`Security overview`,UI.ARIAUtils.markAsHeading(t,1);const i=this._summarySection.createChild("div","lock-spectrum");this._lockSpectrum=new Map([[Protocol.Security.SecurityState.Secure,i.createChild("div","lock-icon lock-icon-secure")],[Protocol.Security.SecurityState.Neutral,i.createChild("div","lock-icon lock-icon-neutral")],[Protocol.Security.SecurityState.Insecure,i.createChild("div","lock-icon lock-icon-insecure")]]),this._lockSpectrum.get(Protocol.Security.SecurityState.Secure).title=Common.UIString.UIString("Secure"),this._lockSpectrum.get(Protocol.Security.SecurityState.Neutral).title=Common.UIString.UIString("Info"),this._lockSpectrum.get(Protocol.Security.SecurityState.Insecure).title=Common.UIString.UIString("Not secure"),this._summarySection.createChild("div","triangle-pointer-container").createChild("div","triangle-pointer-wrapper").createChild("div","triangle-pointer"),this._summaryText=this._summarySection.createChild("div","security-summary-text"),UI.ARIAUtils.markAsHeading(this._summaryText,2)}_addExplanation(e,t){const i=e.createChild("div","security-explanation");i.classList.add("security-explanation-"+t.securityState),i.createChild("div","security-property").classList.add("security-property-"+t.securityState);const r=i.createChild("div","security-explanation-text"),s=r.createChild("div","security-explanation-title");if(t.title?(s.createChild("span").textContent=t.title+" - ",s.createChild("span","security-explanation-title-"+t.securityState).textContent=t.summary):s.textContent=t.summary,r.createChild("div").textContent=t.description,t.certificate.length&&r.appendChild(SecurityPanel.createCertificateViewerButtonForCert(Common.UIString.UIString("View certificate"),t.certificate)),t.recommendations&&t.recommendations.length){const e=r.createChild("ul","security-explanation-recommendations");for(const i of t.recommendations)e.createChild("li").textContent=i}return r}updateSecurityState(e,t,i){this._summarySection.classList.remove("security-summary-"+this._securityState),this._securityState=e,this._summarySection.classList.add("security-summary-"+this._securityState);const r={unknown:ls`The security of this page is unknown.`,insecure:ls`This page is not secure.`,neutral:ls`This page is not secure.`,secure:ls`This page is secure (valid HTTPS).`,"insecure-broken":ls`This page is not secure (broken HTTPS).`};this._securityState===Protocol.Security.SecurityState.Insecure?(this._lockSpectrum.get(Protocol.Security.SecurityState.Insecure).classList.add("lock-icon-insecure"),this._lockSpectrum.get(Protocol.Security.SecurityState.Insecure).classList.remove("lock-icon-insecure-broken"),this._lockSpectrum.get(Protocol.Security.SecurityState.Insecure).title=Common.UIString.UIString("Not secure")):this._securityState===Protocol.Security.SecurityState.InsecureBroken&&(this._lockSpectrum.get(Protocol.Security.SecurityState.Insecure).classList.add("lock-icon-insecure-broken"),this._lockSpectrum.get(Protocol.Security.SecurityState.Insecure).classList.remove("lock-icon-insecure"),this._lockSpectrum.get(Protocol.Security.SecurityState.Insecure).title=Common.UIString.UIString("Not secure (broken)")),this._summaryText.textContent=i||r[this._securityState],this._explanations=t,this.refreshExplanations()}updateVisibleSecurityState(e){this._summarySection.classList.remove("security-summary-"+this._securityState),this._securityState=e.securityState,this._summarySection.classList.add("security-summary-"+this._securityState),this._securityState===Protocol.Security.SecurityState.Insecure?(this._lockSpectrum.get(Protocol.Security.SecurityState.Insecure).classList.add("lock-icon-insecure"),this._lockSpectrum.get(Protocol.Security.SecurityState.Insecure).classList.remove("lock-icon-insecure-broken"),this._lockSpectrum.get(Protocol.Security.SecurityState.Insecure).title=ls`Not secure`):this._securityState===Protocol.Security.SecurityState.InsecureBroken&&(this._lockSpectrum.get(Protocol.Security.SecurityState.Insecure).classList.add("lock-icon-insecure-broken"),this._lockSpectrum.get(Protocol.Security.SecurityState.Insecure).classList.remove("lock-icon-insecure"),this._lockSpectrum.get(Protocol.Security.SecurityState.Insecure).title=ls`Not secure (broken)`);const{summary:t,explanations:i}=this._getSecuritySummaryAndExplanations(e);this._summaryText.textContent=t||SummaryMessages[this._securityState],this._explanations=this._orderExplanations(i),this.refreshExplanations()}_getSecuritySummaryAndExplanations(e){const{securityState:t,securityStateIssueIds:i}=e;let r;const s=[];if(r=this._explainSafetyTipSecurity(e,r,s),i.includes("malicious-content"))r=ls`This page is dangerous (flagged by Google Safe Browsing).`,s.unshift(new SecurityStyleExplanation(Protocol.Security.SecurityState.Insecure,void 0,ls`Flagged by Google Safe Browsing`,ls`To check this page's status, visit g.co/safebrowsingstatus.`));else{if(i.includes("is-error-page")&&(null===e.certificateSecurityState||null===e.certificateSecurityState.certificateNetworkError))return r=ls`This is an error page.`,{summary:r,explanations:s};t===Protocol.Security.SecurityState.InsecureBroken&&i.includes("scheme-is-not-cryptographic")&&(r=r||ls`This page is insecure (unencrypted HTTP).`,i.includes("insecure-input-events")&&s.push(new SecurityStyleExplanation(Protocol.Security.SecurityState.Insecure,void 0,ls`Form field edited on a non-secure page`,ls`Data was entered in a field on a non-secure page. A warning has been added to the URL bar.`)))}return i.includes("scheme-is-not-cryptographic")?(t!==Protocol.Security.SecurityState.Neutral||i.includes("insecure-origin")||(r=ls`This page has a non-HTTPS secure origin.`),{summary:r,explanations:s}):(this._explainCertificateSecurity(e,s),this._explainConnectionSecurity(e,s),this._explainContentSecurity(e,s),{summary:r,explanations:s})}_explainSafetyTipSecurity(e,t,i){const{securityStateIssueIds:r,safetyTipInfo:s}=e,n=[];return r.includes("bad_reputation")?n.push({summary:ls`This page is suspicious`,description:ls`Chrome has determined that this site could be fake or fraudulent.\n\nIf you believe this is shown in error please visit https://bugs.chromium.org/p/chromium/issues/entry?template=Safety+Tips+Appeals.`}):r.includes("lookalike")&&s.safeUrl&&n.push({summary:ls`Possible spoofing URL`,description:ls`This site's hostname looks similar to ${new URL(s.safeUrl).hostname}. Attackers sometimes mimic sites by making small, hard-to-see changes to the domain name.\n\nIf you believe this is shown in error please visit https://bugs.chromium.org/p/chromium/issues/entry?template=Safety+Tips+Appeals.`}),n.length>0&&(t=t||ls`This page is suspicious (flagged by Chrome).`,i.push(new SecurityStyleExplanation(Protocol.Security.SecurityState.Insecure,void 0,n[0].summary,n[0].description))),t}_explainCertificateSecurity(e,t){const{certificateSecurityState:i,securityStateIssueIds:r}=e,s=ls`Certificate`;if(i&&i.certificateHasSha1Signature){const e=ls`insecure (SHA-1)`,r=ls`The certificate chain for this site contains a certificate signed using SHA-1.`;i.certificateHasWeakSignature?t.push(new SecurityStyleExplanation(Protocol.Security.SecurityState.Insecure,s,e,r,i.certificate,Protocol.Security.MixedContentType.None)):t.push(new SecurityStyleExplanation(Protocol.Security.SecurityState.Neutral,s,e,r,i.certificate,Protocol.Security.MixedContentType.None))}i&&r.includes("cert-missing-subject-alt-name")&&t.push(new SecurityStyleExplanation(Protocol.Security.SecurityState.Insecure,s,ls`Subject Alternative Name missing`,ls`The certificate for this site does not contain a Subject Alternative Name extension containing a domain name or IP address.`,i.certificate,Protocol.Security.MixedContentType.None)),i&&null!==i.certificateNetworkError?t.push(new SecurityStyleExplanation(Protocol.Security.SecurityState.Insecure,s,ls`missing`,ls`This site is missing a valid, trusted certificate (${i.certificateNetworkError}).`,i.certificate,Protocol.Security.MixedContentType.None)):i&&!i.certificateHasSha1Signature&&t.push(new SecurityStyleExplanation(Protocol.Security.SecurityState.Secure,s,ls`valid and trusted`,ls`The connection to this site is using a valid, trusted server certificate issued by ${i.issuer}.`,i.certificate,Protocol.Security.MixedContentType.None)),r.includes("pkp-bypassed")&&t.push(new SecurityStyleExplanation(Protocol.Security.SecurityState.Info,s,ls`Public-Key-Pinning bypassed`,ls`Public-Key-Pinning was bypassed by a local root certificate.`)),i&&i.isCertificateExpiringSoon()&&t.push(new SecurityStyleExplanation(Protocol.Security.SecurityState.Info,void 0,ls`Certificate expires soon`,ls`The certificate for this site expires in less than 48 hours and needs to be renewed.`))}_explainConnectionSecurity(e,t){const i=e.certificateSecurityState;if(!i)return;const r=ls`Connection`;if(i.modernSSL)return void t.push(new SecurityStyleExplanation(Protocol.Security.SecurityState.Secure,r,ls`secure connection settings`,ls`The connection to this site is encrypted and authenticated using ${i.protocol}, ${i.getKeyExchangeName()}, and ${i.getCipherFullName()}.`));const s=[];i.obsoleteSslProtocol&&s.push(ls`${i.protocol} is obsolete. Enable TLS 1.2 or later.`),i.obsoleteSslKeyExchange&&s.push(ls`RSA key exchange is obsolete. Enable an ECDHE-based cipher suite.`),i.obsoleteSslCipher&&s.push(ls`${i.cipher} is obsolete. Enable an AES-GCM-based cipher suite.`),i.obsoleteSslSignature&&s.push(ls`The server signature uses SHA-1, which is obsolete. Enable a SHA-2 signature algorithm instead. (Note this is different from the signature in the certificate.)`),t.push(new SecurityStyleExplanation(Protocol.Security.SecurityState.Info,r,ls`obsolete connection settings`,ls`The connection to this site is encrypted and authenticated using ${i.protocol}, ${i.getKeyExchangeName()}, and ${i.getCipherFullName()}.`,void 0,void 0,s))}_explainContentSecurity(e,t){let i=!0;const r=ls`Resources`,s=e.securityStateIssueIds;s.includes("ran-mixed-content")&&(i=!1,t.push(new SecurityStyleExplanation(Protocol.Security.SecurityState.Insecure,r,ls`active mixed content`,ls`You have recently allowed non-secure content (such as scripts or iframes) to run on this site.`,[],Protocol.Security.MixedContentType.Blockable))),s.includes("displayed-mixed-content")&&(i=!1,t.push(new SecurityStyleExplanation(Protocol.Security.SecurityState.Neutral,r,ls`mixed content`,ls`This page includes HTTP resources.`,[],Protocol.Security.MixedContentType.OptionallyBlockable))),s.includes("contained-mixed-form")&&(i=!1,t.push(new SecurityStyleExplanation(Protocol.Security.SecurityState.Neutral,r,ls`non-secure form`,ls`This page includes a form with a non-secure "action" attribute.`))),null!==e.certificateSecurityState&&null!==e.certificateSecurityState.certificateNetworkError||(s.includes("ran-content-with-cert-error")&&(i=!1,t.push(new SecurityStyleExplanation(Protocol.Security.SecurityState.Insecure,r,ls`active content with certificate errors`,ls`You have recently allowed content loaded with certificate errors (such as scripts or iframes) to run on this site.`))),s.includes("displayed-content-with-cert-errors")&&(i=!1,t.push(new SecurityStyleExplanation(Protocol.Security.SecurityState.Neutral,r,ls`content with certificate errors`,ls`This page includes resources that were loaded with certificate errors.`)))),i&&(s.includes("scheme-is-not-cryptographic")||t.push(new SecurityStyleExplanation(Protocol.Security.SecurityState.Secure,r,ls`all served securely`,ls`All resources on this page are served securely.`)))}_orderExplanations(e){if(0===e.length)return e;const t=[Protocol.Security.SecurityState.Insecure,Protocol.Security.SecurityState.Neutral,Protocol.Security.SecurityState.Secure,Protocol.Security.SecurityState.Info],i=[];return t.forEach(t=>i.push(...e.filter(e=>e.securityState===t))),i}refreshExplanations(){this._securityExplanationsMain.removeChildren(),this._securityExplanationsExtra.removeChildren();for(const e of this._explanations)if(e.securityState===Protocol.Security.SecurityState.Info)this._addExplanation(this._securityExplanationsExtra,e);else switch(e.mixedContentType){case Protocol.Security.MixedContentType.Blockable:this._addMixedContentExplanation(this._securityExplanationsMain,e,Network.NetworkLogView.MixedContentFilterValues.BlockOverridden);break;case Protocol.Security.MixedContentType.OptionallyBlockable:this._addMixedContentExplanation(this._securityExplanationsMain,e,Network.NetworkLogView.MixedContentFilterValues.Displayed);break;default:this._addExplanation(this._securityExplanationsMain,e)}if(this._panel.filterRequestCount(Network.NetworkLogView.MixedContentFilterValues.Blocked)>0){const e={securityState:Protocol.Security.SecurityState.Info,summary:Common.UIString.UIString("Blocked mixed content"),description:Common.UIString.UIString("Your page requested non-secure resources that were blocked."),mixedContentType:Protocol.Security.MixedContentType.Blockable,certificate:[]};this._addMixedContentExplanation(this._securityExplanationsMain,e,Network.NetworkLogView.MixedContentFilterValues.Blocked)}}_addMixedContentExplanation(e,t,i){const r=this._addExplanation(e,t),s=this._panel.filterRequestCount(i);if(!s){return void(r.createChild("div","security-mixed-content").textContent=Common.UIString.UIString("Reload the page to record requests for HTTP resources."))}const n=r.createChild("div","security-mixed-content devtools-link");UI.ARIAUtils.markAsLink(n),n.tabIndex=0,n.textContent=1===s?Common.UIString.UIString("View %d request in Network Panel",s):Common.UIString.UIString("View %d requests in Network Panel",s),n.addEventListener("click",this.showNetworkFilter.bind(this,i)),n.addEventListener("keydown",e=>{isEnterKey(e)&&this.showNetworkFilter(i,e)})}showNetworkFilter(e,t){t.consume(),Network.NetworkPanel.NetworkPanel.revealAndFilter([{filterType:Network.NetworkLogView.FilterType.MixedContent,filterValue:e}])}}export class SecurityOriginView extends UI.Widget.VBox{constructor(e,t,i){super(),this._panel=e,this.setMinimumSize(200,100),this.element.classList.add("security-origin-view"),this.registerRequiredCSS("security/originView.css"),this.registerRequiredCSS("security/lockIcon.css");const r=this.element.createChild("div","title-section"),s=r.createChild("div","title-section-header");s.textContent=ls`Origin`,UI.ARIAUtils.markAsHeading(s,1);const n=r.createChild("div","origin-display");this._originLockIcon=n.createChild("span","security-property"),this._originLockIcon.classList.add("security-property-"+i.securityState),n.appendChild(SecurityPanel.createHighlightedUrl(t,i.securityState));const o=r.createChild("div","view-network-button").createChild("span","devtools-link origin-button");if(o.tabIndex=0,o.textContent=ls`View requests in Network Panel`,o.addEventListener("click",e=>{e.consume();const i=new Common.ParsedURL.ParsedURL(t);Network.NetworkPanel.NetworkPanel.revealAndFilter([{filterType:Network.NetworkLogView.FilterType.Domain,filterValue:i.host},{filterType:Network.NetworkLogView.FilterType.Scheme,filterValue:i.scheme}])}),UI.ARIAUtils.markAsLink(o),i.securityDetails){const e=this.element.createChild("div","origin-view-section"),r=e.createChild("div","origin-view-section-title");r.textContent=ls`Connection`,UI.ARIAUtils.markAsHeading(r,2);let s=new SecurityDetailsTable;e.appendChild(s.element()),s.addRow(Common.UIString.UIString("Protocol"),i.securityDetails.protocol),i.securityDetails.keyExchange&&s.addRow(Common.UIString.UIString("Key exchange"),i.securityDetails.keyExchange),i.securityDetails.keyExchangeGroup&&s.addRow(Common.UIString.UIString("Key exchange group"),i.securityDetails.keyExchangeGroup),s.addRow(Common.UIString.UIString("Cipher"),i.securityDetails.cipher+(i.securityDetails.mac?" with "+i.securityDetails.mac:""));const n=this.element.createChild("div","origin-view-section"),o=n.createChild("div","origin-view-section-title");o.textContent=ls`Certificate`,UI.ARIAUtils.markAsHeading(o,2);const a=i.securityDetails.signedCertificateTimestampList.length,c=i.securityDetails.certificateTransparencyCompliance;let l;if(a||c!==Protocol.Network.CertificateTransparencyCompliance.Unknown){l=this.element.createChild("div","origin-view-section");const e=l.createChild("div","origin-view-section-title");e.textContent=ls`Certificate Transparency`,UI.ARIAUtils.markAsHeading(e,2)}const u=this._createSanDiv(i.securityDetails.sanList),d=new Date(1e3*i.securityDetails.validFrom).toUTCString(),S=new Date(1e3*i.securityDetails.validTo).toUTCString();if(s=new SecurityDetailsTable,n.appendChild(s.element()),s.addRow(Common.UIString.UIString("Subject"),i.securityDetails.subjectName),s.addRow(Common.UIString.UIString("SAN"),u),s.addRow(Common.UIString.UIString("Valid from"),d),s.addRow(Common.UIString.UIString("Valid until"),S),s.addRow(Common.UIString.UIString("Issuer"),i.securityDetails.issuer),s.addRow("",SecurityPanel.createCertificateViewerButtonForOrigin(Common.UIString.UIString("Open full certificate details"),t)),!l)return;const h=new SecurityDetailsTable;h.element().classList.add("sct-summary"),l.appendChild(h.element());for(let e=0;e<a;e++){const t=i.securityDetails.signedCertificateTimestampList[e];h.addRow(Common.UIString.UIString("SCT"),t.logDescription+" ("+t.origin+", "+t.status+")")}const y=l.createChild("div","sct-details");y.classList.add("hidden");for(let e=0;e<a;e++){const t=new SecurityDetailsTable;y.appendChild(t.element());const r=i.securityDetails.signedCertificateTimestampList[e];t.addRow(Common.UIString.UIString("Log name"),r.logDescription),t.addRow(Common.UIString.UIString("Log ID"),r.logId.replace(/(.{2})/g,"$1 ")),t.addRow(Common.UIString.UIString("Validation status"),r.status),t.addRow(Common.UIString.UIString("Source"),r.origin),t.addRow(Common.UIString.UIString("Issued at"),new Date(r.timestamp).toUTCString()),t.addRow(Common.UIString.UIString("Hash algorithm"),r.hashAlgorithm),t.addRow(Common.UIString.UIString("Signature algorithm"),r.signatureAlgorithm),t.addRow(Common.UIString.UIString("Signature data"),r.signatureData.replace(/(.{2})/g,"$1 "))}if(a){const e=UI.UIUtils.createTextButton(ls`Show full details`,(function(){let t;const i=!y.classList.contains("hidden");t=i?ls`Show full details`:ls`Hide full details`,e.textContent=t,UI.ARIAUtils.setAccessibleName(e,t),UI.ARIAUtils.setExpanded(e,!i),h.element().classList.toggle("hidden"),y.classList.toggle("hidden")}),"details-toggle");l.appendChild(e)}switch(c){case Protocol.Network.CertificateTransparencyCompliance.Compliant:l.createChild("div","origin-view-section-notes").textContent=Common.UIString.UIString("This request complies with Chrome's Certificate Transparency policy.");break;case Protocol.Network.CertificateTransparencyCompliance.NotCompliant:l.createChild("div","origin-view-section-notes").textContent=Common.UIString.UIString("This request does not comply with Chrome's Certificate Transparency policy.");break;case Protocol.Network.CertificateTransparencyCompliance.Unknown:}const m=this.element.createChild("div","origin-view-section origin-view-notes");i.loadedFromCache&&(m.createChild("div").textContent=Common.UIString.UIString("This response was loaded from cache. Some security details might be missing.")),m.createChild("div").textContent=Common.UIString.UIString("The security details above are from the first inspected response.")}else if(i.securityState===Protocol.Security.SecurityState.Secure){const e=this.element.createChild("div","origin-view-section"),t=e.createChild("div","origin-view-section-title");t.textContent=ls`Secure`,UI.ARIAUtils.markAsHeading(t,2),e.createChild("div").textContent=ls`This origin is a non-HTTPS secure origin.`}else if(i.securityState!==Protocol.Security.SecurityState.Unknown){const e=this.element.createChild("div","origin-view-section"),t=e.createChild("div","origin-view-section-title");t.textContent=ls`Not secure`,UI.ARIAUtils.markAsHeading(t,2),e.createChild("div").textContent=Common.UIString.UIString("Your connection to this origin is not secure.")}else{const e=this.element.createChild("div","origin-view-section"),t=e.createChild("div","origin-view-section-title");t.textContent=ls`No security information`,UI.ARIAUtils.markAsHeading(t,2),e.createChild("div").textContent=Common.UIString.UIString("No security details are available for this origin.")}}_createSanDiv(e){const t=createElement("div");if(0===e.length)t.textContent=Common.UIString.UIString("(n/a)"),t.classList.add("empty-san");else{const r=2,s=e.length>r+1;for(let i=0;i<e.length;i++){const n=t.createChild("span","san-entry");n.textContent=e[i],s&&i>=r&&n.classList.add("truncated-entry")}if(s){function i(){const i=t.classList.contains("truncated-san");let s;i?(t.classList.remove("truncated-san"),s=ls`Show less`):(t.classList.add("truncated-san"),s=ls`Show more (${e.length} total)`),r.textContent=s,UI.ARIAUtils.setAccessibleName(r,s),UI.ARIAUtils.setExpanded(r,i)}const r=UI.UIUtils.createTextButton(ls`Show more (${e.length} total)`,i);t.appendChild(r),i()}}return t}setSecurityState(e){for(const e of Array.prototype.slice.call(this._originLockIcon.classList))e.startsWith("security-property-")&&this._originLockIcon.classList.remove(e);this._originLockIcon.classList.add("security-property-"+e)}}export class SecurityDetailsTable{constructor(){this._element=createElement("table"),this._element.classList.add("details-table")}element(){return this._element}addRow(e,t){const i=this._element.createChild("div","details-table-row");i.createChild("div").textContent=e;const r=i.createChild("div");"string"==typeof t?r.textContent=t:r.appendChild(t)}}export let OriginState;export let Origin;