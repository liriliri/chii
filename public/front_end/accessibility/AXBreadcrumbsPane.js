import*as Common from"../common/common.js";import*as SDK from"../sdk/sdk.js";import*as UI from"../ui/ui.js";import{AccessibilityNode}from"./AccessibilityModel.js";import{AccessibilitySidebarView}from"./AccessibilitySidebarView.js";import{AccessibilitySubPane}from"./AccessibilitySubPane.js";export class AXBreadcrumbsPane extends AccessibilitySubPane{constructor(e){super(ls`Accessibility Tree`),this.element.classList.add("ax-subpane"),UI.ARIAUtils.markAsTree(this.element),this.element.tabIndex=-1,this._axSidebarView=e,this._preselectedBreadcrumb=null,this._inspectedNodeBreadcrumb=null,this._collapsingBreadcrumbId=-1,this._hoveredBreadcrumb=null,this._rootElement=this.element.createChild("div","ax-breadcrumbs"),this._rootElement.addEventListener("keydown",this._onKeyDown.bind(this),!0),this._rootElement.addEventListener("mousemove",this._onMouseMove.bind(this),!1),this._rootElement.addEventListener("mouseleave",this._onMouseLeave.bind(this),!1),this._rootElement.addEventListener("click",this._onClick.bind(this),!1),this._rootElement.addEventListener("contextmenu",this._contextMenuEventFired.bind(this),!1),this._rootElement.addEventListener("focusout",this._onFocusOut.bind(this),!1),this.registerRequiredCSS("accessibility/axBreadcrumbs.css")}focus(){this._inspectedNodeBreadcrumb?this._inspectedNodeBreadcrumb.nodeElement().focus():this.element.focus()}setAXNode(e){const t=this.element.hasFocus();if(super.setAXNode(e),this._rootElement.removeChildren(),!e)return;const s=[];let r=e;for(;r;)s.push(r),r=r.parentNode();s.reverse();let d=0,i=null,n=null;for(r of s)i=new AXBreadcrumb(r,d,r===e),n?n.appendChild(i):this._rootElement.appendChild(i.element()),n=i,d++;function o(e,t,s){const r=new AXBreadcrumb(t,s,!1);e.appendChild(r);for(const e of t.children())o(r,e,s+1)}this._inspectedNodeBreadcrumb=i,this._inspectedNodeBreadcrumb.setPreselected(!0,t),this._setPreselectedBreadcrumb(this._inspectedNodeBreadcrumb);for(const t of e.children())o(this._inspectedNodeBreadcrumb,t,d),t.backendDOMNodeId()===this._collapsingBreadcrumbId&&this._setPreselectedBreadcrumb(this._inspectedNodeBreadcrumb.lastChild());this._collapsingBreadcrumbId=-1}willHide(){this._setPreselectedBreadcrumb(null)}_onKeyDown(e){if(!this._preselectedBreadcrumb)return;if(!e.composedPath().some(e=>e===this._preselectedBreadcrumb.element()))return;if(e.shiftKey||e.metaKey||e.ctrlKey)return;let t=!1;"ArrowUp"!==e.key||e.altKey?"ArrowDown"!==e.key||e.altKey?"ArrowLeft"!==e.key||e.altKey?(isEnterKey(e)||"ArrowRight"===e.key&&!e.altKey&&this._preselectedBreadcrumb.axNode().hasOnlyUnloadedChildren())&&(t=this._inspectDOMNode(this._preselectedBreadcrumb.axNode())):this._preselectedBreadcrumb.hasExpandedChildren()?this._collapseBreadcrumb(this._preselectedBreadcrumb):t=this._preselectParent():t=this._preselectNext():t=this._preselectPrevious(),t&&e.consume(!0)}_preselectPrevious(){const e=this._preselectedBreadcrumb.previousBreadcrumb();return!!e&&(this._setPreselectedBreadcrumb(e),!0)}_preselectNext(){const e=this._preselectedBreadcrumb.nextBreadcrumb();return!!e&&(this._setPreselectedBreadcrumb(e),!0)}_preselectParent(){const e=this._preselectedBreadcrumb.parentBreadcrumb();return!!e&&(this._setPreselectedBreadcrumb(e),!0)}_setPreselectedBreadcrumb(e){if(e===this._preselectedBreadcrumb)return;const t=this.element.hasFocus();this._preselectedBreadcrumb&&this._preselectedBreadcrumb.setPreselected(!1,t),this._preselectedBreadcrumb=e||this._inspectedNodeBreadcrumb,this._preselectedBreadcrumb.setPreselected(!0,t),!e&&t&&SDK.OverlayModel.OverlayModel.hideDOMNodeHighlight()}_collapseBreadcrumb(e){e.parentBreadcrumb()&&(this._collapsingBreadcrumbId=e.axNode().backendDOMNodeId(),this._inspectDOMNode(e.parentBreadcrumb().axNode()))}_onMouseLeave(e){this._setHoveredBreadcrumb(null)}_onMouseMove(e){const t=e.target.enclosingNodeOrSelfWithClass("ax-breadcrumb");if(!t)return void this._setHoveredBreadcrumb(null);const s=t.breadcrumb;s.isDOMNode()&&this._setHoveredBreadcrumb(s)}_onFocusOut(e){this._preselectedBreadcrumb&&e.target===this._preselectedBreadcrumb.nodeElement()&&this._setPreselectedBreadcrumb(null)}_onClick(e){const t=e.target.enclosingNodeOrSelfWithClass("ax-breadcrumb");if(!t)return void this._setHoveredBreadcrumb(null);const s=t.breadcrumb;if(s.inspected())return this._collapseBreadcrumb(s),void s.nodeElement().focus();s.isDOMNode()&&this._inspectDOMNode(s.axNode())}_setHoveredBreadcrumb(e){e!==this._hoveredBreadcrumb&&(this._hoveredBreadcrumb&&this._hoveredBreadcrumb.setHovered(!1),e?e.setHovered(!0):this.node()&&this.node().domModel().overlayModel().nodeHighlightRequested(this.node().id),this._hoveredBreadcrumb=e)}_inspectDOMNode(e){return!!e.isDOMNode()&&(e.deferredDOMNode().resolve(e=>{this._axSidebarView.setNode(e,!0),Common.Revealer.reveal(e,!0)}),!0)}_contextMenuEventFired(e){const t=e.target.enclosingNodeOrSelfWithClass("ax-breadcrumb");if(!t)return;const s=t.breadcrumb.axNode();if(!s.isDOMNode()||!s.deferredDOMNode())return;const r=new UI.ContextMenu.ContextMenu(e);r.viewSection().appendItem(ls`Scroll into view`,()=>{s.deferredDOMNode().resolvePromise().then(e=>{e&&e.scrollIntoView()})}),r.appendApplicableItems(s.deferredDOMNode()),r.show()}}export class AXBreadcrumb{constructor(e,t,s){this._axNode=e,this._element=createElementWithClass("div","ax-breadcrumb"),this._element.breadcrumb=this,this._nodeElement=createElementWithClass("div","ax-node"),UI.ARIAUtils.markAsTreeitem(this._nodeElement),this._nodeElement.tabIndex=-1,this._element.appendChild(this._nodeElement),this._nodeWrapper=createElementWithClass("div","wrapper"),this._nodeElement.appendChild(this._nodeWrapper),this._selectionElement=createElementWithClass("div","selection fill"),this._nodeElement.appendChild(this._selectionElement),this._childrenGroupElement=createElementWithClass("div","children"),UI.ARIAUtils.markAsGroup(this._childrenGroupElement),this._element.appendChild(this._childrenGroupElement),this._children=[],this._hovered=!1,this._preselected=!1,this._parent=null,this._inspected=s,this._nodeElement.classList.toggle("inspected",s),this._nodeElement.style.paddingLeft=16*t+4+"px",this._axNode.ignored()?this._appendIgnoredNodeElement():(this._appendRoleElement(this._axNode.role()),this._axNode.name()&&this._axNode.name().value&&(this._nodeWrapper.createChild("span","separator").textContent="Â ",this._appendNameElement(this._axNode.name().value))),this._axNode.hasOnlyUnloadedChildren()&&(this._nodeElement.classList.add("children-unloaded"),UI.ARIAUtils.setExpanded(this._nodeElement,!1)),this._axNode.isDOMNode()||this._nodeElement.classList.add("no-dom-node")}element(){return this._element}nodeElement(){return this._nodeElement}appendChild(e){this._children.push(e),e.setParent(this),this._nodeElement.classList.add("parent"),UI.ARIAUtils.setExpanded(this._nodeElement,!0),this._childrenGroupElement.appendChild(e.element())}hasExpandedChildren(){return this._children.length}setParent(e){this._parent=e}preselected(){return this._preselected}setPreselected(e,t){this._preselected!==e&&(this._preselected=e,this._nodeElement.classList.toggle("preselected",e),e?this._nodeElement.setAttribute("tabIndex",0):this._nodeElement.setAttribute("tabIndex",-1),this._preselected&&(t&&this._nodeElement.focus(),this._inspected?SDK.OverlayModel.OverlayModel.hideDOMNodeHighlight():this._axNode.highlightDOMNode()))}setHovered(e){this._hovered!==e&&(this._hovered=e,this._nodeElement.classList.toggle("hovered",e),this._hovered&&(this._nodeElement.classList.toggle("hovered",!0),this._axNode.highlightDOMNode()))}axNode(){return this._axNode}inspected(){return this._inspected}isDOMNode(){return this._axNode.isDOMNode()}nextBreadcrumb(){if(this._children.length)return this._children[0];const e=this.element().nextSibling;return e?e.breadcrumb:null}previousBreadcrumb(){const e=this.element().previousSibling;return e?e.breadcrumb:this._parent}parentBreadcrumb(){return this._parent}lastChild(){return this._children[this._children.length-1]}_appendNameElement(e){const t=createElement("span");t.textContent='"'+e+'"',t.classList.add("ax-readable-string"),this._nodeWrapper.appendChild(t)}_appendRoleElement(e){if(!e)return;const t=createElementWithClass("span","monospace");t.classList.add(RoleStyles[e.type]),t.setTextContentTruncatedIfNeeded(e.value||""),this._nodeWrapper.appendChild(t)}_appendIgnoredNodeElement(){const e=createElementWithClass("span","monospace");e.textContent=ls`Ignored`,e.classList.add("ax-breadcrumbs-ignored-node"),this._nodeWrapper.appendChild(e)}}export const RoleStyles={internalRole:"ax-internal-role",role:"ax-role"};