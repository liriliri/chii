import*as Common from"../common/common.js";import*as Coverage from"../coverage/coverage.js";import*as PerfUI from"../perf_ui/perf_ui.js";import*as Platform from"../platform/platform.js";import*as SDK from"../sdk/sdk.js";import*as TimelineModel from"../timeline_model/timeline_model.js";import*as UI from"../ui/ui.js";import{PerformanceModel}from"./PerformanceModel.js";import{EventDispatchTypeDescriptor,TimelineUIUtils}from"./TimelineUIUtils.js";export class TimelineEventOverview extends PerfUI.TimelineOverviewPane.TimelineOverviewBase{constructor(e,t){super(),this.element.id="timeline-overview-"+e,this.element.classList.add("overview-strip"),this._model=null,t&&(this.element.createChild("div","timeline-overview-strip-title").textContent=t)}setModel(e){this._model=e}_renderBar(e,t,i,o,n){const s=e,r=t-e,l=this.context();l.fillStyle=n,l.fillRect(s,i,r,o)}}export class TimelineEventOverviewInput extends TimelineEventOverview{constructor(){super("input",null)}update(){if(super.update(),!this._model)return;const e=this.height(),t=TimelineUIUtils.eventDispatchDesciptors(),i=new Map;let o=-1;for(const e of t){for(const t of e.eventTypes)i.set(t,e);o=Math.max(o,e.priority)}const n=2*window.devicePixelRatio,s=this._model.timelineModel().minimumRecordTime(),r=this._model.timelineModel().maximumRecordTime()-s,l=this.width(),a=l/r;for(let t=0;t<=o;++t)for(const o of this._model.timelineModel().tracks())for(let r=0;r<o.events.length;++r){const m=o.events[r];if(m.name!==TimelineModel.TimelineModel.RecordType.EventDispatch)continue;const h=i.get(m.args.data.type);if(!h||h.priority!==t)continue;const d=Platform.NumberUtilities.clamp(Math.floor((m.startTime-s)*a),0,l),c=Platform.NumberUtilities.clamp(Math.ceil((m.endTime-s)*a),0,l),u=Math.max(c-d,n);this._renderBar(d,d+u,0,e,h.color)}}}export class TimelineEventOverviewNetwork extends TimelineEventOverview{constructor(){super("network",Common.UIString.UIString("NET"))}update(){if(super.update(),!this._model)return;const e=this._model.timelineModel(),t=this.height()/2,i=e.minimumRecordTime(),o=e.maximumRecordTime()-i,n=this.width(),s=n/o,r=new Path2D,l=new Path2D,a=Protocol.Network.ResourcePriority,m=new Set([a.VeryHigh,a.High,a.Medium]);for(const o of e.networkRequests()){const e=m.has(o.priority)?r:l,a=Math.max(Math.floor((o.startTime-i)*s),0),h=Math.min(Math.ceil((o.endTime-i)*s+1),n);e.rect(a,0,h-a,t-1)}const h=this.context();h.save(),h.fillStyle="hsl(214, 60%, 60%)",h.fill(r),h.translate(0,t),h.fillStyle="hsl(214, 80%, 80%)",h.fill(l),h.restore()}}export class TimelineEventOverviewCPUActivity extends TimelineEventOverview{constructor(){super("cpu-activity",Common.UIString.UIString("CPU")),this._backgroundCanvas=this.element.createChild("canvas","fill background")}resetCanvas(){super.resetCanvas(),this._backgroundCanvas.width=this.element.clientWidth*window.devicePixelRatio,this._backgroundCanvas.height=this.element.clientHeight*window.devicePixelRatio}update(){if(super.update(),!this._model)return;const e=this._model.timelineModel(),t=4*window.devicePixelRatio,i=this.width(),o=this.height(),n=o,s=e.minimumRecordTime(),r=e.maximumRecordTime()-s,l=t/(i/r),a=TimelineUIUtils.categories(),m=TimelineUIUtils.getTimelineMainEventCategories(),h=m.indexOf("other");console.assert(0===m.indexOf("idle"));for(let e=1;e<m.length;++e)a[m[e]]._overviewIndex=e;const d=this._backgroundCanvas.getContext("2d");for(const t of e.tracks())t.type===TimelineModel.TimelineModel.TrackType.MainThread&&t.forMainFrame?c(this.context(),t.events):c(d,t.events);function c(e,d){const c=new Quantizer(s,l,(function(e){let i=n;for(let n=1;n<m.length;++n){const s=(e[n]||0)/l*o;i-=s,f[n].bezierCurveTo(u,p[n],u,i,u+t/2,i),p[n]=i}u+=t}));let u=0;const v=[],f=[],p=[];for(let e=0;e<m.length;++e)f[e]=new Path2D,f[e].moveTo(0,o),p[e]=o;TimelineModel.TimelineModel.TimelineModelImpl.forEachEvent(d,(function(e){const t=v.length?v.peekLast():0;c.appendInterval(e.startTime,t),v.push(TimelineUIUtils.eventStyle(e).category._overviewIndex||h)}),(function(e){c.appendInterval(e.endTime,v.pop())})),c.appendInterval(s+r+l,0);for(let t=m.length-1;t>0;--t)f[t].lineTo(i,o),e.fillStyle=a[m[t]].color,e.fill(f[t])}!function(e){const t=4*window.devicePixelRatio;e.save(),e.lineWidth=t/Math.sqrt(8);for(let n=.5;n<i+o;n+=t)e.moveTo(n,0),e.lineTo(n-o,o);e.globalCompositeOperation="destination-out",e.stroke(),e.restore()}(d)}}export class TimelineEventOverviewResponsiveness extends TimelineEventOverview{constructor(){super("responsiveness",null)}update(){if(super.update(),!this._model)return;const e=this.height(),t=this._model.timelineModel().minimumRecordTime(),i=this._model.timelineModel().maximumRecordTime()-t,o=this.width()/i,n=this._model.frames(),s=this.context(),r=new Path2D,l=new Path2D;for(let e=0;e<n.length;++e){const t=n[e];t.hasWarnings()&&a(t.startTime,t.duration)}for(const e of this._model.timelineModel().tracks()){const t=e.events;for(let e=0;e<t.length;++e)TimelineModel.TimelineModel.TimelineData.forEvent(t[e]).warning&&a(t[e].startTime,t[e].duration)}function a(i,n){const s=Math.round(o*(i-t)),a=Math.round(o*n);r.rect(s,0,a,e),l.moveTo(s+a,0),l.lineTo(s+a,e)}s.fillStyle="hsl(0, 80%, 90%)",s.strokeStyle="red",s.lineWidth=2*window.devicePixelRatio,s.fill(r),s.stroke(l)}}export class TimelineFilmStripOverview extends TimelineEventOverview{constructor(){super("filmstrip",null),this.reset()}update(){super.update();const e=this._model?this._model.filmStripModel().frames():[];if(!e.length)return;const t=Symbol("drawGeneration");this._drawGeneration=t,this._imageByFrame(e[0]).then(e=>{if(this._drawGeneration!==t)return;if(!e||!e.naturalWidth||!e.naturalHeight)return;const i=this.height()-2*TimelineFilmStripOverview.Padding,o=Math.ceil(i*e.naturalWidth/e.naturalHeight),n=Math.min(200/e.naturalWidth,1);this._emptyImage=new Image(e.naturalWidth*n,e.naturalHeight*n),this._drawFrames(o,i)})}_imageByFrame(e){let t=this._frameToImagePromise.get(e);return t||(t=e.imageDataPromise().then(e=>UI.UIUtils.loadImageFromData(e)),this._frameToImagePromise.set(e,t)),t}_drawFrames(e,t){if(!e||!this._model)return;const i=this._model.filmStripModel();if(!i.frames().length)return;const o=TimelineFilmStripOverview.Padding,n=this.width(),s=i.zeroTime(),r=i.spanTime()/n,l=this.context(),a=this._drawGeneration;l.beginPath();for(let a=o;a<n;a+=e+2*o){const o=s+(a+e/2)*r,n=i.frameByTimestamp(o);n&&(l.rect(a-.5,.5,e+1,t+1),this._imageByFrame(n).then(m.bind(this,a)))}function m(i,o){this._drawGeneration===a&&o&&l.drawImage(o,i,1,e,t)}l.strokeStyle="#ddd",l.stroke()}overviewInfoPromise(e){if(!this._model||!this._model.filmStripModel().frames().length)return Promise.resolve(null);const t=this.calculator().positionToTime(e),i=this._model.filmStripModel().frameByTimestamp(t);if(i===this._lastFrame)return Promise.resolve(this._lastElement);return(i?this._imageByFrame(i):Promise.resolve(this._emptyImage)).then(function(e){const t=createElementWithClass("div","frame");e&&t.createChild("div","thumbnail").appendChild(e);return this._lastFrame=i,this._lastElement=t,t}.bind(this))}reset(){this._lastFrame=void 0,this._lastElement=null,this._frameToImagePromise=new Map,this._imageWidth=0}}TimelineFilmStripOverview.Padding=2;export class TimelineEventOverviewFrames extends TimelineEventOverview{constructor(){super("framerate",Common.UIString.UIString("FPS"))}update(){if(super.update(),!this._model)return;const e=this._model.frames();if(!e.length)return;const t=this.height(),i=1*window.devicePixelRatio,o=t-2*i,n=this._model.timelineModel().minimumRecordTime(),s=this._model.timelineModel().maximumRecordTime()-n,r=this.width()/s,l=t-i,a=this.context(),m=l+10*window.devicePixelRatio;let h=0,d=m;const c=window.devicePixelRatio,u=1&c?.5:0,v=1.5*window.devicePixelRatio;a.beginPath(),a.moveTo(0,d);for(let t=0;t<e.length;++t){const i=e[t];h=Math.round((i.startTime-n)*r)+u,a.lineTo(h,d),a.lineTo(h,d+v),d=i.idle?m:Math.round(l-o*Math.min(1e3/60/i.duration,1))-u,a.lineTo(h,d+v),a.lineTo(h,d)}const f=e.peekLast();h=Math.round((f.startTime+f.duration-n)*r)+u,a.lineTo(h,d),a.lineTo(h,m),a.fillStyle="hsl(110, 50%, 88%)",a.strokeStyle="hsl(110, 50%, 60%)",a.lineWidth=c,a.fill(),a.stroke()}}export class TimelineEventOverviewMemory extends TimelineEventOverview{constructor(){super("memory",Common.UIString.UIString("HEAP")),this._heapSizeLabel=this.element.createChild("div","memory-graph-label")}resetHeapSizeLabels(){this._heapSizeLabel.textContent=""}update(){super.update();const e=window.devicePixelRatio;if(!this._model)return void this.resetHeapSizeLabels();const t=this._model.timelineModel().tracks().filter(e=>e.type===TimelineModel.TimelineModel.TrackType.MainThread&&e.forMainFrame).map(e=>e.events),i=3*e;let o=0,n=1e11;const s=this._model.timelineModel().minimumRecordTime(),r=this._model.timelineModel().maximumRecordTime();function l(e){return e.name===TimelineModel.TimelineModel.RecordType.UpdateCounters}for(let e=0;e<t.length;e++)t[e]=t[e].filter(l);function a(e){const t=e.args.data;t&&t.jsHeapSizeUsed&&(o=Math.max(o,t.jsHeapSizeUsed),n=Math.min(n,t.jsHeapSizeUsed))}for(let e=0;e<t.length;e++)t[e].forEach(a);n=Math.min(n,o);const m=this.width(),h=this.height()-i,d=m/(r-s),c=(h-1)/Math.max(o-n,1),u=new Array(m);function v(e){const t=e.args.data;if(!t||!t.jsHeapSizeUsed)return;const i=Math.round((e.startTime-s)*d),o=Math.round((t.jsHeapSizeUsed-n)*c);u[i]=Math.max(u[i]||0,o)}for(let e=0;e<t.length;e++)t[e].forEach(v);const f=this.context(),p=h+i+1;f.translate(.5,.5),f.beginPath(),f.moveTo(-1,p);let T=0,g=!0,_=0;for(let e=0;e<u.length;e++){if(void 0===u[e])continue;g&&(g=!1,T=u[e],f.lineTo(-1,h-T));const t=u[e];Math.abs(t-T)>2&&Math.abs(e-_)>1&&f.lineTo(e,h-T),T=t,f.lineTo(e,h-T),_=e}f.lineTo(m+1,h-T),f.lineTo(m+1,p),f.closePath(),f.fillStyle="hsla(220, 90%, 70%, 0.2)",f.fill(),f.lineWidth=1,f.strokeStyle="hsl(220, 90%, 70%)",f.stroke(),this._heapSizeLabel.textContent=Common.UIString.UIString("%s â€“ %s",Number.bytesToString(n),Number.bytesToString(o))}}export class Quantizer{constructor(e,t,i){this._lastTime=e,this._quantDuration=t,this._callback=i,this._counters=[],this._remainder=t}appendInterval(e,t){let i=e-this._lastTime;if(i<=this._remainder)return this._counters[t]=(this._counters[t]||0)+i,this._remainder-=i,void(this._lastTime=e);for(this._counters[t]=(this._counters[t]||0)+this._remainder,this._callback(this._counters),i-=this._remainder;i>=this._quantDuration;){const e=[];e[t]=this._quantDuration,this._callback(e),i-=this._quantDuration}this._counters=[],this._counters[t]=i,this._lastTime=e,this._remainder=this._quantDuration-i}}export class TimelineEventOverviewCoverage extends TimelineEventOverview{constructor(){super("coverage",Common.UIString.UIString("COVERAGE")),this._heapSizeLabel=this.element.createChild("div","timeline-overview-coverage-label")}resetHeapSizeLabels(){this._heapSizeLabel.textContent=""}setModel(e){super.setModel(e),this._model&&(this._coverageModel=e.mainTarget().model(Coverage.CoverageModel.CoverageModel))}update(){super.update();const e=window.devicePixelRatio;if(!this._coverageModel)return;let t=0,i=0;const o=new Map,n=new Map;for(const e of this._coverageModel.entries())for(const s of e.entries()){t+=s.size();for(const[e,t]of s.usedByTimestamp())i+=t,n.has(e)||n.set(e,new Set),n.get(e).add(s),o.has(e)?o.set(e,o.get(e)+t):o.set(e,t)}const s=new Set,r=new Map;let l=0,a=0;const m=Array.from(n.entries()).sort((e,t)=>e[0]-t[0]);for(const[e,t]of m){for(const e of t.values())s.has(e)||(s.add(e),l+=e.size());a+=o.get(e),r.set(e,a/l)}const h=t?Math.round(100*i/t):0,d=3*e,c=this._model.timelineModel().minimumRecordTime()/1e3,u=this._model.timelineModel().maximumRecordTime()/1e3,v=this.width(),f=this.height()-d,p=v/(u-c),T=f-1;let g=0;const _=this.context(),w=f+d+1;_.translate(.5,.5),_.beginPath(),_.moveTo(-1,w),_.lineTo(-1,f-g);let M=null;for(const e of this._coverageModel.coverageUpdateTimes()){const t=r.get(e)||M;if(M=t,!t)continue;if(e>u)break;const i=(e-c)*p;g=t*T,_.lineTo(i,f-g)}const x="hsl(220, 90%, 70%)";_.lineTo(v+1,f-g),_.lineTo(v+1,w),_.closePath(),_.fillStyle="hsla(220, 90%, 70%, 0.2)",_.fill(),_.lineWidth=1,_.strokeStyle=x,_.stroke(),M=null;for(const e of this._coverageModel.coverageUpdateTimes()){const t=r.get(e)||M;if(M=t,!t)continue;_.beginPath();const i=(e-c)*p,o=f-t*T;_.arc(i,o,2,0,2*Math.PI,!1),_.closePath(),_.stroke(),_.fillStyle=r.has(e)?x:"hsl(0, 100%, 100%)",_.fill()}this._heapSizeLabel.textContent=h+"% used"}}