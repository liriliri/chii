import*as Bindings from"../bindings/bindings.js";import*as Common from"../common/common.js";import*as Components from"../components/components.js";import*as DataGrid from"../data_grid/data_grid.js";import*as Host from"../host/host.js";import*as PerfUI from"../perf_ui/perf_ui.js";import*as SDK from"../sdk/sdk.js";import*as UI from"../ui/ui.js";import{BottomUpProfileDataGridTree}from"./BottomUpProfileDataGrid.js";import{CPUProfileFlameChart,ProfileFlameChartDataProvider}from"./CPUProfileFlameChart.js";import{Formatter,ProfileDataGridNode,ProfileDataGridTree}from"./ProfileDataGrid.js";import{DataDisplayDelegate,Events,ProfileHeader,ProfileType}from"./ProfileHeader.js";import{ProfileSidebarTreeElement}from"./ProfileSidebarTreeElement.js";import{TopDownProfileDataGridTree}from"./TopDownProfileDataGrid.js";export class ProfileView extends UI.View.SimpleView{constructor(){super(Common.UIString.UIString("Profile")),this._profile=null,this._searchableView=new UI.SearchableView.SearchableView(this),this._searchableView.setPlaceholder(Common.UIString.UIString("Find by cost (>50ms), name or file")),this._searchableView.show(this.element);const e=[];e.push({id:"self",title:this.columnHeader("self"),width:"120px",fixedWidth:!0,sortable:!0,sort:DataGrid.DataGrid.Order.Descending}),e.push({id:"total",title:this.columnHeader("total"),width:"120px",fixedWidth:!0,sortable:!0}),e.push({id:"function",title:Common.UIString.UIString("Function"),disclosure:!0,sortable:!0}),this.dataGrid=new DataGrid.DataGrid.DataGridImpl({displayName:ls`Profiler`,columns:e}),this.dataGrid.addEventListener(DataGrid.DataGrid.Events.SortingChanged,this._sortProfile,this),this.dataGrid.addEventListener(DataGrid.DataGrid.Events.SelectedNode,this._nodeSelected.bind(this,!0)),this.dataGrid.addEventListener(DataGrid.DataGrid.Events.DeselectedNode,this._nodeSelected.bind(this,!1)),this.dataGrid.setRowContextMenuCallback(this._populateContextMenu.bind(this)),this.viewSelectComboBox=new UI.Toolbar.ToolbarComboBox(this._changeView.bind(this),ls`Profile view mode`),this.focusButton=new UI.Toolbar.ToolbarButton(Common.UIString.UIString("Focus selected function"),"largeicon-visibility"),this.focusButton.setEnabled(!1),this.focusButton.addEventListener(UI.Toolbar.ToolbarButton.Events.Click,this._focusClicked,this),this.excludeButton=new UI.Toolbar.ToolbarButton(Common.UIString.UIString("Exclude selected function"),"largeicon-delete"),this.excludeButton.setEnabled(!1),this.excludeButton.addEventListener(UI.Toolbar.ToolbarButton.Events.Click,this._excludeClicked,this),this.resetButton=new UI.Toolbar.ToolbarButton(Common.UIString.UIString("Restore all functions"),"largeicon-refresh"),this.resetButton.setEnabled(!1),this.resetButton.addEventListener(UI.Toolbar.ToolbarButton.Events.Click,this._resetClicked,this),this._linkifier=new Components.Linkifier.Linkifier(maxLinkLength)}static buildPopoverTable(e){const t=createElement("table");for(const i of e){const e=t.createChild("tr");e.createChild("td").textContent=i.title,e.createChild("td").textContent=i.value}return t}setProfile(e){this._profile=e,this._bottomUpProfileDataGridTree=null,this._topDownProfileDataGridTree=null,this._changeView(),this.refresh()}profile(){return this._profile}initialize(e,t){this._nodeFormatter=e,this._viewType=Common.Settings.Settings.instance().createSetting("profileView",ViewTypes.Heavy),t=t||[ViewTypes.Flame,ViewTypes.Heavy,ViewTypes.Tree];const i=new Map([[ViewTypes.Flame,ls`Chart`],[ViewTypes.Heavy,ls`Heavy (Bottom Up)`],[ViewTypes.Tree,ls`Tree (Top Down)`],[ViewTypes.Text,ls`Text (Top Down)`]]),r=new Map(t.map(e=>[e,this.viewSelectComboBox.createOption(i.get(e),e)])),s=this._viewType.get()||t[0],o=r.get(s)||r.get(t[0]);this.viewSelectComboBox.select(o),this._changeView(),this._flameChart&&this._flameChart.update()}focus(){this._flameChart?this._flameChart.focus():super.focus()}columnHeader(e){throw"Not implemented"}selectRange(e,t){this._flameChart&&this._flameChart.selectRange(e,t)}async toolbarItems(){return[this.viewSelectComboBox,this.focusButton,this.excludeButton,this.resetButton]}_getBottomUpProfileDataGridTree(){return this._bottomUpProfileDataGridTree||(this._bottomUpProfileDataGridTree=new BottomUpProfileDataGridTree(this._nodeFormatter,this._searchableView,this._profile.root,this.adjustedTotal)),this._bottomUpProfileDataGridTree}_getTopDownProfileDataGridTree(){return this._topDownProfileDataGridTree||(this._topDownProfileDataGridTree=new TopDownProfileDataGridTree(this._nodeFormatter,this._searchableView,this._profile.root,this.adjustedTotal)),this._topDownProfileDataGridTree}_populateContextMenu(e,t){const i=t;i.linkElement&&!e.containsTarget(i.linkElement)&&e.appendApplicableItems(i.linkElement)}willHide(){this._currentSearchResultIndex=-1}refresh(){if(!this.profileDataGridTree)return;const e=this.dataGrid.selectedNode?this.dataGrid.selectedNode.profileNode:null;this.dataGrid.rootNode().removeChildren();const t=this.profileDataGridTree.children,i=t.length;for(let e=0;e<i;++e)this.dataGrid.rootNode().appendChild(t[e]);e&&(e.selected=!0)}refreshVisibleData(){let e=this.dataGrid.rootNode().children[0];for(;e;)e.refresh(),e=e.traverseNextNode(!1,null,!0)}searchableView(){return this._searchableView}supportsCaseSensitiveSearch(){return!0}supportsRegexSearch(){return!1}searchCanceled(){this._searchableElement.searchCanceled()}performSearch(e,t,i){this._searchableElement.performSearch(e,t,i)}jumpToNextSearchResult(){this._searchableElement.jumpToNextSearchResult()}jumpToPreviousSearchResult(){this._searchableElement.jumpToPreviousSearchResult()}linkifier(){return this._linkifier}_ensureTextViewCreated(){this._textView||(this._textView=new UI.View.SimpleView(ls`Call tree`),this._textView.registerRequiredCSS("profiler/profilesPanel.css"),this.populateTextView(this._textView))}populateTextView(e){}createFlameChartDataProvider(){throw"Not implemented"}_ensureFlameChartCreated(){this._flameChart||(this._dataProvider=this.createFlameChartDataProvider(),this._flameChart=new CPUProfileFlameChart(this._searchableView,this._dataProvider),this._flameChart.addEventListener(PerfUI.FlameChart.Events.EntryInvoked,e=>{this._onEntryInvoked(e)}))}async _onEntryInvoked(e){const t=e.data,i=this._dataProvider._entryNodes[t],r=this._profileHeader._debuggerModel;if(!i||!i.scriptId||!r)return;const s=r.scriptForId(i.scriptId);if(!s)return;const o=r.createRawLocation(s,i.lineNumber,i.columnNumber),a=await Bindings.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance().rawLocationToUILocation(o);Common.Revealer.reveal(a)}_changeView(){if(!this._profile)return;switch(this._searchableView.closeSearch(),this._visibleView&&this._visibleView.detach(),this._viewType.set(this.viewSelectComboBox.selectedOption().value),this._viewType.get()){case ViewTypes.Flame:this._ensureFlameChartCreated(),this._visibleView=this._flameChart,this._searchableElement=this._flameChart;break;case ViewTypes.Tree:this.profileDataGridTree=this._getTopDownProfileDataGridTree(),this._sortProfile(),this._visibleView=this.dataGrid.asWidget(),this._searchableElement=this.profileDataGridTree;break;case ViewTypes.Heavy:this.profileDataGridTree=this._getBottomUpProfileDataGridTree(),this._sortProfile(),this._visibleView=this.dataGrid.asWidget(),this._searchableElement=this.profileDataGridTree;break;case ViewTypes.Text:this._ensureTextViewCreated(),this._visibleView=this._textView,this._searchableElement=this._textView}const e=this._viewType.get()===ViewTypes.Flame;this.focusButton.setVisible(!e),this.excludeButton.setVisible(!e),this.resetButton.setVisible(!e),this._visibleView.show(this._searchableView.element)}_nodeSelected(e){this.focusButton.setEnabled(e),this.excludeButton.setEnabled(e)}_focusClicked(e){this.dataGrid.selectedNode&&(this.resetButton.setEnabled(!0),this.resetButton.element.focus(),this.profileDataGridTree.focus(this.dataGrid.selectedNode),this.refresh(),this.refreshVisibleData(),Host.userMetrics.actionTaken(Host.UserMetrics.Action.CpuProfileNodeFocused))}_excludeClicked(e){const t=this.dataGrid.selectedNode;t&&(this.resetButton.setEnabled(!0),this.resetButton.element.focus(),t.deselect(),this.profileDataGridTree.exclude(t),this.refresh(),this.refreshVisibleData(),Host.userMetrics.actionTaken(Host.UserMetrics.Action.CpuProfileNodeExcluded))}_resetClicked(e){this.viewSelectComboBox.selectElement().focus(),this.resetButton.setEnabled(!1),this.profileDataGridTree.restore(),this._linkifier.reset(),this.refresh(),this.refreshVisibleData()}_sortProfile(){const e=this.dataGrid.isSortOrderAscending(),t=this.dataGrid.sortColumnId(),i="function"===t?"functionName":t||"";this.profileDataGridTree.sort(ProfileDataGridTree.propertyComparator(i,e)),this.refresh()}}export const maxLinkLength=30;export const ViewTypes={Flame:"Flame",Tree:"Tree",Heavy:"Heavy",Text:"Text"};export class WritableProfileHeader extends ProfileHeader{constructor(e,t,i){super(t,i||Common.UIString.UIString("Profile %d",t.nextProfileUid())),this._debuggerModel=e,this._tempFile=null}_onChunkTransferred(e){this.updateStatus(Common.UIString.UIString("Loading… %d%%",Number.bytesToString(this._jsonifiedProfile.length)))}_onError(e){this.updateStatus(Common.UIString.UIString("File '%s' read error: %s",e.fileName(),e.error().message))}async write(e){this._jsonifiedProfile+=e}close(){}dispose(){this.removeTempFile()}createSidebarTreeElement(e){return new ProfileSidebarTreeElement(e,this,"profile-sidebar-tree-item")}canSaveToFile(){return!this.fromFile()&&this._protocolProfile}async saveToFile(){const e=new Bindings.FileUtils.FileOutputStream;this._fileName=this._fileName||`${this.profileType().typeName()}-${(new Date).toISO8601Compact()}${this.profileType().fileExtension()}`;if(!await e.open(this._fileName)||!this._tempFile)return;const t=await this._tempFile.read();t&&await e.write(t),e.close()}async loadFromFile(e){this.updateStatus(Common.UIString.UIString("Loading…"),!0);const t=new Bindings.FileUtils.ChunkedFileReader(e,1e7,this._onChunkTransferred.bind(this));this._jsonifiedProfile="";if(!await t.read(this))return this._onError(t),new Error(Common.UIString.UIString("Failed to read file"));this.updateStatus(Common.UIString.UIString("Parsing…"),!0);let i=null;try{this._profile=JSON.parse(this._jsonifiedProfile),this.setProfile(this._profile),this.updateStatus(Common.UIString.UIString("Loaded"),!1)}catch(e){i=e,this.profileType().removeProfile(this)}return this._jsonifiedProfile=null,this.profileType().profileBeingRecorded()===this&&this.profileType().setProfileBeingRecorded(null),i}setProtocolProfile(e){this.setProfile(e),this._protocolProfile=e,this._tempFile=new Bindings.TempFile.TempFile,this._tempFile.write([JSON.stringify(e)]),this.canSaveToFile()&&this.dispatchEventToListeners(Events.ProfileReceived)}}