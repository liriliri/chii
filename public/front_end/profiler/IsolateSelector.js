import*as Common from"../common/common.js";import*as SDK from"../sdk/sdk.js";import*as UI from"../ui/ui.js";export class IsolateSelector extends UI.Widget.VBox{constructor(){super(!1),this._items=new UI.ListModel.ListModel,this._list=new UI.ListControl.ListControl(this._items,this,UI.ListControl.ListMode.NonViewport),this._list.element.tabIndex=0,this._list.element.classList.add("javascript-vm-instances-list"),UI.ARIAUtils.setAccessibleName(this._list.element,ls`JavaScript VM instances`),this.contentElement.appendChild(this._list.element),this._itemByIsolate=new Map,this._totalElement=createElementWithClass("div","profile-memory-usage-item hbox"),this._totalValueDiv=this._totalElement.createChild("div","profile-memory-usage-item-size"),this._totalTrendDiv=this._totalElement.createChild("div","profile-memory-usage-item-trend"),this._totalElement.createChild("div").textContent=ls`Total JS heap size`;const e=Math.round(SDK.IsolateManager.MemoryTrendWindowMs/6e4);this._totalTrendDiv.title=ls`Total page JS heap size change trend over the last ${e} minutes.`,this._totalValueDiv.title=ls`Total page JS heap size across all VM instances.`,self.SDK.isolateManager.observeIsolates(this),SDK.SDKModel.TargetManager.instance().addEventListener(SDK.SDKModel.Events.NameChanged,this._targetChanged,this),SDK.SDKModel.TargetManager.instance().addEventListener(SDK.SDKModel.Events.InspectedURLChanged,this._targetChanged,this)}wasShown(){self.SDK.isolateManager.addEventListener(SDK.IsolateManager.Events.MemoryChanged,this._heapStatsChanged,this)}willHide(){self.SDK.isolateManager.removeEventListener(SDK.IsolateManager.Events.MemoryChanged,this._heapStatsChanged,this)}isolateAdded(e){const t=new ListItem(e),s=t.model().target()===SDK.SDKModel.TargetManager.instance().mainTarget()?0:this._items.length;this._items.insert(s,t),this._itemByIsolate.set(e,t),(1===this._items.length||e.isMainThread())&&this._list.selectItem(t),this._update()}isolateChanged(e){this._itemByIsolate.get(e).updateTitle(),this._update()}isolateRemoved(e){const t=this._itemByIsolate.get(e);this._items.remove(this._items.indexOf(t)),this._itemByIsolate.delete(e),this._update()}_targetChanged(e){const t=e.data.model(SDK.RuntimeModel.RuntimeModel);if(!t)return;const s=self.SDK.isolateManager.isolateByModel(t),i=s&&this._itemByIsolate.get(s);i&&i.updateTitle()}_heapStatsChanged(e){const t=e.data,s=this._itemByIsolate.get(t);s&&s.updateStats(),this._updateTotal()}_updateTotal(){let e=0,t=0;for(const s of self.SDK.isolateManager.isolates())e+=s.usedHeapSize(),t+=s.usedHeapSizeGrowRate();this._totalValueDiv.textContent=Number.bytesToString(e),IsolateSelector._formatTrendElement(t,this._totalTrendDiv)}static _formatTrendElement(e,t){const s=1e3*e;if(Math.abs(s)<1024)return;const i=Number.bytesToString(Math.abs(s));let a,l;s>0?(a=ls`\u2B06${i}/s`,t.classList.toggle("increasing",!0),l=ls`increasing by ${i} per second`):(a=ls`\u2B07${i}/s`,t.classList.toggle("increasing",!1),l=ls`decreasing by ${i} per second`),t.textContent=a,UI.ARIAUtils.setAccessibleName(t,l)}totalMemoryElement(){return this._totalElement}createElementForItem(e){return e.element}heightForItem(e){}updateSelectedItemARIA(e,t){return!1}isItemSelectable(e){return!0}selectedItemChanged(e,t,s,i){s&&s.classList.remove("selected"),i&&i.classList.add("selected");const a=t&&t.model();self.UI.context.setFlavor(SDK.HeapProfilerModel.HeapProfilerModel,a&&a.heapProfilerModel()),self.UI.context.setFlavor(SDK.CPUProfilerModel.CPUProfilerModel,a&&a.target().model(SDK.CPUProfilerModel.CPUProfilerModel))}_update(){this._updateTotal(),this._list.invalidateRange(0,this._items.length)}}export class ListItem{constructor(e){this._isolate=e;const t=Math.round(SDK.IsolateManager.MemoryTrendWindowMs/6e4);this.element=createElementWithClass("div","profile-memory-usage-item hbox"),UI.ARIAUtils.markAsOption(this.element),this._heapDiv=this.element.createChild("div","profile-memory-usage-item-size"),this._heapDiv.title=ls`Heap size in use by live JS objects.`,this._trendDiv=this.element.createChild("div","profile-memory-usage-item-trend"),this._trendDiv.title=ls`Heap size change trend over the last ${t} minutes.`,this._nameDiv=this.element.createChild("div","profile-memory-usage-item-name"),this.updateTitle()}model(){return this._isolate.runtimeModel()}updateStats(){this._heapDiv.textContent=Number.bytesToString(this._isolate.usedHeapSize()),IsolateSelector._formatTrendElement(this._isolate.usedHeapSizeGrowRate(),this._trendDiv)}updateTitle(){const e=new Map;for(const t of this._isolate.models()){const s=t.target(),i=SDK.SDKModel.TargetManager.instance().mainTarget()!==s?s.name():"",a=new Common.ParsedURL.ParsedURL(s.inspectedURL()),l=a.isValid?a.domain():"",o=s.decorateLabel(l&&i?`${l}: ${i}`:i||l||ls`(empty)`);e.set(o,(e.get(o)||0)+1)}this._nameDiv.removeChildren();const t=[];for(const[s,i]of e){const e=i>1?`${s} (${i})`:s;t.push(e);const a=this._nameDiv.createChild("div");a.textContent=e,a.title=e}}}