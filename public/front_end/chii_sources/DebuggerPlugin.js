import*as Bindings from"../bindings/bindings.js";import*as Common from"../common/common.js";import*as Host from"../host/host.js";import*as ObjectUI from"../object_ui/object_ui.js";import*as SDK from"../sdk/sdk.js";import*as SourceFrame from"../source_frame/source_frame.js";import*as TextEditor from"../text_editor/text_editor.js";import*as TextUtils from"../text_utils/text_utils.js";import*as UI from"../ui/ui.js";import*as Workspace from"../workspace/workspace.js";import{AddSourceMapURLDialog}from"./AddSourceMapURLDialog.js";import{BreakpointEditDialog,LogpointPrefix}from"./BreakpointEditDialog.js";import{Plugin}from"./Plugin.js";import{resolveExpression,resolveScopeInObject}from"./SourceMapNamesResolver.js";import{SourcesPanel}from"./SourcesPanel.js";const breakpointsGutterType="CodeMirror-gutter-breakpoints";export class DebuggerPlugin extends Plugin{constructor(e,t,i){super(),this._textEditor=e,this._uiSourceCode=t,this._transformer=i,this._executionLocation=null,this._controlDown=!1,this._asyncStepInHoveredLine=0,this._asyncStepInHovered=!1,this._clearValueWidgetsTimer=null,this._sourceMapInfobar=null,this._controlTimeout=null,this._scriptsPanel=SourcesPanel.instance(),this._breakpointManager=Bindings.BreakpointManager.BreakpointManager.instance(),t.project().type()===Workspace.Workspace.projectTypes.Debugger&&this._textEditor.element.classList.add("source-frame-debugger-script"),this._popoverHelper=new UI.PopoverHelper.PopoverHelper(this._scriptsPanel.element,this._getPopoverRequest.bind(this)),this._popoverHelper.setDisableOnClick(!0),this._popoverHelper.setTimeout(250,250),this._popoverHelper.setHasPadding(!0),this._boundPopoverHelperHide=this._popoverHelper.hidePopover.bind(this._popoverHelper),this._scriptsPanel.element.addEventListener("scroll",this._boundPopoverHelperHide,!0);const o={"debugger.toggle-breakpoint":async()=>{const e=this._textEditor.selection();return!!e&&(await this._toggleBreakpoint(e.startLine,!1),!0)},"debugger.toggle-breakpoint-enabled":async()=>{const e=this._textEditor.selection();return!!e&&(await this._toggleBreakpoint(e.startLine,!0),!0)},"debugger.breakpoint-input-window":async()=>{const e=this._textEditor.selection();if(!e)return!1;const t=this._lineBreakpointDecorations(e.startLine).map(e=>e.breakpoint).filter(e=>!!e);let i;t.length&&(i=t[0]);const o=!!i&&i.condition().includes(LogpointPrefix);return this._editBreakpointCondition(e.startLine,i,null,o),!0}};self.UI.shortcutRegistry.addShortcutListener(this._textEditor.element,o),this._boundKeyDown=this._onKeyDown.bind(this),this._textEditor.element.addEventListener("keydown",this._boundKeyDown,!0),this._boundKeyUp=this._onKeyUp.bind(this),this._textEditor.element.addEventListener("keyup",this._boundKeyUp,!0),this._boundMouseMove=this._onMouseMove.bind(this),this._textEditor.element.addEventListener("mousemove",this._boundMouseMove,!1),this._boundMouseDown=this._onMouseDown.bind(this),this._textEditor.element.addEventListener("mousedown",this._boundMouseDown,!0),this._boundBlur=this._onBlur.bind(this),this._textEditor.element.addEventListener("focusout",this._boundBlur,!1),this._boundWheel=e=>{this._executionLocation&&UI.KeyboardShortcut.KeyboardShortcut.eventHasCtrlOrMeta(e)&&e.preventDefault()},this._textEditor.element.addEventListener("wheel",this._boundWheel,!0),this._textEditor.addEventListener(SourceFrame.SourcesTextEditor.Events.GutterClick,e=>{this._handleGutterClick(e)},this),this._breakpointManager.addEventListener(Bindings.BreakpointManager.Events.BreakpointAdded,this._breakpointAdded,this),this._breakpointManager.addEventListener(Bindings.BreakpointManager.Events.BreakpointRemoved,this._breakpointRemoved,this),this._uiSourceCode.addEventListener(Workspace.UISourceCode.Events.WorkingCopyChanged,this._workingCopyChanged,this),this._uiSourceCode.addEventListener(Workspace.UISourceCode.Events.WorkingCopyCommitted,this._workingCopyCommitted,this),this._breakpointDecorations=new Set,this._decorationByBreakpoint=new Map,this._possibleBreakpointsRequested=new Set,this._scriptFileForDebuggerModel=new Map,Common.Settings.Settings.instance().moduleSetting("skipStackFramesPattern").addChangeListener(this._showBlackboxInfobarIfNeeded,this),Common.Settings.Settings.instance().moduleSetting("skipContentScripts").addChangeListener(this._showBlackboxInfobarIfNeeded,this),this._valueWidgets=new Map,this._continueToLocationDecorations=null,self.UI.context.addFlavorChangeListener(SDK.DebuggerModel.CallFrame,this._callFrameChanged,this),this._liveLocationPool=new Bindings.LiveLocation.LiveLocationPool,this._callFrameChanged(),this._updateScriptFiles(),this._uiSourceCode.isDirty()?(this._muted=!0,this._mutedFromStart=!0):(this._muted=!1,this._mutedFromStart=!1,this._initializeBreakpoints()),this._blackboxInfobar=null,this._showBlackboxInfobarIfNeeded();for(const e of this._scriptFileForDebuggerModel.values())e.checkMapping();this._hasLineWithoutMapping=!1,this._updateLinesWithoutMappingHighlight(),Root.Runtime.experiments.isEnabled("sourcesPrettyPrint")||(this._prettyPrintInfobar=null,this._detectMinified()),this._textEditor.installGutter(breakpointsGutterType,!0);for(let e=0;e<this._textEditor.linesCount;++e){const t=createElementWithClass("div","breakpoint-element");this._textEditor.setGutterDecoration(e,breakpointsGutterType,t)}}static accepts(e){return e.contentType().hasScripts()}_showBlackboxInfobarIfNeeded(){const e=this._uiSourceCode;if(!e.contentType().hasScripts())return;const t=e.project().type();if(!Bindings.BlackboxManager.BlackboxManager.instance().isBlackboxedUISourceCode(e))return void this._hideBlackboxInfobar();this._blackboxInfobar&&this._blackboxInfobar.dispose();const i=new UI.Infobar.Infobar(UI.Infobar.Type.Warning,Common.UIString.UIString("This script is blackboxed in the debugger"),[{text:ls`Unblackbox`,highlight:!1,delegate:function(){Bindings.BlackboxManager.BlackboxManager.instance().unblackboxUISourceCode(e),t===Workspace.Workspace.projectTypes.ContentScripts&&Bindings.BlackboxManager.BlackboxManager.instance().unblackboxContentScripts()},dismiss:!0},{text:ls`Configure`,highlight:!1,delegate:UI.ViewManager.ViewManager.instance().showView.bind(UI.ViewManager.ViewManager.instance(),"blackbox"),dismiss:!1}]);this._blackboxInfobar=i,i.createDetailsRowMessage(Common.UIString.UIString("The debugger will skip stepping through this script, and will not stop on exceptions."));const o=this._scriptFileForDebuggerModel.size?this._scriptFileForDebuggerModel.values().next().value:null;o&&o.hasSourceMapURL()&&i.createDetailsRowMessage(Common.UIString.UIString("Source map found, but ignored for blackboxed file.")),this._textEditor.attachInfobar(this._blackboxInfobar)}_hideBlackboxInfobar(){this._blackboxInfobar&&(this._blackboxInfobar.dispose(),this._blackboxInfobar=null)}wasShown(){this._executionLocation&&setImmediate(()=>{this._generateValuesInSource()})}willHide(){this._popoverHelper.hidePopover()}populateLineGutterContextMenu(e,t){return new Promise(function(i,o){const n=new Workspace.UISourceCode.UILocation(this._uiSourceCode,t,0);this._scriptsPanel.appendUILocationItems(e,n);const r=this._lineBreakpointDecorations(t).map(e=>e.breakpoint).filter(e=>!!e);if(r.length){const i=1===r.length,o=i?Common.UIString.UIString("Remove breakpoint"):Common.UIString.UIString("Remove all breakpoints in line");e.debugSection().appendItem(o,()=>r.map(e=>e.remove())),i&&e.debugSection().appendItem(Common.UIString.UIString("Edit breakpoint…"),this._editBreakpointCondition.bind(this,t,r[0],null));if(r.some(e=>e.enabled())){const t=i?Common.UIString.UIString("Disable breakpoint"):Common.UIString.UIString("Disable all breakpoints in line");e.debugSection().appendItem(t,()=>r.map(e=>e.setEnabled(!1)))}if(r.some(e=>!e.enabled())){const t=i?Common.UIString.UIString("Enable breakpoint"):Common.UIString.UIString("Enable all breakpoints in line");e.debugSection().appendItem(t,()=>r.map(e=>e.setEnabled(!0)))}}else e.debugSection().appendItem(Common.UIString.UIString("Add breakpoint"),this._createNewBreakpoint.bind(this,t,"",!0)),e.debugSection().appendItem(Common.UIString.UIString("Add conditional breakpoint…"),this._editBreakpointCondition.bind(this,t,null,null)),e.debugSection().appendItem(ls`Add logpoint…`,this._editBreakpointCondition.bind(this,t,null,null,!0)),e.debugSection().appendItem(Common.UIString.UIString("Never pause here"),this._createNewBreakpoint.bind(this,t,"false",!0));i()}.bind(this))}populateTextAreaContextMenu(e,t,i){function o(e){new AddSourceMapURLDialog(n.bind(null,e)).show()}function n(e,t){t&&e.addSourceMapURL(t)}return super.populateTextAreaContextMenu(e,t,i).then(function(){if(this._uiSourceCode.project().type()===Workspace.Workspace.projectTypes.Network&&Common.Settings.Settings.instance().moduleSetting("jsSourceMapsEnabled").get()&&!Bindings.BlackboxManager.BlackboxManager.instance().isBlackboxedUISourceCode(this._uiSourceCode)&&this._scriptFileForDebuggerModel.size){const t=this._scriptFileForDebuggerModel.values().next().value,i=Common.UIString.UIString("Add source map…");e.debugSection().appendItem(i,o.bind(null,t))}}.bind(this))}_workingCopyChanged(){this._scriptFileForDebuggerModel.size||(this._uiSourceCode.isDirty()?this._muteBreakpointsWhileEditing():this._restoreBreakpointsAfterEditing())}_workingCopyCommitted(e){this._scriptsPanel.updateLastModificationTime(),this._scriptFileForDebuggerModel.size||this._restoreBreakpointsAfterEditing()}_didMergeToVM(){this._restoreBreakpointsIfConsistentScripts()}_didDivergeFromVM(){this._muteBreakpointsWhileEditing()}_muteBreakpointsWhileEditing(){if(!this._muted){for(const e of this._breakpointDecorations)this._updateBreakpointDecoration(e);this._muted=!0}}async _restoreBreakpointsIfConsistentScripts(){for(const e of this._scriptFileForDebuggerModel.values())if(e.hasDivergedFromVM()||e.isMergingToVM())return;await this._restoreBreakpointsAfterEditing()}async _restoreBreakpointsAfterEditing(){if(this._muted=!1,this._mutedFromStart)return this._mutedFromStart=!1,void this._initializeBreakpoints();const e=Array.from(this._breakpointDecorations);this._breakpointDecorations.clear(),this._textEditor.operation(()=>e.map(e=>e.hide()));for(const t of e){if(!t.breakpoint)continue;const e=t.enabled;t.breakpoint.remove();const i=t.handle.resolve();i&&await this._setBreakpoint(i.lineNumber,i.columnNumber,t.condition,e)}}_isIdentifier(e){return e.startsWith("js-variable")||e.startsWith("js-property")||"js-def"===e}_getPopoverRequest(e){if(UI.KeyboardShortcut.KeyboardShortcut.eventHasCtrlOrMeta(e))return null;const t=self.UI.context.flavor(SDK.SDKModel.Target),i=t?t.model(SDK.DebuggerModel.DebuggerModel):null;if(!i||!i.isPaused())return null;const o=this._textEditor.coordinatesToCursorPosition(e.x,e.y);if(!o)return null;const n=o.startLine,r=o.startColumn,s=this._textEditor.selection().normalize();let a,c,l,d;const u=self.UI.context.flavor(SDK.DebuggerModel.CallFrame);if(!u)return null;if(u.script.isWasm())return null;if(s&&!s.isEmpty()){if(s.startLine!==s.endLine||s.startLine!==n||r<s.startColumn||r>s.endColumn)return null;const e=this._textEditor.cursorPositionToCoordinates(s.startLine,s.startColumn),t=this._textEditor.cursorPositionToCoordinates(s.endLine,s.endColumn);a=new AnchorBox(e.x,e.y,t.x-e.x,e.height),c=s.startLine,l=s.startColumn,d=s.endColumn-1}else{const e=this._textEditor.tokenAtTextPosition(o.startLine,o.startColumn);if(!e||!e.type)return null;c=o.startLine;const t=this._textEditor.line(c),i=t.substring(e.startColumn,e.endColumn);if(!this._isIdentifier(e.type)&&("js-keyword"!==e.type||"this"!==i))return null;const n=this._textEditor.cursorPositionToCoordinates(c,e.startColumn),r=this._textEditor.cursorPositionToCoordinates(c,e.endColumn-1);for(a=new AnchorBox(n.x,n.y,r.x-n.x,n.height),l=e.startColumn,d=e.endColumn-1;l>1&&"."===t.charAt(l-1);){const e=this._textEditor.tokenAtTextPosition(c,l-2);if(!e||!e.type)return null;if("js-meta"===e.type)break;if("js-string-2"===e.type){if(e.endColumn<2)return null;if(l=t.lastIndexOf("`",e.endColumn-2),l<0)return null;break}l=e.startColumn}}let h,p;return{box:a,show:async e=>{const t=this._textEditor.line(c).substring(l,d+1),o=await resolveExpression(u,t,this._uiSourceCode,c,l,d),n=await u.evaluate({expression:o||t,objectGroup:"popover",includeCommandLineAPI:!1,silent:!0,returnByValue:!1,generatePreview:!1});if(!n.object||"object"===n.object.type&&"error"===n.object.subtype)return!1;h=await ObjectUI.ObjectPopoverHelper.ObjectPopoverHelper.buildObjectPopover(n.object,e);const r=self.UI.context.flavor(SDK.DebuggerModel.CallFrame);if(!h||u!==r)return i.runtimeModel().releaseObjectGroup("popover"),h&&h.dispose(),!1;const s=new TextUtils.TextRange.TextRange(c,l,c,d);return p=this._textEditor.highlightRange(s,"source-frame-eval-expression"),!0},hide:()=>{h.dispose(),i.runtimeModel().releaseObjectGroup("popover"),this._textEditor.removeHighlight(p)}}}async _onKeyDown(e){this._clearControlDown(),"Escape"!==e.key?UI.KeyboardShortcut.KeyboardShortcut.eventHasCtrlOrMeta(e)&&this._executionLocation&&(this._controlDown=!0,e.key===(Host.Platform.isMac()?"Meta":"Control")&&(this._controlTimeout=setTimeout(()=>{this._executionLocation&&this._controlDown&&this._showContinueToLocations()},150))):this._popoverHelper.isPopoverVisible()&&(this._popoverHelper.hidePopover(),e.consume())}_onMouseMove(e){if(this._executionLocation&&this._controlDown&&UI.KeyboardShortcut.KeyboardShortcut.eventHasCtrlOrMeta(e)&&(this._continueToLocationDecorations||this._showContinueToLocations()),this._continueToLocationDecorations){const t=this._textEditor.coordinatesToCursorPosition(e.x,e.y),i=!!e.target.enclosingNodeOrSelfWithClass("source-frame-async-step-in");this._setAsyncStepInHoveredLine(t?t.startLine:null,i)}}_setAsyncStepInHoveredLine(e,t){this._asyncStepInHoveredLine===e&&this._asyncStepInHovered===t||(this._asyncStepInHovered&&this._asyncStepInHoveredLine&&this._textEditor.toggleLineClass(this._asyncStepInHoveredLine,"source-frame-async-step-in-hovered",!1),this._asyncStepInHoveredLine=e,this._asyncStepInHovered=t,this._asyncStepInHovered&&this._asyncStepInHoveredLine&&this._textEditor.toggleLineClass(this._asyncStepInHoveredLine,"source-frame-async-step-in-hovered",!0))}_onMouseDown(e){if(!this._executionLocation||!UI.KeyboardShortcut.KeyboardShortcut.eventHasCtrlOrMeta(e))return;if(!this._continueToLocationDecorations)return;e.consume();const t=this._textEditor.coordinatesToCursorPosition(e.x,e.y);if(t)for(const e of this._continueToLocationDecorations.keys()){const i=e.find();if(i.from.line===t.startLine&&i.to.line===t.startLine&&(i.from.ch<=t.startColumn&&t.startColumn<=i.to.ch)){this._continueToLocationDecorations.get(e)();break}}}_onBlur(e){this._textEditor.element.isAncestor(e.target)||this._clearControlDown()}_onKeyUp(e){this._clearControlDown()}_clearControlDown(){this._controlDown=!1,this._clearContinueToLocations(),clearTimeout(this._controlTimeout)}async _editBreakpointCondition(e,t,i,o){const n=t?t.condition():"",r=createElement("div"),s=new BreakpointEditDialog(e,n,!!o,async o=>{s.detach(),this._textEditor.removeDecoration(r,e),o.committed&&(t?t.setCondition(o.condition):i?await this._setBreakpoint(i.lineNumber,i.columnNumber,o.condition,!0):await this._createNewBreakpoint(e,o.condition,!0))});this._textEditor.addDecoration(r,e),s.markAsExternallyManaged(),s.show(r)}async _executionLineChanged(e){this._clearExecutionLine();const t=await e.uiLocation();if(!t||t.uiSourceCode.url()!==this._uiSourceCode.url())return void(this._executionLocation=null);this._executionLocation=t;const i=this._transformer.rawToEditorLocation(t.lineNumber,t.columnNumber);this._textEditor.setExecutionLocation(i[0],i[1]),this._textEditor.isShowing()&&setImmediate(()=>{this._controlDown?this._showContinueToLocations():this._generateValuesInSource()})}_generateValuesInSource(){if(!Common.Settings.Settings.instance().moduleSetting("inlineVariableValues").get())return;if(!self.UI.context.flavor(SDK.RuntimeModel.ExecutionContext))return;const e=self.UI.context.flavor(SDK.DebuggerModel.CallFrame);if(!e)return;const t=e.localScope(),i=e.functionLocation();t&&i&&resolveScopeInObject(t).getAllProperties(!1,!1).then(this._prepareScopeVariables.bind(this,e))}_showContinueToLocations(){this._popoverHelper.hidePopover();if(!self.UI.context.flavor(SDK.RuntimeModel.ExecutionContext))return;const e=self.UI.context.flavor(SDK.DebuggerModel.CallFrame);if(!e)return;const t=e.functionLocation()||e.location();function i(e){this._clearContinueToLocationsNoRestore(),this._textEditor.hideExecutionLineBackground(),this._clearValueWidgets(),this._continueToLocationDecorations=new Map,e=e.reverse();let t=-1;for(const i of e){const e=this._transformer.rawToEditorLocation(i.lineNumber,i.columnNumber);let o=this._textEditor.tokenAtTextPosition(e[0],e[1]);if(!o)continue;const n=this._textEditor.line(e[0]);let r=n.substring(o.startColumn,o.endColumn);if(o.type||"."!==r||(o=this._textEditor.tokenAtTextPosition(e[0],o.endColumn+1),r=n.substring(o.startColumn,o.endColumn)),!o.type)continue;if(!("js-keyword"===o.type&&("this"===r||"return"===r||"new"===r||"continue"===r||"break"===r))&&!this._isIdentifier(o.type))continue;if(t===e[0]&&i.type!==Protocol.Debugger.BreakLocationType.Call)continue;let s=new TextUtils.TextRange.TextRange(e[0],o.startColumn,e[0],o.endColumn-1),a=this._textEditor.highlightRange(s,"source-frame-continue-to-location");this._continueToLocationDecorations.set(a,i.continueToLocation.bind(i)),i.type===Protocol.Debugger.BreakLocationType.Call&&(t=e[0]);let c="."===n[o.startColumn-1]&&"then"===r||"setTimeout"===r||"setInterval"===r||"postMessage"===r;"new"===r&&(o=this._textEditor.tokenAtTextPosition(e[0],o.endColumn+1),r=n.substring(o.startColumn,o.endColumn),c="Worker"===r);const l=this._executionLocation&&i.lineNumber===this._executionLocation.lineNumber&&i.columnNumber===this._executionLocation.columnNumber;if(i.type===Protocol.Debugger.BreakLocationType.Call&&c){const t=this._findAsyncStepInRange(this._textEditor,e[0],n,o.endColumn);t&&(s=new TextUtils.TextRange.TextRange(e[0],t.from,e[0],t.to-1),a=this._textEditor.highlightRange(s,"source-frame-async-step-in"),this._continueToLocationDecorations.set(a,this._asyncStepIn.bind(this,i,!!l)))}}this._continueToLocationRenderedForTest()}e.debuggerModel.getPossibleBreakpoints(t,null,!0).then(e=>this._textEditor.operation(i.bind(this,e)))}_continueToLocationRenderedForTest(){}_findAsyncStepInRange(e,t,i,o){let n,r,s=o,a=i.length,c=i.indexOf("(",o);const l=c;if(-1===c)return null;if(c++,h(),c>=i.length)return null;if(u(),!n)return null;if(s=n.startColumn,"js-keyword"===n.type&&"async"===r){if(h(),c>=i.length)return{from:s,to:a};if(u(),!n)return{from:s,to:a}}if("js-keyword"===n.type&&"function"===r)return{from:s,to:a};if("js-string"===n.type)return{from:l,to:a};if(n.type&&this._isIdentifier(n.type))return{from:s,to:a};if("("!==r)return null;const d=i.indexOf(")",c);return-1===d||-1!==i.substring(c,d).indexOf("(")?{from:s,to:a}:{from:s,to:d+1};function u(){n=e.tokenAtTextPosition(t,c),n&&(c=n.endColumn,a=n.endColumn,r=i.substring(n.startColumn,n.endColumn))}function h(){for(;c<i.length;){if(" "===i[c]){c++;continue}const o=e.tokenAtTextPosition(t,c);if("js-comment"!==o.type)break;c=o.endColumn}}}_asyncStepIn(e,t){function i(){e.debuggerModel.scheduleStepIntoAsync()}t?i():e.continueToLocation(i)}async _prepareScopeVariables(e,t){const i=t.properties;if(this._clearValueWidgets(),!i||!i.length||i.length>500||!this._textEditor.isShowing())return;const o=Bindings.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance().rawLocationToUILocation(e.functionLocation()),n=Bindings.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance().rawLocationToUILocation(e.location()),[r,s]=await Promise.all([o,n]);if(!r||!s||r.uiSourceCode.url()!==this._uiSourceCode.url()||s.uiSourceCode.url()!==this._uiSourceCode.url())return;const a=this._transformer.rawToEditorLocation(r.lineNumber,r.columnNumber),c=this._transformer.rawToEditorLocation(s.lineNumber,s.columnNumber),l=a[0],d=a[1],u=c[0];if(l>=u||u-l>500||l<0||u>=this._textEditor.linesCount)return;const h=new Map;for(const e of i)h.set(e.name,e.value);const p=new Map;let g=!1;const _=(new TextEditor.CodeMirrorUtils.TokenizerFactory).createTokenizer("text/javascript");_(this._textEditor.line(l).substring(d),m.bind(this,l));for(let e=l+1;e<u;++e)_(this._textEditor.line(e),m.bind(this,e));function m(e,t,i,o,n){if(!g&&i&&this._isIdentifier(i)&&h.get(t)){let i=p.get(e);i||(i=new Set,p.set(e,i)),i.add(t)}g="."===t}this._textEditor.operation(this._renderDecorations.bind(this,h,p,l,u))}_renderDecorations(e,t,i,o){const n=new ObjectUI.RemoteObjectPreviewFormatter.RemoteObjectPreviewFormatter;for(let r=i;r<o;++r){const i=t.get(r),o=this._valueWidgets.get(r);if(!i){o&&(this._valueWidgets.delete(r),this._textEditor.removeDecoration(o,r));continue}const s=createElementWithClass("div","text-editor-value-decoration"),a=this._textEditor.cursorPositionToCoordinates(r,0),c=4,l=this._textEditor.cursorPositionToCoordinates(r,this._textEditor.line(r).length).x-a.x+c;s.style.left=l+"px",s.__nameToToken=new Map;let d=0;for(const o of i){if(d>10)break;if(t.get(r-1)&&t.get(r-1).has(o))continue;d&&s.createTextChild(", ");const i=s.createChild("span");s.__nameToToken.set(o,i),i.createTextChild(o+" = ");const a=e.get(o),c=a.preview?a.preview.properties.length:0,l=a.preview&&a.preview.entries?a.preview.entries.length:0;if(a.preview&&c+l<10)n.appendObjectPreview(i,a.preview,!1);else{const e=ObjectUI.ObjectPropertiesSection.ObjectPropertiesSection.createPropertyValue(a,!1,!1);i.appendChild(e.element)}++d}let u=!0;if(o){u=!1;for(const e of s.__nameToToken.keys()){const t=o.__nameToToken.get(e)?o.__nameToToken.get(e).textContent:"";(s.__nameToToken.get(e)?s.__nameToToken.get(e).textContent:"")!==t&&(u=!0,UI.UIUtils.runCSSAnimationOnce(s.__nameToToken.get(e),"source-frame-value-update-highlight"))}u&&(this._valueWidgets.delete(r),this._textEditor.removeDecoration(o,r))}u&&(this._valueWidgets.set(r,s),this._textEditor.addDecoration(s,r))}}_clearExecutionLine(){this._textEditor.operation(()=>{this._executionLocation&&this._textEditor.clearExecutionLine(),this._executionLocation=null,this._clearValueWidgetsTimer&&(clearTimeout(this._clearValueWidgetsTimer),this._clearValueWidgetsTimer=null),this._clearValueWidgetsTimer=setTimeout(this._clearValueWidgets.bind(this),1e3),this._clearContinueToLocationsNoRestore()})}_clearValueWidgets(){clearTimeout(this._clearValueWidgetsTimer),this._clearValueWidgetsTimer=null,this._textEditor.operation(()=>{for(const e of this._valueWidgets.keys())this._textEditor.removeDecoration(this._valueWidgets.get(e),e);this._valueWidgets.clear()})}_clearContinueToLocationsNoRestore(){this._continueToLocationDecorations&&this._textEditor.operation(()=>{for(const e of this._continueToLocationDecorations.keys())this._textEditor.removeHighlight(e);this._continueToLocationDecorations=null,this._setAsyncStepInHoveredLine(null,!1)})}_clearContinueToLocations(){this._continueToLocationDecorations&&this._textEditor.operation(()=>{this._textEditor.showExecutionLineBackground(),this._generateValuesInSource(),this._clearContinueToLocationsNoRestore()})}_lineBreakpointDecorations(e){return Array.from(this._breakpointDecorations).filter(t=>(t.handle.resolve()||{}).lineNumber===e)}_breakpointDecoration(e,t){for(const i of this._breakpointDecorations){const o=i.handle.resolve();if(o&&(o.lineNumber===e&&o.columnNumber===t))return i}return null}_updateBreakpointDecoration(e){function t(){if(!this._scheduledBreakpointDecorationUpdates)return;const e=new Set;for(const t of this._scheduledBreakpointDecorationUpdates){const i=t.handle.resolve();i&&e.add(i.lineNumber)}this._scheduledBreakpointDecorationUpdates=null;let t=!1;for(const n of e){const e=this._lineBreakpointDecorations(n);i.call(this,n,e),this._possibleBreakpointsRequested.has(n)?t=!0:o.call(this,n,e)}t||this._breakpointDecorationsUpdatedForTest()}function i(e,t){if(this._textEditor.toggleLineClass(e,"cm-breakpoint",!1),this._textEditor.toggleLineClass(e,"cm-breakpoint-disabled",!1),this._textEditor.toggleLineClass(e,"cm-breakpoint-unbound",!1),this._textEditor.toggleLineClass(e,"cm-breakpoint-conditional",!1),this._textEditor.toggleLineClass(e,"cm-breakpoint-logpoint",!1),t.length){t.sort(BreakpointDecoration.mostSpecificFirst);const i=!t[0].enabled||this._muted,o=t[0].condition.includes(LogpointPrefix),n=!t[0].bound,r=!!t[0].condition&&!o;this._textEditor.toggleLineClass(e,"cm-breakpoint",!0),this._textEditor.toggleLineClass(e,"cm-breakpoint-disabled",i),this._textEditor.toggleLineClass(e,"cm-breakpoint-unbound",n&&!i),this._textEditor.toggleLineClass(e,"cm-breakpoint-logpoint",o),this._textEditor.toggleLineClass(e,"cm-breakpoint-conditional",r)}}function o(e,t){const i=new Set(t.map(e=>e.bookmark).filter(e=>!!e)),o=this._textEditor.line(e).length,n=this._textEditor.bookmarks(new TextUtils.TextRange.TextRange(e,0,e,o),BreakpointDecoration.bookmarkSymbol);for(const e of n)i.has(e)||e.clear();if(t.length)if(t.length>1)for(const e of t)e.update(),this._muted?e.hide():e.show();else t[0].update(),t[0].hide()}this._scheduledBreakpointDecorationUpdates||(this._scheduledBreakpointDecorationUpdates=new Set,setImmediate(()=>this._textEditor.operation(t.bind(this)))),this._scheduledBreakpointDecorationUpdates.add(e)}_breakpointDecorationsUpdatedForTest(){}async _inlineBreakpointClick(e,t){if(t.consume(!0),e.breakpoint)t.shiftKey?e.breakpoint.setEnabled(!e.breakpoint.enabled()):e.breakpoint.remove();else{const t=e.handle.resolve();if(!t)return;const i=this._transformer.editorToRawLocation(t.lineNumber,t.columnNumber);await this._setBreakpoint(i[0],i[1],e.condition,!0)}}_inlineBreakpointContextMenu(e,t){t.consume(!0);const i=e.handle.resolve();if(!i)return;const o=this._transformer.editorToRawLocation(i[0],i[1]),n=new UI.ContextMenu.ContextMenu(t);e.breakpoint?n.debugSection().appendItem(Common.UIString.UIString("Edit breakpoint…"),this._editBreakpointCondition.bind(this,i.lineNumber,e.breakpoint,null)):(n.debugSection().appendItem(Common.UIString.UIString("Add conditional breakpoint…"),this._editBreakpointCondition.bind(this,i.lineNumber,null,i)),n.debugSection().appendItem(ls`Add logpoint…`,this._editBreakpointCondition.bind(this,i.lineNumber,null,i,!0)),n.debugSection().appendItem(Common.UIString.UIString("Never pause here"),this._setBreakpoint.bind(this,o[0],o[1],"false",!0))),n.show()}_shouldIgnoreExternalBreakpointEvents(e){if(e.data.uiLocation.uiSourceCode!==this._uiSourceCode)return!0;if(this._muted)return!0;for(const e of this._scriptFileForDebuggerModel.values())if(e.isDivergingFromVM()||e.isMergingToVM())return!0;return!1}_breakpointAdded(e){if(this._shouldIgnoreExternalBreakpointEvents(e))return;const t=e.data.uiLocation,i=e.data.breakpoint;this._addBreakpoint(t,i)}_addBreakpoint(e,t){const i=this._transformer.rawToEditorLocation(e.lineNumber,e.columnNumber),o=this._lineBreakpointDecorations(e.lineNumber);let n=this._breakpointDecoration(i[0],i[1]);if(n)n.breakpoint=t,n.condition=t.condition(),n.enabled=t.enabled();else{const e=this._textEditor.textEditorPositionHandle(i[0],i[1]);n=new BreakpointDecoration(this._textEditor,e,t.condition(),t.enabled(),t.bound(),t),n.element.addEventListener("click",this._inlineBreakpointClick.bind(this,n),!0),n.element.addEventListener("contextmenu",this._inlineBreakpointContextMenu.bind(this,n),!0),this._breakpointDecorations.add(n)}if(this._decorationByBreakpoint.set(t,n),this._updateBreakpointDecoration(n),t.enabled()&&!o.length){this._possibleBreakpointsRequested.add(i[0]);const e=this._transformer.editorToRawLocation(i[0],0),t=this._transformer.editorToRawLocation(i[0]+1,0);this._breakpointManager.possibleBreakpoints(this._uiSourceCode,new TextUtils.TextRange.TextRange(e[0],e[1],t[0],t[1])).then(function(e,t){this._possibleBreakpointsRequested.delete(e);const i=this._lineBreakpointDecorations(e);for(const e of i)this._updateBreakpointDecoration(e);if(!i.some(e=>!!e.breakpoint))return;const o=new Set;for(const e of i){const t=e.handle.resolve();t&&o.add(t.columnNumber)}for(const i of t.slice(0,100)){const t=this._transformer.rawToEditorLocation(i.lineNumber,i.columnNumber);if(t[0]!==e)continue;if(o.has(t[1]))continue;const n=this._textEditor.textEditorPositionHandle(t[0],t[1]),r=new BreakpointDecoration(this._textEditor,n,"",!1,!1,null);r.element.addEventListener("click",this._inlineBreakpointClick.bind(this,r),!0),r.element.addEventListener("contextmenu",this._inlineBreakpointContextMenu.bind(this,r),!0),this._breakpointDecorations.add(r),this._updateBreakpointDecoration(r)}}.bind(this,i[0]))}}_breakpointRemoved(e){if(this._shouldIgnoreExternalBreakpointEvents(e))return;const t=e.data.uiLocation,i=e.data.breakpoint,o=this._decorationByBreakpoint.get(i);if(!o)return;this._decorationByBreakpoint.delete(i);const n=this._transformer.rawToEditorLocation(t.lineNumber,t.columnNumber);o.breakpoint=null,o.enabled=!1;const r=this._lineBreakpointDecorations(n[0]);if(r.some(e=>!!e.breakpoint))this._updateBreakpointDecoration(o);else for(const e of r)this._breakpointDecorations.delete(e),this._updateBreakpointDecoration(e)}_initializeBreakpoints(){const e=this._breakpointManager.breakpointLocationsForUISourceCode(this._uiSourceCode);for(const t of e)this._addBreakpoint(t.uiLocation,t.breakpoint)}_updateLinesWithoutMappingHighlight(){if(!!!Bindings.CompilerScriptMapping.CompilerScriptMapping.uiSourceCodeOrigin(this._uiSourceCode))return;const e=this._textEditor.linesCount;for(let t=0;t<e;++t){const e=Bindings.CompilerScriptMapping.CompilerScriptMapping.uiLineHasMapping(this._uiSourceCode,t);e||(this._hasLineWithoutMapping=!0),this._hasLineWithoutMapping&&this._textEditor.toggleLineClass(t,"cm-line-without-source-mapping",!e)}}_updateScriptFiles(){for(const e of SDK.SDKModel.TargetManager.instance().models(SDK.DebuggerModel.DebuggerModel)){Bindings.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance().scriptFile(this._uiSourceCode,e)&&this._updateScriptFile(e)}}_updateScriptFile(e){const t=this._scriptFileForDebuggerModel.get(e),i=Bindings.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance().scriptFile(this._uiSourceCode,e);this._scriptFileForDebuggerModel.delete(e),t&&(t.removeEventListener(Bindings.ResourceScriptMapping.ResourceScriptFile.Events.DidMergeToVM,this._didMergeToVM,this),t.removeEventListener(Bindings.ResourceScriptMapping.ResourceScriptFile.Events.DidDivergeFromVM,this._didDivergeFromVM,this),this._muted&&!this._uiSourceCode.isDirty()&&this._restoreBreakpointsIfConsistentScripts()),i&&(this._scriptFileForDebuggerModel.set(e,i),i.addEventListener(Bindings.ResourceScriptMapping.ResourceScriptFile.Events.DidMergeToVM,this._didMergeToVM,this),i.addEventListener(Bindings.ResourceScriptMapping.ResourceScriptFile.Events.DidDivergeFromVM,this._didDivergeFromVM,this),i.checkMapping(),i.hasSourceMapURL()&&this._showSourceMapInfobar())}_showSourceMapInfobar(){this._sourceMapInfobar||(this._sourceMapInfobar=UI.Infobar.Infobar.create(UI.Infobar.Type.Info,Common.UIString.UIString("Source Map detected."),[],Common.Settings.Settings.instance().createSetting("sourceMapInfobarDisabled",!1)),this._sourceMapInfobar&&(this._sourceMapInfobar.createDetailsRowMessage(Common.UIString.UIString("Associated files should be added to the file tree. You can debug these resolved source files as regular JavaScript files.")),this._sourceMapInfobar.createDetailsRowMessage(Common.UIString.UIString("Associated files are available via file tree or %s.",self.UI.shortcutRegistry.shortcutTitleForAction("quickOpen.show"))),this._sourceMapInfobar.setCloseCallback(()=>this._sourceMapInfobar=null),this._textEditor.attachInfobar(this._sourceMapInfobar)))}async _detectMinified(){const e=this._uiSourceCode.content();if(!e||!TextUtils.TextUtils.isMinified(e))return;const t=await self.runtime.allInstances(Sources.SourcesView.EditorAction);let i=null;for(const e of t)if(e instanceof Sources.ScriptFormatterEditorAction){if(!e.isCurrentUISourceCodeFormatable())return;i=e.toggleFormatScriptSource.bind(e);break}if(this._prettyPrintInfobar=UI.Infobar.Infobar.create(UI.Infobar.Type.Info,Common.UIString.UIString("Pretty-print this minified file?"),[{text:ls`Pretty-print`,delegate:i,highlight:!0,dismiss:!0}],Common.Settings.Settings.instance().createSetting("prettyPrintInfobarDisabled",!1)),!this._prettyPrintInfobar)return;this._prettyPrintInfobar.setCloseCallback(()=>this._prettyPrintInfobar=null);const o=new UI.Toolbar.Toolbar(""),n=new UI.Toolbar.ToolbarButton("","largeicon-pretty-print");o.appendToolbarItem(n),o.element.style.display="inline-block",o.element.style.verticalAlign="middle",o.element.style.marginBottom="3px",o.element.style.pointerEvents="none",o.element.tabIndex=-1;this._prettyPrintInfobar.createDetailsRowMessage().appendChild(UI.UIUtils.formatLocalized("Pretty-printing will format this file in a new tab where you can continue debugging. You can also pretty-print this file by clicking the %s button on the bottom status bar.",[o.element])),this._textEditor.attachInfobar(this._prettyPrintInfobar)}async _handleGutterClick(e){if(this._muted)return;const t=e.data;if(t.gutterType!==SourceFrame.SourcesTextEditor.lineNumbersGutterType&&t.gutterType!==breakpointsGutterType)return;const i=t.lineNumber,o=t.event;0!==o.button||o.altKey||o.ctrlKey||o.metaKey||(await this._toggleBreakpoint(i,o.shiftKey),o.consume(!0))}async _toggleBreakpoint(e,t){const i=this._lineBreakpointDecorations(e);if(!i.length)return void await this._createNewBreakpoint(e,"",!0);const o=this._textEditor.hasLineClass(e,"cm-breakpoint-disabled"),n=i.map(e=>e.breakpoint).filter(e=>!!e);for(const e of n)t?e.setEnabled(o):e.remove()}async _createNewBreakpoint(e,t,i){if(Host.userMetrics.actionTaken(Host.UserMetrics.Action.ScriptsBreakpointSet),e<this._textEditor.linesCount){const o=Math.min(this._textEditor.line(e).length,1024),n=this._transformer.editorToRawLocation(e,0),r=this._transformer.editorToRawLocation(e,o),s=await this._breakpointManager.possibleBreakpoints(this._uiSourceCode,new TextUtils.TextRange.TextRange(n[0],n[1],r[0],r[1]));if(s&&s.length)return void await this._setBreakpoint(s[0].lineNumber,s[0].columnNumber,t,i)}const o=this._transformer.editorToRawLocation(e,0);await this._setBreakpoint(o[0],o[1],t,i)}async _setBreakpoint(e,t,i,o){Bindings.CompilerScriptMapping.CompilerScriptMapping.uiLineHasMapping(this._uiSourceCode,e)&&(Common.Settings.Settings.instance().moduleSetting("breakpointsActive").set(!0),await this._breakpointManager.setBreakpoint(this._uiSourceCode,e,t,i,o),this._breakpointWasSetForTest(e,t,i,o))}_breakpointWasSetForTest(e,t,i,o){}async _callFrameChanged(){this._liveLocationPool.disposeAll();const e=self.UI.context.flavor(SDK.DebuggerModel.CallFrame);e?await Bindings.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance().createCallFrameLiveLocation(e.location(),this._executionLineChanged.bind(this),this._liveLocationPool):this._clearExecutionLine()}dispose(){for(const e of this._breakpointDecorations)e.dispose();if(this._breakpointDecorations.clear(),this._scheduledBreakpointDecorationUpdates){for(const e of this._scheduledBreakpointDecorationUpdates)e.dispose();this._scheduledBreakpointDecorationUpdates.clear()}this._hideBlackboxInfobar(),this._sourceMapInfobar&&this._sourceMapInfobar.dispose(),this._prettyPrintInfobar&&this._prettyPrintInfobar.dispose(),this._scriptsPanel.element.removeEventListener("scroll",this._boundPopoverHelperHide,!0);for(const e of this._scriptFileForDebuggerModel.values())e.removeEventListener(Bindings.ResourceScriptMapping.ResourceScriptFile.Events.DidMergeToVM,this._didMergeToVM,this),e.removeEventListener(Bindings.ResourceScriptMapping.ResourceScriptFile.Events.DidDivergeFromVM,this._didDivergeFromVM,this);this._scriptFileForDebuggerModel.clear(),this._textEditor.element.removeEventListener("keydown",this._boundKeyDown,!0),this._textEditor.element.removeEventListener("keyup",this._boundKeyUp,!0),this._textEditor.element.removeEventListener("mousemove",this._boundMouseMove,!1),this._textEditor.element.removeEventListener("mousedown",this._boundMouseDown,!0),this._textEditor.element.removeEventListener("focusout",this._boundBlur,!1),this._textEditor.element.removeEventListener("wheel",this._boundWheel,!0),this._textEditor.removeEventListener(SourceFrame.SourcesTextEditor.Events.GutterClick,e=>{this._handleGutterClick(e)},this),this._popoverHelper.hidePopover(),this._popoverHelper.dispose(),this._breakpointManager.removeEventListener(Bindings.BreakpointManager.Events.BreakpointAdded,this._breakpointAdded,this),this._breakpointManager.removeEventListener(Bindings.BreakpointManager.Events.BreakpointRemoved,this._breakpointRemoved,this),this._uiSourceCode.removeEventListener(Workspace.UISourceCode.Events.WorkingCopyChanged,this._workingCopyChanged,this),this._uiSourceCode.removeEventListener(Workspace.UISourceCode.Events.WorkingCopyCommitted,this._workingCopyCommitted,this),Common.Settings.Settings.instance().moduleSetting("skipStackFramesPattern").removeChangeListener(this._showBlackboxInfobarIfNeeded,this),Common.Settings.Settings.instance().moduleSetting("skipContentScripts").removeChangeListener(this._showBlackboxInfobarIfNeeded,this),super.dispose(),this._clearExecutionLine(),self.UI.context.removeFlavorChangeListener(SDK.DebuggerModel.CallFrame,this._callFrameChanged,this),this._liveLocationPool.disposeAll()}}export class BreakpointDecoration{constructor(e,t,i,o,n,r){this._textEditor=e,this.handle=t,this.condition=i,this.enabled=o,this.bound=n,this.breakpoint=r,this.element=createElement("span"),this.element.classList.toggle("cm-inline-breakpoint",!0),this.bookmark=null}static mostSpecificFirst(e,t){return e.enabled!==t.enabled?e.enabled?-1:1:e.bound!==t.bound?e.bound?-1:1:!!e.condition!=!!t.condition?e.condition?-1:1:0}update(){const e=!!this.condition&&this.condition.includes(LogpointPrefix),t=!!this.condition&&!e;this.element.classList.toggle("cm-inline-logpoint",e),this.element.classList.toggle("cm-inline-breakpoint-conditional",t),this.element.classList.toggle("cm-inline-disabled",!this.enabled)}show(){if(this.bookmark)return;const e=this.handle.resolve();e&&(this.bookmark=this._textEditor.addBookmark(e.lineNumber,e.columnNumber,this.element,BreakpointDecoration.bookmarkSymbol),this.bookmark[BreakpointDecoration._elementSymbolForTest]=this.element)}hide(){this.bookmark&&(this.bookmark.clear(),this.bookmark=null)}dispose(){const e=this.handle.resolve();e&&(this._textEditor.toggleLineClass(e.lineNumber,"cm-breakpoint",!1),this._textEditor.toggleLineClass(e.lineNumber,"cm-breakpoint-disabled",!1),this._textEditor.toggleLineClass(e.lineNumber,"cm-breakpoint-unbound",!1),this._textEditor.toggleLineClass(e.lineNumber,"cm-breakpoint-conditional",!1),this._textEditor.toggleLineClass(e.lineNumber,"cm-breakpoint-logpoint",!1)),this.hide()}}BreakpointDecoration.bookmarkSymbol=Symbol("bookmark"),BreakpointDecoration._elementSymbolForTest=Symbol("element");export const continueToLocationDecorationSymbol=Symbol("bookmark");