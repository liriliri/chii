import*as Common from"../common/common.js";import*as Diff from"../diff/diff.js";import*as SourceFrame from"../source_frame/source_frame.js";import*as TextEditor from"../text_editor/text_editor.js";import*as UI from"../ui/ui.js";import*as Workspace from"../workspace/workspace.js";import*as WorkspaceDiff from"../workspace_diff/workspace_diff.js";import{Plugin}from"./Plugin.js";export class GutterDiffPlugin extends Plugin{constructor(e,t){super(),this._textEditor=e,this._uiSourceCode=t,this._decorations=[],this._textEditor.installGutter(DiffGutterType,!0),this._workspaceDiff=WorkspaceDiff.WorkspaceDiff.workspaceDiff(),this._workspaceDiff.subscribeToDiffChange(this._uiSourceCode,this._update,this),this._update()}static accepts(e){return e.project().type()===Workspace.Workspace.projectTypes.Network}_updateDecorations(e,t){this._textEditor.operation((function(){for(const t of e)t.remove();for(const e of t)e.install()}))}_update(){this._uiSourceCode?this._workspaceDiff.requestDiff(this._uiSourceCode).then(this._innerUpdate.bind(this)):this._innerUpdate(null)}_innerUpdate(e){if(!e)return this._updateDecorations(this._decorations,[]),void(this._decorations=[]);const t=SourceFrame.SourceCodeDiff.SourceCodeDiff.computeDiff(e),o=new Map;for(let e=0;e<t.length;++e){const i=t[e];for(let e=i.from;e<i.to;++e)o.set(e,{lineNumber:e,type:i.type})}const i=this._calculateDecorationsDiff(o),s=i.added.map(e=>new GutterDecoration(this._textEditor,e.lineNumber,e.type));this._decorations=i.equal.concat(s),this._updateDecorations(i.removed,s),this._decorationsSetForTest(o)}_decorationsByLine(){const e=new Map;for(const t of this._decorations){const o=t.lineNumber();-1!==o&&e.set(o,t)}return e}_calculateDecorationsDiff(e){const t=this._decorationsByLine(),o=[...t.keys()],i=[...e.keys()];o.sort((e,t)=>e-t),i.sort((e,t)=>e-t);const s=[],r=[],n=[];let f=0,a=0;for(;f<o.length&&a<i.length;){const c=o[f],u=i[a],p=t.get(c),d=e.get(u);c===u&&p.type===d.type?(n.push(p),++f,++a):c<=u?(s.push(p),++f):(r.push(d),++a)}for(;f<o.length;){const e=o[f++];s.push(t.get(e))}for(;a<i.length;){const t=i[a++];r.push(e.get(t))}return{added:r,removed:s,equal:n}}_decorationsSetForTest(e){}async populateLineGutterContextMenu(e,t){GutterDiffPlugin._appendRevealDiffContextMenu(e,this._uiSourceCode)}async populateTextAreaContextMenu(e,t,o){GutterDiffPlugin._appendRevealDiffContextMenu(e,this._uiSourceCode)}static _appendRevealDiffContextMenu(e,t){WorkspaceDiff.WorkspaceDiff.workspaceDiff().isUISourceCodeModified(t)&&e.revealSection().appendItem(ls`Local Modifications...`,()=>{Common.Revealer.reveal(new WorkspaceDiff.WorkspaceDiff.DiffUILocation(t))})}dispose(){for(const e of this._decorations)e.remove();WorkspaceDiff.WorkspaceDiff.workspaceDiff().unsubscribeFromDiffChange(this._uiSourceCode,this._update,this)}}export class GutterDecoration{constructor(e,t,o){this._textEditor=e,this._position=this._textEditor.textEditorPositionHandle(t,0),this._className="",o===SourceFrame.SourceCodeDiff.EditType.Insert?this._className="diff-entry-insert":o===SourceFrame.SourceCodeDiff.EditType.Delete?this._className="diff-entry-delete":o===SourceFrame.SourceCodeDiff.EditType.Modify&&(this._className="diff-entry-modify"),this.type=o}lineNumber(){const e=this._position.resolve();return e?e.lineNumber:-1}install(){const e=this._position.resolve();if(!e)return;const t=createElementWithClass("div","diff-marker");t.textContent="Â ",this._textEditor.setGutterDecoration(e.lineNumber,DiffGutterType,t),this._textEditor.toggleLineClass(e.lineNumber,this._className,!0)}remove(){const e=this._position.resolve();e&&(this._textEditor.setGutterDecoration(e.lineNumber,DiffGutterType,null),this._textEditor.toggleLineClass(e.lineNumber,this._className,!1))}}export const DiffGutterType="CodeMirror-gutter-diff";export class ContextMenuProvider{appendApplicableItems(e,t,o){let i=o;const s=self.Persistence.persistence.binding(i);s&&(i=s.network),GutterDiffPlugin._appendRevealDiffContextMenu(t,i)}}